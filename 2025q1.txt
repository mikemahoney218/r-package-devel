From ||u|@@rev|||@ @end|ng |rom gm@||@com  Thu Jan  2 15:55:39 2025
From: ||u|@@rev|||@ @end|ng |rom gm@||@com (=?UTF-8?Q?Llu=C3=ADs_Revilla?=)
Date: Thu, 2 Jan 2025 15:55:39 +0100
Subject: [R-pkg-devel] Removing packages files
Message-ID: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>

Hi list,

I am developing a package that will download some data, and I'd like
to store it locally to not recalculate it often.
The CRAN policy requires tools::R_user_dir to be used and "the
contents are actively managed (including removing outdated material)"
or using TMPDIR but "such usage should be cleaned up".

When loading a package there is .onLoad or .onAttach to fill or check
those files and other settings required for a package. Is there
something for when a package is removed?

I found some related functions like .Last or reg.fnalizer and setHook
or packageEvent but they are about closing a session or don't have a
specific event for when uninstalling packages via (remove.packages). I
appreciate any feedback, thanks in advance.

Best wishes and a happy new year,

Llu?s


From murdoch@dunc@n @end|ng |rom gm@||@com  Thu Jan  2 17:23:40 2025
From: murdoch@dunc@n @end|ng |rom gm@||@com (Duncan Murdoch)
Date: Thu, 2 Jan 2025 11:23:40 -0500
Subject: [R-pkg-devel] Removing packages files
In-Reply-To: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
References: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
Message-ID: <fa376599-ff9f-4509-bc41-c5f8c0f8e9c9@gmail.com>

On 2025-01-02 9:55 a.m., Llu?s Revilla wrote:
> Hi list,
> 
> I am developing a package that will download some data, and I'd like
> to store it locally to not recalculate it often.
> The CRAN policy requires tools::R_user_dir to be used and "the
> contents are actively managed (including removing outdated material)"
> or using TMPDIR but "such usage should be cleaned up".
> 
> When loading a package there is .onLoad or .onAttach to fill or check
> those files and other settings required for a package. Is there
> something for when a package is removed?
> 
> I found some related functions like .Last or reg.fnalizer and setHook
> or packageEvent but they are about closing a session or don't have a
> specific event for when uninstalling packages via (remove.packages). I
> appreciate any feedback, thanks in advance.
> 

Yes, those are described in section "1.5.3 Load hooks" of writing R 
extensions:

"Packages can use a .onDetach or .Last.lib function (provided the latter 
is exported from the namespace) when detach is called on the package. It 
is called with a single argument, the full path to the installed 
package. There is also a hook .onUnload which is called when the 
namespace is unloaded (via a call to unloadNamespace, perhaps called by 
detach(unload = TRUE)) with argument the full path to the installed 
package?s directory. Functions .onUnload and .onDetach should be defined 
in the namespace and not exported, but .Last.lib does need to be exported."

Duncan Murdoch


From ||u|@@rev|||@ @end|ng |rom gm@||@com  Thu Jan  2 22:29:18 2025
From: ||u|@@rev|||@ @end|ng |rom gm@||@com (=?UTF-8?Q?Llu=C3=ADs_Revilla?=)
Date: Thu, 2 Jan 2025 22:29:18 +0100
Subject: [R-pkg-devel] Removing packages files
In-Reply-To: <fa376599-ff9f-4509-bc41-c5f8c0f8e9c9@gmail.com>
References: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
 <fa376599-ff9f-4509-bc41-c5f8c0f8e9c9@gmail.com>
Message-ID: <CAN+W6_v3opSqb54GP=uo5O_MpA5Do+m3cR_1GyPdUCxJWRqV3Q@mail.gmail.com>

Dear Duncan,

Thank you for your answer. I checked again and made a mock package
that removes a file with .onDetach.
The file was not removed upon uninstalling the package.

Llu?s

On Thu, 2 Jan 2025 at 17:23, Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
>
> On 2025-01-02 9:55 a.m., Llu?s Revilla wrote:
> > Hi list,
> >
> > I am developing a package that will download some data, and I'd like
> > to store it locally to not recalculate it often.
> > The CRAN policy requires tools::R_user_dir to be used and "the
> > contents are actively managed (including removing outdated material)"
> > or using TMPDIR but "such usage should be cleaned up".
> >
> > When loading a package there is .onLoad or .onAttach to fill or check
> > those files and other settings required for a package. Is there
> > something for when a package is removed?
> >
> > I found some related functions like .Last or reg.fnalizer and setHook
> > or packageEvent but they are about closing a session or don't have a
> > specific event for when uninstalling packages via (remove.packages). I
> > appreciate any feedback, thanks in advance.
> >
>
> Yes, those are described in section "1.5.3 Load hooks" of writing R
> extensions:
>
> "Packages can use a .onDetach or .Last.lib function (provided the latter
> is exported from the namespace) when detach is called on the package. It
> is called with a single argument, the full path to the installed
> package. There is also a hook .onUnload which is called when the
> namespace is unloaded (via a call to unloadNamespace, perhaps called by
> detach(unload = TRUE)) with argument the full path to the installed
> package?s directory. Functions .onUnload and .onDetach should be defined
> in the namespace and not exported, but .Last.lib does need to be exported."
>
> Duncan Murdoch
>


From henr|k@bengt@@on @end|ng |rom gm@||@com  Thu Jan  2 22:41:59 2025
From: henr|k@bengt@@on @end|ng |rom gm@||@com (Henrik Bengtsson)
Date: Thu, 2 Jan 2025 13:41:59 -0800
Subject: [R-pkg-devel] Removing packages files
In-Reply-To: <CAN+W6_v3opSqb54GP=uo5O_MpA5Do+m3cR_1GyPdUCxJWRqV3Q@mail.gmail.com>
References: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
 <fa376599-ff9f-4509-bc41-c5f8c0f8e9c9@gmail.com>
 <CAN+W6_v3opSqb54GP=uo5O_MpA5Do+m3cR_1GyPdUCxJWRqV3Q@mail.gmail.com>
Message-ID: <CAFDcVCQxDLka17fGx4XzdLUOCV4aV2B8GHRaqzhCvgzsxMHtjg@mail.gmail.com>

As a first step, this sounds like something for the 'tools' package,
e.g. tools::cleanup_R_user_dir() that wipes package subfolders of
packages no longer installed, or the specified package, iff given.
With that in place, one could argue for adding a 'cleanup' argument to
remove.packages() that use the former.

Agree, it would be neat if a package could clean up after itself when
uninstalled.

/Henrik

On Thu, Jan 2, 2025 at 1:37?PM Llu?s Revilla <lluis.revilla at gmail.com> wrote:
>
> Dear Duncan,
>
> Thank you for your answer. I checked again and made a mock package
> that removes a file with .onDetach.
> The file was not removed upon uninstalling the package.
>
> Llu?s
>
> On Thu, 2 Jan 2025 at 17:23, Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
> >
> > On 2025-01-02 9:55 a.m., Llu?s Revilla wrote:
> > > Hi list,
> > >
> > > I am developing a package that will download some data, and I'd like
> > > to store it locally to not recalculate it often.
> > > The CRAN policy requires tools::R_user_dir to be used and "the
> > > contents are actively managed (including removing outdated material)"
> > > or using TMPDIR but "such usage should be cleaned up".
> > >
> > > When loading a package there is .onLoad or .onAttach to fill or check
> > > those files and other settings required for a package. Is there
> > > something for when a package is removed?
> > >
> > > I found some related functions like .Last or reg.fnalizer and setHook
> > > or packageEvent but they are about closing a session or don't have a
> > > specific event for when uninstalling packages via (remove.packages). I
> > > appreciate any feedback, thanks in advance.
> > >
> >
> > Yes, those are described in section "1.5.3 Load hooks" of writing R
> > extensions:
> >
> > "Packages can use a .onDetach or .Last.lib function (provided the latter
> > is exported from the namespace) when detach is called on the package. It
> > is called with a single argument, the full path to the installed
> > package. There is also a hook .onUnload which is called when the
> > namespace is unloaded (via a call to unloadNamespace, perhaps called by
> > detach(unload = TRUE)) with argument the full path to the installed
> > package?s directory. Functions .onUnload and .onDetach should be defined
> > in the namespace and not exported, but .Last.lib does need to be exported."
> >
> > Duncan Murdoch
> >
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From murdoch@dunc@n @end|ng |rom gm@||@com  Thu Jan  2 22:47:21 2025
From: murdoch@dunc@n @end|ng |rom gm@||@com (Duncan Murdoch)
Date: Thu, 2 Jan 2025 16:47:21 -0500
Subject: [R-pkg-devel] Removing packages files
In-Reply-To: <CAN+W6_v3opSqb54GP=uo5O_MpA5Do+m3cR_1GyPdUCxJWRqV3Q@mail.gmail.com>
References: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
 <fa376599-ff9f-4509-bc41-c5f8c0f8e9c9@gmail.com>
 <CAN+W6_v3opSqb54GP=uo5O_MpA5Do+m3cR_1GyPdUCxJWRqV3Q@mail.gmail.com>
Message-ID: <7d36ce00-c0b0-458f-ac50-5aa577396acc@gmail.com>

Sorry, I misunderstood what you are after.  I thought you only wanted to 
keep it for the duration of a session.  I don't think there's a way to 
keep a file beyond the current session, but uninstall it later when the 
package is uninstalled.

I think the way you should handle this is to offer a function to the 
user to download the data to the user directory, not to ever do that 
automatically.  If the data hasn't been downloaded, then give the user a 
message that it needs to be downloaded for things to work.  (Or maybe 
download it to the temp directory, and delete it when your package is 
unloaded.)

Duncan Murdoch


On 2025-01-02 4:29 p.m., Llu?s Revilla wrote:
> Dear Duncan,
> 
> Thank you for your answer. I checked again and made a mock package
> that removes a file with .onDetach.
> The file was not removed upon uninstalling the package.
> 
> Llu?s
> 
> On Thu, 2 Jan 2025 at 17:23, Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
>>
>> On 2025-01-02 9:55 a.m., Llu?s Revilla wrote:
>>> Hi list,
>>>
>>> I am developing a package that will download some data, and I'd like
>>> to store it locally to not recalculate it often.
>>> The CRAN policy requires tools::R_user_dir to be used and "the
>>> contents are actively managed (including removing outdated material)"
>>> or using TMPDIR but "such usage should be cleaned up".
>>>
>>> When loading a package there is .onLoad or .onAttach to fill or check
>>> those files and other settings required for a package. Is there
>>> something for when a package is removed?
>>>
>>> I found some related functions like .Last or reg.fnalizer and setHook
>>> or packageEvent but they are about closing a session or don't have a
>>> specific event for when uninstalling packages via (remove.packages). I
>>> appreciate any feedback, thanks in advance.
>>>
>>
>> Yes, those are described in section "1.5.3 Load hooks" of writing R
>> extensions:
>>
>> "Packages can use a .onDetach or .Last.lib function (provided the latter
>> is exported from the namespace) when detach is called on the package. It
>> is called with a single argument, the full path to the installed
>> package. There is also a hook .onUnload which is called when the
>> namespace is unloaded (via a call to unloadNamespace, perhaps called by
>> detach(unload = TRUE)) with argument the full path to the installed
>> package?s directory. Functions .onUnload and .onDetach should be defined
>> in the namespace and not exported, but .Last.lib does need to be exported."
>>
>> Duncan Murdoch
>>


From ||u|@@rev|||@ @end|ng |rom gm@||@com  Fri Jan  3 16:04:01 2025
From: ||u|@@rev|||@ @end|ng |rom gm@||@com (=?UTF-8?Q?Llu=C3=ADs_Revilla?=)
Date: Fri, 3 Jan 2025 16:04:01 +0100
Subject: [R-pkg-devel] Removing packages files
In-Reply-To: <CAFDcVCQxDLka17fGx4XzdLUOCV4aV2B8GHRaqzhCvgzsxMHtjg@mail.gmail.com>
References: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
 <fa376599-ff9f-4509-bc41-c5f8c0f8e9c9@gmail.com>
 <CAN+W6_v3opSqb54GP=uo5O_MpA5Do+m3cR_1GyPdUCxJWRqV3Q@mail.gmail.com>
 <CAFDcVCQxDLka17fGx4XzdLUOCV4aV2B8GHRaqzhCvgzsxMHtjg@mail.gmail.com>
Message-ID: <CAN+W6_uipwj9WopA1Dk5VA9aY1=7HM=XoixWUMXrYPtHj9id_Q@mail.gmail.com>

Thanks Henrik for confirming there is nothing similar currently.

Duncan: Letting the user choose when to remove the folder/data at will is easy.
I was trying to ensure that the system is clean after removing the package.
Thanks.

On Thu, 2 Jan 2025 at 22:42, Henrik Bengtsson
<henrik.bengtsson at gmail.com> wrote:
>
> As a first step, this sounds like something for the 'tools' package,
> e.g. tools::cleanup_R_user_dir() that wipes package subfolders of
> packages no longer installed, or the specified package, iff given.
> With that in place, one could argue for adding a 'cleanup' argument to
> remove.packages() that use the former.
>
> Agree, it would be neat if a package could clean up after itself when
> uninstalled.
>
> /Henrik
>
> On Thu, Jan 2, 2025 at 1:37?PM Llu?s Revilla <lluis.revilla at gmail.com> wrote:
> >
> > Dear Duncan,
> >
> > Thank you for your answer. I checked again and made a mock package
> > that removes a file with .onDetach.
> > The file was not removed upon uninstalling the package.
> >
> > Llu?s
> >
> > On Thu, 2 Jan 2025 at 17:23, Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
> > >
> > > On 2025-01-02 9:55 a.m., Llu?s Revilla wrote:
> > > > Hi list,
> > > >
> > > > I am developing a package that will download some data, and I'd like
> > > > to store it locally to not recalculate it often.
> > > > The CRAN policy requires tools::R_user_dir to be used and "the
> > > > contents are actively managed (including removing outdated material)"
> > > > or using TMPDIR but "such usage should be cleaned up".
> > > >
> > > > When loading a package there is .onLoad or .onAttach to fill or check
> > > > those files and other settings required for a package. Is there
> > > > something for when a package is removed?
> > > >
> > > > I found some related functions like .Last or reg.fnalizer and setHook
> > > > or packageEvent but they are about closing a session or don't have a
> > > > specific event for when uninstalling packages via (remove.packages). I
> > > > appreciate any feedback, thanks in advance.
> > > >
> > >
> > > Yes, those are described in section "1.5.3 Load hooks" of writing R
> > > extensions:
> > >
> > > "Packages can use a .onDetach or .Last.lib function (provided the latter
> > > is exported from the namespace) when detach is called on the package. It
> > > is called with a single argument, the full path to the installed
> > > package. There is also a hook .onUnload which is called when the
> > > namespace is unloaded (via a call to unloadNamespace, perhaps called by
> > > detach(unload = TRUE)) with argument the full path to the installed
> > > package?s directory. Functions .onUnload and .onDetach should be defined
> > > in the namespace and not exported, but .Last.lib does need to be exported."
> > >
> > > Duncan Murdoch
> > >
> >
> > ______________________________________________
> > R-package-devel at r-project.org mailing list
> > https://stat.ethz.ch/mailman/listinfo/r-package-devel


From murdoch@dunc@n @end|ng |rom gm@||@com  Fri Jan  3 17:23:32 2025
From: murdoch@dunc@n @end|ng |rom gm@||@com (Duncan Murdoch)
Date: Fri, 3 Jan 2025 11:23:32 -0500
Subject: [R-pkg-devel] Removing packages files
In-Reply-To: <CAN+W6_uipwj9WopA1Dk5VA9aY1=7HM=XoixWUMXrYPtHj9id_Q@mail.gmail.com>
References: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
 <fa376599-ff9f-4509-bc41-c5f8c0f8e9c9@gmail.com>
 <CAN+W6_v3opSqb54GP=uo5O_MpA5Do+m3cR_1GyPdUCxJWRqV3Q@mail.gmail.com>
 <CAFDcVCQxDLka17fGx4XzdLUOCV4aV2B8GHRaqzhCvgzsxMHtjg@mail.gmail.com>
 <CAN+W6_uipwj9WopA1Dk5VA9aY1=7HM=XoixWUMXrYPtHj9id_Q@mail.gmail.com>
Message-ID: <7cca8298-6e75-429f-ac89-dba8a7a79929@gmail.com>

On 2025-01-03 10:04 a.m., Llu?s Revilla wrote:
> Thanks Henrik for confirming there is nothing similar currently.
> 
> Duncan: Letting the user choose when to remove the folder/data at will is easy.
> I was trying to ensure that the system is clean after removing the package.
> Thanks.

No, I was suggesting that you require the user to explicitly ask for the 
data.  You don't want CRAN to install the data during testing and then 
have it left behind at the end.

Duncan Murdoch

> 
> On Thu, 2 Jan 2025 at 22:42, Henrik Bengtsson
> <henrik.bengtsson at gmail.com> wrote:
>>
>> As a first step, this sounds like something for the 'tools' package,
>> e.g. tools::cleanup_R_user_dir() that wipes package subfolders of
>> packages no longer installed, or the specified package, iff given.
>> With that in place, one could argue for adding a 'cleanup' argument to
>> remove.packages() that use the former.
>>
>> Agree, it would be neat if a package could clean up after itself when
>> uninstalled.
>>
>> /Henrik
>>
>> On Thu, Jan 2, 2025 at 1:37?PM Llu?s Revilla <lluis.revilla at gmail.com> wrote:
>>>
>>> Dear Duncan,
>>>
>>> Thank you for your answer. I checked again and made a mock package
>>> that removes a file with .onDetach.
>>> The file was not removed upon uninstalling the package.
>>>
>>> Llu?s
>>>
>>> On Thu, 2 Jan 2025 at 17:23, Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
>>>>
>>>> On 2025-01-02 9:55 a.m., Llu?s Revilla wrote:
>>>>> Hi list,
>>>>>
>>>>> I am developing a package that will download some data, and I'd like
>>>>> to store it locally to not recalculate it often.
>>>>> The CRAN policy requires tools::R_user_dir to be used and "the
>>>>> contents are actively managed (including removing outdated material)"
>>>>> or using TMPDIR but "such usage should be cleaned up".
>>>>>
>>>>> When loading a package there is .onLoad or .onAttach to fill or check
>>>>> those files and other settings required for a package. Is there
>>>>> something for when a package is removed?
>>>>>
>>>>> I found some related functions like .Last or reg.fnalizer and setHook
>>>>> or packageEvent but they are about closing a session or don't have a
>>>>> specific event for when uninstalling packages via (remove.packages). I
>>>>> appreciate any feedback, thanks in advance.
>>>>>
>>>>
>>>> Yes, those are described in section "1.5.3 Load hooks" of writing R
>>>> extensions:
>>>>
>>>> "Packages can use a .onDetach or .Last.lib function (provided the latter
>>>> is exported from the namespace) when detach is called on the package. It
>>>> is called with a single argument, the full path to the installed
>>>> package. There is also a hook .onUnload which is called when the
>>>> namespace is unloaded (via a call to unloadNamespace, perhaps called by
>>>> detach(unload = TRUE)) with argument the full path to the installed
>>>> package?s directory. Functions .onUnload and .onDetach should be defined
>>>> in the namespace and not exported, but .Last.lib does need to be exported."
>>>>
>>>> Duncan Murdoch
>>>>
>>>
>>> ______________________________________________
>>> R-package-devel at r-project.org mailing list
>>> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From edd @end|ng |rom deb|@n@org  Fri Jan  3 17:34:17 2025
From: edd @end|ng |rom deb|@n@org (Dirk Eddelbuettel)
Date: Fri, 3 Jan 2025 10:34:17 -0600
Subject: [R-pkg-devel] Removing packages files
In-Reply-To: <CAFDcVCQxDLka17fGx4XzdLUOCV4aV2B8GHRaqzhCvgzsxMHtjg@mail.gmail.com>
References: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
 <fa376599-ff9f-4509-bc41-c5f8c0f8e9c9@gmail.com>
 <CAN+W6_v3opSqb54GP=uo5O_MpA5Do+m3cR_1GyPdUCxJWRqV3Q@mail.gmail.com>
 <CAFDcVCQxDLka17fGx4XzdLUOCV4aV2B8GHRaqzhCvgzsxMHtjg@mail.gmail.com>
Message-ID: <26488.4489.589883.44632@rob.eddelbuettel.com>


On 2 January 2025 at 13:41, Henrik Bengtsson wrote:
| Agree, it would be neat if a package could clean up after itself when
| uninstalled.

Indeed many things could be nicer if we had more package manager integrations
and hooks besides `cleanup` and `configure`.  Someone would have to start
with some patches to get the ball rolling.

Dirk

-- 
dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org


From ||u|@@rev|||@ @end|ng |rom gm@||@com  Fri Jan  3 17:46:36 2025
From: ||u|@@rev|||@ @end|ng |rom gm@||@com (=?UTF-8?Q?Llu=C3=ADs_Revilla?=)
Date: Fri, 3 Jan 2025 17:46:36 +0100
Subject: [R-pkg-devel] Removing packages files
In-Reply-To: <7cca8298-6e75-429f-ac89-dba8a7a79929@gmail.com>
References: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
 <fa376599-ff9f-4509-bc41-c5f8c0f8e9c9@gmail.com>
 <CAN+W6_v3opSqb54GP=uo5O_MpA5Do+m3cR_1GyPdUCxJWRqV3Q@mail.gmail.com>
 <CAFDcVCQxDLka17fGx4XzdLUOCV4aV2B8GHRaqzhCvgzsxMHtjg@mail.gmail.com>
 <CAN+W6_uipwj9WopA1Dk5VA9aY1=7HM=XoixWUMXrYPtHj9id_Q@mail.gmail.com>
 <7cca8298-6e75-429f-ac89-dba8a7a79929@gmail.com>
Message-ID: <CAN+W6_s4ihi_D65Ph=j7-zDSc+DrgR1J-nOECEPmerROZTJ=4A@mail.gmail.com>

The data is mostly CRAN's own files transformed, I don't expect the
download to be problematic on CRAN's checks.
The R core members made the functionality inside tools to use a local
variable to search for the requested file locally.
Only if the file is not found they are downloaded from the internet.

Regarding tests, I could disable saving the content to a file (Thanks
for mentioning, I hadn't thought about it).
But the functionality/utility of the package is to transform CRAN's data.
If it is failing to do so, I would like to know.

Llu?s

On Fri, 3 Jan 2025 at 17:23, Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
>
> On 2025-01-03 10:04 a.m., Llu?s Revilla wrote:
> > Thanks Henrik for confirming there is nothing similar currently.
> >
> > Duncan: Letting the user choose when to remove the folder/data at will is easy.
> > I was trying to ensure that the system is clean after removing the package.
> > Thanks.
>
> No, I was suggesting that you require the user to explicitly ask for the
> data.  You don't want CRAN to install the data during testing and then
> have it left behind at the end.
>
> Duncan Murdoch
>
> >
> > On Thu, 2 Jan 2025 at 22:42, Henrik Bengtsson
> > <henrik.bengtsson at gmail.com> wrote:
> >>
> >> As a first step, this sounds like something for the 'tools' package,
> >> e.g. tools::cleanup_R_user_dir() that wipes package subfolders of
> >> packages no longer installed, or the specified package, iff given.
> >> With that in place, one could argue for adding a 'cleanup' argument to
> >> remove.packages() that use the former.
> >>
> >> Agree, it would be neat if a package could clean up after itself when
> >> uninstalled.
> >>
> >> /Henrik
> >>
> >> On Thu, Jan 2, 2025 at 1:37?PM Llu?s Revilla <lluis.revilla at gmail.com> wrote:
> >>>
> >>> Dear Duncan,
> >>>
> >>> Thank you for your answer. I checked again and made a mock package
> >>> that removes a file with .onDetach.
> >>> The file was not removed upon uninstalling the package.
> >>>
> >>> Llu?s
> >>>
> >>> On Thu, 2 Jan 2025 at 17:23, Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
> >>>>
> >>>> On 2025-01-02 9:55 a.m., Llu?s Revilla wrote:
> >>>>> Hi list,
> >>>>>
> >>>>> I am developing a package that will download some data, and I'd like
> >>>>> to store it locally to not recalculate it often.
> >>>>> The CRAN policy requires tools::R_user_dir to be used and "the
> >>>>> contents are actively managed (including removing outdated material)"
> >>>>> or using TMPDIR but "such usage should be cleaned up".
> >>>>>
> >>>>> When loading a package there is .onLoad or .onAttach to fill or check
> >>>>> those files and other settings required for a package. Is there
> >>>>> something for when a package is removed?
> >>>>>
> >>>>> I found some related functions like .Last or reg.fnalizer and setHook
> >>>>> or packageEvent but they are about closing a session or don't have a
> >>>>> specific event for when uninstalling packages via (remove.packages). I
> >>>>> appreciate any feedback, thanks in advance.
> >>>>>
> >>>>
> >>>> Yes, those are described in section "1.5.3 Load hooks" of writing R
> >>>> extensions:
> >>>>
> >>>> "Packages can use a .onDetach or .Last.lib function (provided the latter
> >>>> is exported from the namespace) when detach is called on the package. It
> >>>> is called with a single argument, the full path to the installed
> >>>> package. There is also a hook .onUnload which is called when the
> >>>> namespace is unloaded (via a call to unloadNamespace, perhaps called by
> >>>> detach(unload = TRUE)) with argument the full path to the installed
> >>>> package?s directory. Functions .onUnload and .onDetach should be defined
> >>>> in the namespace and not exported, but .Last.lib does need to be exported."
> >>>>
> >>>> Duncan Murdoch
> >>>>
> >>>
> >>> ______________________________________________
> >>> R-package-devel at r-project.org mailing list
> >>> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>


From pep|jn@devr|e@ @end|ng |rom out|ook@com  Wed Jan  8 13:51:32 2025
From: pep|jn@devr|e@ @end|ng |rom out|ook@com (Pepijn de Vries)
Date: Wed, 8 Jan 2025 12:51:32 +0000
Subject: [R-pkg-devel] (no subject)
Message-ID: <AM8PR10MB466065432B7F9DA11EA0D279A7122@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>

Dear fellow package developers,

A while back I have submitted a package to CRAN and is now listed under waiting <https://cran.r-project.org/incoming/waiting/openmpt_0.1.1.tar.gz>

As I understand it, incoming packages are listed there if CRAN needs more information from the maintainer. However, I have received no requests from CRAN. In the meantime it has been stagnant in the waiting area for about 22 days.

After some more testing I discovered that the submitted package violates CRAN policy (it does not exit gracefully when online resources are not available). Maybe this is why it is on hold. This has been fixed in <https://github.com/pepijn-devries/openmpt>, but has not been submitted yet. How do I proceed? I think I have the following options:

 - wait even longer for feedback from CRAN;
 - contact CRAN about the status of this package;
 - submit the latest version of the package in which policy violations have been addressed.

Any thoughts are welcome.

Pepijn

From ||u|@@rev|||@ @end|ng |rom gm@||@com  Wed Jan  8 22:17:57 2025
From: ||u|@@rev|||@ @end|ng |rom gm@||@com (=?UTF-8?Q?Llu=C3=ADs_Revilla?=)
Date: Wed, 8 Jan 2025 22:17:57 +0100
Subject: [R-pkg-devel] (no subject)
In-Reply-To: <AM8PR10MB466065432B7F9DA11EA0D279A7122@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>
References: <AM8PR10MB466065432B7F9DA11EA0D279A7122@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>
Message-ID: <CAN+W6_u9v-XftUpdt0Fu9QZ+2u+Eh7RmxyFOqX+rV0entox0Mg@mail.gmail.com>

Dear Pepijn,

Thank you for the very detailed email.
Part of these 22 days might be explained by CRAN volunteers being on
vacations a couple of weeks, until yesterday.

I would submit the latest version of the package with the improvements you made.
Other options require more manual work from CRAN volunteers and/or more delays.
I'm sure they will appreciate you double checking CRAN policy to make
sure you comply with all the requirements.

To solve some common issues, there is a new resource co-authored by a
CRAN reviewer: the CRAN cookbook:
https://contributor.r-project.org/cran-cookbook/
I hope it helps.

Good luck!
Best,

Llu?s Revilla

PS: There are some issues on AmigaFFH package, you might receive a
message to update it.

On Wed, 8 Jan 2025 at 13:51, Pepijn de Vries <pepijn.devries at outlook.com> wrote:
>
> Dear fellow package developers,
>
> A while back I have submitted a package to CRAN and is now listed under waiting <https://cran.r-project.org/incoming/waiting/openmpt_0.1.1.tar.gz>
>
> As I understand it, incoming packages are listed there if CRAN needs more information from the maintainer. However, I have received no requests from CRAN. In the meantime it has been stagnant in the waiting area for about 22 days.
>
> After some more testing I discovered that the submitted package violates CRAN policy (it does not exit gracefully when online resources are not available). Maybe this is why it is on hold. This has been fixed in <https://github.com/pepijn-devries/openmpt>, but has not been submitted yet. How do I proceed? I think I have the following options:
>
>  - wait even longer for feedback from CRAN;
>  - contact CRAN about the status of this package;
>  - submit the latest version of the package in which policy violations have been addressed.
>
> Any thoughts are welcome.
>
> Pepijn
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From pep|jn@devr|e@ @end|ng |rom out|ook@com  Wed Jan  8 23:00:07 2025
From: pep|jn@devr|e@ @end|ng |rom out|ook@com (Pepijn de Vries)
Date: Wed, 8 Jan 2025 22:00:07 +0000
Subject: [R-pkg-devel] (no subject)
In-Reply-To: <CAN+W6_u9v-XftUpdt0Fu9QZ+2u+Eh7RmxyFOqX+rV0entox0Mg@mail.gmail.com>
References: <AM8PR10MB466065432B7F9DA11EA0D279A7122@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>
 <CAN+W6_u9v-XftUpdt0Fu9QZ+2u+Eh7RmxyFOqX+rV0entox0Mg@mail.gmail.com>
Message-ID: <AM8PR10MB466003A076F7723BBAAFCC0BA7122@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>

Hi Llu?s,

Thank you for you thoughts on this matter and recommendations. I will go ahead to submit the revised version as soon as possible.

Cheers,

Pepijn

________________________________________
Van:?Llu?s Revilla <lluis.revilla at gmail.com>
Verzonden:?woensdag 8 januari 2025 22:17
Aan:?Pepijn de Vries <pepijn.devries at outlook.com>
CC:?Ivan Krylov via R-package-devel <r-package-devel at r-project.org>
Onderwerp:?Re: [R-pkg-devel] (no subject)
?
Dear Pepijn,

Thank you for the very detailed email.
Part of these 22 days might be explained by CRAN volunteers being on
vacations a couple of weeks, until yesterday.

I would submit the latest version of the package with the improvements you made.
Other options require more manual work from CRAN volunteers and/or more delays.
I'm sure they will appreciate you double checking CRAN policy to make
sure you comply with all the requirements.

To solve some common issues, there is a new resource co-authored by a
CRAN reviewer: the CRAN cookbook:
https://contributor.r-project.org/cran-cookbook/
I hope it helps.

Good luck!
Best,

Llu?s Revilla

PS: There are some issues on AmigaFFH package, you might receive a
message to update it.

On Wed, 8 Jan 2025 at 13:51, Pepijn de Vries <pepijn.devries at outlook.com> wrote:
>
> Dear fellow package developers,
>
> A while back I have submitted a package to CRAN and is now listed under waiting <https://cran.r-project.org/incoming/waiting/openmpt_0.1.1.tar.gz>
>
> As I understand it, incoming packages are listed there if CRAN needs more information from the maintainer. However, I have received no requests from CRAN. In the meantime it has been stagnant in the waiting area for about 22 days.
>
> After some more testing I discovered that the submitted package violates CRAN policy (it does not exit gracefully when online resources are not available). Maybe this is why it is on hold. This has been fixed in <https://github.com/pepijn-devries/openmpt>, but has not been submitted yet. How do I proceed? I think I have the following options:
>
>? - wait even longer for feedback from CRAN;
>? - contact CRAN about the status of this package;
>? - submit the latest version of the package in which policy violations have been addressed.
>
> Any thoughts are welcome.
>
> Pepijn
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel

From vo|ody@ @end|ng |rom m|nd@pr|ng@com  Thu Jan  9 04:23:15 2025
From: vo|ody@ @end|ng |rom m|nd@pr|ng@com (Vladimir Dergachev)
Date: Wed, 8 Jan 2025 22:23:15 -0500 (EST)
Subject: [R-pkg-devel] Removing packages files
In-Reply-To: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
References: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
Message-ID: <alpine.DEB.2.22.394.2501082220520.45848@iridium>


Hi Llu?s,

   Just wanted to add to the discussion that it would be good to consider 
users that are disconnected or behind a firewall and are installing the 
package from file.

   An option to point the package to a separately downloaded file would be
useful.

best

Vladimir Dergachev

On Thu, 2 Jan 2025, Llu?s Revilla wrote:

> Hi list,
>
> I am developing a package that will download some data, and I'd like
> to store it locally to not recalculate it often.
> The CRAN policy requires tools::R_user_dir to be used and "the
> contents are actively managed (including removing outdated material)"
> or using TMPDIR but "such usage should be cleaned up".
>
> When loading a package there is .onLoad or .onAttach to fill or check
> those files and other settings required for a package. Is there
> something for when a package is removed?
>
> I found some related functions like .Last or reg.fnalizer and setHook
> or packageEvent but they are about closing a session or don't have a
> specific event for when uninstalling packages via (remove.packages). I
> appreciate any feedback, thanks in advance.
>
> Best wishes and a happy new year,
>
> Llu?s
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>

From kent@r|emondy @end|ng |rom gm@||@com  Fri Jan 10 15:45:00 2025
From: kent@r|emondy @end|ng |rom gm@||@com (Kent Riemondy)
Date: Fri, 10 Jan 2025 07:45:00 -0700
Subject: [R-pkg-devel] addressing a CRAN submission pre-test clang-san
 warning
Message-ID: <CA+cnB_jbABqxCOsxuCA1-E5sJOf0qZBwrC7t1gNSAH3sHCPKig@mail.gmail.com>

Hi,
  I maintain a package on CRAN (valr) and recently submitted a new version.
The package is failing CRAN pre-test checks due to the warning below from
the clang-san test. The cleancall.c file referenced in the warning isn't in
valr's source code, nor direct dependencies, but eventually I believe
tracks back to the purrr package. Does anyone have any advice for how to
replicate or address this warning?

Flavor: r-devel-linux-x86_64-debian-special-clang-san
Check: Post-processing issues found for clang-san, Result: WARNING
  File: valr-Ex.Rout
  cleancall.c:110:46: runtime error: call to function cb_progress_done
through pointer to incorrect function type 'void (*)(void *)'

  File: tests/testthat.Rout
  cleancall.c:110:46: runtime error: call to function cb_progress_done
through pointer to incorrect function type 'void (*)(void *)'

package source: https://github.com/rnabioco/valr
pre-test artifacts:
https://win-builder.r-project.org/incoming_pretest/valr_0.8.3_20250108_153335/specialChecks/clang-san
/

Thanks in advance,
Kent

	[[alternative HTML version deleted]]


From |kry|ov @end|ng |rom d|@root@org  Fri Jan 10 16:06:52 2025
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Fri, 10 Jan 2025 18:06:52 +0300
Subject: [R-pkg-devel] 
 [SPAM Warning!] addressing a CRAN submission pre-test
 clang-san warning
In-Reply-To: <CA+cnB_jbABqxCOsxuCA1-E5sJOf0qZBwrC7t1gNSAH3sHCPKig@mail.gmail.com>
References: <CA+cnB_jbABqxCOsxuCA1-E5sJOf0qZBwrC7t1gNSAH3sHCPKig@mail.gmail.com>
Message-ID: <20250110180652.2d7bbc89@arachnoid>

? Fri, 10 Jan 2025 07:45:00 -0700
Kent Riemondy <kent.riemondy at gmail.com> ?????:

>   cleancall.c:110:46: runtime error: call to function cb_progress_done
> through pointer to incorrect function type 'void (*)(void *)'

This is a (mostly harmless) error in the purrr package:
https://stat.ethz.ch/pipermail/r-package-devel/2024q4/011230.html

It has recently been reported to the package maintainers:
https://github.com/tidyverse/purrr/issues/1157

Instead of casting the cb_progress_done function pointer to (void
(*)(void*)), the function needs to accept (void*) and cast the argument
to SEXP in the function body.

-- 
Best regards,
Ivan


From kent@r|emondy @end|ng |rom gm@||@com  Fri Jan 10 16:21:27 2025
From: kent@r|emondy @end|ng |rom gm@||@com (Kent Riemondy)
Date: Fri, 10 Jan 2025 08:21:27 -0700
Subject: [R-pkg-devel] 
 [SPAM Warning!] addressing a CRAN submission pre-test
 clang-san warning
In-Reply-To: <20250110180652.2d7bbc89@arachnoid>
References: <CA+cnB_jbABqxCOsxuCA1-E5sJOf0qZBwrC7t1gNSAH3sHCPKig@mail.gmail.com>
 <20250110180652.2d7bbc89@arachnoid>
Message-ID: <CA+cnB_gPGQEDXJHPao2TzQjFzFMg+Akn-Padvn_e1Gd03C=UMg@mail.gmail.com>

Ivan,
  Many thanks for the prompt and helpful response. I hadn't seen the
previous r-package-devel message with the same error. I will explain this
situation to CRAN which hopefully will allow valr to stay on CRAN while I
work to get the suggested fix implemented in purrr.

Thanks,
Kent


On Fri, Jan 10, 2025 at 8:08?AM Ivan Krylov <ikrylov at disroot.org> wrote:

> ? Fri, 10 Jan 2025 07:45:00 -0700
> Kent Riemondy <kent.riemondy at gmail.com> ?????:
>
> >   cleancall.c:110:46: runtime error: call to function cb_progress_done
> > through pointer to incorrect function type 'void (*)(void *)'
>
> This is a (mostly harmless) error in the purrr package:
> https://stat.ethz.ch/pipermail/r-package-devel/2024q4/011230.html
>
> It has recently been reported to the package maintainers:
> https://github.com/tidyverse/purrr/issues/1157
>
> Instead of casting the cb_progress_done function pointer to (void
> (*)(void*)), the function needs to accept (void*) and cast the argument
> to SEXP in the function body.
>
> --
> Best regards,
> Ivan
>

	[[alternative HTML version deleted]]


From pep|jn@devr|e@ @end|ng |rom out|ook@com  Fri Jan 10 18:00:04 2025
From: pep|jn@devr|e@ @end|ng |rom out|ook@com (Pepijn de Vries)
Date: Fri, 10 Jan 2025 17:00:04 +0000
Subject: [R-pkg-devel] gcc-san check warns for non-portable flags
Message-ID: <AM8PR10MB4660B3C058C111F115FC8A9DA71C2@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>

Dear fellow package developers,

There were multiple issues with a package I maintain: @CRAN: <https://cran.r-project.org/package=adfExplorer> @source: <https://github.com/pepijn-devries/adfExplorer/>. As far as I can tell all issues listed @CRAN were fixed in the latest version (available from GitHub and R-Universe). However, when submitting to CRAN, the special gcc san check complains about non-portable flags (see below).

I cannot reproduce this warning myself. As far as I can tell, I don't set these flags myself (neither in the configure script nor in makevars.in). I suspect that these flags are set by the machine that performs the checks. How do I pass this check? Or should I report it to CRAN as a false negative result?

Many thanks for your help.

Kind regards,

Pepijn

> Flavor: r-devel-windows-x86_64, r-devel-linux-x86_64-debian-special-clang-san
> Check: *, Result: OK
>  ?
> Flavor: r-devel-linux-x86_64-debian-special-gcc-san
> Check: compilation flags used, Result: WARNING
> ?Compilation used the following non-portable flag(s):
>  ? ?'-Wno-deprecated-declarations' '-Wno-ignored-attributes'
>  ? ?'-Wno-stringop-truncation'
>  ?including flag(s) suppressing warnings


From d@v|d@gohe| @end|ng |rom @rd@t@@|r  Fri Jan 10 18:17:39 2025
From: d@v|d@gohe| @end|ng |rom @rd@t@@|r (David Gohel)
Date: Fri, 10 Jan 2025 17:17:39 +0000
Subject: [R-pkg-devel] gcc-san check warns for non-portable flags
In-Reply-To: <AM8PR10MB4660B3C058C111F115FC8A9DA71C2@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>
References: <AM8PR10MB4660B3C058C111F115FC8A9DA71C2@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>
Message-ID: <MRXP264MB0328A82A5EB35DFAAB4BAAA0FA1C2@MRXP264MB0328.FRAP264.PROD.OUTLOOK.COM>

I had the same this week.

Yes, you should answer these are false negative results.

KR,
David

De : R-package-devel <r-package-devel-bounces at r-project.org> de la part de Pepijn de Vries <pepijn.devries at outlook.com>
Date : vendredi, 10 janvier 2025 ? 18:00
? : Ivan Krylov via R-package-devel <r-package-devel at r-project.org>
Objet : [R-pkg-devel] gcc-san check warns for non-portable flags
Dear fellow package developers,

There were multiple issues with a package I maintain: @CRAN: <https://cran.r-project.org/package=adfExplorer> @source: <https://github.com/pepijn-devries/adfExplorer/>. As far as I can tell all issues listed @CRAN were fixed in the latest version (available from GitHub and R-Universe). However, when submitting to CRAN, the special gcc san check complains about non-portable flags (see below).

I cannot reproduce this warning myself. As far as I can tell, I don't set these flags myself (neither in the configure script nor in makevars.in). I suspect that these flags are set by the machine that performs the checks. How do I pass this check? Or should I report it to CRAN as a false negative result?

Many thanks for your help.

Kind regards,

Pepijn

> Flavor: r-devel-windows-x86_64, r-devel-linux-x86_64-debian-special-clang-san
> Check: *, Result: OK
>
> Flavor: r-devel-linux-x86_64-debian-special-gcc-san
> Check: compilation flags used, Result: WARNING
>  Compilation used the following non-portable flag(s):
>     '-Wno-deprecated-declarations' '-Wno-ignored-attributes'
>     '-Wno-stringop-truncation'
>   including flag(s) suppressing warnings

______________________________________________
R-package-devel at r-project.org mailing list
https://stat.ethz.ch/mailman/listinfo/r-package-devel

	[[alternative HTML version deleted]]


From pep|jn@devr|e@ @end|ng |rom out|ook@com  Fri Jan 10 21:19:27 2025
From: pep|jn@devr|e@ @end|ng |rom out|ook@com (Pepijn de Vries)
Date: Fri, 10 Jan 2025 20:19:27 +0000
Subject: [R-pkg-devel] gcc-san check warns for non-portable flags
In-Reply-To: <MRXP264MB0328A82A5EB35DFAAB4BAAA0FA1C2@MRXP264MB0328.FRAP264.PROD.OUTLOOK.COM>
References: <AM8PR10MB4660B3C058C111F115FC8A9DA71C2@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>
 <MRXP264MB0328A82A5EB35DFAAB4BAAA0FA1C2@MRXP264MB0328.FRAP264.PROD.OUTLOOK.COM>
Message-ID: <AM8PR10MB4660414895B1D16891E4AEB9A71C2@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>

Hi David,

Thanks for the quick response. I will report it.

Pepijn

________________________________________
Van:?R-package-devel <r-package-devel-bounces at r-project.org> namens David Gohel <david.gohel at ardata.fr>
Verzonden:?vrijdag 10 januari 2025 18:17
Aan:?r-package-devel at r-project.org <r-package-devel at r-project.org>
Onderwerp:?Re: [R-pkg-devel] gcc-san check warns for non-portable flags
?
I had the same this week.

Yes, you should answer these are false negative results.

KR,
David

De : R-package-devel <r-package-devel-bounces at r-project.org> de la part de Pepijn de Vries <pepijn.devries at outlook.com>
Date : vendredi, 10 janvier 2025 ? 18:00
? : Ivan Krylov via R-package-devel <r-package-devel at r-project.org>
Objet : [R-pkg-devel] gcc-san check warns for non-portable flags
Dear fellow package developers,

There were multiple issues with a package I maintain: @CRAN: <https://cran.r-project.org/package=adfExplorer> @source: <https://github.com/pepijn-devries/adfExplorer/>. As far as I can tell all issues listed @CRAN were fixed in the latest version (available from GitHub and R-Universe). However, when submitting to CRAN, the special gcc san check complains about non-portable flags (see below).

I cannot reproduce this warning myself. As far as I can tell, I don't set these flags myself (neither in the configure script nor in makevars.in). I suspect that these flags are set by the machine that performs the checks. How do I pass this check? Or should I report it to CRAN as a false negative result?

Many thanks for your help.

Kind regards,

Pepijn

> Flavor: r-devel-windows-x86_64, r-devel-linux-x86_64-debian-special-clang-san
> Check: *, Result: OK
>
> Flavor: r-devel-linux-x86_64-debian-special-gcc-san
> Check: compilation flags used, Result: WARNING
>? Compilation used the following non-portable flag(s):
>???? '-Wno-deprecated-declarations' '-Wno-ignored-attributes'
>???? '-Wno-stringop-truncation'
>?? including flag(s) suppressing warnings

______________________________________________
R-package-devel at r-project.org mailing list
https://stat.ethz.ch/mailman/listinfo/r-package-devel

??????? [[alternative HTML version deleted]]

From |uk@@@@chne|derb@uer @end|ng |rom gm@||@com  Sat Jan 11 10:37:20 2025
From: |uk@@@@chne|derb@uer @end|ng |rom gm@||@com (Lukas Schneiderbauer)
Date: Sat, 11 Jan 2025 10:37:20 +0100
Subject: [R-pkg-devel] SystemRequirements & configure check for FFTW with
 single precision support
Message-ID: <CAHETjtZcmar26ud0s0yn9RGQXwjKtVpkT3gt+o2DGfAyR-T=qg@mail.gmail.com>

Hi list,

I am working on getting a package <https://github.com/lschneiderbauer/fCWTr> to
CRAN. It depends on the FFTW library <https://www.fftw.org/> that is built
with single precision support. I am stuck in the submission process and I
require your help.

Before I come to my questions, some key facts about the package:

The package has an autoconf configure script that uses (among other things,
like OpenMP checks, etc..) AC_SEARCH_LIBS to check whether required
functions of the library 'fftwf' exist, if yes, it adds the corresponding
compiler/linker flags; if no, it errs with a descriptive error message.

The CRAN Windows as well as Linux build service included fftwf in their
fftw build out of the box, and so building there was no problem, R CMD
Check passes there. In the past, building for MacOS was more trouble, since
its fftw package does not include a single-precision build. I reached out
to Simon Urbanek, and he was so kind as to add an appropriate new recipe
"fftw-s" that provided an fftw version with single precision support. As of
now, R CMD check also passes cleanly on the MacOS build service, thanks to
Simon Urbanek's efforts.

Now, I am stuck at submission for two reasons:
1. The SystemRequirements specification in the DESCRIPTION file is
incorrect.
2. It is said that "the package needs a configure check for fftwf".

Add 1.
Initially, I had no mention of the "single precision" version of fftw,
because I thought it is included everywhere by default. It was stated that
I need to add that information. I naturally complied.
This is my current version:
"SystemRequirements: fftw3 (including single precision support fftw3f),
fftw3f_omp (optional), OpenMP (optional)"
In the second subscription run, I was told to add "fftw-s" since I require
the fftw-s package on MacOS. This does not make much sense to me since
"fftw-s" is only the name of this package on Simon Urbanek's MacOS build
service. The library file itself is still called fftwf, like it is on any
other platform. If I added "fftw-s", I would also need to explain that this
is only valid for MacOS which seems to make the SystemRequirements
unnecessary verbose.
* Can someone explain the reason behind this request to me?
* How exactly should I add "fftw-s" to pass the submission process?

Add 2.
I tried to explain now for the second time in the submission notes, that a
check is already in place (see the AC_SEARCH_LIBS paragraph above). But my
explanation gets ignored.
* What am I doing wrong?
* What additional configure checks do I need to add to the package?

Thanks a lot for your help!
Sincerely, Lukas Schneiderbauer

	[[alternative HTML version deleted]]


From edd @end|ng |rom deb|@n@org  Sat Jan 11 19:52:59 2025
From: edd @end|ng |rom deb|@n@org (Dirk Eddelbuettel)
Date: Sat, 11 Jan 2025 12:52:59 -0600
Subject: [R-pkg-devel] 
 SystemRequirements & configure check for FFTW with
 single precision support
In-Reply-To: <CAHETjtZcmar26ud0s0yn9RGQXwjKtVpkT3gt+o2DGfAyR-T=qg@mail.gmail.com>
References: <CAHETjtZcmar26ud0s0yn9RGQXwjKtVpkT3gt+o2DGfAyR-T=qg@mail.gmail.com>
Message-ID: <26498.48651.572674.777799@rob.eddelbuettel.com>


Lukas,

It is, as you noticed, complicated.

One way forward might be to rely on what you can rely on (i.e. a suitable
system fftw on two of the three platforms) and to embed and locally build
where not. Nowadays a number of packages embedding external libraries and
resorting to eg cmake to build locally to provide what their R package needs
(pak now rebuilds curl, igraph 'vendors' a number of external libraries, as
does duckdb and so on), and so on. It is one approach. Others download if
they must (i.e. what I once added to nloptr) but CRAN now leans more against
downloads at build time. [1]

The problem is that SystemRequirements: is all we have to solve a cross-OS,
cross-platform, cross-distro (for Linux), cross-release, ... dependency
issue.  Something for which a (commonly) single-line of free form text is not
all that well suited. But anything more formal would be need to reliably
address the cross-product of cpu architecture, operating system,
flavour/distro, release, ... Not easy for (less than) a handful of already
stretched volunteers.

So this is a hard problem; if it could be fixed easily it would have been
addressed in the 25+ plus years of CRAN.

Cheers, Dirk

PS For the smaller subset of three releases for (currently) one architecture,
one platform, and one distribution flavor this has been address using the
existence of system package manager: r2u covers this reliably and gets you
(CRAN) package binaries for Ubuntu with full and complete system dependency
integration, see https://eddelbuettel.github.io/r2u -- but it is hard /
impossible to generalise to other OSs without a similar package manager.

-- 
dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org


From |kry|ov @end|ng |rom d|@root@org  Sat Jan 11 20:09:57 2025
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Sat, 11 Jan 2025 22:09:57 +0300
Subject: [R-pkg-devel] 
 SystemRequirements & configure check for FFTW with
 single precision support
In-Reply-To: <CAHETjtZcmar26ud0s0yn9RGQXwjKtVpkT3gt+o2DGfAyR-T=qg@mail.gmail.com>
References: <CAHETjtZcmar26ud0s0yn9RGQXwjKtVpkT3gt+o2DGfAyR-T=qg@mail.gmail.com>
Message-ID: <20250111220957.6f839b0d@Tarkus>

? Sat, 11 Jan 2025 10:37:20 +0100
Lukas Schneiderbauer <lukas.schneiderbauer at gmail.com> ?????:

> I was told to add "fftw-s" since I require the fftw-s package on
> MacOS.

> * Can someone explain the reason behind this request to me?

While the SystemRequirements: field currently contains free-form text,
eventually we might be able to evolve it into something
machine-readable to install the system-level dependencies
automatically. Since the macOS packages are built using the recipes
system to provide the dependencies, it makes certain sense to list the
name of the recipe for their sake, in addition to the name of the
shared library.

> * How exactly should I add "fftw-s" to pass the submission process?

I've tried looking for examples using

db <- tools::CRAN_package_db()
subset(db, grepl('recipe|mac', SystemRequirements, ignore.case=TRUE))

...but found nothing relevant. How about something like the following?

SystemRequirements:
 fftw3 (including single precision support fftw3f; 'fftw-s' macOS
 recipe), fftw3f_omp (optional), OpenMP (optional)

> I tried to explain now for the second time in the submission notes,
> that a check is already in place (see the AC_SEARCH_LIBS paragraph
> above). But my explanation gets ignored.

I'm sorry for asking this admittedly thick question, but are you sure
it's not just R CMD check --as-cran repeating the X-CRAN-Comment: field
(which includes the phrase about not testing for single-precision
FFTW)? Does the rejection e-mail say "please fix and resubmit", list
specific problems, or ask for specific actions?

> * What additional configure checks do I need to add to the package?

The configure test for -lfftwf seems fine to me.

I wouldn't test for OpenMP's omp.h because testing for a working OpenMP
installation is fraught with peril and corner cases [*], but you pick
up R's OpenMP flags correctly and have appropriate #ifdef _OPENMP
sections in the source code, so that shouldn't cause you any real
problems.

-- 
Best regards,
Ivan

[*] https://github.com/Rdatatable/data.table/pull/6642


From gr@eme|eeh|ckey @end|ng |rom gm@||@com  Tue Jan 14 08:08:20 2025
From: gr@eme|eeh|ckey @end|ng |rom gm@||@com (Graeme Hickey)
Date: Mon, 13 Jan 2025 23:08:20 -0800
Subject: [R-pkg-devel] Vignette build issue on Debian platform
Message-ID: <CALvcmje4JO8cfV05o+8dDWTWtCfx4GPGU0zYcxMgw+gTEghqug@mail.gmail.com>

Dear all,


I recently made some minor updates to the joineRML R package to squash some
CRAN CMD check NOTEs that have emerged over the past couple of years.  After
resubmitting to CRAN, a new NOTE appeared on the Debian platform only:


> package joineRML_0.4.7.tar.gz does not pass the incoming checks
automatically, please see the following pre-tests (additional issue checks):

> Windows: <
https://win-builder.r-project.org/incoming_pretest/joineRML_0.4.7_20250114_073418/Windows/00check.log
>

> Status: OK

> Debian: <
https://win-builder.r-project.org/incoming_pretest/joineRML_0.4.7_20250114_073418/Debian/00check.log
>

> Status: 1 NOTE


The NOTE in particular is:


> * checking re-building of vignette outputs ... [116s/30s] NOTE

> Re-building vignettes had CPU time 3.9 times elapsed time


I emailed Uwe Ligges and got a reply:


> We see

> Flavor: r-devel-linux-x86_64-debian-gcc

> Check: re-building of vignette outputs, Result: NOTE

>    Re-building vignettes had CPU time 3.9 times elapsed time


> which suggests you are using more than 2 cores which is not permitted by
default.


There is only one function in my package that uses multiple cores:
bootSE(). However, this function is not called in any of my vignettes
because it is computationally expensive. The Rmd code has `eval = FALSE`
options for all of these cases. Therefore, I am at a loss as to why these
vignettes would be using more than 2 cores or what is causing this, or why
it only impacts the CRAN CMD check Debian system.


I noticed this has been a common reported issue (e.g.,
https://github.com/Rdatatable/data.table/issues/5658), but mainly for those
using data.table or openMP; I use neither. The same issue was showing for
some examples also, which I dealt with by wrapping in \dontrun{} ? not
ideal, but seemed quickest way to avoid.


I have tried many things to fix this:

   1. Modifying the vignettes to make faster
   2. Adding various combinations of Sys.setenv("OMP_THREAD_LIMIT" = 1),
   Sys.setenv("OMP_NUM_THREADS" = 1), options(Ncpus = 1), options(cores = 2)
   to the Rmd vignettes
   3. Checked the package builds using r-lib/actions (GitHub actions) and
   r-hub Debian platform ? I cannot reproduce this CRAN error


CRAN will not accept the update to my package until this NOTE is squashed.
If anyone is able to provide a recommendation on what I might do, I would
appreciate it.


Kind regards,


Graeme Hickey

	[[alternative HTML version deleted]]


From j|@c@@hu|@m@n @end|ng |rom gm@||@com  Tue Jan 14 17:25:23 2025
From: j|@c@@hu|@m@n @end|ng |rom gm@||@com (Jisca Huisman)
Date: Tue, 14 Jan 2025 17:25:23 +0100
Subject: [R-pkg-devel] Vignette build issue on Debian platform
In-Reply-To: <CALvcmje4JO8cfV05o+8dDWTWtCfx4GPGU0zYcxMgw+gTEghqug@mail.gmail.com>
References: <CALvcmje4JO8cfV05o+8dDWTWtCfx4GPGU0zYcxMgw+gTEghqug@mail.gmail.com>
Message-ID: <852a85b8-0966-43fb-9d0b-b10188eb85fd@gmail.com>

Hi Graeme,

> There is only one function in my package that uses multiple cores:
> bootSE(). However, this function is not called in any of my vignettes
> because it is computationally expensive. The Rmd code has `eval = FALSE`
> options for all of these cases. Therefore, I am at a loss as to why these
> vignettes would be using more than 2 cores or what is causing this, or why
> it only impacts the CRAN CMD check Debian system.

CRAN has changed its settings when compiling the vignette, and now 
*does* run everything in chunks with `eval = FALSE`.? The solution is to 
also add `purl=FALSE` to each chunk that should not be run.

If you dig through the mailing list archive you should be able to find 
further details on the why and how of this, or someone else might remember.

Best,

Jisca



On Tue, 14/01/2025 08:08, Graeme Hickey wrote:
> Dear all,
>
>
> I recently made some minor updates to the joineRML R package to squash some
> CRAN CMD check NOTEs that have emerged over the past couple of years.  After
> resubmitting to CRAN, a new NOTE appeared on the Debian platform only:
>
>
>> package joineRML_0.4.7.tar.gz does not pass the incoming checks
> automatically, please see the following pre-tests (additional issue checks):
>
>> Windows: <
> https://win-builder.r-project.org/incoming_pretest/joineRML_0.4.7_20250114_073418/Windows/00check.log
>> Status: OK
>> Debian: <
> https://win-builder.r-project.org/incoming_pretest/joineRML_0.4.7_20250114_073418/Debian/00check.log
>> Status: 1 NOTE
>
> The NOTE in particular is:
>
>
>> * checking re-building of vignette outputs ... [116s/30s] NOTE
>> Re-building vignettes had CPU time 3.9 times elapsed time
>
> I emailed Uwe Ligges and got a reply:
>
>
>> We see
>> Flavor: r-devel-linux-x86_64-debian-gcc
>> Check: re-building of vignette outputs, Result: NOTE
>>     Re-building vignettes had CPU time 3.9 times elapsed time
>
>> which suggests you are using more than 2 cores which is not permitted by
> default.
>
>
> There is only one function in my package that uses multiple cores:
> bootSE(). However, this function is not called in any of my vignettes
> because it is computationally expensive. The Rmd code has `eval = FALSE`
> options for all of these cases. Therefore, I am at a loss as to why these
> vignettes would be using more than 2 cores or what is causing this, or why
> it only impacts the CRAN CMD check Debian system.
>
>
> I noticed this has been a common reported issue (e.g.,
> https://github.com/Rdatatable/data.table/issues/5658), but mainly for those
> using data.table or openMP; I use neither. The same issue was showing for
> some examples also, which I dealt with by wrapping in \dontrun{} ? not
> ideal, but seemed quickest way to avoid.
>
>
> I have tried many things to fix this:
>
>     1. Modifying the vignettes to make faster
>     2. Adding various combinations of Sys.setenv("OMP_THREAD_LIMIT" = 1),
>     Sys.setenv("OMP_NUM_THREADS" = 1), options(Ncpus = 1), options(cores = 2)
>     to the Rmd vignettes
>     3. Checked the package builds using r-lib/actions (GitHub actions) and
>     r-hub Debian platform ? I cannot reproduce this CRAN error
>
>
> CRAN will not accept the update to my package until this NOTE is squashed.
> If anyone is able to provide a recommendation on what I might do, I would
> appreciate it.
>
>
> Kind regards,
>
>
> Graeme Hickey
>
> 	[[alternative HTML version deleted]]
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From @|mon@urb@nek @end|ng |rom R-project@org  Wed Jan 15 03:59:17 2025
From: @|mon@urb@nek @end|ng |rom R-project@org (Simon Urbanek)
Date: Wed, 15 Jan 2025 15:59:17 +1300
Subject: [R-pkg-devel] 
 SystemRequirements & configure check for FFTW with
 single precision support
In-Reply-To: <CAHETjtZcmar26ud0s0yn9RGQXwjKtVpkT3gt+o2DGfAyR-T=qg@mail.gmail.com>
References: <CAHETjtZcmar26ud0s0yn9RGQXwjKtVpkT3gt+o2DGfAyR-T=qg@mail.gmail.com>
Message-ID: <4D3E0C0F-263C-4B48-91A6-0E9C56D70B27@R-project.org>

Lukas,

I have not seen the communication so I'm not commenting on that specifically, I only looked at the GitHub link.

Although your configure could be improved (more below), it works well enough to detect fftw3f.

Unfortunately, SystemRequirements don't have a well-defined structure, but there are two commonly used notations:

a) library name and version so in your case that would be something like
libfftw3f (>=3.3.0)

b) deb/rpm package names
libfftw3-dev (deb), fftw3-devel (rpm)

fftw is a bit of a mess, because Debian ships the single-precision static library in libfftw3-dev, but also has libfftw3-single3 which is the dynamic version of the same, while RH does not distinguish. macOS recipe names are usually included only if they are non-obvious, but that would be the case here since installing fftw recipe does not work for you, so mentioning fftw-s is probably a good idea (there are community scripts that try to extract that information from the packages so that the dependencies can be installed).

As for your configure, my main objection would be that it ignores CPPFLAGS (they are not substituted at all even though they *are* used in the tests) and doesn't use pkg-config to get the correct flags. (Also the brew part should go - it's makes unwarranted assumptions [see below] and is entirely superfluous if you use pkg-config instead.) To illustrate what I mean, you get

$ pkg-config --cflags fftw3f
-I/opt/R/x86_64/include
$ pkg-config --libs fftw3f
-L/opt/R/x86_64/lib -lfftw3f -lm

while fCWTr on GitHub only uses

  Configuration for fCWTr 0.2.9000

    cppflags:    
    cxxflags:    
    ldflags:   
    libs:     -lfftw3f    

It actually works despite that, because R will inject the other flags for you, but that will only work is fftw is installed in the same location as the other libraries used by R (which is common, but not guaranteed). I wouldn't say it is dealbreaker, but it would recommend it for robustness.

FWIW with homebrew the correct flags are obtainable from pkg-config:

$ pkg-config --libs fftw3f
-L/opt/brew/Cellar/fftw/3.3.8_1/lib -lfftw3f
$ pkg-config --cflags fftw3f
-I/opt/brew/Cellar/fftw/3.3.8_1/include

Cheers,
Simon



> On Jan 11, 2025, at 10:37 PM, Lukas Schneiderbauer <lukas.schneiderbauer at gmail.com> wrote:
> 
> Hi list,
> 
> I am working on getting a package <https://github.com/lschneiderbauer/fCWTr> to
> CRAN. It depends on the FFTW library <https://www.fftw.org/> that is built
> with single precision support. I am stuck in the submission process and I
> require your help.
> 
> Before I come to my questions, some key facts about the package:
> 
> The package has an autoconf configure script that uses (among other things,
> like OpenMP checks, etc..) AC_SEARCH_LIBS to check whether required
> functions of the library 'fftwf' exist, if yes, it adds the corresponding
> compiler/linker flags; if no, it errs with a descriptive error message.
> 
> The CRAN Windows as well as Linux build service included fftwf in their
> fftw build out of the box, and so building there was no problem, R CMD
> Check passes there. In the past, building for MacOS was more trouble, since
> its fftw package does not include a single-precision build. I reached out
> to Simon Urbanek, and he was so kind as to add an appropriate new recipe
> "fftw-s" that provided an fftw version with single precision support. As of
> now, R CMD check also passes cleanly on the MacOS build service, thanks to
> Simon Urbanek's efforts.
> 
> Now, I am stuck at submission for two reasons:
> 1. The SystemRequirements specification in the DESCRIPTION file is
> incorrect.
> 2. It is said that "the package needs a configure check for fftwf".
> 
> Add 1.
> Initially, I had no mention of the "single precision" version of fftw,
> because I thought it is included everywhere by default. It was stated that
> I need to add that information. I naturally complied.
> This is my current version:
> "SystemRequirements: fftw3 (including single precision support fftw3f),
> fftw3f_omp (optional), OpenMP (optional)"
> In the second subscription run, I was told to add "fftw-s" since I require
> the fftw-s package on MacOS. This does not make much sense to me since
> "fftw-s" is only the name of this package on Simon Urbanek's MacOS build
> service. The library file itself is still called fftwf, like it is on any
> other platform. If I added "fftw-s", I would also need to explain that this
> is only valid for MacOS which seems to make the SystemRequirements
> unnecessary verbose.
> * Can someone explain the reason behind this request to me?
> * How exactly should I add "fftw-s" to pass the submission process?
> 
> Add 2.
> I tried to explain now for the second time in the submission notes, that a
> check is already in place (see the AC_SEARCH_LIBS paragraph above). But my
> explanation gets ignored.
> * What am I doing wrong?
> * What additional configure checks do I need to add to the package?
> 
> Thanks a lot for your help!
> Sincerely, Lukas Schneiderbauer
> 
> 	[[alternative HTML version deleted]]
> 
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
> 


From c|yde @end|ng |rom duke@edu  Wed Jan 15 05:26:32 2025
From: c|yde @end|ng |rom duke@edu (Merlise Clyde, Ph.D.)
Date: Wed, 15 Jan 2025 04:26:32 +0000
Subject: [R-pkg-devel] Replacement for SETLENGTH
Message-ID: <CY8PR05MB100342EF92E6E169CA1067103C8182@CY8PR05MB10034.namprd05.prod.outlook.com>

I am trying to determine the best way to eliminate the use of SETLENGTH to truncate over allocated vectors in my package BAS to eliminate the NOTES about non-API calls in anticipation of R 4.5.0.

>From WRE:  "At times it can be useful to allocate a larger initial result vector and resize it to a shorter length if that is sufficient. The functions Rf_lengthgets and Rf_xlengthgets accomplish this; they are analogous to using length(x) <- n in R. Typically these functions return a freshly allocated object, but in some cases they may re-use the supplied object." 

it looks like using 

    x = Rf_lengthgets(x, newsize);  
    SET_VECTOR_ELT(result, 0, x); 
    
before returning works to resize without a performance hit that incurs with a copy.  (will this always re-use the supplied object if newsize < old size?)

There is no mention in section 5.9.2 about the need for re-protection of the object,  but it seems to be mentioned in some packages as well as a really old thread about SET_LENGTH that looks like a  non-API MACRO to lengthgets, 

indeed if I call gc() and then rerun my test I have had some non-reproducible aborts in R Studio on my M3 Mac (caught once in R -d lldb)  

Do I need to do something more like 

PROTECT_INDEX ipx0;.
PROTECT_WITH_INDEX(x0 = allocVector(REALSXP, old_size), &ipx0);

PROTECT_INDEX ipx1;.
PROTECT_WITH_INDEX(x1 = allocVector(REALSXP, old_size), &ipx1);

# fill in values in x0 and  x1up to new_size (random) < old_size
...
REPROTECT(x0 = Rf_lengthgets(x0, new_size), ipx0);
REPROTECT(x1 = Rf_lengthgets(x1, new_size), ipx1);

SET_VECTOR_ELT(result, 0, x0);
SET_VECTOR_ELT(result, 1, x1);
...
UNPROTECT(2);   # or is this 4? 
return(result);


There is also a mention in WRE of R_PreserveObject and R_ReleaseObject -  

looking for advice if this is needed, or which approach is better/more stable to replace SETLENGTH?   (I have many many instances that need to be updated, so trying to get some clarity here before updating and running code through valgrind or other sanitizers to catch any memory issues before submitting an update to CRAN.

best,
Merlise








From |kw@|mmo @end|ng |rom gm@||@com  Wed Jan 15 07:00:02 2025
From: |kw@|mmo @end|ng |rom gm@||@com (Iris Simmons)
Date: Wed, 15 Jan 2025 01:00:02 -0500
Subject: [R-pkg-devel] Replacement for SETLENGTH
In-Reply-To: <CY8PR05MB100342EF92E6E169CA1067103C8182@CY8PR05MB10034.namprd05.prod.outlook.com>
References: <CY8PR05MB100342EF92E6E169CA1067103C8182@CY8PR05MB10034.namprd05.prod.outlook.com>
Message-ID: <CADNULg9fKRf3K6Q062D7X4rUJysO=9cWA1kFEjpSv3J-Oy0bYg@mail.gmail.com>

Hi Merlise!


Referring to here:

https://github.com/wch/r-source/blob/8ca367db0c94194f07ee7bcf4b883e9c5dc11e02/src/main/builtin.c#L832

It seems as though the object is only re-used if the new length is
equal to the old length.

If you use Rf_lengthgets, you will need to protect the return value.
The code you wrote that uses protect indexes looks correct, and the
reprotect is good because you no longer need the old object.

2 is the correct amount to unprotect. PROTECT and PROTECT_WITH_INDEX
(as far as I know) are the only functions that increase the size of
the protect stack, and so the only calls that need to be unprotected.
Typically, people define `int nprotect = 0;` at the start of their
functions, add `nprotect++;` after each PROTECT and PROTECT_WITH_INDEX
call, and add `UNPROTECT(nprotect);` immediately before each return or
function end. That makes it easier to keep track.

I typically use R_PreserveObject and R_ReleaseObject to protect
objects without a need to bind them somewhere in my package's
namespace. This would be that .onLoad() uses R_PreserveObject to
protect some objects, and .onUnload uses R_ReleaseObject to release
the protected objects. I probably would not use that for what you're
describing.


Regards,
    Iris

On Tue, Jan 14, 2025 at 11:26?PM Merlise Clyde, Ph.D. <clyde at duke.edu> wrote:
>
> I am trying to determine the best way to eliminate the use of SETLENGTH to truncate over allocated vectors in my package BAS to eliminate the NOTES about non-API calls in anticipation of R 4.5.0.
>
> From WRE:  "At times it can be useful to allocate a larger initial result vector and resize it to a shorter length if that is sufficient. The functions Rf_lengthgets and Rf_xlengthgets accomplish this; they are analogous to using length(x) <- n in R. Typically these functions return a freshly allocated object, but in some cases they may re-use the supplied object."
>
> it looks like using
>
>     x = Rf_lengthgets(x, newsize);
>     SET_VECTOR_ELT(result, 0, x);
>
> before returning works to resize without a performance hit that incurs with a copy.  (will this always re-use the supplied object if newsize < old size?)
>
> There is no mention in section 5.9.2 about the need for re-protection of the object,  but it seems to be mentioned in some packages as well as a really old thread about SET_LENGTH that looks like a  non-API MACRO to lengthgets,
>
> indeed if I call gc() and then rerun my test I have had some non-reproducible aborts in R Studio on my M3 Mac (caught once in R -d lldb)
>
> Do I need to do something more like
>
> PROTECT_INDEX ipx0;.
> PROTECT_WITH_INDEX(x0 = allocVector(REALSXP, old_size), &ipx0);
>
> PROTECT_INDEX ipx1;.
> PROTECT_WITH_INDEX(x1 = allocVector(REALSXP, old_size), &ipx1);
>
> # fill in values in x0 and  x1up to new_size (random) < old_size
> ...
> REPROTECT(x0 = Rf_lengthgets(x0, new_size), ipx0);
> REPROTECT(x1 = Rf_lengthgets(x1, new_size), ipx1);
>
> SET_VECTOR_ELT(result, 0, x0);
> SET_VECTOR_ELT(result, 1, x1);
> ...
> UNPROTECT(2);   # or is this 4?
> return(result);
>
>
> There is also a mention in WRE of R_PreserveObject and R_ReleaseObject -
>
> looking for advice if this is needed, or which approach is better/more stable to replace SETLENGTH?   (I have many many instances that need to be updated, so trying to get some clarity here before updating and running code through valgrind or other sanitizers to catch any memory issues before submitting an update to CRAN.
>
> best,
> Merlise
>
>
>
>
>
>
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From tom@@@k@||ber@ @end|ng |rom gm@||@com  Wed Jan 15 09:58:11 2025
From: tom@@@k@||ber@ @end|ng |rom gm@||@com (Tomas Kalibera)
Date: Wed, 15 Jan 2025 09:58:11 +0100
Subject: [R-pkg-devel] Replacement for SETLENGTH
In-Reply-To: <CY8PR05MB100342EF92E6E169CA1067103C8182@CY8PR05MB10034.namprd05.prod.outlook.com>
References: <CY8PR05MB100342EF92E6E169CA1067103C8182@CY8PR05MB10034.namprd05.prod.outlook.com>
Message-ID: <0be66c5f-1fc1-448e-82b7-90ac17321af9@gmail.com>


On 1/15/25 05:26, Merlise Clyde, Ph.D. wrote:
> I am trying to determine the best way to eliminate the use of SETLENGTH to truncate over allocated vectors in my package BAS to eliminate the NOTES about non-API calls in anticipation of R 4.5.0.
>
>  From WRE:  "At times it can be useful to allocate a larger initial result vector and resize it to a shorter length if that is sufficient. The functions Rf_lengthgets and Rf_xlengthgets accomplish this; they are analogous to using length(x) <- n in R. Typically these functions return a freshly allocated object, but in some cases they may re-use the supplied object."
>
> it looks like using
>
>      x = Rf_lengthgets(x, newsize);
>      SET_VECTOR_ELT(result, 0, x);
>      
> before returning works to resize without a performance hit that incurs with a copy.  (will this always re-use the supplied object if newsize < old size?)
>
> There is no mention in section 5.9.2 about the need for re-protection of the object,  but it seems to be mentioned in some packages as well as a really old thread about SET_LENGTH that looks like a  non-API MACRO to lengthgets,
>
> indeed if I call gc() and then rerun my test I have had some non-reproducible aborts in R Studio on my M3 Mac (caught once in R -d lldb)

The important part for protection is that Rf_lengthgets _may_ return a 
freshly allocated object. This means that the object needs protection 
from garbage collection, implicit or explicit - and that is covered in 
section "Handling the effects of garbage collection".? There are? many 
functions in the? R API that return freshly allocated objects, so don't 
expect that documentation of every such function would give advice on 
how to protect, that is covered in that special section.

So, you are right, some protection is needed _if_ the return value of 
Rf_lengthgets may be exposed to gc().

>
> Do I need to do something more like
>
> PROTECT_INDEX ipx0;.
> PROTECT_WITH_INDEX(x0 = allocVector(REALSXP, old_size), &ipx0);
>
> PROTECT_INDEX ipx1;.
> PROTECT_WITH_INDEX(x1 = allocVector(REALSXP, old_size), &ipx1);
>
> # fill in values in x0 and  x1up to new_size (random) < old_size
> ...
> REPROTECT(x0 = Rf_lengthgets(x0, new_size), ipx0);
> REPROTECT(x1 = Rf_lengthgets(x1, new_size), ipx1);
>
> SET_VECTOR_ELT(result, 0, x0);
> SET_VECTOR_ELT(result, 1, x1);
> ...
> UNPROTECT(2);   # or is this 4?

You have protected two objects here, one was in x0 and one in x1 
(REPROTECT doesn't change the depth of the protection stack). Some 
people put that into a comment:

UNPROTECT(2); /* x1, x0 */

The code above is ok. In some cases, you can shuffle it around a bit or 
rely on implicit protection if you want to reduce the need for explicit 
protection. But perfomance-wise it doesn't matter given code that is 
allocating, etc, that takes much more time - it is more about readability.

For instance,

result = PROTECT(allocVector(...))
x0 = allocVector()
SET_VECTOR_ELT(result, 0, x0);
// now x0 is implicitly protected via result
...

x0 = Rf_lengthgets(..)
SET_VECTOR_ELT(result, 0, x0);
/// now the new value of x0 is implicitly protected via result (the old 
value may not be)

UNPROTECT(1)? // result
return result

> return(result);
>
>
> There is also a mention in WRE of R_PreserveObject and R_ReleaseObject -
>
> looking for advice if this is needed, or which approach is better/more stable to replace SETLENGTH?   (I have many many instances that need to be updated, so trying to get some clarity here before updating and running code through valgrind or other sanitizers to catch any memory issues before submitting an update to CRAN.

PreserveObject/ReleaseObject is good e.g. for global structures, 
probably not in this case. The difficulty there is making sure 
ReleaseObject() does execute in case of error, a non-local return. On 
the other hand, protection via PROTECT/UNPROTECT is automatically robust 
to non-local returns (automatic unprotection).

There is nothing specific about Rf_lengthgets wrt to protection here - 
the same rules apply to any other R API function that returns an SEXP.

For finding protection bugs in code, one can use an R build with barrier 
checking enabled and gctorture or rchk tool. Some bugs may lead to 
crashes or incorrect outputs even in normaln builds. Some bugs may be 
found by UBSAN. But none of this is a verification tool, one can only 
find some bugs in some cases, correctness remains the responsibility of 
the programmer.

Best
Tomas

>
> best,
> Merlise
>
>
>
>
>
>
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From c|yde @end|ng |rom duke@edu  Wed Jan 15 16:30:36 2025
From: c|yde @end|ng |rom duke@edu (Merlise Clyde, Ph.D.)
Date: Wed, 15 Jan 2025 15:30:36 +0000
Subject: [R-pkg-devel] Replacement for SETLENGTH
In-Reply-To: <CADNULg9fKRf3K6Q062D7X4rUJysO=9cWA1kFEjpSv3J-Oy0bYg@mail.gmail.com>
References: <CY8PR05MB100342EF92E6E169CA1067103C8182@CY8PR05MB10034.namprd05.prod.outlook.com>
 <CADNULg9fKRf3K6Q062D7X4rUJysO=9cWA1kFEjpSv3J-Oy0bYg@mail.gmail.com>
Message-ID: <CY8PR05MB10034614E651AB601A74968AFC8192@CY8PR05MB10034.namprd05.prod.outlook.com>

Thanks for the added explanation Iris and Tomas!

So looking at the code for xlengthgets, it does appear that I may take a memory hit for multiple large objects due to the second allocation before the old objects are possibly garbage collected.     There are about 12 such instances per function that are returned (I do use a counter for keeping track of the number of PROTECTED and to UNPROTECT for bookkeeping :-).   For memory limited machines, the alloc/copy was a problem for memory usage - and if I recall was one of the reasons in 2008 I switched to SETLENGTH, which doesn't seem to do an allocation ???  If there is going to be an absolute ban on SETLENGTH  in packages I'll probably need to address memory management differently for those cases.

I did see a note before the function def'n of xlengthgets:

/* (if it is vectorizable). We could probably be fairly */
/* clever with memory here if we wanted to. */

It would seem that memcpy would be more efficient for at least some of the types  (REALSPX, INTSPX) unless I am missing something - but any way to be more clever with VECSPX ?

best,
Merlise



Merlise Clyde (she/her/hers)
Professor of Statistical Science and Director of Graduate Studies
Duke University

________________________________________
From:?Iris Simmons <ikwsimmo at gmail.com>
Sent:?Wednesday, January 15, 2025 1:00 AM
To:?Merlise Clyde, Ph.D. <clyde at duke.edu>
Cc:?r-package-devel at r-project.org <r-package-devel at r-project.org>
Subject:?Re: [R-pkg-devel] Replacement for SETLENGTH
?
Hi Merlise!


Referring to here:

https://github.com/wch/r-source/blob/bb5a829466f77a3e1d03541747d149d65e900f2b/src/main/builtin.c#L834

It seems as though the object is only re-used if the new length is
equal to the old length.

If you use Rf_lengthgets, you will need to protect the return value.
The code you wrote that uses protect indexes looks correct, and the
reprotect is good because you no longer need the old object.

2 is the correct amount to unprotect. PROTECT and PROTECT_WITH_INDEX
(as far as I know) are the only functions that increase the size of
the protect stack, and so the only calls that need to be unprotected.
Typically, people define `int nprotect = 0;` at the start of their
functions, add `nprotect++;` after each PROTECT and PROTECT_WITH_INDEX
call, and add `UNPROTECT(nprotect);` immediately before each return or
function end. That makes it easier to keep track.

I typically use R_PreserveObject and R_ReleaseObject to protect
objects without a need to bind them somewhere in my package's
namespace. This would be that .onLoad() uses R_PreserveObject to
protect some objects, and .onUnload uses R_ReleaseObject to release
the protected objects. I probably would not use that for what you're
describing.


Regards,
??? Iris

On Tue, Jan 14, 2025 at 11:26?PM Merlise Clyde, Ph.D. <clyde at duke.edu> wrote:
>
> I am trying to determine the best way to eliminate the use of SETLENGTH to truncate over allocated vectors in my package BAS to eliminate the NOTES about non-API calls in anticipation of R 4.5.0.
>
> From WRE:? "At times it can be useful to allocate a larger initial result vector and resize it to a shorter length if that is sufficient. The functions Rf_lengthgets and Rf_xlengthgets accomplish this; they are analogous to using length(x) <- n in R. Typically these functions return a freshly allocated object, but in some cases they may re-use the supplied object."
>
> it looks like using
>
>???? x = Rf_lengthgets(x, newsize);
>???? SET_VECTOR_ELT(result, 0, x);
>
> before returning works to resize without a performance hit that incurs with a copy.? (will this always re-use the supplied object if newsize < old size?)
>
> There is no mention in section 5.9.2 about the need for re-protection of the object,? but it seems to be mentioned in some packages as well as a really old thread about SET_LENGTH that looks like a? non-API MACRO to lengthgets,
>
> indeed if I call gc() and then rerun my test I have had some non-reproducible aborts in R Studio on my M3 Mac (caught once in R -d lldb)
>
> Do I need to do something more like
>
> PROTECT_INDEX ipx0;.
> PROTECT_WITH_INDEX(x0 = allocVector(REALSXP, old_size), &ipx0);
>
> PROTECT_INDEX ipx1;.
> PROTECT_WITH_INDEX(x1 = allocVector(REALSXP, old_size), &ipx1);
>
> # fill in values in x0 and? x1up to new_size (random) < old_size
> ...
> REPROTECT(x0 = Rf_lengthgets(x0, new_size), ipx0);
> REPROTECT(x1 = Rf_lengthgets(x1, new_size), ipx1);
>
> SET_VECTOR_ELT(result, 0, x0);
> SET_VECTOR_ELT(result, 1, x1);
> ...
> UNPROTECT(2);?? # or is this 4?
> return(result);
>
>
> There is also a mention in WRE of R_PreserveObject and R_ReleaseObject -
>
> looking for advice if this is needed, or which approach is better/more stable to replace SETLENGTH??? (I have many many instances that need to be updated, so trying to get some clarity here before updating and running code through valgrind or other sanitizers to catch any memory issues before submitting an update to CRAN.
>
> best,
> Merlise
>
>
>
>
>
>
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://urldefense.com/v3/__https://stat.ethz.ch/mailman/listinfo/r-package-devel__;!!OToaGQ!ohDoxcAn5uIC25d42XhBz8Kd4YftOJDBoEW1NK9FOmgZpcmv0XIy5fQRm24-s_D8m9O_lR6jo6FcKiA$

From |kw@|mmo @end|ng |rom gm@||@com  Wed Jan 15 16:51:28 2025
From: |kw@|mmo @end|ng |rom gm@||@com (Iris Simmons)
Date: Wed, 15 Jan 2025 10:51:28 -0500
Subject: [R-pkg-devel] Replacement for SETLENGTH
In-Reply-To: <CY8PR05MB10034614E651AB601A74968AFC8192@CY8PR05MB10034.namprd05.prod.outlook.com>
References: <CY8PR05MB100342EF92E6E169CA1067103C8182@CY8PR05MB10034.namprd05.prod.outlook.com>
 <CADNULg9fKRf3K6Q062D7X4rUJysO=9cWA1kFEjpSv3J-Oy0bYg@mail.gmail.com>
 <CY8PR05MB10034614E651AB601A74968AFC8192@CY8PR05MB10034.namprd05.prod.outlook.com>
Message-ID: <CADNULg-ws6Atf6s-=TrHAHhXE=NDt+ij8+s9j5YUhV9KsA7Ggw@mail.gmail.com>

I don't think memcpy works well for VECSXP. The elements being overwritten
need to have their reference counts decreased and the new elements need to
have theirs increased.

Also, I don't entirely know how accurate everything I'm about to say is,
but I think you need to be using SET_TRUELENGTH and SET_GROWABLE_BIT along
with SETLENGTH. There's an example here:

https://github.com/wch/r-source/blob/744b5d34e1b8eb839e5d49d91ab21c1fe6800856/src/main/subassign.c#L257


The example uses SET_STDVEC_LENGTH which shouldn't be used, just replace it
with SETLENGTH.

So in your code, I'd replace:

SETLENGTH(modelspace, nUnique);

with

SET_GROWABLE_BIT(modelspace);
SET_TRUELENGTH(modelspace, nModels);
SETLENGTH(modelspace, nUnique);

On Wed, Jan 15, 2025, 10:30 Merlise Clyde, Ph.D. <clyde at duke.edu> wrote:

> Thanks for the added explanation Iris and Tomas!
>
> So looking at the code for xlengthgets, it does appear that I may take a
> memory hit for multiple large objects due to the second allocation before
> the old objects are possibly garbage collected.     There are about 12 such
> instances per function that are returned (I do use a counter for keeping
> track of the number of PROTECTED and to UNPROTECT for bookkeeping :-).
>  For memory limited machines, the alloc/copy was a problem for memory usage
> - and if I recall was one of the reasons in 2008 I switched to SETLENGTH,
> which doesn't seem to do an allocation ???  If there is going to be an
> absolute ban on SETLENGTH  in packages I'll probably need to address memory
> management differently for those cases.
>
> I did see a note before the function def'n of xlengthgets:
>
> /* (if it is vectorizable). We could probably be fairly */
> /* clever with memory here if we wanted to. */
>
> It would seem that memcpy would be more efficient for at least some of the
> types  (REALSPX, INTSPX) unless I am missing something - but any way to be
> more clever with VECSPX ?
>
> best,
> Merlise
>
>
>
> Merlise Clyde (she/her/hers)
> Professor of Statistical Science and Director of Graduate Studies
> Duke University
>
> ________________________________________
> From: Iris Simmons <ikwsimmo at gmail.com>
> Sent: Wednesday, January 15, 2025 1:00 AM
> To: Merlise Clyde, Ph.D. <clyde at duke.edu>
> Cc: r-package-devel at r-project.org <r-package-devel at r-project.org>
> Subject: Re: [R-pkg-devel] Replacement for SETLENGTH
>
> Hi Merlise!
>
>
> Referring to here:
>
>
> https://github.com/wch/r-source/blob/bb5a829466f77a3e1d03541747d149d65e900f2b/src/main/builtin.c#L834
>
> It seems as though the object is only re-used if the new length is
> equal to the old length.
>
> If you use Rf_lengthgets, you will need to protect the return value.
> The code you wrote that uses protect indexes looks correct, and the
> reprotect is good because you no longer need the old object.
>
> 2 is the correct amount to unprotect. PROTECT and PROTECT_WITH_INDEX
> (as far as I know) are the only functions that increase the size of
> the protect stack, and so the only calls that need to be unprotected.
> Typically, people define `int nprotect = 0;` at the start of their
> functions, add `nprotect++;` after each PROTECT and PROTECT_WITH_INDEX
> call, and add `UNPROTECT(nprotect);` immediately before each return or
> function end. That makes it easier to keep track.
>
> I typically use R_PreserveObject and R_ReleaseObject to protect
> objects without a need to bind them somewhere in my package's
> namespace. This would be that .onLoad() uses R_PreserveObject to
> protect some objects, and .onUnload uses R_ReleaseObject to release
> the protected objects. I probably would not use that for what you're
> describing.
>
>
> Regards,
>     Iris
>
> On Tue, Jan 14, 2025 at 11:26?PM Merlise Clyde, Ph.D. <clyde at duke.edu>
> wrote:
> >
> > I am trying to determine the best way to eliminate the use of SETLENGTH
> to truncate over allocated vectors in my package BAS to eliminate the NOTES
> about non-API calls in anticipation of R 4.5.0.
> >
> > From WRE:  "At times it can be useful to allocate a larger initial
> result vector and resize it to a shorter length if that is sufficient. The
> functions Rf_lengthgets and Rf_xlengthgets accomplish this; they are
> analogous to using length(x) <- n in R. Typically these functions return a
> freshly allocated object, but in some cases they may re-use the supplied
> object."
> >
> > it looks like using
> >
> >     x = Rf_lengthgets(x, newsize);
> >     SET_VECTOR_ELT(result, 0, x);
> >
> > before returning works to resize without a performance hit that incurs
> with a copy.  (will this always re-use the supplied object if newsize < old
> size?)
> >
> > There is no mention in section 5.9.2 about the need for re-protection of
> the object,  but it seems to be mentioned in some packages as well as a
> really old thread about SET_LENGTH that looks like a  non-API MACRO to
> lengthgets,
> >
> > indeed if I call gc() and then rerun my test I have had some
> non-reproducible aborts in R Studio on my M3 Mac (caught once in R -d lldb)
> >
> > Do I need to do something more like
> >
> > PROTECT_INDEX ipx0;.
> > PROTECT_WITH_INDEX(x0 = allocVector(REALSXP, old_size), &ipx0);
> >
> > PROTECT_INDEX ipx1;.
> > PROTECT_WITH_INDEX(x1 = allocVector(REALSXP, old_size), &ipx1);
> >
> > # fill in values in x0 and  x1up to new_size (random) < old_size
> > ...
> > REPROTECT(x0 = Rf_lengthgets(x0, new_size), ipx0);
> > REPROTECT(x1 = Rf_lengthgets(x1, new_size), ipx1);
> >
> > SET_VECTOR_ELT(result, 0, x0);
> > SET_VECTOR_ELT(result, 1, x1);
> > ...
> > UNPROTECT(2);   # or is this 4?
> > return(result);
> >
> >
> > There is also a mention in WRE of R_PreserveObject and R_ReleaseObject -
> >
> > looking for advice if this is needed, or which approach is better/more
> stable to replace SETLENGTH?   (I have many many instances that need to be
> updated, so trying to get some clarity here before updating and running
> code through valgrind or other sanitizers to catch any memory issues before
> submitting an update to CRAN.
> >
> > best,
> > Merlise
> >
> >
> >
> >
> >
> >
> >
> > ______________________________________________
> > R-package-devel at r-project.org mailing list
> >
> https://urldefense.com/v3/__https://stat.ethz.ch/mailman/listinfo/r-package-devel__;!!OToaGQ!ohDoxcAn5uIC25d42XhBz8Kd4YftOJDBoEW1NK9FOmgZpcmv0XIy5fQRm24-s_D8m9O_lR6jo6FcKiA$

	[[alternative HTML version deleted]]


From iuke-tier@ey m@iii@g oii uiow@@edu  Wed Jan 15 18:34:20 2025
From: iuke-tier@ey m@iii@g oii uiow@@edu (iuke-tier@ey m@iii@g oii uiow@@edu)
Date: Wed, 15 Jan 2025 11:34:20 -0600 (CST)
Subject: [R-pkg-devel] [External] Re:  Replacement for SETLENGTH
In-Reply-To: <CADNULg-ws6Atf6s-=TrHAHhXE=NDt+ij8+s9j5YUhV9KsA7Ggw@mail.gmail.com>
References: <CY8PR05MB100342EF92E6E169CA1067103C8182@CY8PR05MB10034.namprd05.prod.outlook.com>
 <CADNULg9fKRf3K6Q062D7X4rUJysO=9cWA1kFEjpSv3J-Oy0bYg@mail.gmail.com>
 <CY8PR05MB10034614E651AB601A74968AFC8192@CY8PR05MB10034.namprd05.prod.outlook.com>
 <CADNULg-ws6Atf6s-=TrHAHhXE=NDt+ij8+s9j5YUhV9KsA7Ggw@mail.gmail.com>
Message-ID: <a424ea59-f51e-a0c9-9887-799d66b50e4@uiowa.edu>

On Wed, 15 Jan 2025, Iris Simmons wrote:

> I don't think memcpy works well for VECSXP. The elements being overwritten
> need to have their reference counts decreased and the new elements need to
> have theirs increased.

You do not want to use memcpy or inanyother way try to write to the
locations in a VECSXP. It is not jus the reference counts but also the
integrity of the GC write barrier that you would be damaging.

>
> Also, I don't entirely know how accurate everything I'm about to say is,
> but I think you need to be using SET_TRUELENGTH and SET_GROWABLE_BIT along
> with SETLENGTH. There's an example here:
>
> https://github.com/wch/r-source/blob/744b5d34e1b8eb839e5d49d91ab21c1fe6800856/src/main/subassign.c#L257
>
>
> The example uses SET_STDVEC_LENGTH which shouldn't be used, just replace it
> with SETLENGTH.
>
> So in your code, I'd replace:
>
> SETLENGTH(modelspace, nUnique);
>
> with
>
> SET_GROWABLE_BIT(modelspace);
> SET_TRUELENGTH(modelspace, nModels);
> SETLENGTH(modelspace, nUnique);

These are not part of the API.

Support for growable vectors maybe added to the API in the future, but
probably with a more robust interface.

In any case, this mechanism is intended for growing, not shrinking,
vectors.

Initially over-allocating and returning a smaller result is a
reasonable strategy, but the right way to do it is to allocate a new
shorter result. xlengthgets is a convenient way to do this. Tholonger
vector will be subject to garbage collecion once there are no
remaining references to it.

Attempting to keep alive a longer allocation but pretending it is
shorter is mis-guided: it would keep alive a larger object than is
needed and so waste memory.

Best,

luke

> On Wed, Jan 15, 2025, 10:30 Merlise Clyde, Ph.D. <clyde at duke.edu> wrote:
>
>> Thanks for the added explanation Iris and Tomas!
>>
>> So looking at the code for xlengthgets, it does appear that I may take a
>> memory hit for multiple large objects due to the second allocation before
>> the old objects are possibly garbage collected.     There are about 12 such
>> instances per function that are returned (I do use a counter for keeping
>> track of the number of PROTECTED and to UNPROTECT for bookkeeping :-).
>>  For memory limited machines, the alloc/copy was a problem for memory usage
>> - and if I recall was one of the reasons in 2008 I switched to SETLENGTH,
>> which doesn't seem to do an allocation ???  If there is going to be an
>> absolute ban on SETLENGTH  in packages I'll probably need to address memory
>> management differently for those cases.
>>
>> I did see a note before the function def'n of xlengthgets:
>>
>> /* (if it is vectorizable). We could probably be fairly */
>> /* clever with memory here if we wanted to. */
>>
>> It would seem that memcpy would be more efficient for at least some of the
>> types  (REALSPX, INTSPX) unless I am missing something - but any way to be
>> more clever with VECSPX ?
>>
>> best,
>> Merlise
>>
>>
>>
>> Merlise Clyde (she/her/hers)
>> Professor of Statistical Science and Director of Graduate Studies
>> Duke University
>>
>> ________________________________________
>> From: Iris Simmons <ikwsimmo at gmail.com>
>> Sent: Wednesday, January 15, 2025 1:00 AM
>> To: Merlise Clyde, Ph.D. <clyde at duke.edu>
>> Cc: r-package-devel at r-project.org <r-package-devel at r-project.org>
>> Subject: Re: [R-pkg-devel] Replacement for SETLENGTH
>>
>> Hi Merlise!
>>
>>
>> Referring to here:
>>
>>
>> https://github.com/wch/r-source/blob/bb5a829466f77a3e1d03541747d149d65e900f2b/src/main/builtin.c#L834
>>
>> It seems as though the object is only re-used if the new length is
>> equal to the old length.
>>
>> If you use Rf_lengthgets, you will need to protect the return value.
>> The code you wrote that uses protect indexes looks correct, and the
>> reprotect is good because you no longer need the old object.
>>
>> 2 is the correct amount to unprotect. PROTECT and PROTECT_WITH_INDEX
>> (as far as I know) are the only functions that increase the size of
>> the protect stack, and so the only calls that need to be unprotected.
>> Typically, people define `int nprotect = 0;` at the start of their
>> functions, add `nprotect++;` after each PROTECT and PROTECT_WITH_INDEX
>> call, and add `UNPROTECT(nprotect);` immediately before each return or
>> function end. That makes it easier to keep track.
>>
>> I typically use R_PreserveObject and R_ReleaseObject to protect
>> objects without a need to bind them somewhere in my package's
>> namespace. This would be that .onLoad() uses R_PreserveObject to
>> protect some objects, and .onUnload uses R_ReleaseObject to release
>> the protected objects. I probably would not use that for what you're
>> describing.
>>
>>
>> Regards,
>>     Iris
>>
>> On Tue, Jan 14, 2025 at 11:26?PM Merlise Clyde, Ph.D. <clyde at duke.edu>
>> wrote:
>>>
>>> I am trying to determine the best way to eliminate the use of SETLENGTH
>> to truncate over allocated vectors in my package BAS to eliminate the NOTES
>> about non-API calls in anticipation of R 4.5.0.
>>>
>>> From WRE:  "At times it can be useful to allocate a larger initial
>> result vector and resize it to a shorter length if that is sufficient. The
>> functions Rf_lengthgets and Rf_xlengthgets accomplish this; they are
>> analogous to using length(x) <- n in R. Typically these functions return a
>> freshly allocated object, but in some cases they may re-use the supplied
>> object."
>>>
>>> it looks like using
>>>
>>>     x = Rf_lengthgets(x, newsize);
>>>     SET_VECTOR_ELT(result, 0, x);
>>>
>>> before returning works to resize without a performance hit that incurs
>> with a copy.  (will this always re-use the supplied object if newsize < old
>> size?)
>>>
>>> There is no mention in section 5.9.2 about the need for re-protection of
>> the object,  but it seems to be mentioned in some packages as well as a
>> really old thread about SET_LENGTH that looks like a  non-API MACRO to
>> lengthgets,
>>>
>>> indeed if I call gc() and then rerun my test I have had some
>> non-reproducible aborts in R Studio on my M3 Mac (caught once in R -d lldb)
>>>
>>> Do I need to do something more like
>>>
>>> PROTECT_INDEX ipx0;.
>>> PROTECT_WITH_INDEX(x0 = allocVector(REALSXP, old_size), &ipx0);
>>>
>>> PROTECT_INDEX ipx1;.
>>> PROTECT_WITH_INDEX(x1 = allocVector(REALSXP, old_size), &ipx1);
>>>
>>> # fill in values in x0 and  x1up to new_size (random) < old_size
>>> ...
>>> REPROTECT(x0 = Rf_lengthgets(x0, new_size), ipx0);
>>> REPROTECT(x1 = Rf_lengthgets(x1, new_size), ipx1);
>>>
>>> SET_VECTOR_ELT(result, 0, x0);
>>> SET_VECTOR_ELT(result, 1, x1);
>>> ...
>>> UNPROTECT(2);   # or is this 4?
>>> return(result);
>>>
>>>
>>> There is also a mention in WRE of R_PreserveObject and R_ReleaseObject -
>>>
>>> looking for advice if this is needed, or which approach is better/more
>> stable to replace SETLENGTH?   (I have many many instances that need to be
>> updated, so trying to get some clarity here before updating and running
>> code through valgrind or other sanitizers to catch any memory issues before
>> submitting an update to CRAN.
>>>
>>> best,
>>> Merlise
>>>
>>>
>>>
>>>
>>>
>>>
>>>
>>> ______________________________________________
>>> R-package-devel at r-project.org mailing list
>>>
>> https://urldefense.com/v3/__https://stat.ethz.ch/mailman/listinfo/r-package-devel__;!!OToaGQ!ohDoxcAn5uIC25d42XhBz8Kd4YftOJDBoEW1NK9FOmgZpcmv0XIy5fQRm24-s_D8m9O_lR6jo6FcKiA$
>
> 	[[alternative HTML version deleted]]
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>

-- 
Luke Tierney
Ralph E. Wareham Professor of Mathematical Sciences
University of Iowa                  Phone:             319-335-3386
Department of Statistics and        Fax:               319-335-3017
    Actuarial Science
241 Schaeffer Hall                  email:   luke-tierney at uiowa.edu
Iowa City, IA 52242                 WWW:  http://www.stat.uiowa.edu/

From |kry|ov @end|ng |rom d|@root@org  Wed Jan 15 21:13:00 2025
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Wed, 15 Jan 2025 23:13:00 +0300
Subject: [R-pkg-devel] Replacement for SETLENGTH
In-Reply-To: <CY8PR05MB10034614E651AB601A74968AFC8192@CY8PR05MB10034.namprd05.prod.outlook.com>
References: <CY8PR05MB100342EF92E6E169CA1067103C8182@CY8PR05MB10034.namprd05.prod.outlook.com>
 <CADNULg9fKRf3K6Q062D7X4rUJysO=9cWA1kFEjpSv3J-Oy0bYg@mail.gmail.com>
 <CY8PR05MB10034614E651AB601A74968AFC8192@CY8PR05MB10034.namprd05.prod.outlook.com>
Message-ID: <20250115231300.2b5ba55b@Tarkus>

On Wed, 15 Jan 2025 15:30:36 +0000
"Merlise Clyde, Ph.D." <clyde at duke.edu> wrote:

> For memory limited machines, the alloc/copy was a problem for memory
> usage - and if I recall was one of the reasons in 2008 I switched to
> SETLENGTH, which doesn't seem to do an allocation ???  If there is
> going to be an absolute ban on SETLENGTH  in packages I'll probably
> need to address memory management differently for those cases.

If you need to adjust the xlength() of your vectors without causing
reallocations, I'm afraid the only API-compliant way to do that for now
is ALTREP [1]. It's a lot of typing because the code will need to
register an ALTREP class for every vector type that needs to be
shrinkable. Moreover, since some of those vectors are of type VECSXP
and "altlist" classes only appeared in R-4.3.0, you will probably
prefer to leave the old implementation based on SETLENGTH() behind #if
R_VERSION < R_Version(4, 3, 0) to avoid requiring your users to upgrade
from R >= 3.0.

A work-in-progress implementation of shrinkable vectors for data.table
can be found at [2]. The real problem is not implementing the same
simple API using SETLENGTH() and ALTREP, but in refactoring the rest of
the code not to violate its assumptions. (Total control over the
allocation of your shrinkable vectors is required: nothing good will
happen if the code tries to call ALTREP methods on an object that is
not of the exact ALTREP class it needs to be.)

My own notes on the use of ALTREP can be found at [3]. I will do my
best to keep them correct, but patches are always welcome.

And now a question:

Would R benefit from a patch to make xlengthgets() more like
EnlargeVector() [4] and sometimes return vectors with GROWABLE_BIT set?
(EnlargeVector() is currently only reachable from the `[<-` operation.)
It wouldn't be a deviation from the currently documented behaviour if
the function tested for NO_REFERENCES() and then used SETLENGTH() when,
say, reducing the length of a vector to 1/2 of its length or more.

-- 
Best regards,
Ivan

[1]
https://rdatatable-community.github.io/The-Raft/posts/2025-01-13-non-api-use/index.html#growable-vectors

[2]
https://github.com/Rdatatable/data.table/blob/growable_refactor/src/growable.c
Everyone is welcome to use this under the terms of GPL-2 or a later
version, or MPL-2, at their choice.

[3]
https://aitap.codeberg.page/R-api/#ALTREP

[4]
https://github.com/r-devel/r-svn/blob/59df414b844eea27c09b352ad30fd82e66764d2d/src/main/subassign.c#L256-L260


From c|yde @end|ng |rom duke@edu  Wed Jan 15 21:53:19 2025
From: c|yde @end|ng |rom duke@edu (Merlise Clyde, Ph.D.)
Date: Wed, 15 Jan 2025 20:53:19 +0000
Subject: [R-pkg-devel] [External] Re:  Replacement for SETLENGTH
In-Reply-To: <a424ea59-f51e-a0c9-9887-799d66b50e4@uiowa.edu>
References: <CY8PR05MB100342EF92E6E169CA1067103C8182@CY8PR05MB10034.namprd05.prod.outlook.com>
 <CADNULg9fKRf3K6Q062D7X4rUJysO=9cWA1kFEjpSv3J-Oy0bYg@mail.gmail.com>
 <CY8PR05MB10034614E651AB601A74968AFC8192@CY8PR05MB10034.namprd05.prod.outlook.com>
 <CADNULg-ws6Atf6s-=TrHAHhXE=NDt+ij8+s9j5YUhV9KsA7Ggw@mail.gmail.com>
 <a424ea59-f51e-a0c9-9887-799d66b50e4@uiowa.edu>
Message-ID: <CY8PR05MB100349ABE1DB2CE78F0D79F06C8192@CY8PR05MB10034.namprd05.prod.outlook.com>


Thanks Luke !   I had seen the usage and discussion of growable vectors, as well as using SET_TRUELENGTH with SETLENGTH and didn't necessarily want to get even more out of API compliance :-). but if that looks like it will allowed (subject to perhaps changes) that seems like the better way forward to handle the different SEXPs.    And switching to smaller vectors and enlarging would be much more efficient in terms of memory.    I'll need to play around with how much to expand by as the enlargement would need to be in the loop with a final resizing before returning.

So if I understand the suggestion the use of xlengthgets basically handles the body of the code in EnlargeVector function  for allocation and copying (but now smaller vectors) with then the extra step to SETLENGTH and SET_TRUELENGTH
If done within a loop over MCMC iterations, then I would need to use SET_GROWABLE_BIT before the loop or when I encounter the need to enlarge.   (so basically a local implementation of EnlargeVector)

For my non-VECSXP objects (REALSXP, INTSXP)  it might be more efficient to use Realloc on a working array within loops and only allocate and assign after determining the final length (nUnique), and freeing the memory myself...  That way I avoid SETLENGTH altogether for those types.

best,
Merlise



Merlise Clyde (she/her/hers)
Professor of Statistical Science and Director of Graduate Studies
Duke University


________________________________________
From:?luke-tierney at uiowa.edu <luke-tierney at uiowa.edu>
Sent:?Wednesday, January 15, 2025 12:34 PM
To:?Iris Simmons <ikwsimmo at gmail.com>
Cc:?Merlise Clyde, Ph.D. <clyde at duke.edu>; List r-package-devel <r-package-devel at r-project.org>
Subject:?Re: [External] Re: [R-pkg-devel] Replacement for SETLENGTH
?
On Wed, 15 Jan 2025, Iris Simmons wrote:

> I don't think memcpy works well for VECSXP. The elements being overwritten
> need to have their reference counts decreased and the new elements need to
> have theirs increased.

You do not want to use memcpy or inanyother way try to write to the
locations in a VECSXP. It is not jus the reference counts but also the
integrity of the GC write barrier that you would be damaging.

>
> Also, I don't entirely know how accurate everything I'm about to say is,
> but I think you need to be using SET_TRUELENGTH and SET_GROWABLE_BIT along
> with SETLENGTH. There's an example here:
>
> https://urldefense.com/v3/__https://github.com/wch/r-source/blob/744b5d34e1b8eb839e5d49d91ab21c1fe6800856/src/main/subassign.c*L257__;Iw!!OToaGQ!uACtQIEun1eC8hwn-FzFogXQoPl1wETg9EUSV1NzAif9u15KlRTctzEq1RSA5rcbeVGv0n3geb8UexFngaonYos$
>
>
> The example uses SET_STDVEC_LENGTH which shouldn't be used, just replace it
> with SETLENGTH.
>
> So in your code, I'd replace:
>
> SETLENGTH(modelspace, nUnique);
>
> with
>
> SET_GROWABLE_BIT(modelspace);
> SET_TRUELENGTH(modelspace, nModels);
> SETLENGTH(modelspace, nUnique);

These are not part of the API.

Support for growable vectors maybe added to the API in the future, but
probably with a more robust interface.

In any case, this mechanism is intended for growing, not shrinking,
vectors.

Initially over-allocating and returning a smaller result is a
reasonable strategy, but the right way to do it is to allocate a new
shorter result. xlengthgets is a convenient way to do this. Tholonger
vector will be subject to garbage collecion once there are no
remaining references to it.

Attempting to keep alive a longer allocation but pretending it is
shorter is mis-guided: it would keep alive a larger object than is
needed and so waste memory.

Best,

luke

> On Wed, Jan 15, 2025, 10:30 Merlise Clyde, Ph.D. <clyde at duke.edu> wrote:
>
>> Thanks for the added explanation Iris and Tomas!
>>
>> So looking at the code for xlengthgets, it does appear that I may take a
>> memory hit for multiple large objects due to the second allocation before
>> the old objects are possibly garbage collected.???? There are about 12 such
>> instances per function that are returned (I do use a counter for keeping
>> track of the number of PROTECTED and to UNPROTECT for bookkeeping :-).
>>? For memory limited machines, the alloc/copy was a problem for memory usage
>> - and if I recall was one of the reasons in 2008 I switched to SETLENGTH,
>> which doesn't seem to do an allocation ???? If there is going to be an
>> absolute ban on SETLENGTH? in packages I'll probably need to address memory
>> management differently for those cases.
>>
>> I did see a note before the function def'n of xlengthgets:
>>
>> /* (if it is vectorizable). We could probably be fairly */
>> /* clever with memory here if we wanted to. */
>>
>> It would seem that memcpy would be more efficient for at least some of the
>> types? (REALSPX, INTSPX) unless I am missing something - but any way to be
>> more clever with VECSPX ?
>>
>> best,
>> Merlise
>>
>>
>>
>> Merlise Clyde (she/her/hers)
>> Professor of Statistical Science and Director of Graduate Studies
>> Duke University
>>
>> ________________________________________
>> From: Iris Simmons <ikwsimmo at gmail.com>
>> Sent: Wednesday, January 15, 2025 1:00 AM
>> To: Merlise Clyde, Ph.D. <clyde at duke.edu>
>> Cc: r-package-devel at r-project.org <r-package-devel at r-project.org>
>> Subject: Re: [R-pkg-devel] Replacement for SETLENGTH
>>
>> Hi Merlise!
>>
>>
>> Referring to here:
>>
>>
>> https://urldefense.com/v3/__https://github.com/wch/r-source/blob/bb5a829466f77a3e1d03541747d149d65e900f2b/src/main/builtin.c*L834__;Iw!!OToaGQ!uACtQIEun1eC8hwn-FzFogXQoPl1wETg9EUSV1NzAif9u15KlRTctzEq1RSA5rcbeVGv0n3geb8UexFnr_0lCLM$
>>
>> It seems as though the object is only re-used if the new length is
>> equal to the old length.
>>
>> If you use Rf_lengthgets, you will need to protect the return value.
>> The code you wrote that uses protect indexes looks correct, and the
>> reprotect is good because you no longer need the old object.
>>
>> 2 is the correct amount to unprotect. PROTECT and PROTECT_WITH_INDEX
>> (as far as I know) are the only functions that increase the size of
>> the protect stack, and so the only calls that need to be unprotected.
>> Typically, people define `int nprotect = 0;` at the start of their
>> functions, add `nprotect++;` after each PROTECT and PROTECT_WITH_INDEX
>> call, and add `UNPROTECT(nprotect);` immediately before each return or
>> function end. That makes it easier to keep track.
>>
>> I typically use R_PreserveObject and R_ReleaseObject to protect
>> objects without a need to bind them somewhere in my package's
>> namespace. This would be that .onLoad() uses R_PreserveObject to
>> protect some objects, and .onUnload uses R_ReleaseObject to release
>> the protected objects. I probably would not use that for what you're
>> describing.
>>
>>
>> Regards,
>>???? Iris
>>
>> On Tue, Jan 14, 2025 at 11:26?PM Merlise Clyde, Ph.D. <clyde at duke.edu>
>> wrote:
>>>
>>> I am trying to determine the best way to eliminate the use of SETLENGTH
>> to truncate over allocated vectors in my package BAS to eliminate the NOTES
>> about non-API calls in anticipation of R 4.5.0.
>>>
>>> From WRE:? "At times it can be useful to allocate a larger initial
>> result vector and resize it to a shorter length if that is sufficient. The
>> functions Rf_lengthgets and Rf_xlengthgets accomplish this; they are
>> analogous to using length(x) <- n in R. Typically these functions return a
>> freshly allocated object, but in some cases they may re-use the supplied
>> object."
>>>
>>> it looks like using
>>>
>>>???? x = Rf_lengthgets(x, newsize);
>>>???? SET_VECTOR_ELT(result, 0, x);
>>>
>>> before returning works to resize without a performance hit that incurs
>> with a copy.? (will this always re-use the supplied object if newsize < old
>> size?)
>>>
>>> There is no mention in section 5.9.2 about the need for re-protection of
>> the object,? but it seems to be mentioned in some packages as well as a
>> really old thread about SET_LENGTH that looks like a? non-API MACRO to
>> lengthgets,
>>>
>>> indeed if I call gc() and then rerun my test I have had some
>> non-reproducible aborts in R Studio on my M3 Mac (caught once in R -d lldb)
>>>
>>> Do I need to do something more like
>>>
>>> PROTECT_INDEX ipx0;.
>>> PROTECT_WITH_INDEX(x0 = allocVector(REALSXP, old_size), &ipx0);
>>>
>>> PROTECT_INDEX ipx1;.
>>> PROTECT_WITH_INDEX(x1 = allocVector(REALSXP, old_size), &ipx1);
>>>
>>> # fill in values in x0 and? x1up to new_size (random) < old_size
>>> ...
>>> REPROTECT(x0 = Rf_lengthgets(x0, new_size), ipx0);
>>> REPROTECT(x1 = Rf_lengthgets(x1, new_size), ipx1);
>>>
>>> SET_VECTOR_ELT(result, 0, x0);
>>> SET_VECTOR_ELT(result, 1, x1);
>>> ...
>>> UNPROTECT(2);?? # or is this 4?
>>> return(result);
>>>
>>>
>>> There is also a mention in WRE of R_PreserveObject and R_ReleaseObject -
>>>
>>> looking for advice if this is needed, or which approach is better/more
>> stable to replace SETLENGTH??? (I have many many instances that need to be
>> updated, so trying to get some clarity here before updating and running
>> code through valgrind or other sanitizers to catch any memory issues before
>> submitting an update to CRAN.
>>>
>>> best,
>>> Merlise
>>>
>>>
>>>
>>>
>>>
>>>
>>>
>>> ______________________________________________
>>> R-package-devel at r-project.org mailing list
>>>
>> https://urldefense.com/v3/__https://stat.ethz.ch/mailman/listinfo/r-package-devel__;!!OToaGQ!ohDoxcAn5uIC25d42XhBz8Kd4YftOJDBoEW1NK9FOmgZpcmv0XIy5fQRm24-s_D8m9O_lR6jo6FcKiA$
>
>??????? [[alternative HTML version deleted]]
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://urldefense.com/v3/__https://stat.ethz.ch/mailman/listinfo/r-package-devel__;!!OToaGQ!uACtQIEun1eC8hwn-FzFogXQoPl1wETg9EUSV1NzAif9u15KlRTctzEq1RSA5rcbeVGv0n3geb8UexFnYd-1ZB4$
>

--
Luke Tierney
Ralph E. Wareham Professor of Mathematical Sciences
University of Iowa????????????????? Phone:???????????? 319-335-3386
Department of Statistics and??????? Fax:?????????????? 319-335-3017
??? Actuarial Science
241 Schaeffer Hall????????????????? email:?? luke-tierney at uiowa.edu
Iowa City, IA 52242???????????????? WWW:? https://urldefense.com/v3/__http://www.stat.uiowa.edu/__;!!OToaGQ!uACtQIEun1eC8hwn-FzFogXQoPl1wETg9EUSV1NzAif9u15KlRTctzEq1RSA5rcbeVGv0n3geb8UexFnFDCXgK0$

From joh@nnp||tz|nger @end|ng |rom goog|em@||@com  Wed Jan 15 22:13:36 2025
From: joh@nnp||tz|nger @end|ng |rom goog|em@||@com (Johann Pfitzinger)
Date: Wed, 15 Jan 2025 22:13:36 +0100
Subject: [R-pkg-devel] Help with clang-san warnings for package "tidyfit"
In-Reply-To: <01db66c4$Blat.v3.2.22$368863fe$19b4445fe@mail.statistik.tu-dortmund.de>
References: <01db66c4$Blat.v3.2.22$368863fe$19b4445fe@mail.statistik.tu-dortmund.de>
Message-ID: <aa1193b5-7921-42d8-83a7-bab58f3f7903@gmail.com>

Dear community,

my R package "tidyfit" is failing CRAN submission checks with the 
following warning (see email below for complete results):

Flavor: r-devel-linux-x86_64-debian-special-clang-san
Check: Post-processing issues found for clang-san, Result: WARNING
   File: tidyfit-Ex.Rout
   cleancall.c:110:46: runtime error: call to function cb_progress_done through pointer to incorrect function type 'void (*)(void *)'
   
   File: tests/testthat.Rout
   cleancall.c:110:46: runtime error: call to function cb_progress_done through pointer to incorrect function type 'void (*)(void *)'
   
   File: build_vignettes.log
   cleancall.c:110:46: runtime error: call to function cb_progress_done through pointer to incorrect function type 'void (*)(void *)'
   cleancall.c:110:46: runtime error: call to function cb_progress_done through pointer to incorrect function type 'void (*)(void *)'
   cleancall.c:110:46: runtime error: call to function cb_progress_done through pointer to incorrect function type 'void (*)(void *)'
   cleancall.c:110:46: runtime error: call to function cb_progress_done through pointer to incorrect function type 'void (*)(void *)'
   cleancall.c:110:46: runtime error: call to function cb_progress_done through pointer to incorrect function type 'void (*)(void *)'
   cleancall.c:110:46: runtime error: call to function cb_progress_done through pointer to incorrect function type 'void (*)(void *)'

I have, so far, failed to reproduce this or to find any useful 
information on how to fix it. My best guess based on the output.txt is 
that it originates in "purrr" (which I depend on).

I would really like to get the package back on CRAN as soon as possible. 
Any help is greatly appreciated!

Best regards,
Johann Pfitzinger

-------- Forwarded Message --------
Subject: 	[CRAN-pretest-archived] CRAN Submission tidyfit 0.7.3
Date: 	Tue, 14 Jan 2025 21:38:05 +0100
From: 	ligges at statistik.tu-dortmund.de
Reply-To: 	CRAN-submissions at R-project.org
To: 	johann.pfitzinger at gmail.com
CC: 	CRAN-submissions at R-project.org



Dear maintainer,
package tidyfit_0.7.3.tar.gz does not pass the incoming checks 
automatically, please see the following pre-tests (additional issue checks):
Windows: 
<https://win-builder.r-project.org/incoming_pretest/tidyfit_0.7.3_20250114_204852/Windows/00check.log>
Status: 1 NOTE
Debian: 
<https://win-builder.r-project.org/incoming_pretest/tidyfit_0.7.3_20250114_204852/Debian/00check.log>
Status: 1 NOTE
Additional issues checked: 
<https://win-builder.r-project.org/incoming_pretest/tidyfit_0.7.3_20250114_204852/specialChecks/>
clang-san: Status: WARNING
Last released version's CRAN status: OK: 13
See: 
<https://cran-archive.r-project.org/web/checks/2025/2025-01-14_check_results_tidyfit.html>

Last released version's additional issues:
clang-ASAN <https://www.stats.ox.ac.uk/pub/bdr/memtests/clang-ASAN/tidyfit>
gcc-ASAN <https://www.stats.ox.ac.uk/pub/bdr/memtests/gcc-ASAN/tidyfit>
Please fix all problems and resubmit a fixed version via the webform.
If you are not sure how to fix the problems shown, please ask for help 
on the R-package-devel mailing list:
<https://stat.ethz.ch/mailman/listinfo/r-package-devel>
If you are fairly certain the rejection is a false positive, please 
reply-all to this message and explain.
More details are given in the directory:
<https://win-builder.r-project.org/incoming_pretest/tidyfit_0.7.3_20250114_204852/>
The files will be removed after roughly 7 days.
No strong reverse dependencies to be checked.
Best regards,
CRAN teams' auto-check service

-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: Attached Message Part
URL: <https://stat.ethz.ch/pipermail/r-package-devel/attachments/20250115/9f28132e/attachment.ksh>

From |kry|ov @end|ng |rom d|@root@org  Thu Jan 16 21:30:48 2025
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Thu, 16 Jan 2025 23:30:48 +0300
Subject: [R-pkg-devel] 
 Help with clang-san warnings for package "tidyfit"
In-Reply-To: <aa1193b5-7921-42d8-83a7-bab58f3f7903@gmail.com>
References: <01db66c4$Blat.v3.2.22$368863fe$19b4445fe@mail.statistik.tu-dortmund.de>
 <aa1193b5-7921-42d8-83a7-bab58f3f7903@gmail.com>
Message-ID: <20250116233048.030ef17e@Tarkus>

? Wed, 15 Jan 2025 22:13:36 +0100
Johann Pfitzinger <johannpfitzinger at googlemail.com> ?????:

> I have, so far, failed to reproduce this or to find any useful 
> information on how to fix it. My best guess based on the output.txt
> is that it originates in "purrr" (which I depend on).

This is, indeed, a purrr bug:
https://github.com/tidyverse/purrr/issues/1157

Since the bug is very minor (R's own .C() and .Fortran() currently do
similar things), a fix for purrr has already been suggested, and
another package with the same problem (valr) has been recently
approved, you have a good chance of your package too being approved if
you reply-all and explain the situation.

-- 
Best regards,
Ivan


From iuke-tier@ey m@iii@g oii uiow@@edu  Thu Jan 16 21:51:54 2025
From: iuke-tier@ey m@iii@g oii uiow@@edu (iuke-tier@ey m@iii@g oii uiow@@edu)
Date: Thu, 16 Jan 2025 14:51:54 -0600 (CST)
Subject: [R-pkg-devel] [External] Re:  Replacement for SETLENGTH
In-Reply-To: <CY8PR05MB100349ABE1DB2CE78F0D79F06C8192@CY8PR05MB10034.namprd05.prod.outlook.com>
References: <CY8PR05MB100342EF92E6E169CA1067103C8182@CY8PR05MB10034.namprd05.prod.outlook.com>
 <CADNULg9fKRf3K6Q062D7X4rUJysO=9cWA1kFEjpSv3J-Oy0bYg@mail.gmail.com>
 <CY8PR05MB10034614E651AB601A74968AFC8192@CY8PR05MB10034.namprd05.prod.outlook.com>
 <CADNULg-ws6Atf6s-=TrHAHhXE=NDt+ij8+s9j5YUhV9KsA7Ggw@mail.gmail.com>
 <a424ea59-f51e-a0c9-9887-799d66b50e4@uiowa.edu>
 <CY8PR05MB100349ABE1DB2CE78F0D79F06C8192@CY8PR05MB10034.namprd05.prod.outlook.com>
Message-ID: <b9a35c69-2e58-f7f0-bda9-13e8f4e21b1@uiowa.edu>

You may be over-complicating this. Taking mcmc_new in src/lm_lcmc.c
from https://github.com/merliseclyde/BAS, to minimize code changes I
would arrange the memory management along these lines:

SEXP mcmc_new(...)
{
     /* ... */

     /* create and protect ANS */
     SEXP ANS = PROTECT(allocVector(VECSXP, 16));

     /* create the work vectors; placing them in ANS protects them */
     SEXP modelspace = allocVector(VECSXP, nModels);
     SET_VECTOR_ELT(ANS, 1, modelspace);
     SEXP logmarg = allocVector(REALSXP, nModels);
     SET_VECTOR_ELT(ANS, 2, logmarg);
     SEXP modelprobs = allocVector(REALSXP, nModels);
     SET_VECTOR_ELT(ANS, 3, modelprobs);
     /* etc */

     /* do your computations */

     if (nUnique < nModels) {
 	/* new values are protected via ANS;
 	   old ones are immediately available for GC */
 	SET_VECTOR_ELT(ANS, 1, xlengthgets(modelspace, nUnique));
 	SET_VECTOR_ELT(ANS, 2, xlengthgets(logmarg, nUnique));
 	SET_VECTOR_ELT(ANS, 3, xlengthgets(modelprobs, nUnique));
 	/* etc */
     }

     /* ... */
     UNPROTECT(1); /* ANS */
     return ANS;
}

Best,

luke

On Wed, 15 Jan 2025, Merlise Clyde, Ph.D. wrote:

>
> Thanks Luke !   I had seen the usage and discussion of growable vectors, as well as using SET_TRUELENGTH with SETLENGTH and didn't necessarily want to get even more out of API compliance :-). but if that looks like it will allowed (subject to perhaps changes) that seems like the better way forward to handle the different SEXPs.    And switching to smaller vectors and enlarging would be much more efficient in terms of memory.    I'll need to play around with how much to expand by as the enlargement would need to be in the loop with a final resizing before returning.
>
> So if I understand the suggestion the use of xlengthgets basically handles the body of the code in EnlargeVector function  for allocation and copying (but now smaller vectors) with then the extra step to SETLENGTH and SET_TRUELENGTH
> If done within a loop over MCMC iterations, then I would need to use SET_GROWABLE_BIT before the loop or when I encounter the need to enlarge.   (so basically a local implementation of EnlargeVector)
>
> For my non-VECSXP objects (REALSXP, INTSXP)  it might be more efficient to use Realloc on a working array within loops and only allocate and assign after determining the final length (nUnique), and freeing the memory myself...  That way I avoid SETLENGTH altogether for those types.
>
> best,
> Merlise
>
>
>
> Merlise Clyde (she/her/hers)
> Professor of Statistical Science and Director of Graduate Studies
> Duke University
>
>
> ________________________________________
> From:?luke-tierney at uiowa.edu <luke-tierney at uiowa.edu>
> Sent:?Wednesday, January 15, 2025 12:34 PM
> To:?Iris Simmons <ikwsimmo at gmail.com>
> Cc:?Merlise Clyde, Ph.D. <clyde at duke.edu>; List r-package-devel <r-package-devel at r-project.org>
> Subject:?Re: [External] Re: [R-pkg-devel] Replacement for SETLENGTH
> ?
> On Wed, 15 Jan 2025, Iris Simmons wrote:
>
>> I don't think memcpy works well for VECSXP. The elements being overwritten
>> need to have their reference counts decreased and the new elements need to
>> have theirs increased.
>
> You do not want to use memcpy or inanyother way try to write to the
> locations in a VECSXP. It is not jus the reference counts but also the
> integrity of the GC write barrier that you would be damaging.
>
>>
>> Also, I don't entirely know how accurate everything I'm about to say is,
>> but I think you need to be using SET_TRUELENGTH and SET_GROWABLE_BIT along
>> with SETLENGTH. There's an example here:
>>
>> https://urldefense.com/v3/__https://github.com/wch/r-source/blob/744b5d34e1b8eb839e5d49d91ab21c1fe6800856/src/main/subassign.c*L257__;Iw!!OToaGQ!uACtQIEun1eC8hwn-FzFogXQoPl1wETg9EUSV1NzAif9u15KlRTctzEq1RSA5rcbeVGv0n3geb8UexFngaonYos$
>>
>>
>> The example uses SET_STDVEC_LENGTH which shouldn't be used, just replace it
>> with SETLENGTH.
>>
>> So in your code, I'd replace:
>>
>> SETLENGTH(modelspace, nUnique);
>>
>> with
>>
>> SET_GROWABLE_BIT(modelspace);
>> SET_TRUELENGTH(modelspace, nModels);
>> SETLENGTH(modelspace, nUnique);
>
> These are not part of the API.
>
> Support for growable vectors maybe added to the API in the future, but
> probably with a more robust interface.
>
> In any case, this mechanism is intended for growing, not shrinking,
> vectors.
>
> Initially over-allocating and returning a smaller result is a
> reasonable strategy, but the right way to do it is to allocate a new
> shorter result. xlengthgets is a convenient way to do this. Tholonger
> vector will be subject to garbage collecion once there are no
> remaining references to it.
>
> Attempting to keep alive a longer allocation but pretending it is
> shorter is mis-guided: it would keep alive a larger object than is
> needed and so waste memory.
>
> Best,
>
> luke
>
>> On Wed, Jan 15, 2025, 10:30 Merlise Clyde, Ph.D. <clyde at duke.edu> wrote:
>>
>>> Thanks for the added explanation Iris and Tomas!
>>>
>>> So looking at the code for xlengthgets, it does appear that I may take a
>>> memory hit for multiple large objects due to the second allocation before
>>> the old objects are possibly garbage collected.???? There are about 12 such
>>> instances per function that are returned (I do use a counter for keeping
>>> track of the number of PROTECTED and to UNPROTECT for bookkeeping :-).
>>> ? For memory limited machines, the alloc/copy was a problem for memory usage
>>> - and if I recall was one of the reasons in 2008 I switched to SETLENGTH,
>>> which doesn't seem to do an allocation ???? If there is going to be an
>>> absolute ban on SETLENGTH? in packages I'll probably need to address memory
>>> management differently for those cases.
>>>
>>> I did see a note before the function def'n of xlengthgets:
>>>
>>> /* (if it is vectorizable). We could probably be fairly */
>>> /* clever with memory here if we wanted to. */
>>>
>>> It would seem that memcpy would be more efficient for at least some of the
>>> types? (REALSPX, INTSPX) unless I am missing something - but any way to be
>>> more clever with VECSPX ?
>>>
>>> best,
>>> Merlise
>>>
>>>
>>>
>>> Merlise Clyde (she/her/hers)
>>> Professor of Statistical Science and Director of Graduate Studies
>>> Duke University
>>>
>>> ________________________________________
>>> From: Iris Simmons <ikwsimmo at gmail.com>
>>> Sent: Wednesday, January 15, 2025 1:00 AM
>>> To: Merlise Clyde, Ph.D. <clyde at duke.edu>
>>> Cc: r-package-devel at r-project.org <r-package-devel at r-project.org>
>>> Subject: Re: [R-pkg-devel] Replacement for SETLENGTH
>>>
>>> Hi Merlise!
>>>
>>>
>>> Referring to here:
>>>
>>>
>>> https://urldefense.com/v3/__https://github.com/wch/r-source/blob/bb5a829466f77a3e1d03541747d149d65e900f2b/src/main/builtin.c*L834__;Iw!!OToaGQ!uACtQIEun1eC8hwn-FzFogXQoPl1wETg9EUSV1NzAif9u15KlRTctzEq1RSA5rcbeVGv0n3geb8UexFnr_0lCLM$
>>>
>>> It seems as though the object is only re-used if the new length is
>>> equal to the old length.
>>>
>>> If you use Rf_lengthgets, you will need to protect the return value.
>>> The code you wrote that uses protect indexes looks correct, and the
>>> reprotect is good because you no longer need the old object.
>>>
>>> 2 is the correct amount to unprotect. PROTECT and PROTECT_WITH_INDEX
>>> (as far as I know) are the only functions that increase the size of
>>> the protect stack, and so the only calls that need to be unprotected.
>>> Typically, people define `int nprotect = 0;` at the start of their
>>> functions, add `nprotect++;` after each PROTECT and PROTECT_WITH_INDEX
>>> call, and add `UNPROTECT(nprotect);` immediately before each return or
>>> function end. That makes it easier to keep track.
>>>
>>> I typically use R_PreserveObject and R_ReleaseObject to protect
>>> objects without a need to bind them somewhere in my package's
>>> namespace. This would be that .onLoad() uses R_PreserveObject to
>>> protect some objects, and .onUnload uses R_ReleaseObject to release
>>> the protected objects. I probably would not use that for what you're
>>> describing.
>>>
>>>
>>> Regards,
>>> ???? Iris
>>>
>>> On Tue, Jan 14, 2025 at 11:26?PM Merlise Clyde, Ph.D. <clyde at duke.edu>
>>> wrote:
>>>>
>>>> I am trying to determine the best way to eliminate the use of SETLENGTH
>>> to truncate over allocated vectors in my package BAS to eliminate the NOTES
>>> about non-API calls in anticipation of R 4.5.0.
>>>>
>>>> From WRE:? "At times it can be useful to allocate a larger initial
>>> result vector and resize it to a shorter length if that is sufficient. The
>>> functions Rf_lengthgets and Rf_xlengthgets accomplish this; they are
>>> analogous to using length(x) <- n in R. Typically these functions return a
>>> freshly allocated object, but in some cases they may re-use the supplied
>>> object."
>>>>
>>>> it looks like using
>>>>
>>>> ???? x = Rf_lengthgets(x, newsize);
>>>> ???? SET_VECTOR_ELT(result, 0, x);
>>>>
>>>> before returning works to resize without a performance hit that incurs
>>> with a copy.? (will this always re-use the supplied object if newsize < old
>>> size?)
>>>>
>>>> There is no mention in section 5.9.2 about the need for re-protection of
>>> the object,? but it seems to be mentioned in some packages as well as a
>>> really old thread about SET_LENGTH that looks like a? non-API MACRO to
>>> lengthgets,
>>>>
>>>> indeed if I call gc() and then rerun my test I have had some
>>> non-reproducible aborts in R Studio on my M3 Mac (caught once in R -d lldb)
>>>>
>>>> Do I need to do something more like
>>>>
>>>> PROTECT_INDEX ipx0;.
>>>> PROTECT_WITH_INDEX(x0 = allocVector(REALSXP, old_size), &ipx0);
>>>>
>>>> PROTECT_INDEX ipx1;.
>>>> PROTECT_WITH_INDEX(x1 = allocVector(REALSXP, old_size), &ipx1);
>>>>
>>>> # fill in values in x0 and? x1up to new_size (random) < old_size
>>>> ...
>>>> REPROTECT(x0 = Rf_lengthgets(x0, new_size), ipx0);
>>>> REPROTECT(x1 = Rf_lengthgets(x1, new_size), ipx1);
>>>>
>>>> SET_VECTOR_ELT(result, 0, x0);
>>>> SET_VECTOR_ELT(result, 1, x1);
>>>> ...
>>>> UNPROTECT(2);?? # or is this 4?
>>>> return(result);
>>>>
>>>>
>>>> There is also a mention in WRE of R_PreserveObject and R_ReleaseObject -
>>>>
>>>> looking for advice if this is needed, or which approach is better/more
>>> stable to replace SETLENGTH??? (I have many many instances that need to be
>>> updated, so trying to get some clarity here before updating and running
>>> code through valgrind or other sanitizers to catch any memory issues before
>>> submitting an update to CRAN.
>>>>
>>>> best,
>>>> Merlise
>>>>
>>>>
>>>>
>>>>
>>>>
>>>>
>>>>
>>>> ______________________________________________
>>>> R-package-devel at r-project.org mailing list
>>>>
>>> https://urldefense.com/v3/__https://stat.ethz.ch/mailman/listinfo/r-package-devel__;!!OToaGQ!ohDoxcAn5uIC25d42XhBz8Kd4YftOJDBoEW1NK9FOmgZpcmv0XIy5fQRm24-s_D8m9O_lR6jo6FcKiA$
>>
>> ??????? [[alternative HTML version deleted]]
>>
>> ______________________________________________
>> R-package-devel at r-project.org mailing list
>> https://urldefense.com/v3/__https://stat.ethz.ch/mailman/listinfo/r-package-devel__;!!OToaGQ!uACtQIEun1eC8hwn-FzFogXQoPl1wETg9EUSV1NzAif9u15KlRTctzEq1RSA5rcbeVGv0n3geb8UexFnYd-1ZB4$
>>
>
> --
> Luke Tierney
> Ralph E. Wareham Professor of Mathematical Sciences
> University of Iowa????????????????? Phone:???????????? 319-335-3386
> Department of Statistics and??????? Fax:?????????????? 319-335-3017
> ??? Actuarial Science
> 241 Schaeffer Hall????????????????? email:?? luke-tierney at uiowa.edu
> Iowa City, IA 52242???????????????? WWW:? https://urldefense.com/v3/__http://www.stat.uiowa.edu/__;!!OToaGQ!uACtQIEun1eC8hwn-FzFogXQoPl1wETg9EUSV1NzAif9u15KlRTctzEq1RSA5rcbeVGv0n3geb8UexFnFDCXgK0$

-- 
Luke Tierney
Ralph E. Wareham Professor of Mathematical Sciences
University of Iowa                  Phone:             319-335-3386
Department of Statistics and        Fax:               319-335-3017
    Actuarial Science
241 Schaeffer Hall                  email:   luke-tierney at uiowa.edu
Iowa City, IA 52242                 WWW:  http://www.stat.uiowa.edu/

From joh@nnp||tz|nger @end|ng |rom goog|em@||@com  Fri Jan 17 09:01:33 2025
From: joh@nnp||tz|nger @end|ng |rom goog|em@||@com (Johann Pfitzinger)
Date: Fri, 17 Jan 2025 09:01:33 +0100
Subject: [R-pkg-devel] 
 Help with clang-san warnings for package "tidyfit"
In-Reply-To: <20250116233048.030ef17e@Tarkus>
References: <01db66c4$Blat.v3.2.22$368863fe$19b4445fe@mail.statistik.tu-dortmund.de>
 <aa1193b5-7921-42d8-83a7-bab58f3f7903@gmail.com>
 <20250116233048.030ef17e@Tarkus>
Message-ID: <dd026412-b763-4d6b-b2e5-b81e030404d4@gmail.com>

Hi Ivan,

thanks for your helpful response and for the background info! Much 
appreciated!

I'll reply-all as you suggested.

Best regards,
Johann

On 16.01.25 21:30, Ivan Krylov wrote:
> ? Wed, 15 Jan 2025 22:13:36 +0100
> Johann Pfitzinger <johannpfitzinger at googlemail.com> ?????:
>
>> I have, so far, failed to reproduce this or to find any useful
>> information on how to fix it. My best guess based on the output.txt
>> is that it originates in "purrr" (which I depend on).
> This is, indeed, a purrr bug:
> https://github.com/tidyverse/purrr/issues/1157
>
> Since the bug is very minor (R's own .C() and .Fortran() currently do
> similar things), a fix for purrr has already been suggested, and
> another package with the same problem (valr) has been recently
> approved, you have a good chance of your package too being approved if
> you reply-all and explain the situation.
>


From p@kr|v|t@ky @end|ng |rom un@w@edu@@u  Fri Jan 17 11:21:27 2025
From: p@kr|v|t@ky @end|ng |rom un@w@edu@@u (Pavel Krivitsky)
Date: Fri, 17 Jan 2025 10:21:27 +0000
Subject: [R-pkg-devel] Best practices for built version checking in packages
 LinkingTo others?
Message-ID: <98a863d7814e843ef600bfb67e742109edc8fa15.camel@unsw.edu.au>

Dear All,

I maintain a package ('ergm') that exports a C API via /inst/include/
that includes header files with data structures, macros, and inline
functions, as well as a number of functions exported in a stubs file
(that use R_FindSymbol() and/or R_GetCCallable() to locate the
functions in 'ergm') that the linking package #includes to access them.

I've recently had an update stall because a source-compatible change in
one of the structs changed the ABI---that is, packages LinkingTo 'ergm'
needs to be rebuilt, and one of them was Suggested by 'ergm' precisely
in order to test the exported C API. As
https://cloud.r-project.org/doc/manuals/r-devel/R-exts.html#Linking-to-native-routines-in-other-packages
suggests, LinkingTo packages should either depend on an exact version
(which is impractical) or test whether the version matches at runtime.

Thus, the questions are:

   1. What is the best way to save this information? I have a
      rudimentary implementation [1], but R already has a mechanism to
      store the build-time R version since it warns about that; can it
      be used for packages as well?
      
   2. How to best test the C API without making updates impossible?
      Obviously, I have my own continuous integration setups, so I
      could simply disable the tests on CRAN, but there is some benefit
      to having tests on CRAN as well [2]. That is, should the testing
      be conditional ABI versions not mismatching, or is this more
      trouble than it's worth?
      
   3. What should be done in case of a mismatch?
      
         1. Is there a way for 'ergm' to detect when a package LinkingTo it
            is being loaded? Checking and handling can be put into .onLoad()
            of the LinkingTo packages, but there is some benefit to putting
            as little code into the LinkingTo package. However, as far as I
            can tell, hooks can only be set for specific packages. Is this
            correct?
            
         2. What should happen if a mismatch is detected? Should the loading
            be blocked (e.g., by having .onLoad() throw an error), or should
            it lead to a "use at your own risk" type warning?

Thanks in advance,
Pavel

[1]

This can be implemented by defining macros with the ABI version in
'ergm', e.g.,

ergm_version.h:

#define ERGM_API_MAJOR 4
#define ERGM_API_MINOR 8

typedef struct {unsigned int major, minor;} APIVersion;

then

ergm_stubs.c (#included from every LinkingTo package into a C file):

#include "ergm_version.h"

APIVersion GetBuiltErgmAPIVersion(void){
  return (APIVersion) {ERGM_API_MAJOR, ERGM_API_MINOR};
}

Then, at compile time, the macros will be resolved so
GetBuiltErgmAPIVersion() will return the build-time 'ergm' version.
R_FindSymbol() could be used to obtain a pointer to
GetBuiltErgmAPIVersion() from a given package and hence its 'ergm'
build version, which can then be returned to R.

[2]

For example (and this actually happened several versions ago) the
package might do something with computational cost that depends on the
number of installed packages.


From |kry|ov @end|ng |rom d|@root@org  Fri Jan 17 14:50:57 2025
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Fri, 17 Jan 2025 16:50:57 +0300
Subject: [R-pkg-devel] 
 Best practices for built version checking in packages
 LinkingTo others?
In-Reply-To: <98a863d7814e843ef600bfb67e742109edc8fa15.camel@unsw.edu.au>
References: <98a863d7814e843ef600bfb67e742109edc8fa15.camel@unsw.edu.au>
Message-ID: <20250117165057.7d994670@arachnoid>

? Fri, 17 Jan 2025 10:21:27 +0000
Pavel Krivitsky via R-package-devel <r-package-devel at r-project.org>
?????:

>    1. What is the best way to save this information? I have a
>       rudimentary implementation [1]

For now, this is the best way we have. Export the ABI version as an
include-time constant and as a registered callable. The LinkingTo
reverse dependencies can give the include-time constant to the
registered callable to compare the two versions.

I agree that we could do better and introduce an ABIversion: field to
the DESCRIPTION file. R CMD INSTALL would write down the current
ABIversion of every package that the current package is LinkingTo (into
the installed package's DESCRIPTION or Meta/features.rds). Later, the
namespace loader would check the ABI versions and provide an
informative message in case a LinkingTo dependency is updated with an
incremented ABI version. A machine-readable list of ABI-level
dependencies should simplify the lives of the binary package
maintainers as well.

(Related may be a problem with S4, where packages may end up caching
parts of the classes from other packages they depend upon, which also
breaks binary installations but self-heals upon reinstalling from
source [1]. This still happens under R-devel. R could store and check
some sort of hash when caching these classes and either reload them in
full or prompt for the package to be reinstalled.)

>    2. How to best test the C API without making updates impossible?

Would abi-compliance-checker [2] have helped there?

It's not exactly designed for static functions and R_GetCCallable(),
but with abi-dumper -all or -dump-static it is possible to use it to
demonstrate incompatibilities between (for example) Matrix_1.6-1.1 and
Matrix_1.7. With either a separate build that exports the functions
destined for R_RegisterCCallable() or some sort of filter for public
symbols, this tool may help detect ABI incompatibilities early.

>    3. What should be done in case of a mismatch?

It's hard to guarantee anything when the ABI is broken. Maybe it's
completely harmless because your code will know that the new structure
member is not initialised. Maybe the wrong stack layout will crash the
process due to a return address mismatch, dooming the process from the
first function call.

>          1. Is there a way for 'ergm' to detect when a package
> LinkingTo it is being loaded?

With inline functions, you could make your every API call perform ABI
version checking, but that obviously comes with potential performance
problems:

// public header in mypackage
#define MYPACKAGE_ABI_VERSION 2
static R_INLINE SEXP mypackage_frobnicate(SEXP arg) {
 (
  (void (*)(int))R_GetCCallable("mypackage", "check_abi_version")
 )(MYPACKAGE_ABI_VERSION); // signals an error on mismatch
 return (
  (SEXP (*)(SEXP))R_GetCCallable("mypackage", "frobnicate")
 )(arg);
}

>          2. What should happen if a mismatch is detected? Should the
> loading be blocked (e.g., by having .onLoad() throw an error), or
> should it lead to a "use at your own risk" type warning?

The safest option would be to signal an error before any of the
potentially incompatible functions are called. It's probably pragmatic
to provide an "I know what I'm doing, void my warranty" emergency
override.

-- 
Best regards,
Ivan

[1] https://stat.ethz.ch/pipermail/r-devel/2023-August/082769.html

[2] https://lvc.github.io/abi-compliance-checker/


From bbo|ker @end|ng |rom gm@||@com  Fri Jan 17 15:13:00 2025
From: bbo|ker @end|ng |rom gm@||@com (Ben Bolker)
Date: Fri, 17 Jan 2025 09:13:00 -0500
Subject: [R-pkg-devel] 
 Best practices for built version checking in packages
 LinkingTo others?
In-Reply-To: <20250117165057.7d994670@arachnoid>
References: <98a863d7814e843ef600bfb67e742109edc8fa15.camel@unsw.edu.au>
 <20250117165057.7d994670@arachnoid>
Message-ID: <4467ebb8-205f-4c69-96da-15a5d1b2999b@gmail.com>

   I wouldn't guarantee that it's best practices, but for reference this 
is what glmmTMB does about checking the Matrix and TMB versions (Matrix 
has a formal ABI version distinct from its package version; TMB doesn't)


https://github.com/glmmTMB/glmmTMB/blob/b7936f4cbe9f26e3d8d5eae727afd83f6ec2b76b/glmmTMB/R/zzz.R#L21-L26

https://github.com/glmmTMB/glmmTMB/blob/b7936f4cbe9f26e3d8d5eae727afd83f6ec2b76b/glmmTMB/R/utils.R#L232-L252

   cheers
    Ben Bolker


> 
>>     1. What is the best way to save this information? I have a
>>        rudimentary implementation [1]
> 
> For now, this is the best way we have. Export the ABI version as an
> include-time constant and as a registered callable. The LinkingTo
> reverse dependencies can give the include-time constant to the
> registered callable to compare the two versions.
> 
> I agree that we could do better and introduce an ABIversion: field to
> the DESCRIPTION file. R CMD INSTALL would write down the current
> ABIversion of every package that the current package is LinkingTo (into
> the installed package's DESCRIPTION or Meta/features.rds). Later, the
> namespace loader would check the ABI versions and provide an
> informative message in case a LinkingTo dependency is updated with an
> incremented ABI version. A machine-readable list of ABI-level
> dependencies should simplify the lives of the binary package
> maintainers as well.
> 
> (Related may be a problem with S4, where packages may end up caching
> parts of the classes from other packages they depend upon, which also
> breaks binary installations but self-heals upon reinstalling from
> source [1]. This still happens under R-devel. R could store and check
> some sort of hash when caching these classes and either reload them in
> full or prompt for the package to be reinstalled.)
> 
>>     2. How to best test the C API without making updates impossible?
> 
> Would abi-compliance-checker [2] have helped there?
> 
> It's not exactly designed for static functions and R_GetCCallable(),
> but with abi-dumper -all or -dump-static it is possible to use it to
> demonstrate incompatibilities between (for example) Matrix_1.6-1.1 and
> Matrix_1.7. With either a separate build that exports the functions
> destined for R_RegisterCCallable() or some sort of filter for public
> symbols, this tool may help detect ABI incompatibilities early.
> 
>>     3. What should be done in case of a mismatch?
> 
> It's hard to guarantee anything when the ABI is broken. Maybe it's
> completely harmless because your code will know that the new structure
> member is not initialised. Maybe the wrong stack layout will crash the
> process due to a return address mismatch, dooming the process from the
> first function call.
> 
>>           1. Is there a way for 'ergm' to detect when a package
>> LinkingTo it is being loaded?
> 
> With inline functions, you could make your every API call perform ABI
> version checking, but that obviously comes with potential performance
> problems:
> 
> // public header in mypackage
> #define MYPACKAGE_ABI_VERSION 2
> static R_INLINE SEXP mypackage_frobnicate(SEXP arg) {
>   (
>    (void (*)(int))R_GetCCallable("mypackage", "check_abi_version")
>   )(MYPACKAGE_ABI_VERSION); // signals an error on mismatch
>   return (
>    (SEXP (*)(SEXP))R_GetCCallable("mypackage", "frobnicate")
>   )(arg);
> }
> 
>>           2. What should happen if a mismatch is detected? Should the
>> loading be blocked (e.g., by having .onLoad() throw an error), or
>> should it lead to a "use at your own risk" type warning?
> 
> The safest option would be to signal an error before any of the
> potentially incompatible functions are called. It's probably pragmatic
> to provide an "I know what I'm doing, void my warranty" emergency
> override.
> 

-- 
Dr. Benjamin Bolker
Professor, Mathematics & Statistics and Biology, McMaster University
Director, School of Computational Science and Engineering
* E-mail is sent at my convenience; I don't expect replies outside of 
working hours.


From |uk@@@@chne|derb@uer @end|ng |rom gm@||@com  Sat Jan 18 00:05:10 2025
From: |uk@@@@chne|derb@uer @end|ng |rom gm@||@com (Lukas Schneiderbauer)
Date: Sat, 18 Jan 2025 00:05:10 +0100
Subject: [R-pkg-devel] 
 SystemRequirements & configure check for FFTW with
 single precision support
In-Reply-To: <20250111220957.6f839b0d@Tarkus>
References: <CAHETjtZcmar26ud0s0yn9RGQXwjKtVpkT3gt+o2DGfAyR-T=qg@mail.gmail.com>
 <20250111220957.6f839b0d@Tarkus>
Message-ID: <CAHETjtao+kQMLOG3aoktqAy1GY75jQ+9XMqjhosDG3wKzDc0NA@mail.gmail.com>

Thanks for the feedback and advice!
I removed the omp.h test, I guess using AC_OPENMP should do the trick
anyways.

I will also try your suggestion regarding the SystemRequirements. Let's see
if it will be accepted this time.

I'm sorry for asking this admittedly thick question, but are you sure
> it's not just R CMD check --as-cran repeating the X-CRAN-Comment: field
> (which includes the phrase about not testing for single-precision
> FFTW)? Does the rejection e-mail say "please fix and resubmit", list
> specific problems, or ask for specific actions?


I am pretty confident it was also a personal response, not only the
X-CRAN-Comment: field. But let's see how the next run goes.

Best regards,
Lukas

	[[alternative HTML version deleted]]


From |uk@@@@chne|derb@uer @end|ng |rom gm@||@com  Sat Jan 18 00:15:36 2025
From: |uk@@@@chne|derb@uer @end|ng |rom gm@||@com (Lukas Schneiderbauer)
Date: Sat, 18 Jan 2025 00:15:36 +0100
Subject: [R-pkg-devel] 
 SystemRequirements & configure check for FFTW with
 single precision support
In-Reply-To: <4D3E0C0F-263C-4B48-91A6-0E9C56D70B27@R-project.org>
References: <CAHETjtZcmar26ud0s0yn9RGQXwjKtVpkT3gt+o2DGfAyR-T=qg@mail.gmail.com>
 <4D3E0C0F-263C-4B48-91A6-0E9C56D70B27@R-project.org>
Message-ID: <CAHETjtYdNBA1cR-=GMcxsLfmi7xdvWYAGREjL_=o=gRMKxR3xQ@mail.gmail.com>

Hi Simon,

Thank you for your detailed feedback!
I rebuilt the configure script to use pkg-config, removed the extra
brew-check, fixed the CPPFLAGS issue you mentioned, and included "fftw-s"
in SystemRequirements.
The package is building fine again on all platforms (using rhub tests and
the `devtools::check_win_devel()` test).

Hopefully it will get accepted soon. :)

Best regards,
Lukas


On Wed, Jan 15, 2025 at 3:59?AM Simon Urbanek <simon.urbanek at r-project.org>
wrote:

> Lukas,
>
> I have not seen the communication so I'm not commenting on that
> specifically, I only looked at the GitHub link.
>
> Although your configure could be improved (more below), it works well
> enough to detect fftw3f.
>
> Unfortunately, SystemRequirements don't have a well-defined structure, but
> there are two commonly used notations:
>
> a) library name and version so in your case that would be something like
> libfftw3f (>=3.3.0)
>
> b) deb/rpm package names
> libfftw3-dev (deb), fftw3-devel (rpm)
>
> fftw is a bit of a mess, because Debian ships the single-precision static
> library in libfftw3-dev, but also has libfftw3-single3 which is the dynamic
> version of the same, while RH does not distinguish. macOS recipe names are
> usually included only if they are non-obvious, but that would be the case
> here since installing fftw recipe does not work for you, so mentioning
> fftw-s is probably a good idea (there are community scripts that try to
> extract that information from the packages so that the dependencies can be
> installed).
>
> As for your configure, my main objection would be that it ignores CPPFLAGS
> (they are not substituted at all even though they *are* used in the tests)
> and doesn't use pkg-config to get the correct flags. (Also the brew part
> should go - it's makes unwarranted assumptions [see below] and is entirely
> superfluous if you use pkg-config instead.) To illustrate what I mean, you
> get
>
> $ pkg-config --cflags fftw3f
> -I/opt/R/x86_64/include
> $ pkg-config --libs fftw3f
> -L/opt/R/x86_64/lib -lfftw3f -lm
>
> while fCWTr on GitHub only uses
>
>   Configuration for fCWTr 0.2.9000
>
>     cppflags:
>     cxxflags:
>     ldflags:
>     libs:     -lfftw3f
>
> It actually works despite that, because R will inject the other flags for
> you, but that will only work is fftw is installed in the same location as
> the other libraries used by R (which is common, but not guaranteed). I
> wouldn't say it is dealbreaker, but it would recommend it for robustness.
>
> FWIW with homebrew the correct flags are obtainable from pkg-config:
>
> $ pkg-config --libs fftw3f
> -L/opt/brew/Cellar/fftw/3.3.8_1/lib -lfftw3f
> $ pkg-config --cflags fftw3f
> -I/opt/brew/Cellar/fftw/3.3.8_1/include
>
> Cheers,
> Simon
>
>
>
> > On Jan 11, 2025, at 10:37 PM, Lukas Schneiderbauer <
> lukas.schneiderbauer at gmail.com> wrote:
> >
> > Hi list,
> >
> > I am working on getting a package <
> https://github.com/lschneiderbauer/fCWTr> to
> > CRAN. It depends on the FFTW library <https://www.fftw.org/> that is
> built
> > with single precision support. I am stuck in the submission process and I
> > require your help.
> >
> > Before I come to my questions, some key facts about the package:
> >
> > The package has an autoconf configure script that uses (among other
> things,
> > like OpenMP checks, etc..) AC_SEARCH_LIBS to check whether required
> > functions of the library 'fftwf' exist, if yes, it adds the corresponding
> > compiler/linker flags; if no, it errs with a descriptive error message.
> >
> > The CRAN Windows as well as Linux build service included fftwf in their
> > fftw build out of the box, and so building there was no problem, R CMD
> > Check passes there. In the past, building for MacOS was more trouble,
> since
> > its fftw package does not include a single-precision build. I reached out
> > to Simon Urbanek, and he was so kind as to add an appropriate new recipe
> > "fftw-s" that provided an fftw version with single precision support. As
> of
> > now, R CMD check also passes cleanly on the MacOS build service, thanks
> to
> > Simon Urbanek's efforts.
> >
> > Now, I am stuck at submission for two reasons:
> > 1. The SystemRequirements specification in the DESCRIPTION file is
> > incorrect.
> > 2. It is said that "the package needs a configure check for fftwf".
> >
> > Add 1.
> > Initially, I had no mention of the "single precision" version of fftw,
> > because I thought it is included everywhere by default. It was stated
> that
> > I need to add that information. I naturally complied.
> > This is my current version:
> > "SystemRequirements: fftw3 (including single precision support fftw3f),
> > fftw3f_omp (optional), OpenMP (optional)"
> > In the second subscription run, I was told to add "fftw-s" since I
> require
> > the fftw-s package on MacOS. This does not make much sense to me since
> > "fftw-s" is only the name of this package on Simon Urbanek's MacOS build
> > service. The library file itself is still called fftwf, like it is on any
> > other platform. If I added "fftw-s", I would also need to explain that
> this
> > is only valid for MacOS which seems to make the SystemRequirements
> > unnecessary verbose.
> > * Can someone explain the reason behind this request to me?
> > * How exactly should I add "fftw-s" to pass the submission process?
> >
> > Add 2.
> > I tried to explain now for the second time in the submission notes, that
> a
> > check is already in place (see the AC_SEARCH_LIBS paragraph above). But
> my
> > explanation gets ignored.
> > * What am I doing wrong?
> > * What additional configure checks do I need to add to the package?
> >
> > Thanks a lot for your help!
> > Sincerely, Lukas Schneiderbauer
> >
> >       [[alternative HTML version deleted]]
> >
> > ______________________________________________
> > R-package-devel at r-project.org mailing list
> > https://stat.ethz.ch/mailman/listinfo/r-package-devel
> >
>
>

	[[alternative HTML version deleted]]


From p@kr|v|t@ky @end|ng |rom un@w@edu@@u  Sun Jan 19 06:31:15 2025
From: p@kr|v|t@ky @end|ng |rom un@w@edu@@u (Pavel Krivitsky)
Date: Sun, 19 Jan 2025 05:31:15 +0000
Subject: [R-pkg-devel] 
 Best practices for built version checking in packages
 LinkingTo others?
In-Reply-To: <20250117165057.7d994670@arachnoid>
References: <98a863d7814e843ef600bfb67e742109edc8fa15.camel@unsw.edu.au>
 <20250117165057.7d994670@arachnoid>
Message-ID: <8d9b8f509ae8ea4dc65928d0285e939ef9272442.camel@unsw.edu.au>

Thanks, Ivan! Replies below.

On Fri, 2025-01-17 at 16:50 +0300, Ivan Krylov wrote:
> ? Fri, 17 Jan 2025 10:21:27 +0000
> Pavel Krivitsky via R-package-devel <r-package-devel at r-project.org>
> ?????:
> 
> > ?? 1. What is the best way to save this information? I have a
> > ????? rudimentary implementation [1]
> 
> For now, this is the best way we have. Export the ABI version as an
> include-time constant and as a registered callable. The LinkingTo
> reverse dependencies can give the include-time constant to the
> registered callable to compare the two versions.

Ben Bolker pointed out that since the code in R/ is executed at build-
time, it is also possible to store the build-time ABI information
entirely in R; the downside of this approach is that it requires
instrumenting every client package rather than just the library
package.

> I agree that we could do better and introduce an ABIversion: field to
> the DESCRIPTION file. R CMD INSTALL would write down the current
> ABIversion of every package that the current package is LinkingTo
> (into the installed package's DESCRIPTION or Meta/features.rds).
> Later, the namespace loader would check the ABI versions and provide
> an informative message in case a LinkingTo dependency is updated with
> an incremented ABI version. A machine-readable list of ABI-level
> dependencies should simplify the lives of the binary package
> maintainers as well.

Yes, that would be great to have. (One nitpick: not just incremented,
but different in either direction.)

AFAIK, for those platforms that use binaries, there is already a
mechanism for downloading a different ZIP for a different version of R,
but I believe it's accomplished simply by having a directory for every
version of R with a potentially different ABI.

I suppose this could be generalised along the lines of a directory
hierarchy of the form

/bin/windows/contrib/RVERSION/PKG_ABIVERSION/.../PKG_ABIVERSION/PKG_PKGVERSION.zip

with a nesting level for every LinkingTo package, in lexicographic
order. Then, given the installed R version and the installed versions
of each package in the LinkingTo list, a unique URL can be constructed.
However, I don't know how practical this is and how likely to be
implemented in the foreseeable future.

> > ?? 2. How to best test the C API without making updates impossible?
> 
> Would abi-compliance-checker [2] have helped there?

I meant specifically in the context of R CMD check; the only want to
fully test the C API and associated facilities is to actually install
the client package and see if it works.

That having been said, 'ergm' may be unusual in this, since the API is
mostly used as a way for others to implement calculation of graph
statistics that are then operated on by functions in 'ergm'. That is,
rather than simply offering C functions for the client packages to use,
'ergm' calls C functions from those packages that it locates via
R_FindSymbol(). Thus, it is helpful to test it as a part of 'ergm'
itself rather than just reverse-dependency checks.

> > ?? 3. What should be done in case of a mismatch?
> 
> It's hard to guarantee anything when the ABI is broken. Maybe it's
> completely harmless because your code will know that the new
> structure member is not initialised. Maybe the wrong stack layout
> will crash the process due to a return address mismatch, dooming the
> process from the first function call.k
> 
> > ???????? 1. Is there a way for 'ergm' to detect when a package
> > LinkingTo it is being loaded?
> 
> With inline functions, you could make your every API call perform ABI
> version checking, but that obviously comes with potential performance
> problems:

The reason I ask is that the best time to inform the user of an ABI
change is when the client package is loaded, and it would be helpful if
this could be done without modifying the client package.

Is there a mechanism for the library package to monitor packages being
loaded, and for each one check if it's LinkingTo it to do the version
check?

> > ???????? 2. What should happen if a mismatch is detected? Should
> > the
> > loading be blocked (e.g., by having .onLoad() throw an error), or
> > should it lead to a "use at your own risk" type warning?
> 
> The safest option would be to signal an error before any of the
> potentially incompatible functions are called. It's probably
> pragmatic to provide an "I know what I'm doing, void my warranty"
> emergency override.

Probably an options() setting.

				Best,
				Pavel


From pep|jn@devr|e@ @end|ng |rom out|ook@com  Sun Jan 19 18:07:51 2025
From: pep|jn@devr|e@ @end|ng |rom out|ook@com (Pepijn de Vries)
Date: Sun, 19 Jan 2025 17:07:51 +0000
Subject: [R-pkg-devel] Package builds on all systems except on Fedora with
 clang
Message-ID: <AS8PR10MB4663D3B455E96FE0A05C7640A7E42@AS8PR10MB4663.EURPRD10.PROD.OUTLOOK.COM>

Dear fellow developers,

Recently I've submitted a package to CRAN which builds without problems on most systems:

https://cran.r-project.org/web/checks/check_results_openmpt.html

Except for Fedora with clang:

https://www.r-project.org/nosvn/R.check/r-devel-linux-x86_64-fedora-clang/openmpt-00install.html

There are some valgrind and ASAN issues, but most of them are solved at https://github.com/pepijn-devries/openmpt

At first I thought that the problem was caused by a missing system requirement (i.e., the libopenmpt library). However, Prof. Ripley reported that all system requirements are installed on the Fedora machine. He also mentioned that I "need to check in your configure script that the external library you need is available *and* usable with the compilers used to compile R and packages." As I'm new to including static libraries in an R package, I'm not sure how to fix this. Does anyone have a clue to get this fixed?

Kind regards,

Pepijn

From |kry|ov @end|ng |rom d|@root@org  Sun Jan 19 20:40:22 2025
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Sun, 19 Jan 2025 22:40:22 +0300
Subject: [R-pkg-devel] 
 Package builds on all systems except on Fedora with clang
In-Reply-To: <AS8PR10MB4663D3B455E96FE0A05C7640A7E42@AS8PR10MB4663.EURPRD10.PROD.OUTLOOK.COM>
References: <AS8PR10MB4663D3B455E96FE0A05C7640A7E42@AS8PR10MB4663.EURPRD10.PROD.OUTLOOK.COM>
Message-ID: <20250119224022.49a80684@Tarkus>

? Sun, 19 Jan 2025 17:07:51 +0000
Pepijn de Vries <pepijn.devries at outlook.com> ?????:

> He also mentioned that I "need to check in your configure script that
> the external library you need is available *and* usable with the
> compilers used to compile R and packages."

The Fedora-clang test fails with a symbol lookup error:

>> /data/gannet/ripley/R/packages/tests-clang/openmpt.Rcheck/00LOCK-openmpt/00new/openmpt/libs/openmpt.so:
>> undefined symbol:
>> _ZNK7openmpt6module15ctl_get_integerENSt3__117basic_string_viewIcNS1_11char_traitsIcEEEE

Translated using 'c++filt', the missing function turns out to be
openmpt::module::ctl_get_integer(std::__1::basic_string_view<char,
std::__1::char_traits<char> >) const. Why would libopenmpt.so be
missing a method for an std::string_view?

The problem here is that the Clang checks compile C++ code with the
"libc++" standard library that belongs to the LLVM project (same people
who develop Clang). The openmpt library, on the other hand, comes from
Fedora and is compiled and linked with the GNU "libstdc++" standard
library. The two standard libraries have very different internals and
can't be mixed. There's nothing you should do as a package developer to
make it work [1] (thank you Tomas for the clarification!).

I think that Prof. Ripley is asking you to make a configure test that
fails in these circumstances. Here's one that should work:

1. Write a C++ source file that includes OpenMPT headers and exports a
single function that calls the problematic OpenMPT function.

2. During ./configure, export the environment variables PKG_CPPFLAGS,
PKG_LIBS with the same contents that you intend to give to Makevars.

3. From the same ./configure script, call ${R_HOME}/bin/R CMD SHLIB to
compile the source file from (1) and link it into a shared library.

4. Call R again to dyn.load() the shared library. (Use
.Platform$dynlib.ext to figure out the file extension.)

-- 
Best regards,
Ivan

[1] https://stat.ethz.ch/pipermail/r-package-devel/2024q4/011326.html


From @jenk|n@ @end|ng |rom @tud|oj@u@  Sat Jan 18 17:37:27 2025
From: @jenk|n@ @end|ng |rom @tud|oj@u@ (Steven Jenkins)
Date: Sat, 18 Jan 2025 11:37:27 -0500
Subject: [R-pkg-devel] LaTeX Error: Unicode character not set up for use
 with LaTeX
Message-ID: <8E4AEA76-0732-4D74-95DC-C11C702857CC@studioj.us>

Longtime R user, first-time packager. Devtools are great; it?s pretty easy.

I?m trying to submit a package (https://github.com/jsjuni/massProps) that calculates mass properties and uncertainties for assembly trees. Very standard mechanical engineering stuff. The data are represented in a data frame and a tree.

It is customary in this and other fields to name an uncertainty parameter with ??? subscripted by the symbol of the parameter it characterizes. My code assumes a data frame with column names including ?_mass, ?_Cx, ?_Cy, ?_Ixx, etc. (If you can?t see it in your locale, it?s GREEK SMALL LETTER SIGMA, U+03C3.)

At least in my locale, these are valid names in R, so I used expressions like result$?_mass and input[row, ??_mass?] liberally. Everything works.

Unfortunately, CRAN doesn?t like that. check() complains about Unicode characters. Easy enough to fix. Putting escapes in the R names made the computation code ugly, so I replaced all the internals as, e.g., result$sigma_mass. Read and update operations on the data frame are isolated, so it was fairly straightforward to fix those as input[row, "\u03c3_mass?].

Again, all good. All unit tests pass, check() produces no errors, no warnings, no notes. Doxygen contents documenting the columns (which retain the Unicode character) render perfectly.

Then I get to check(manual = TRUE). LaTeX issues many complaints:

  ! LaTeX Error: Unicode character ? (U+03C3)
                 not set up for use with LaTeX.

After a good bit of searching, I can't find a fix. Bookdown suggests setting the LaTeX engine to ?xelatex?, but I don?t know whether that?s applicable (or possible) here.

So, two questions: (1) Is it bad practice to name columns like this in external serialization? Obviously, I can just use ?sigma_? everywhere, but I prefer it the way it is. (2) Is there some way to change either the Doxygen input or the LaTeX configuration to correct the problem? (Escaping the Doxygen input doesn?t work.)

Thanks in advance for your guidance.

Steve
	[[alternative HTML version deleted]]


From pep|jn@devr|e@ @end|ng |rom out|ook@com  Sun Jan 19 21:42:17 2025
From: pep|jn@devr|e@ @end|ng |rom out|ook@com (Pepijn de Vries)
Date: Sun, 19 Jan 2025 20:42:17 +0000
Subject: [R-pkg-devel] 
 Package builds on all systems except on Fedora with clang
In-Reply-To: <20250119224022.49a80684@Tarkus>
References: <AS8PR10MB4663D3B455E96FE0A05C7640A7E42@AS8PR10MB4663.EURPRD10.PROD.OUTLOOK.COM>
 <20250119224022.49a80684@Tarkus>
Message-ID: <AM8PR10MB46602CEED17D226A6520A93FA7E42@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>

Hi Ivan,

Thank you for the quick response. The linked discussion thread was also helpful.

I think I could write a similar test as used by `cpp11tesseract`:

https://github.com/pachadotdev/cpp11tesseract/blob/2ea8287ef2c27901446bafa402728014d99904d4/configure#L66-L85

Kind regards,

Pepijn

________________________________________
Van:?Ivan Krylov <ikrylov at disroot.org>
Verzonden:?zondag 19 januari 2025 20:40
Aan:?Pepijn de Vries <pepijn.devries at outlook.com>
CC:?Ivan Krylov via R-package-devel <r-package-devel at r-project.org>
Onderwerp:?Re: [R-pkg-devel] Package builds on all systems except on Fedora with clang
?
? Sun, 19 Jan 2025 17:07:51 +0000
Pepijn de Vries <pepijn.devries at outlook.com> ?????:

> He also mentioned that I "need to check in your configure script that
> the external library you need is available *and* usable with the
> compilers used to compile R and packages."

The Fedora-clang test fails with a symbol lookup error:

>> /data/gannet/ripley/R/packages/tests-clang/openmpt.Rcheck/00LOCK-openmpt/00new/openmpt/libs/openmpt.so:
>> undefined symbol:
>> _ZNK7openmpt6module15ctl_get_integerENSt3__117basic_string_viewIcNS1_11char_traitsIcEEEE

Translated using 'c++filt', the missing function turns out to be
openmpt::module::ctl_get_integer(std::__1::basic_string_view<char,
std::__1::char_traits<char> >) const. Why would libopenmpt.so be
missing a method for an std::string_view?

The problem here is that the Clang checks compile C++ code with the
"libc++" standard library that belongs to the LLVM project (same people
who develop Clang). The openmpt library, on the other hand, comes from
Fedora and is compiled and linked with the GNU "libstdc++" standard
library. The two standard libraries have very different internals and
can't be mixed. There's nothing you should do as a package developer to
make it work [1] (thank you Tomas for the clarification!).

I think that Prof. Ripley is asking you to make a configure test that
fails in these circumstances. Here's one that should work:

1. Write a C++ source file that includes OpenMPT headers and exports a
single function that calls the problematic OpenMPT function.

2. During ./configure, export the environment variables PKG_CPPFLAGS,
PKG_LIBS with the same contents that you intend to give to Makevars.

3. From the same ./configure script, call ${R_HOME}/bin/R CMD SHLIB to
compile the source file from (1) and link it into a shared library.

4. Call R again to dyn.load() the shared library. (Use
.Platform$dynlib.ext to figure out the file extension.)

--
Best regards,
Ivan

[1] https://stat.ethz.ch/pipermail/r-package-devel/2024q4/011326.html

From |kry|ov @end|ng |rom d|@root@org  Sun Jan 19 22:23:17 2025
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Mon, 20 Jan 2025 00:23:17 +0300
Subject: [R-pkg-devel] 
 Package builds on all systems except on Fedora with clang
In-Reply-To: <AM8PR10MB46602CEED17D226A6520A93FA7E42@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>
References: <AS8PR10MB4663D3B455E96FE0A05C7640A7E42@AS8PR10MB4663.EURPRD10.PROD.OUTLOOK.COM>
 <20250119224022.49a80684@Tarkus>
 <AM8PR10MB46602CEED17D226A6520A93FA7E42@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>
Message-ID: <20250120002317.36e351e0@Tarkus>

? Sun, 19 Jan 2025 20:42:17 +0000
Pepijn de Vries <pepijn.devries at outlook.com> ?????:

> I think I could write a similar test as used by `cpp11tesseract`:
> 
> https://github.com/pachadotdev/cpp11tesseract/blob/2ea8287ef2c27901446bafa402728014d99904d4/configure#L66-L85

I should have replied to that thread too, but got swamped. If the
compiler flags are right, $CXX -c conftest.cpp will succeed the same way
that the individual object files currently successfully compile on
Fedora-clang [1]:

>> /usr/local/clang19/bin/clang++ -stdlib=libc++ -std=gnu++17
>> -I"/data/gannet/ripley/R/R-clang/include" -DNDEBUG -pthread
>> -I'/data/gannet/ripley/R/test-clang/cpp11/include' -isystem
>> /usr/local/clang19/include -I/usr/local/clang/include    -fpic  -O3
>> -Wall -pedantic -frtti -Wp,-D_FORTIFY_SOURCE=3
>> -Wno-missing-template-arg-list-after-template-kw  -DR_NO_REMAP -c
>> audio.cpp -o audio.o

Even linking the shared library is not enough, because that step
succeeds on Fedora-clang too:

>> /usr/local/clang19/bin/clang++ -stdlib=libc++ -std=gnu++17 -shared
>> -L/usr/local/clang/lib64 -L/usr/local/clang19/lib
>> -L/usr/local/clang19/lib/x86_64-unknown-linux-gnu
>> -L/usr/local/gcc14/lib64 -L/usr/local/lib64 -o openmpt.so audio.o
>> cpp11.o ctl.o format.o get_mod.o helpers.o info.o io.o module_ext.o
>> names.o render.o render_params.o repeat.o setpos.o state.o subsong.o
>> -lopenmpt -lportaudiocpp -lportaudio -lm -lpthread -lasound

Testing only the previous two steps will succeed during ./configure on
the Fedora-clang check and then fail to load the shared library during
package installation, like it currently does. Using R CMD SHLIB, on the
other hand, spares the effort of trying to figure out the right
compiler and giving it all the right flags.

Unrelated, but speaking of the default linker flags,

>> PKG_LIBS="-llibportaudio -llibportaudiocpp -llibopenmpt"

These are a bit counter-intuitive. When you ask the linker to link with
-lfoo, it tries to link with libfoo.a or libfoo.so, i.e. it prepends
the "lib" by itself.

Also unrelated, but is there OpenMPT in the macOS 'recipes' system? I
think it's the recommended way of making use of third-party code in
CRAN packages [2].

-- 
Best regards,
Ivan

[1]
https://www.r-project.org/nosvn/R.check/r-devel-linux-x86_64-fedora-clang/openmpt-00install.html

[2]
https://cran.r-project.org/web/packages/external_libs.html


From @|mon@urb@nek @end|ng |rom R-project@org  Mon Jan 20 01:48:15 2025
From: @|mon@urb@nek @end|ng |rom R-project@org (Simon Urbanek)
Date: Mon, 20 Jan 2025 13:48:15 +1300
Subject: [R-pkg-devel] LaTeX Error: Unicode character not set up for use
 with LaTeX
In-Reply-To: <8E4AEA76-0732-4D74-95DC-C11C702857CC@studioj.us>
References: <8E4AEA76-0732-4D74-95DC-C11C702857CC@studioj.us>
Message-ID: <8B0AEBA4-24D0-40C0-BBD6-850D9C116342@R-project.org>

Steven,


> On 19 Jan 2025, at 05:37, Steven Jenkins <sjenkins at studioj.us> wrote:
> 
> Longtime R user, first-time packager. Devtools are great; it?s pretty easy.
> 
> I?m trying to submit a package (https://github.com/jsjuni/massProps) that calculates mass properties and uncertainties for assembly trees. Very standard mechanical engineering stuff. The data are represented in a data frame and a tree.
> 
> It is customary in this and other fields to name an uncertainty parameter with ??? subscripted by the symbol of the parameter it characterizes. My code assumes a data frame with column names including ?_mass, ?_Cx, ?_Cy, ?_Ixx, etc. (If you can?t see it in your locale, it?s GREEK SMALL LETTER SIGMA, U+03C3.)
> 
> At least in my locale, these are valid names in R, so I used expressions like result$?_mass and input[row, ??_mass?] liberally. Everything works.
> 
> Unfortunately, CRAN doesn?t like that. check() complains about Unicode characters. Easy enough to fix. Putting escapes in the R names made the computation code ugly, so I replaced all the internals as, e.g., result$sigma_mass. Read and update operations on the data frame are isolated, so it was fairly straightforward to fix those as input[row, "\u03c3_mass?].
> 
> Again, all good. All unit tests pass, check() produces no errors, no warnings, no notes. Doxygen contents documenting the columns (which retain the Unicode character) render perfectly.
> 
> Then I get to check(manual = TRUE). LaTeX issues many complaints:
> 
>  ! LaTeX Error: Unicode character ? (U+03C3)
>                 not set up for use with LaTeX.
> 
> After a good bit of searching, I can't find a fix. Bookdown suggests setting the LaTeX engine to ?xelatex?, but I don?t know whether that?s applicable (or possible) here.
> 


No, it is not, it has to work with pdflatex.


> So, two questions: (1) Is it bad practice to name columns like this in external serialization?


Yes. See R-exts 1.6.3:
"First, consider carefully if you really need non-ASCII text. Some users of R will only be able to view correctly text in their native language group (e.g. Western European, Eastern European, Simplified Chinese) and ASCII. Other characters may not be rendered at all, rendered incorrectly, or cause your R code to give an error. "

> m
     sigma_mass
[1,]  -2.173881
[2,]   1.184118
[3,]  -1.295566

is a lot more readable and usable than 

> m
            <U+03C3>_mass
[1,]     -2.173881
[2,]      1.184118
[3,]     -1.295566


> Obviously, I can just use ?sigma_? everywhere, but I prefer it the way it is.


I suspect you may be the a very small minority as non-ASCII characters are really problematic in code as they require special input methods, making your symbols mostly unusable. Unicode has its place in data as text, e.g. when rendering names or words in other languages, but even there they require careful handling (e.g., still won't work in LaTeX output). Row names are fine as long as they reflect real data (e.g. names/words), but in your case it?s just an unnecessarily awkward use of a symbol so it does not fall into that category.

Cheers,
Simon



> (2) Is there some way to change either the Doxygen input or the LaTeX configuration to correct the problem? (Escaping the Doxygen input doesn?t work.)
> 
> Thanks in advance for your guidance.
> 
> Steve
> [[alternative HTML version deleted]]
> 
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
> 


From @jenk|n@ @end|ng |rom @tud|oj@u@  Mon Jan 20 04:13:57 2025
From: @jenk|n@ @end|ng |rom @tud|oj@u@ (Steven Jenkins)
Date: Sun, 19 Jan 2025 22:13:57 -0500
Subject: [R-pkg-devel] LaTeX Error: Unicode character not set up for use
 with LaTeX
In-Reply-To: <8B0AEBA4-24D0-40C0-BBD6-850D9C116342@R-project.org>
References: <8E4AEA76-0732-4D74-95DC-C11C702857CC@studioj.us>
 <8B0AEBA4-24D0-40C0-BBD6-850D9C116342@R-project.org>
Message-ID: <B716A48E-0DB7-49DD-B298-7EC91DAAA465@studioj.us>

Simon,

Thanks for the clear and direct answer. I was prepared for that to be the case :-).

Steve

> On Jan 19, 2025, at 7:48?PM, Simon Urbanek <simon.urbanek at R-project.org> wrote:
> 
> Steven,
> 
> 
>> On 19 Jan 2025, at 05:37, Steven Jenkins <sjenkins at studioj.us> wrote:
>> 
>> Longtime R user, first-time packager. Devtools are great; it?s pretty easy.
>> 
>> I?m trying to submit a package (https://github.com/jsjuni/massProps) that calculates mass properties and uncertainties for assembly trees. Very standard mechanical engineering stuff. The data are represented in a data frame and a tree.
>> 
>> It is customary in this and other fields to name an uncertainty parameter with ??? subscripted by the symbol of the parameter it characterizes. My code assumes a data frame with column names including ?_mass, ?_Cx, ?_Cy, ?_Ixx, etc. (If you can?t see it in your locale, it?s GREEK SMALL LETTER SIGMA, U+03C3.)
>> 
>> At least in my locale, these are valid names in R, so I used expressions like result$?_mass and input[row, ??_mass?] liberally. Everything works.
>> 
>> Unfortunately, CRAN doesn?t like that. check() complains about Unicode characters. Easy enough to fix. Putting escapes in the R names made the computation code ugly, so I replaced all the internals as, e.g., result$sigma_mass. Read and update operations on the data frame are isolated, so it was fairly straightforward to fix those as input[row, "\u03c3_mass?].
>> 
>> Again, all good. All unit tests pass, check() produces no errors, no warnings, no notes. Doxygen contents documenting the columns (which retain the Unicode character) render perfectly.
>> 
>> Then I get to check(manual = TRUE). LaTeX issues many complaints:
>> 
>> ! LaTeX Error: Unicode character ? (U+03C3)
>>                not set up for use with LaTeX.
>> 
>> After a good bit of searching, I can't find a fix. Bookdown suggests setting the LaTeX engine to ?xelatex?, but I don?t know whether that?s applicable (or possible) here.
>> 
> 
> 
> No, it is not, it has to work with pdflatex.
> 
> 
>> So, two questions: (1) Is it bad practice to name columns like this in external serialization?
> 
> 
> Yes. See R-exts 1.6.3:
> "First, consider carefully if you really need non-ASCII text. Some users of R will only be able to view correctly text in their native language group (e.g. Western European, Eastern European, Simplified Chinese) and ASCII. Other characters may not be rendered at all, rendered incorrectly, or cause your R code to give an error. "
> 
>> m
>     sigma_mass
> [1,]  -2.173881
> [2,]   1.184118
> [3,]  -1.295566
> 
> is a lot more readable and usable than 
> 
>> m
>            <U+03C3>_mass
> [1,]     -2.173881
> [2,]      1.184118
> [3,]     -1.295566
> 
> 
>> Obviously, I can just use ?sigma_? everywhere, but I prefer it the way it is.
> 
> 
> I suspect you may be the a very small minority as non-ASCII characters are really problematic in code as they require special input methods, making your symbols mostly unusable. Unicode has its place in data as text, e.g. when rendering names or words in other languages, but even there they require careful handling (e.g., still won't work in LaTeX output). Row names are fine as long as they reflect real data (e.g. names/words), but in your case it?s just an unnecessarily awkward use of a symbol so it does not fall into that category.
> 
> Cheers,
> Simon
> 
> 
> 
>> (2) Is there some way to change either the Doxygen input or the LaTeX configuration to correct the problem? (Escaping the Doxygen input doesn?t work.)
>> 
>> Thanks in advance for your guidance.
>> 
>> Steve
>> [[alternative HTML version deleted]]
>> 
>> ______________________________________________
>> R-package-devel at r-project.org <mailto:R-package-devel at r-project.org> mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-package-devel


	[[alternative HTML version deleted]]


From edd @end|ng |rom deb|@n@org  Mon Jan 20 16:03:36 2025
From: edd @end|ng |rom deb|@n@org (Dirk Eddelbuettel)
Date: Mon, 20 Jan 2025 09:03:36 -0600
Subject: [R-pkg-devel] 
 Package builds on all systems except on Fedora with clang
In-Reply-To: <AM8PR10MB46602CEED17D226A6520A93FA7E42@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>
References: <AS8PR10MB4663D3B455E96FE0A05C7640A7E42@AS8PR10MB4663.EURPRD10.PROD.OUTLOOK.COM>
 <20250119224022.49a80684@Tarkus>
 <AM8PR10MB46602CEED17D226A6520A93FA7E42@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>
Message-ID: <26510.26056.951900.698722@rob.eddelbuettel.com>


On 19 January 2025 at 20:42, Pepijn de Vries wrote:
| I think I could write a similar test as used by `cpp11tesseract`:
| 
| https://github.com/pachadotdev/cpp11tesseract/blob/2ea8287ef2c27901446bafa402728014d99904d4/configure#L66-L85

Taking an example from a package not on CRAN 'for policy violations' may not
be the safest best.

`autoconf` has included the ability to conduction these tests for a long
time. Here is an (old) snippet from RProtoBuf which uses a test file to
assert we have a recent enough version:

   ## also check for minimum version
   AC_MSG_CHECKING([if ProtoBuf version >= 2.2.0])
   AC_RUN_IFELSE([AC_LANG_SOURCE([[
   #include <google/protobuf/stubs/common.h>
   int main() {
      if (GOOGLE_PROTOBUF_VERSION >= 2001000) {
           exit (0);
      } else {
           exit(1);
      }
   }
   ]])],
   [pb_version_ok=yes],
   [pb_version_ok=no],
   [pb_version_ok=yes])
   if test x"${pb_version_ok}" = x"no"; then
       AC_MSG_ERROR([Need ProtoBuf version >= 2.2.0])
   else
       AC_MSG_RESULT([yes])
   fi

Note that this happens after we found suitable compiler and linker switches.
And of course, switching to `autoconf` is no small task either. But getting
an external library to build reliably on all platforms is one of the harder
things to set up at CRAN.

Dirk

-- 
dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org


From john@c|@rke @end|ng |rom corner@tonenw@com  Tue Jan 21 11:57:46 2025
From: john@c|@rke @end|ng |rom corner@tonenw@com (John Clarke)
Date: Tue, 21 Jan 2025 11:57:46 +0100
Subject: [R-pkg-devel] Rcpp: how best to include source from another Github
 repository
Message-ID: <CAF0e1n9yrb+M+csGMeYpfFm35-fe4s4B5-8H0fQ-ov8yckEqZQ@mail.gmail.com>

Hi folks,

I have an Rcpp package I'm developing. All but one of the cpp source code
files are pulled from the original/authoritative (CLI) version of the
application. The only unique cpp source code to the Rcpp package is my
wrapper.cpp which contains the Rcpp interface. This approach works fine,
but every time we make changes to the original CLI repository, it requires
a manual (and duplicate) commit to my Rcpp repo. This is not ideal from a
source tracking perspective and is a DRY violation.

What is the recommended way of maintaining the shared cpp code in a Rcpp
repo? Ideally, it would be nice to be able to pull the files from the
source repo using a tag/hash so that the only code change in the Rcpp repo
would be that reference rather than all the changes to the shared source.
It would also be nice to use some sort of symlinkish setup during
development to allow quick testing before making commits in the original
CLI repo. Is this possible? Recommended? (we can assume dev is on MacOS or
Linux)

Thanks,

-John

John Clarke | Senior Technical Advisor |
Cornerstone Systems Northwest | john.clarke at cornerstonenw.com

	[[alternative HTML version deleted]]


From |kry|ov @end|ng |rom d|@root@org  Tue Jan 21 13:04:53 2025
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Tue, 21 Jan 2025 15:04:53 +0300
Subject: [R-pkg-devel] 
 Rcpp: how best to include source from another Github repository
In-Reply-To: <CAF0e1n9yrb+M+csGMeYpfFm35-fe4s4B5-8H0fQ-ov8yckEqZQ@mail.gmail.com>
References: <CAF0e1n9yrb+M+csGMeYpfFm35-fe4s4B5-8H0fQ-ov8yckEqZQ@mail.gmail.com>
Message-ID: <20250121150453.6d63147a@arachnoid>

? Tue, 21 Jan 2025 11:57:46 +0100
John Clarke <john.clarke at cornerstonenw.com> ?????:

> Ideally, it would be nice to be able to pull the files from the
> source repo using a tag/hash so that the only code change in the Rcpp
> repo would be that reference rather than all the changes to the
> shared source.

I've been using Git submodules for this purpose:

https://codeberg.org/aitap/Ropj/src/branch/master/src

https://git-scm.com/book/en/v2/Git-Tools-Submodules

Every time the upstream changes I have to update the commit pointer in
my repository too, but other than that, it's been working fine. My
.Rbuildignore filters out all the unnecessary files included in the
upstream repository, leaving only the relevant source code in the
resulting source package.

The resulting repository must be cloned with --recurse-submodules (or,
if forgotten, must be initialised with git submodule update --init);
further updates to the tracked commit pointer must be applied with git
submodule update. If the referenced repository becomes unavailable, it
will be impossible to build the package.

-- 
Best regards,
Ivan


From p@kr|v|t@ky @end|ng |rom un@w@edu@@u  Wed Jan 22 13:20:38 2025
From: p@kr|v|t@ky @end|ng |rom un@w@edu@@u (Pavel Krivitsky)
Date: Wed, 22 Jan 2025 12:20:38 +0000
Subject: [R-pkg-devel] 
 Best practices for built version checking in packages
 LinkingTo others?
In-Reply-To: <8d9b8f509ae8ea4dc65928d0285e939ef9272442.camel@unsw.edu.au>
References: <98a863d7814e843ef600bfb67e742109edc8fa15.camel@unsw.edu.au>
 <20250117165057.7d994670@arachnoid>
 <8d9b8f509ae8ea4dc65928d0285e939ef9272442.camel@unsw.edu.au>
Message-ID: <8db72b652984d133b6189786a095d35633f5420b.camel@unsw.edu.au>

Dear All,

I think I have something that works and may even work as a more general
API for checking for LinkingTo ABI compatibility.

It's in 'ergm' 4.8.1 on CRAN, but would it be useful to anyone else if
I posted an explanation of how it works somewhere? Would a package that
provides this API for saving and checking ABI versions be useful to
anyone?

				Best,
				Pavel

On Sun, 2025-01-19 at 05:31 +0000, Pavel Krivitsky via R-package-devel
wrote:
> Thanks, Ivan! Replies below.
> 
> On Fri, 2025-01-17 at 16:50 +0300, Ivan Krylov wrote:
> > ? Fri, 17 Jan 2025 10:21:27 +0000
> > Pavel Krivitsky via R-package-devel <r-package-devel at r-project.org>
> > ?????:
> > 
> > > ?? 1. What is the best way to save this information? I have a
> > > ????? rudimentary implementation [1]
> > 
> > For now, this is the best way we have. Export the ABI version as an
> > include-time constant and as a registered callable. The LinkingTo
> > reverse dependencies can give the include-time constant to the
> > registered callable to compare the two versions.
> 
> Ben Bolker pointed out that since the code in R/ is executed at
> build-
> time, it is also possible to store the build-time ABI information
> entirely in R; the downside of this approach is that it requires
> instrumenting every client package rather than just the library
> package.
> 
> > I agree that we could do better and introduce an ABIversion: field
> > to
> > the DESCRIPTION file. R CMD INSTALL would write down the current
> > ABIversion of every package that the current package is LinkingTo
> > (into the installed package's DESCRIPTION or Meta/features.rds).
> > Later, the namespace loader would check the ABI versions and
> > provide
> > an informative message in case a LinkingTo dependency is updated
> > with
> > an incremented ABI version. A machine-readable list of ABI-level
> > dependencies should simplify the lives of the binary package
> > maintainers as well.
> 
> Yes, that would be great to have. (One nitpick: not just incremented,
> but different in either direction.)
> 
> AFAIK, for those platforms that use binaries, there is already a
> mechanism for downloading a different ZIP for a different version of
> R,
> but I believe it's accomplished simply by having a directory for
> every
> version of R with a potentially different ABI.
> 
> I suppose this could be generalised along the lines of a directory
> hierarchy of the form
> 
> /bin/windows/contrib/RVERSION/PKG_ABIVERSION/.../PKG_ABIVERSION/PKG_P
> KGVERSION.zip
> 
> with a nesting level for every LinkingTo package, in lexicographic
> order. Then, given the installed R version and the installed versions
> of each package in the LinkingTo list, a unique URL can be
> constructed.
> However, I don't know how practical this is and how likely to be
> implemented in the foreseeable future.
> 
> > > ?? 2. How to best test the C API without making updates
> > > impossible?
> > 
> > Would abi-compliance-checker [2] have helped there?
> 
> I meant specifically in the context of R CMD check; the only want to
> fully test the C API and associated facilities is to actually install
> the client package and see if it works.
> 
> That having been said, 'ergm' may be unusual in this, since the API
> is
> mostly used as a way for others to implement calculation of graph
> statistics that are then operated on by functions in 'ergm'. That is,
> rather than simply offering C functions for the client packages to
> use,
> 'ergm' calls C functions from those packages that it locates via
> R_FindSymbol(). Thus, it is helpful to test it as a part of 'ergm'
> itself rather than just reverse-dependency checks.
> 
> > > ?? 3. What should be done in case of a mismatch?
> > 
> > It's hard to guarantee anything when the ABI is broken. Maybe it's
> > completely harmless because your code will know that the new
> > structure member is not initialised. Maybe the wrong stack layout
> > will crash the process due to a return address mismatch, dooming
> > the
> > process from the first function call.k
> > 
> > > ???????? 1. Is there a way for 'ergm' to detect when a package
> > > LinkingTo it is being loaded?
> > 
> > With inline functions, you could make your every API call perform
> > ABI
> > version checking, but that obviously comes with potential
> > performance
> > problems:
> 
> The reason I ask is that the best time to inform the user of an ABI
> change is when the client package is loaded, and it would be helpful
> if
> this could be done without modifying the client package.
> 
> Is there a mechanism for the library package to monitor packages
> being
> loaded, and for each one check if it's LinkingTo it to do the version
> check?
> 
> > > ???????? 2. What should happen if a mismatch is detected? Should
> > > the
> > > loading be blocked (e.g., by having .onLoad() throw an error), or
> > > should it lead to a "use at your own risk" type warning?
> > 
> > The safest option would be to signal an error before any of the
> > potentially incompatible functions are called. It's probably
> > pragmatic to provide an "I know what I'm doing, void my warranty"
> > emergency override.
> 
> Probably an options() setting.
> 
> 				Best,
> 				Pavel
> 
> ______________________________________________
> R-package-devel at r-project.org?mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From john@c|@rke @end|ng |rom corner@tonenw@com  Wed Jan 22 14:33:22 2025
From: john@c|@rke @end|ng |rom corner@tonenw@com (John Clarke)
Date: Wed, 22 Jan 2025 14:33:22 +0100
Subject: [R-pkg-devel] 
 Rcpp: how best to include source from another Github repository
In-Reply-To: <20250121150453.6d63147a@arachnoid>
References: <CAF0e1n9yrb+M+csGMeYpfFm35-fe4s4B5-8H0fQ-ov8yckEqZQ@mail.gmail.com>
 <20250121150453.6d63147a@arachnoid>
Message-ID: <CAF0e1n_tG0BJe-Gs1tL5ah-Zx0A+VB2ZW_+i3L-0c3gaf=nV=g@mail.gmail.com>

Thanks Ivan, this is helpful. I'll do some more research. It would be nice
to have an Rcpp standard/recommended way to do this. I don't want to have a
non-standard ./src or ./data folder structure for my Rcpp package, but
these are the two relevant folders in my original repository. Maybe with
some sort of synlinking I could achieve this 'custom' folder/file mapping.
-John

On Tue, Jan 21, 2025 at 1:05?PM Ivan Krylov <ikrylov at disroot.org> wrote:

> ? Tue, 21 Jan 2025 11:57:46 +0100
> John Clarke <john.clarke at cornerstonenw.com> ?????:
>
> > Ideally, it would be nice to be able to pull the files from the
> > source repo using a tag/hash so that the only code change in the Rcpp
> > repo would be that reference rather than all the changes to the
> > shared source.
>
> I've been using Git submodules for this purpose:
>
> https://codeberg.org/aitap/Ropj/src/branch/master/src
>
> https://git-scm.com/book/en/v2/Git-Tools-Submodules
>
> Every time the upstream changes I have to update the commit pointer in
> my repository too, but other than that, it's been working fine. My
> .Rbuildignore filters out all the unnecessary files included in the
> upstream repository, leaving only the relevant source code in the
> resulting source package.
>
> The resulting repository must be cloned with --recurse-submodules (or,
> if forgotten, must be initialised with git submodule update --init);
> further updates to the tracked commit pointer must be applied with git
> submodule update. If the referenced repository becomes unavailable, it
> will be impossible to build the package.
>
> --
> Best regards,
> Ivan
>

	[[alternative HTML version deleted]]


From th|b@u|t@v@tter @end|ng |rom gm@||@com  Wed Jan 22 20:53:08 2025
From: th|b@u|t@v@tter @end|ng |rom gm@||@com (Thibault Vatter)
Date: Wed, 22 Jan 2025 20:53:08 +0100
Subject: [R-pkg-devel] 
 Rcpp: how best to include source from another Github repository
In-Reply-To: <CAF0e1n_tG0BJe-Gs1tL5ah-Zx0A+VB2ZW_+i3L-0c3gaf=nV=g@mail.gmail.com>
References: <CAF0e1n9yrb+M+csGMeYpfFm35-fe4s4B5-8H0fQ-ov8yckEqZQ@mail.gmail.com>
 <20250121150453.6d63147a@arachnoid>
 <CAF0e1n_tG0BJe-Gs1tL5ah-Zx0A+VB2ZW_+i3L-0c3gaf=nV=g@mail.gmail.com>
Message-ID: <CAFyih6DGV-08Zej6+F=wwS_8HC7x7tNiCi_X+R+isJjqBAkYPw@mail.gmail.com>

There is balance between DRY, safety, and customization needs. The
symlinkish approach would be "dangerous" imo, because you can't guarantee
the wrapper.cpp will stay compatible with changes in the underlying C++
library.

The submodule approach works well. Alternatives that I know of are:


   - a script that pulls the latest sources in the standalone C++ library
   and does things like adding a preprocessor macro, see e.g. rvinecopulib
   - a "patches" folder with patch files in diff format (.patch or .diff),
   see e.g. RcppEigen

Either way, such scripts or patches folders have to be excluded from being
put into the package via the .Rbuildignore.

On Wed, Jan 22, 2025, 2:33?PM John Clarke <john.clarke at cornerstonenw.com>
wrote:

> Thanks Ivan, this is helpful. I'll do some more research. It would be nice
> to have an Rcpp standard/recommended way to do this. I don't want to have a
> non-standard ./src or ./data folder structure for my Rcpp package, but
> these are the two relevant folders in my original repository. Maybe with
> some sort of synlinking I could achieve this 'custom' folder/file mapping.
> -John
>
> On Tue, Jan 21, 2025 at 1:05?PM Ivan Krylov <ikrylov at disroot.org> wrote:
>
> > ? Tue, 21 Jan 2025 11:57:46 +0100
> > John Clarke <john.clarke at cornerstonenw.com> ?????:
> >
> > > Ideally, it would be nice to be able to pull the files from the
> > > source repo using a tag/hash so that the only code change in the Rcpp
> > > repo would be that reference rather than all the changes to the
> > > shared source.
> >
> > I've been using Git submodules for this purpose:
> >
> > https://codeberg.org/aitap/Ropj/src/branch/master/src
> >
> > https://git-scm.com/book/en/v2/Git-Tools-Submodules
> >
> > Every time the upstream changes I have to update the commit pointer in
> > my repository too, but other than that, it's been working fine. My
> > .Rbuildignore filters out all the unnecessary files included in the
> > upstream repository, leaving only the relevant source code in the
> > resulting source package.
> >
> > The resulting repository must be cloned with --recurse-submodules (or,
> > if forgotten, must be initialised with git submodule update --init);
> > further updates to the tracked commit pointer must be applied with git
> > submodule update. If the referenced repository becomes unavailable, it
> > will be impossible to build the package.
> >
> > --
> > Best regards,
> > Ivan
> >
>
>         [[alternative HTML version deleted]]
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>

	[[alternative HTML version deleted]]


From john@c|@rke @end|ng |rom corner@tonenw@com  Thu Jan 23 14:21:18 2025
From: john@c|@rke @end|ng |rom corner@tonenw@com (John Clarke)
Date: Thu, 23 Jan 2025 14:21:18 +0100
Subject: [R-pkg-devel] 
 Rcpp: how best to include source from another Github repository
In-Reply-To: <CAFyih6DGV-08Zej6+F=wwS_8HC7x7tNiCi_X+R+isJjqBAkYPw@mail.gmail.com>
References: <CAF0e1n9yrb+M+csGMeYpfFm35-fe4s4B5-8H0fQ-ov8yckEqZQ@mail.gmail.com>
 <20250121150453.6d63147a@arachnoid>
 <CAF0e1n_tG0BJe-Gs1tL5ah-Zx0A+VB2ZW_+i3L-0c3gaf=nV=g@mail.gmail.com>
 <CAFyih6DGV-08Zej6+F=wwS_8HC7x7tNiCi_X+R+isJjqBAkYPw@mail.gmail.com>
Message-ID: <CAF0e1n_daqkBaAUsWKTJsXhqzTudQUu4Oqt37djrtc+E++btvA@mail.gmail.com>

Thank you Dirk and Thibault for your additional tips and ideas.

I took a look at the vignette for *rcppcorels* and noted that this is
exactly the model/pattern I used to create my package. And it appears that
the /src files are simply copied from the external *corels* C++ library
into the rcppcorel's /src folder. And committed twice: once in the external
C++ repo and again in the rcppcorels repo. That is what I do now, but I
wasn't satisfied with the double commits and also I'd really like users of
the R package to have a reference/version/tag to confirm that what they
have in the R package is the same as a particular release of the C++ repo.

But in the end, it appears that there is no easy (and robust) way to do
this other than copy the files (via script or manually) and re-commit
changes in both repos. I suppose I could add a reference to the tag from
the C++ library, but this step can easily get lost/forgotten and is a
definite DRY violation. Maybe an import/copy script could help with that.

Thanks again for your help and suggestions.

-John











On Wed, Jan 22, 2025 at 8:53?PM Thibault Vatter <thibault.vatter at gmail.com>
wrote:

> There is balance between DRY, safety, and customization needs. The
> symlinkish approach would be "dangerous" imo, because you can't guarantee
> the wrapper.cpp will stay compatible with changes in the underlying C++
> library.
>
> The submodule approach works well. Alternatives that I know of are:
>
>
>    - a script that pulls the latest sources in the standalone C++ library
>    and does things like adding a preprocessor macro, see e.g. rvinecopulib
>    - a "patches" folder with patch files in diff format (.patch or
>    .diff), see e.g. RcppEigen
>
> Either way, such scripts or patches folders have to be excluded from being
> put into the package via the .Rbuildignore.
>
> On Wed, Jan 22, 2025, 2:33?PM John Clarke <john.clarke at cornerstonenw.com>
> wrote:
>
>> Thanks Ivan, this is helpful. I'll do some more research. It would be nice
>> to have an Rcpp standard/recommended way to do this. I don't want to have
>> a
>> non-standard ./src or ./data folder structure for my Rcpp package, but
>> these are the two relevant folders in my original repository. Maybe with
>> some sort of synlinking I could achieve this 'custom' folder/file mapping.
>> -John
>>
>> On Tue, Jan 21, 2025 at 1:05?PM Ivan Krylov <ikrylov at disroot.org> wrote:
>>
>> > ? Tue, 21 Jan 2025 11:57:46 +0100
>> > John Clarke <john.clarke at cornerstonenw.com> ?????:
>> >
>> > > Ideally, it would be nice to be able to pull the files from the
>> > > source repo using a tag/hash so that the only code change in the Rcpp
>> > > repo would be that reference rather than all the changes to the
>> > > shared source.
>> >
>> > I've been using Git submodules for this purpose:
>> >
>> > https://codeberg.org/aitap/Ropj/src/branch/master/src
>> >
>> > https://git-scm.com/book/en/v2/Git-Tools-Submodules
>> >
>> > Every time the upstream changes I have to update the commit pointer in
>> > my repository too, but other than that, it's been working fine. My
>> > .Rbuildignore filters out all the unnecessary files included in the
>> > upstream repository, leaving only the relevant source code in the
>> > resulting source package.
>> >
>> > The resulting repository must be cloned with --recurse-submodules (or,
>> > if forgotten, must be initialised with git submodule update --init);
>> > further updates to the tracked commit pointer must be applied with git
>> > submodule update. If the referenced repository becomes unavailable, it
>> > will be impossible to build the package.
>> >
>> > --
>> > Best regards,
>> > Ivan
>> >
>>
>>         [[alternative HTML version deleted]]
>>
>> ______________________________________________
>> R-package-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>>
>

	[[alternative HTML version deleted]]


From jon@th@n @end|ng |rom berr|@ch@b|z  Tue Jan 21 12:04:52 2025
From: jon@th@n @end|ng |rom berr|@ch@b|z (Jonathan Berrisch)
Date: Tue, 21 Jan 2025 12:04:52 +0100
Subject: [R-pkg-devel] 
 Rcpp: how best to include source from another Github repository
In-Reply-To: <CAF0e1n9yrb+M+csGMeYpfFm35-fe4s4B5-8H0fQ-ov8yckEqZQ@mail.gmail.com>
References: <CAF0e1n9yrb+M+csGMeYpfFm35-fe4s4B5-8H0fQ-ov8yckEqZQ@mail.gmail.com>
Message-ID: <e800be15-576a-477a-8de5-69cf9733e244@berrisch.biz>

Hi John,

first of all: I'm not an expert on this and don't really know if there 
is a recommended way.

However, you may look at my 'rcpptimer' package and how it includes 
'cpptimer' as a submodule.

You can find the repository here: https://github.com/BerriJ/rcpptimer

And here you can see 'cpptimer' which is included as a submodule: 
https://github.com/BerriJ/rcpptimer/tree/main/inst/include

Whenever I make commits to 'cpptimer' I have to update the submodule 
(basically changing at what commit I want to have that submodule 
included 'git submodule update --remote'). You'll find good 
documentation about submodules online.

Maybe that helps.

Best Regards,

Jonathan / BerriJ


On 1/21/25 11:57, John Clarke wrote:
> Hi folks,
>
> I have an Rcpp package I'm developing. All but one of the cpp source code
> files are pulled from the original/authoritative (CLI) version of the
> application. The only unique cpp source code to the Rcpp package is my
> wrapper.cpp which contains the Rcpp interface. This approach works fine,
> but every time we make changes to the original CLI repository, it requires
> a manual (and duplicate) commit to my Rcpp repo. This is not ideal from a
> source tracking perspective and is a DRY violation.
>
> What is the recommended way of maintaining the shared cpp code in a Rcpp
> repo? Ideally, it would be nice to be able to pull the files from the
> source repo using a tag/hash so that the only code change in the Rcpp repo
> would be that reference rather than all the changes to the shared source.
> It would also be nice to use some sort of symlinkish setup during
> development to allow quick testing before making commits in the original
> CLI repo. Is this possible? Recommended? (we can assume dev is on MacOS or
> Linux)
>
> Thanks,
>
> -John
>
> John Clarke | Senior Technical Advisor |
> Cornerstone Systems Northwest | john.clarke at cornerstonenw.com
>
> 	[[alternative HTML version deleted]]
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>


From john@c|@rke @end|ng |rom corner@tonenw@com  Thu Jan 23 15:22:09 2025
From: john@c|@rke @end|ng |rom corner@tonenw@com (John Clarke)
Date: Thu, 23 Jan 2025 15:22:09 +0100
Subject: [R-pkg-devel] 
 Rcpp: how best to include source from another Github repository
In-Reply-To: <e800be15-576a-477a-8de5-69cf9733e244@berrisch.biz>
References: <CAF0e1n9yrb+M+csGMeYpfFm35-fe4s4B5-8H0fQ-ov8yckEqZQ@mail.gmail.com>
 <e800be15-576a-477a-8de5-69cf9733e244@berrisch.biz>
Message-ID: <CAF0e1n_0UQOv2PejP7hky1c0bo7Ke+G8zvBxVs+BUR5yUOsw4Q@mail.gmail.com>

Thanks Jonathan, this is helpful. I'm just a bit concerned based on other
comments that submodules might not be compatible with CRAN and/or other CI
runners. Plus, I only want a few cpp files copied over.

On Thu, Jan 23, 2025 at 3:19?PM Jonathan Berrisch <jonathan at berrisch.biz>
wrote:

> Hi John,
>
> first of all: I'm not an expert on this and don't really know if there
> is a recommended way.
>
> However, you may look at my 'rcpptimer' package and how it includes
> 'cpptimer' as a submodule.
>
> You can find the repository here: https://github.com/BerriJ/rcpptimer
>
> And here you can see 'cpptimer' which is included as a submodule:
> https://github.com/BerriJ/rcpptimer/tree/main/inst/include
>
> Whenever I make commits to 'cpptimer' I have to update the submodule
> (basically changing at what commit I want to have that submodule
> included 'git submodule update --remote'). You'll find good
> documentation about submodules online.
>
> Maybe that helps.
>
> Best Regards,
>
> Jonathan / BerriJ
>
>
> On 1/21/25 11:57, John Clarke wrote:
> > Hi folks,
> >
> > I have an Rcpp package I'm developing. All but one of the cpp source code
> > files are pulled from the original/authoritative (CLI) version of the
> > application. The only unique cpp source code to the Rcpp package is my
> > wrapper.cpp which contains the Rcpp interface. This approach works fine,
> > but every time we make changes to the original CLI repository, it
> requires
> > a manual (and duplicate) commit to my Rcpp repo. This is not ideal from a
> > source tracking perspective and is a DRY violation.
> >
> > What is the recommended way of maintaining the shared cpp code in a Rcpp
> > repo? Ideally, it would be nice to be able to pull the files from the
> > source repo using a tag/hash so that the only code change in the Rcpp
> repo
> > would be that reference rather than all the changes to the shared source.
> > It would also be nice to use some sort of symlinkish setup during
> > development to allow quick testing before making commits in the original
> > CLI repo. Is this possible? Recommended? (we can assume dev is on MacOS
> or
> > Linux)
> >
> > Thanks,
> >
> > -John
> >
> > John Clarke | Senior Technical Advisor |
> > Cornerstone Systems Northwest | john.clarke at cornerstonenw.com
> >
> >       [[alternative HTML version deleted]]
> >
> > ______________________________________________
> > R-package-devel at r-project.org mailing list
> > https://stat.ethz.ch/mailman/listinfo/r-package-devel
> >
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>

	[[alternative HTML version deleted]]


From edd @end|ng |rom deb|@n@org  Thu Jan 23 15:47:49 2025
From: edd @end|ng |rom deb|@n@org (Dirk Eddelbuettel)
Date: Thu, 23 Jan 2025 08:47:49 -0600
Subject: [R-pkg-devel] 
 Rcpp: how best to include source from another Github repository
In-Reply-To: <e800be15-576a-477a-8de5-69cf9733e244@berrisch.biz>
References: <CAF0e1n9yrb+M+csGMeYpfFm35-fe4s4B5-8H0fQ-ov8yckEqZQ@mail.gmail.com>
 <e800be15-576a-477a-8de5-69cf9733e244@berrisch.biz>
Message-ID: <26514.22165.946108.992254@rob.eddelbuettel.com>


On 21 January 2025 at 12:04, Jonathan Berrisch wrote:
| first of all: I'm not an expert on this and don't really know if there 
| is a recommended way.
| 
| However, you may look at my 'rcpptimer' package and how it includes 
| 'cpptimer' as a submodule.
| 
| You can find the repository here: https://github.com/BerriJ/rcpptimer

I had written a longer (private) email to John expressing the view that git
submodules "were once more 'en vogue'" but one sees them less these days.
One reason is that they break some (somewhat standard) workflows, see below.

Overall, this is "no win" situation. You can include the files in the package
as a copy [2] enlarging the package, build process, etc but arguably making
it more robust, or you can keep it external which is cleaner -- but harder as
you now have to ensure users (and CRAN !) can get / have that library.

So it is all tradeoffs one has to make.

Dirk


[1] Log from a standard r2u Ubuntu container, `git` and `ssh` added as needed:

root at 4163d5544547:/# installGithub.r https://github.com/BerriJ/rcpptimer
Downloading GitHub repo BerriJ/rcpptimer at HEAD
'/usr/bin/git' clone --depth 1 --no-hardlinks --recurse-submodules git at github.com:BerriJ/cpptimer.git /tmp/remotes257564d64e0/BerriJ-rcpptimer-35ca024/inst/include/cpptimer
Cloning into '/tmp/remotes257564d64e0/BerriJ-rcpptimer-35ca024/inst/include/cpptimer'...
The authenticity of host 'github.com (140.82.113.3)' can't be established.
ED25519 key fingerprint is SHA256:+DiY3wvvV6TuJJhbpZisF/zLDA0zPMSvHdkr4UvCOqU.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'github.com' (ED25519) to the list of known hosts.
git at github.com: Permission denied (publickey).
fatal: Could not read from remote repository.

Please make sure you have the correct access rights
and the repository exists.
Error: Failed to install 'rcpptimer' from GitHub:
  Command failed (128)
In addition: Warning message:
In system(full, intern = TRUE, ignore.stderr = quiet) :
  running command ''/usr/bin/git' clone --depth 1 --no-hardlinks --recurse-submodules git at github.com:BerriJ/cpptimer.git /tmp/remotes257564d64e0/BerriJ-rcpptimer-35ca024/inst/include/cpptimer' had status 128 and error message 'Function not implemented'
root at 4163d5544547:/# 
exit


[2] The "Rcpp-library" vignette John refers to also mentions (IIRC) that this
is preferable for smaller libraries; its 'corels' example fits that
description.  These days other authors also vendor entire applications such
as whole SQL engines: ?\_(?)_/?  I just updated qlcal on CRAN, it explicitly
copies the calendaring (subset) from QuantLib as I learned over 20 years that
users have difficulties with that large library. Tradeoffs.

-- 
dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org


From murr@y@e||ord @end|ng |rom ot@go@@c@nz  Fri Jan 24 02:13:44 2025
From: murr@y@e||ord @end|ng |rom ot@go@@c@nz (Murray Efford)
Date: Fri, 24 Jan 2025 01:13:44 +0000
Subject: [R-pkg-devel] Pre-test failure with RcppParallel on Windows R-devel
Message-ID: <SY2PR01MB2539F7680A28FE027A7BF77EACE32@SY2PR01MB2539.ausprd01.prod.outlook.com>

Submitting secr 5.2.0 I get this pre-test installation ERROR which is opaque to me. I haven't changed the relevant code, and the package passes checks on Winbuilder (below) and other systems (with a false positive URL fail NOTE).

* checking whether package 'secr' can be installed ... ERROR Installation failed. See 'd:/RCompile/CRANincoming/R-devel/secr.Rcheck/00install.out' for details.
which includes
undefined reference to `RcppParallel::tbbParallelFor(unsigned long long, unsigned long long, RcppParallel::Worker&, unsigned long long, int)'

Winbuilder and the CRAN precheck appear to use identical settings:

* using log directory 'd:/RCompile/CRANguest/R-devel/secr.Rcheck'
* using R Under development (unstable) (2025-01-22 r87618 ucrt)
* using platform: x86_64-w64-mingw32
* R was compiled by
    gcc.exe (GCC) 13.3.0
    GNU Fortran (GCC) 13.3.0
* running under: Windows Server 2022 x64 (build 20348)

Any ideas? I'm guessing it's a transient CRAN problem.




	[[alternative HTML version deleted]]


From kev|nu@hey @end|ng |rom gm@||@com  Fri Jan 24 03:10:35 2025
From: kev|nu@hey @end|ng |rom gm@||@com (Kevin Ushey)
Date: Thu, 23 Jan 2025 18:10:35 -0800
Subject: [R-pkg-devel] 
 Pre-test failure with RcppParallel on Windows R-devel
In-Reply-To: <SY2PR01MB2539F7680A28FE027A7BF77EACE32@SY2PR01MB2539.ausprd01.prod.outlook.com>
References: <SY2PR01MB2539F7680A28FE027A7BF77EACE32@SY2PR01MB2539.ausprd01.prod.outlook.com>
Message-ID: <CAJXgQP1Bb1KFA4wH9+P3hNu1yLPus_aBgtzJktVOfCadA5S1QA@mail.gmail.com>

Hi Murray,

(repeating some of the conversation we had off-list)

Sorry for the trouble -- I was just in the process of submitting
RcppParallel to CRAN, and the first submission I made had this same
issue. That should now be fixed up with RcppParallel 5.1.10, which is
now on CRAN. Hopefully your next submission should go smoothly.

Thanks,
Kevin

On Thu, Jan 23, 2025 at 5:14?PM Murray Efford via R-package-devel
<r-package-devel at r-project.org> wrote:
>
> Submitting secr 5.2.0 I get this pre-test installation ERROR which is opaque to me. I haven't changed the relevant code, and the package passes checks on Winbuilder (below) and other systems (with a false positive URL fail NOTE).
>
> * checking whether package 'secr' can be installed ... ERROR Installation failed. See 'd:/RCompile/CRANincoming/R-devel/secr.Rcheck/00install.out' for details.
> which includes
> undefined reference to `RcppParallel::tbbParallelFor(unsigned long long, unsigned long long, RcppParallel::Worker&, unsigned long long, int)'
>
> Winbuilder and the CRAN precheck appear to use identical settings:
>
> * using log directory 'd:/RCompile/CRANguest/R-devel/secr.Rcheck'
> * using R Under development (unstable) (2025-01-22 r87618 ucrt)
> * using platform: x86_64-w64-mingw32
> * R was compiled by
>     gcc.exe (GCC) 13.3.0
>     GNU Fortran (GCC) 13.3.0
> * running under: Windows Server 2022 x64 (build 20348)
>
> Any ideas? I'm guessing it's a transient CRAN problem.
>
>
>
>
>         [[alternative HTML version deleted]]
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


