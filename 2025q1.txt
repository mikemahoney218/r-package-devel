From ||u|@@rev|||@ @end|ng |rom gm@||@com  Thu Jan  2 15:55:39 2025
From: ||u|@@rev|||@ @end|ng |rom gm@||@com (=?UTF-8?Q?Llu=C3=ADs_Revilla?=)
Date: Thu, 2 Jan 2025 15:55:39 +0100
Subject: [R-pkg-devel] Removing packages files
Message-ID: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>

Hi list,

I am developing a package that will download some data, and I'd like
to store it locally to not recalculate it often.
The CRAN policy requires tools::R_user_dir to be used and "the
contents are actively managed (including removing outdated material)"
or using TMPDIR but "such usage should be cleaned up".

When loading a package there is .onLoad or .onAttach to fill or check
those files and other settings required for a package. Is there
something for when a package is removed?

I found some related functions like .Last or reg.fnalizer and setHook
or packageEvent but they are about closing a session or don't have a
specific event for when uninstalling packages via (remove.packages). I
appreciate any feedback, thanks in advance.

Best wishes and a happy new year,

Llu?s


From murdoch@dunc@n @end|ng |rom gm@||@com  Thu Jan  2 17:23:40 2025
From: murdoch@dunc@n @end|ng |rom gm@||@com (Duncan Murdoch)
Date: Thu, 2 Jan 2025 11:23:40 -0500
Subject: [R-pkg-devel] Removing packages files
In-Reply-To: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
References: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
Message-ID: <fa376599-ff9f-4509-bc41-c5f8c0f8e9c9@gmail.com>

On 2025-01-02 9:55 a.m., Llu?s Revilla wrote:
> Hi list,
> 
> I am developing a package that will download some data, and I'd like
> to store it locally to not recalculate it often.
> The CRAN policy requires tools::R_user_dir to be used and "the
> contents are actively managed (including removing outdated material)"
> or using TMPDIR but "such usage should be cleaned up".
> 
> When loading a package there is .onLoad or .onAttach to fill or check
> those files and other settings required for a package. Is there
> something for when a package is removed?
> 
> I found some related functions like .Last or reg.fnalizer and setHook
> or packageEvent but they are about closing a session or don't have a
> specific event for when uninstalling packages via (remove.packages). I
> appreciate any feedback, thanks in advance.
> 

Yes, those are described in section "1.5.3 Load hooks" of writing R 
extensions:

"Packages can use a .onDetach or .Last.lib function (provided the latter 
is exported from the namespace) when detach is called on the package. It 
is called with a single argument, the full path to the installed 
package. There is also a hook .onUnload which is called when the 
namespace is unloaded (via a call to unloadNamespace, perhaps called by 
detach(unload = TRUE)) with argument the full path to the installed 
package?s directory. Functions .onUnload and .onDetach should be defined 
in the namespace and not exported, but .Last.lib does need to be exported."

Duncan Murdoch


From ||u|@@rev|||@ @end|ng |rom gm@||@com  Thu Jan  2 22:29:18 2025
From: ||u|@@rev|||@ @end|ng |rom gm@||@com (=?UTF-8?Q?Llu=C3=ADs_Revilla?=)
Date: Thu, 2 Jan 2025 22:29:18 +0100
Subject: [R-pkg-devel] Removing packages files
In-Reply-To: <fa376599-ff9f-4509-bc41-c5f8c0f8e9c9@gmail.com>
References: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
 <fa376599-ff9f-4509-bc41-c5f8c0f8e9c9@gmail.com>
Message-ID: <CAN+W6_v3opSqb54GP=uo5O_MpA5Do+m3cR_1GyPdUCxJWRqV3Q@mail.gmail.com>

Dear Duncan,

Thank you for your answer. I checked again and made a mock package
that removes a file with .onDetach.
The file was not removed upon uninstalling the package.

Llu?s

On Thu, 2 Jan 2025 at 17:23, Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
>
> On 2025-01-02 9:55 a.m., Llu?s Revilla wrote:
> > Hi list,
> >
> > I am developing a package that will download some data, and I'd like
> > to store it locally to not recalculate it often.
> > The CRAN policy requires tools::R_user_dir to be used and "the
> > contents are actively managed (including removing outdated material)"
> > or using TMPDIR but "such usage should be cleaned up".
> >
> > When loading a package there is .onLoad or .onAttach to fill or check
> > those files and other settings required for a package. Is there
> > something for when a package is removed?
> >
> > I found some related functions like .Last or reg.fnalizer and setHook
> > or packageEvent but they are about closing a session or don't have a
> > specific event for when uninstalling packages via (remove.packages). I
> > appreciate any feedback, thanks in advance.
> >
>
> Yes, those are described in section "1.5.3 Load hooks" of writing R
> extensions:
>
> "Packages can use a .onDetach or .Last.lib function (provided the latter
> is exported from the namespace) when detach is called on the package. It
> is called with a single argument, the full path to the installed
> package. There is also a hook .onUnload which is called when the
> namespace is unloaded (via a call to unloadNamespace, perhaps called by
> detach(unload = TRUE)) with argument the full path to the installed
> package?s directory. Functions .onUnload and .onDetach should be defined
> in the namespace and not exported, but .Last.lib does need to be exported."
>
> Duncan Murdoch
>


From henr|k@bengt@@on @end|ng |rom gm@||@com  Thu Jan  2 22:41:59 2025
From: henr|k@bengt@@on @end|ng |rom gm@||@com (Henrik Bengtsson)
Date: Thu, 2 Jan 2025 13:41:59 -0800
Subject: [R-pkg-devel] Removing packages files
In-Reply-To: <CAN+W6_v3opSqb54GP=uo5O_MpA5Do+m3cR_1GyPdUCxJWRqV3Q@mail.gmail.com>
References: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
 <fa376599-ff9f-4509-bc41-c5f8c0f8e9c9@gmail.com>
 <CAN+W6_v3opSqb54GP=uo5O_MpA5Do+m3cR_1GyPdUCxJWRqV3Q@mail.gmail.com>
Message-ID: <CAFDcVCQxDLka17fGx4XzdLUOCV4aV2B8GHRaqzhCvgzsxMHtjg@mail.gmail.com>

As a first step, this sounds like something for the 'tools' package,
e.g. tools::cleanup_R_user_dir() that wipes package subfolders of
packages no longer installed, or the specified package, iff given.
With that in place, one could argue for adding a 'cleanup' argument to
remove.packages() that use the former.

Agree, it would be neat if a package could clean up after itself when
uninstalled.

/Henrik

On Thu, Jan 2, 2025 at 1:37?PM Llu?s Revilla <lluis.revilla at gmail.com> wrote:
>
> Dear Duncan,
>
> Thank you for your answer. I checked again and made a mock package
> that removes a file with .onDetach.
> The file was not removed upon uninstalling the package.
>
> Llu?s
>
> On Thu, 2 Jan 2025 at 17:23, Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
> >
> > On 2025-01-02 9:55 a.m., Llu?s Revilla wrote:
> > > Hi list,
> > >
> > > I am developing a package that will download some data, and I'd like
> > > to store it locally to not recalculate it often.
> > > The CRAN policy requires tools::R_user_dir to be used and "the
> > > contents are actively managed (including removing outdated material)"
> > > or using TMPDIR but "such usage should be cleaned up".
> > >
> > > When loading a package there is .onLoad or .onAttach to fill or check
> > > those files and other settings required for a package. Is there
> > > something for when a package is removed?
> > >
> > > I found some related functions like .Last or reg.fnalizer and setHook
> > > or packageEvent but they are about closing a session or don't have a
> > > specific event for when uninstalling packages via (remove.packages). I
> > > appreciate any feedback, thanks in advance.
> > >
> >
> > Yes, those are described in section "1.5.3 Load hooks" of writing R
> > extensions:
> >
> > "Packages can use a .onDetach or .Last.lib function (provided the latter
> > is exported from the namespace) when detach is called on the package. It
> > is called with a single argument, the full path to the installed
> > package. There is also a hook .onUnload which is called when the
> > namespace is unloaded (via a call to unloadNamespace, perhaps called by
> > detach(unload = TRUE)) with argument the full path to the installed
> > package?s directory. Functions .onUnload and .onDetach should be defined
> > in the namespace and not exported, but .Last.lib does need to be exported."
> >
> > Duncan Murdoch
> >
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From murdoch@dunc@n @end|ng |rom gm@||@com  Thu Jan  2 22:47:21 2025
From: murdoch@dunc@n @end|ng |rom gm@||@com (Duncan Murdoch)
Date: Thu, 2 Jan 2025 16:47:21 -0500
Subject: [R-pkg-devel] Removing packages files
In-Reply-To: <CAN+W6_v3opSqb54GP=uo5O_MpA5Do+m3cR_1GyPdUCxJWRqV3Q@mail.gmail.com>
References: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
 <fa376599-ff9f-4509-bc41-c5f8c0f8e9c9@gmail.com>
 <CAN+W6_v3opSqb54GP=uo5O_MpA5Do+m3cR_1GyPdUCxJWRqV3Q@mail.gmail.com>
Message-ID: <7d36ce00-c0b0-458f-ac50-5aa577396acc@gmail.com>

Sorry, I misunderstood what you are after.  I thought you only wanted to 
keep it for the duration of a session.  I don't think there's a way to 
keep a file beyond the current session, but uninstall it later when the 
package is uninstalled.

I think the way you should handle this is to offer a function to the 
user to download the data to the user directory, not to ever do that 
automatically.  If the data hasn't been downloaded, then give the user a 
message that it needs to be downloaded for things to work.  (Or maybe 
download it to the temp directory, and delete it when your package is 
unloaded.)

Duncan Murdoch


On 2025-01-02 4:29 p.m., Llu?s Revilla wrote:
> Dear Duncan,
> 
> Thank you for your answer. I checked again and made a mock package
> that removes a file with .onDetach.
> The file was not removed upon uninstalling the package.
> 
> Llu?s
> 
> On Thu, 2 Jan 2025 at 17:23, Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
>>
>> On 2025-01-02 9:55 a.m., Llu?s Revilla wrote:
>>> Hi list,
>>>
>>> I am developing a package that will download some data, and I'd like
>>> to store it locally to not recalculate it often.
>>> The CRAN policy requires tools::R_user_dir to be used and "the
>>> contents are actively managed (including removing outdated material)"
>>> or using TMPDIR but "such usage should be cleaned up".
>>>
>>> When loading a package there is .onLoad or .onAttach to fill or check
>>> those files and other settings required for a package. Is there
>>> something for when a package is removed?
>>>
>>> I found some related functions like .Last or reg.fnalizer and setHook
>>> or packageEvent but they are about closing a session or don't have a
>>> specific event for when uninstalling packages via (remove.packages). I
>>> appreciate any feedback, thanks in advance.
>>>
>>
>> Yes, those are described in section "1.5.3 Load hooks" of writing R
>> extensions:
>>
>> "Packages can use a .onDetach or .Last.lib function (provided the latter
>> is exported from the namespace) when detach is called on the package. It
>> is called with a single argument, the full path to the installed
>> package. There is also a hook .onUnload which is called when the
>> namespace is unloaded (via a call to unloadNamespace, perhaps called by
>> detach(unload = TRUE)) with argument the full path to the installed
>> package?s directory. Functions .onUnload and .onDetach should be defined
>> in the namespace and not exported, but .Last.lib does need to be exported."
>>
>> Duncan Murdoch
>>


From ||u|@@rev|||@ @end|ng |rom gm@||@com  Fri Jan  3 16:04:01 2025
From: ||u|@@rev|||@ @end|ng |rom gm@||@com (=?UTF-8?Q?Llu=C3=ADs_Revilla?=)
Date: Fri, 3 Jan 2025 16:04:01 +0100
Subject: [R-pkg-devel] Removing packages files
In-Reply-To: <CAFDcVCQxDLka17fGx4XzdLUOCV4aV2B8GHRaqzhCvgzsxMHtjg@mail.gmail.com>
References: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
 <fa376599-ff9f-4509-bc41-c5f8c0f8e9c9@gmail.com>
 <CAN+W6_v3opSqb54GP=uo5O_MpA5Do+m3cR_1GyPdUCxJWRqV3Q@mail.gmail.com>
 <CAFDcVCQxDLka17fGx4XzdLUOCV4aV2B8GHRaqzhCvgzsxMHtjg@mail.gmail.com>
Message-ID: <CAN+W6_uipwj9WopA1Dk5VA9aY1=7HM=XoixWUMXrYPtHj9id_Q@mail.gmail.com>

Thanks Henrik for confirming there is nothing similar currently.

Duncan: Letting the user choose when to remove the folder/data at will is easy.
I was trying to ensure that the system is clean after removing the package.
Thanks.

On Thu, 2 Jan 2025 at 22:42, Henrik Bengtsson
<henrik.bengtsson at gmail.com> wrote:
>
> As a first step, this sounds like something for the 'tools' package,
> e.g. tools::cleanup_R_user_dir() that wipes package subfolders of
> packages no longer installed, or the specified package, iff given.
> With that in place, one could argue for adding a 'cleanup' argument to
> remove.packages() that use the former.
>
> Agree, it would be neat if a package could clean up after itself when
> uninstalled.
>
> /Henrik
>
> On Thu, Jan 2, 2025 at 1:37?PM Llu?s Revilla <lluis.revilla at gmail.com> wrote:
> >
> > Dear Duncan,
> >
> > Thank you for your answer. I checked again and made a mock package
> > that removes a file with .onDetach.
> > The file was not removed upon uninstalling the package.
> >
> > Llu?s
> >
> > On Thu, 2 Jan 2025 at 17:23, Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
> > >
> > > On 2025-01-02 9:55 a.m., Llu?s Revilla wrote:
> > > > Hi list,
> > > >
> > > > I am developing a package that will download some data, and I'd like
> > > > to store it locally to not recalculate it often.
> > > > The CRAN policy requires tools::R_user_dir to be used and "the
> > > > contents are actively managed (including removing outdated material)"
> > > > or using TMPDIR but "such usage should be cleaned up".
> > > >
> > > > When loading a package there is .onLoad or .onAttach to fill or check
> > > > those files and other settings required for a package. Is there
> > > > something for when a package is removed?
> > > >
> > > > I found some related functions like .Last or reg.fnalizer and setHook
> > > > or packageEvent but they are about closing a session or don't have a
> > > > specific event for when uninstalling packages via (remove.packages). I
> > > > appreciate any feedback, thanks in advance.
> > > >
> > >
> > > Yes, those are described in section "1.5.3 Load hooks" of writing R
> > > extensions:
> > >
> > > "Packages can use a .onDetach or .Last.lib function (provided the latter
> > > is exported from the namespace) when detach is called on the package. It
> > > is called with a single argument, the full path to the installed
> > > package. There is also a hook .onUnload which is called when the
> > > namespace is unloaded (via a call to unloadNamespace, perhaps called by
> > > detach(unload = TRUE)) with argument the full path to the installed
> > > package?s directory. Functions .onUnload and .onDetach should be defined
> > > in the namespace and not exported, but .Last.lib does need to be exported."
> > >
> > > Duncan Murdoch
> > >
> >
> > ______________________________________________
> > R-package-devel at r-project.org mailing list
> > https://stat.ethz.ch/mailman/listinfo/r-package-devel


From murdoch@dunc@n @end|ng |rom gm@||@com  Fri Jan  3 17:23:32 2025
From: murdoch@dunc@n @end|ng |rom gm@||@com (Duncan Murdoch)
Date: Fri, 3 Jan 2025 11:23:32 -0500
Subject: [R-pkg-devel] Removing packages files
In-Reply-To: <CAN+W6_uipwj9WopA1Dk5VA9aY1=7HM=XoixWUMXrYPtHj9id_Q@mail.gmail.com>
References: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
 <fa376599-ff9f-4509-bc41-c5f8c0f8e9c9@gmail.com>
 <CAN+W6_v3opSqb54GP=uo5O_MpA5Do+m3cR_1GyPdUCxJWRqV3Q@mail.gmail.com>
 <CAFDcVCQxDLka17fGx4XzdLUOCV4aV2B8GHRaqzhCvgzsxMHtjg@mail.gmail.com>
 <CAN+W6_uipwj9WopA1Dk5VA9aY1=7HM=XoixWUMXrYPtHj9id_Q@mail.gmail.com>
Message-ID: <7cca8298-6e75-429f-ac89-dba8a7a79929@gmail.com>

On 2025-01-03 10:04 a.m., Llu?s Revilla wrote:
> Thanks Henrik for confirming there is nothing similar currently.
> 
> Duncan: Letting the user choose when to remove the folder/data at will is easy.
> I was trying to ensure that the system is clean after removing the package.
> Thanks.

No, I was suggesting that you require the user to explicitly ask for the 
data.  You don't want CRAN to install the data during testing and then 
have it left behind at the end.

Duncan Murdoch

> 
> On Thu, 2 Jan 2025 at 22:42, Henrik Bengtsson
> <henrik.bengtsson at gmail.com> wrote:
>>
>> As a first step, this sounds like something for the 'tools' package,
>> e.g. tools::cleanup_R_user_dir() that wipes package subfolders of
>> packages no longer installed, or the specified package, iff given.
>> With that in place, one could argue for adding a 'cleanup' argument to
>> remove.packages() that use the former.
>>
>> Agree, it would be neat if a package could clean up after itself when
>> uninstalled.
>>
>> /Henrik
>>
>> On Thu, Jan 2, 2025 at 1:37?PM Llu?s Revilla <lluis.revilla at gmail.com> wrote:
>>>
>>> Dear Duncan,
>>>
>>> Thank you for your answer. I checked again and made a mock package
>>> that removes a file with .onDetach.
>>> The file was not removed upon uninstalling the package.
>>>
>>> Llu?s
>>>
>>> On Thu, 2 Jan 2025 at 17:23, Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
>>>>
>>>> On 2025-01-02 9:55 a.m., Llu?s Revilla wrote:
>>>>> Hi list,
>>>>>
>>>>> I am developing a package that will download some data, and I'd like
>>>>> to store it locally to not recalculate it often.
>>>>> The CRAN policy requires tools::R_user_dir to be used and "the
>>>>> contents are actively managed (including removing outdated material)"
>>>>> or using TMPDIR but "such usage should be cleaned up".
>>>>>
>>>>> When loading a package there is .onLoad or .onAttach to fill or check
>>>>> those files and other settings required for a package. Is there
>>>>> something for when a package is removed?
>>>>>
>>>>> I found some related functions like .Last or reg.fnalizer and setHook
>>>>> or packageEvent but they are about closing a session or don't have a
>>>>> specific event for when uninstalling packages via (remove.packages). I
>>>>> appreciate any feedback, thanks in advance.
>>>>>
>>>>
>>>> Yes, those are described in section "1.5.3 Load hooks" of writing R
>>>> extensions:
>>>>
>>>> "Packages can use a .onDetach or .Last.lib function (provided the latter
>>>> is exported from the namespace) when detach is called on the package. It
>>>> is called with a single argument, the full path to the installed
>>>> package. There is also a hook .onUnload which is called when the
>>>> namespace is unloaded (via a call to unloadNamespace, perhaps called by
>>>> detach(unload = TRUE)) with argument the full path to the installed
>>>> package?s directory. Functions .onUnload and .onDetach should be defined
>>>> in the namespace and not exported, but .Last.lib does need to be exported."
>>>>
>>>> Duncan Murdoch
>>>>
>>>
>>> ______________________________________________
>>> R-package-devel at r-project.org mailing list
>>> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From edd @end|ng |rom deb|@n@org  Fri Jan  3 17:34:17 2025
From: edd @end|ng |rom deb|@n@org (Dirk Eddelbuettel)
Date: Fri, 3 Jan 2025 10:34:17 -0600
Subject: [R-pkg-devel] Removing packages files
In-Reply-To: <CAFDcVCQxDLka17fGx4XzdLUOCV4aV2B8GHRaqzhCvgzsxMHtjg@mail.gmail.com>
References: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
 <fa376599-ff9f-4509-bc41-c5f8c0f8e9c9@gmail.com>
 <CAN+W6_v3opSqb54GP=uo5O_MpA5Do+m3cR_1GyPdUCxJWRqV3Q@mail.gmail.com>
 <CAFDcVCQxDLka17fGx4XzdLUOCV4aV2B8GHRaqzhCvgzsxMHtjg@mail.gmail.com>
Message-ID: <26488.4489.589883.44632@rob.eddelbuettel.com>


On 2 January 2025 at 13:41, Henrik Bengtsson wrote:
| Agree, it would be neat if a package could clean up after itself when
| uninstalled.

Indeed many things could be nicer if we had more package manager integrations
and hooks besides `cleanup` and `configure`.  Someone would have to start
with some patches to get the ball rolling.

Dirk

-- 
dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org


From ||u|@@rev|||@ @end|ng |rom gm@||@com  Fri Jan  3 17:46:36 2025
From: ||u|@@rev|||@ @end|ng |rom gm@||@com (=?UTF-8?Q?Llu=C3=ADs_Revilla?=)
Date: Fri, 3 Jan 2025 17:46:36 +0100
Subject: [R-pkg-devel] Removing packages files
In-Reply-To: <7cca8298-6e75-429f-ac89-dba8a7a79929@gmail.com>
References: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
 <fa376599-ff9f-4509-bc41-c5f8c0f8e9c9@gmail.com>
 <CAN+W6_v3opSqb54GP=uo5O_MpA5Do+m3cR_1GyPdUCxJWRqV3Q@mail.gmail.com>
 <CAFDcVCQxDLka17fGx4XzdLUOCV4aV2B8GHRaqzhCvgzsxMHtjg@mail.gmail.com>
 <CAN+W6_uipwj9WopA1Dk5VA9aY1=7HM=XoixWUMXrYPtHj9id_Q@mail.gmail.com>
 <7cca8298-6e75-429f-ac89-dba8a7a79929@gmail.com>
Message-ID: <CAN+W6_s4ihi_D65Ph=j7-zDSc+DrgR1J-nOECEPmerROZTJ=4A@mail.gmail.com>

The data is mostly CRAN's own files transformed, I don't expect the
download to be problematic on CRAN's checks.
The R core members made the functionality inside tools to use a local
variable to search for the requested file locally.
Only if the file is not found they are downloaded from the internet.

Regarding tests, I could disable saving the content to a file (Thanks
for mentioning, I hadn't thought about it).
But the functionality/utility of the package is to transform CRAN's data.
If it is failing to do so, I would like to know.

Llu?s

On Fri, 3 Jan 2025 at 17:23, Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
>
> On 2025-01-03 10:04 a.m., Llu?s Revilla wrote:
> > Thanks Henrik for confirming there is nothing similar currently.
> >
> > Duncan: Letting the user choose when to remove the folder/data at will is easy.
> > I was trying to ensure that the system is clean after removing the package.
> > Thanks.
>
> No, I was suggesting that you require the user to explicitly ask for the
> data.  You don't want CRAN to install the data during testing and then
> have it left behind at the end.
>
> Duncan Murdoch
>
> >
> > On Thu, 2 Jan 2025 at 22:42, Henrik Bengtsson
> > <henrik.bengtsson at gmail.com> wrote:
> >>
> >> As a first step, this sounds like something for the 'tools' package,
> >> e.g. tools::cleanup_R_user_dir() that wipes package subfolders of
> >> packages no longer installed, or the specified package, iff given.
> >> With that in place, one could argue for adding a 'cleanup' argument to
> >> remove.packages() that use the former.
> >>
> >> Agree, it would be neat if a package could clean up after itself when
> >> uninstalled.
> >>
> >> /Henrik
> >>
> >> On Thu, Jan 2, 2025 at 1:37?PM Llu?s Revilla <lluis.revilla at gmail.com> wrote:
> >>>
> >>> Dear Duncan,
> >>>
> >>> Thank you for your answer. I checked again and made a mock package
> >>> that removes a file with .onDetach.
> >>> The file was not removed upon uninstalling the package.
> >>>
> >>> Llu?s
> >>>
> >>> On Thu, 2 Jan 2025 at 17:23, Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
> >>>>
> >>>> On 2025-01-02 9:55 a.m., Llu?s Revilla wrote:
> >>>>> Hi list,
> >>>>>
> >>>>> I am developing a package that will download some data, and I'd like
> >>>>> to store it locally to not recalculate it often.
> >>>>> The CRAN policy requires tools::R_user_dir to be used and "the
> >>>>> contents are actively managed (including removing outdated material)"
> >>>>> or using TMPDIR but "such usage should be cleaned up".
> >>>>>
> >>>>> When loading a package there is .onLoad or .onAttach to fill or check
> >>>>> those files and other settings required for a package. Is there
> >>>>> something for when a package is removed?
> >>>>>
> >>>>> I found some related functions like .Last or reg.fnalizer and setHook
> >>>>> or packageEvent but they are about closing a session or don't have a
> >>>>> specific event for when uninstalling packages via (remove.packages). I
> >>>>> appreciate any feedback, thanks in advance.
> >>>>>
> >>>>
> >>>> Yes, those are described in section "1.5.3 Load hooks" of writing R
> >>>> extensions:
> >>>>
> >>>> "Packages can use a .onDetach or .Last.lib function (provided the latter
> >>>> is exported from the namespace) when detach is called on the package. It
> >>>> is called with a single argument, the full path to the installed
> >>>> package. There is also a hook .onUnload which is called when the
> >>>> namespace is unloaded (via a call to unloadNamespace, perhaps called by
> >>>> detach(unload = TRUE)) with argument the full path to the installed
> >>>> package?s directory. Functions .onUnload and .onDetach should be defined
> >>>> in the namespace and not exported, but .Last.lib does need to be exported."
> >>>>
> >>>> Duncan Murdoch
> >>>>
> >>>
> >>> ______________________________________________
> >>> R-package-devel at r-project.org mailing list
> >>> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>


From pep|jn@devr|e@ @end|ng |rom out|ook@com  Wed Jan  8 13:51:32 2025
From: pep|jn@devr|e@ @end|ng |rom out|ook@com (Pepijn de Vries)
Date: Wed, 8 Jan 2025 12:51:32 +0000
Subject: [R-pkg-devel] (no subject)
Message-ID: <AM8PR10MB466065432B7F9DA11EA0D279A7122@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>

Dear fellow package developers,

A while back I have submitted a package to CRAN and is now listed under waiting <https://cran.r-project.org/incoming/waiting/openmpt_0.1.1.tar.gz>

As I understand it, incoming packages are listed there if CRAN needs more information from the maintainer. However, I have received no requests from CRAN. In the meantime it has been stagnant in the waiting area for about 22 days.

After some more testing I discovered that the submitted package violates CRAN policy (it does not exit gracefully when online resources are not available). Maybe this is why it is on hold. This has been fixed in <https://github.com/pepijn-devries/openmpt>, but has not been submitted yet. How do I proceed? I think I have the following options:

 - wait even longer for feedback from CRAN;
 - contact CRAN about the status of this package;
 - submit the latest version of the package in which policy violations have been addressed.

Any thoughts are welcome.

Pepijn

From ||u|@@rev|||@ @end|ng |rom gm@||@com  Wed Jan  8 22:17:57 2025
From: ||u|@@rev|||@ @end|ng |rom gm@||@com (=?UTF-8?Q?Llu=C3=ADs_Revilla?=)
Date: Wed, 8 Jan 2025 22:17:57 +0100
Subject: [R-pkg-devel] (no subject)
In-Reply-To: <AM8PR10MB466065432B7F9DA11EA0D279A7122@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>
References: <AM8PR10MB466065432B7F9DA11EA0D279A7122@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>
Message-ID: <CAN+W6_u9v-XftUpdt0Fu9QZ+2u+Eh7RmxyFOqX+rV0entox0Mg@mail.gmail.com>

Dear Pepijn,

Thank you for the very detailed email.
Part of these 22 days might be explained by CRAN volunteers being on
vacations a couple of weeks, until yesterday.

I would submit the latest version of the package with the improvements you made.
Other options require more manual work from CRAN volunteers and/or more delays.
I'm sure they will appreciate you double checking CRAN policy to make
sure you comply with all the requirements.

To solve some common issues, there is a new resource co-authored by a
CRAN reviewer: the CRAN cookbook:
https://contributor.r-project.org/cran-cookbook/
I hope it helps.

Good luck!
Best,

Llu?s Revilla

PS: There are some issues on AmigaFFH package, you might receive a
message to update it.

On Wed, 8 Jan 2025 at 13:51, Pepijn de Vries <pepijn.devries at outlook.com> wrote:
>
> Dear fellow package developers,
>
> A while back I have submitted a package to CRAN and is now listed under waiting <https://cran.r-project.org/incoming/waiting/openmpt_0.1.1.tar.gz>
>
> As I understand it, incoming packages are listed there if CRAN needs more information from the maintainer. However, I have received no requests from CRAN. In the meantime it has been stagnant in the waiting area for about 22 days.
>
> After some more testing I discovered that the submitted package violates CRAN policy (it does not exit gracefully when online resources are not available). Maybe this is why it is on hold. This has been fixed in <https://github.com/pepijn-devries/openmpt>, but has not been submitted yet. How do I proceed? I think I have the following options:
>
>  - wait even longer for feedback from CRAN;
>  - contact CRAN about the status of this package;
>  - submit the latest version of the package in which policy violations have been addressed.
>
> Any thoughts are welcome.
>
> Pepijn
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From pep|jn@devr|e@ @end|ng |rom out|ook@com  Wed Jan  8 23:00:07 2025
From: pep|jn@devr|e@ @end|ng |rom out|ook@com (Pepijn de Vries)
Date: Wed, 8 Jan 2025 22:00:07 +0000
Subject: [R-pkg-devel] (no subject)
In-Reply-To: <CAN+W6_u9v-XftUpdt0Fu9QZ+2u+Eh7RmxyFOqX+rV0entox0Mg@mail.gmail.com>
References: <AM8PR10MB466065432B7F9DA11EA0D279A7122@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>
 <CAN+W6_u9v-XftUpdt0Fu9QZ+2u+Eh7RmxyFOqX+rV0entox0Mg@mail.gmail.com>
Message-ID: <AM8PR10MB466003A076F7723BBAAFCC0BA7122@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>

Hi Llu?s,

Thank you for you thoughts on this matter and recommendations. I will go ahead to submit the revised version as soon as possible.

Cheers,

Pepijn

________________________________________
Van:?Llu?s Revilla <lluis.revilla at gmail.com>
Verzonden:?woensdag 8 januari 2025 22:17
Aan:?Pepijn de Vries <pepijn.devries at outlook.com>
CC:?Ivan Krylov via R-package-devel <r-package-devel at r-project.org>
Onderwerp:?Re: [R-pkg-devel] (no subject)
?
Dear Pepijn,

Thank you for the very detailed email.
Part of these 22 days might be explained by CRAN volunteers being on
vacations a couple of weeks, until yesterday.

I would submit the latest version of the package with the improvements you made.
Other options require more manual work from CRAN volunteers and/or more delays.
I'm sure they will appreciate you double checking CRAN policy to make
sure you comply with all the requirements.

To solve some common issues, there is a new resource co-authored by a
CRAN reviewer: the CRAN cookbook:
https://contributor.r-project.org/cran-cookbook/
I hope it helps.

Good luck!
Best,

Llu?s Revilla

PS: There are some issues on AmigaFFH package, you might receive a
message to update it.

On Wed, 8 Jan 2025 at 13:51, Pepijn de Vries <pepijn.devries at outlook.com> wrote:
>
> Dear fellow package developers,
>
> A while back I have submitted a package to CRAN and is now listed under waiting <https://cran.r-project.org/incoming/waiting/openmpt_0.1.1.tar.gz>
>
> As I understand it, incoming packages are listed there if CRAN needs more information from the maintainer. However, I have received no requests from CRAN. In the meantime it has been stagnant in the waiting area for about 22 days.
>
> After some more testing I discovered that the submitted package violates CRAN policy (it does not exit gracefully when online resources are not available). Maybe this is why it is on hold. This has been fixed in <https://github.com/pepijn-devries/openmpt>, but has not been submitted yet. How do I proceed? I think I have the following options:
>
>? - wait even longer for feedback from CRAN;
>? - contact CRAN about the status of this package;
>? - submit the latest version of the package in which policy violations have been addressed.
>
> Any thoughts are welcome.
>
> Pepijn
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel

From vo|ody@ @end|ng |rom m|nd@pr|ng@com  Thu Jan  9 04:23:15 2025
From: vo|ody@ @end|ng |rom m|nd@pr|ng@com (Vladimir Dergachev)
Date: Wed, 8 Jan 2025 22:23:15 -0500 (EST)
Subject: [R-pkg-devel] Removing packages files
In-Reply-To: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
References: <CAN+W6_sjx59W6hGGMyj565smnazws=uasSWbwEHEe7kXT+YLAQ@mail.gmail.com>
Message-ID: <alpine.DEB.2.22.394.2501082220520.45848@iridium>


Hi Llu?s,

   Just wanted to add to the discussion that it would be good to consider 
users that are disconnected or behind a firewall and are installing the 
package from file.

   An option to point the package to a separately downloaded file would be
useful.

best

Vladimir Dergachev

On Thu, 2 Jan 2025, Llu?s Revilla wrote:

> Hi list,
>
> I am developing a package that will download some data, and I'd like
> to store it locally to not recalculate it often.
> The CRAN policy requires tools::R_user_dir to be used and "the
> contents are actively managed (including removing outdated material)"
> or using TMPDIR but "such usage should be cleaned up".
>
> When loading a package there is .onLoad or .onAttach to fill or check
> those files and other settings required for a package. Is there
> something for when a package is removed?
>
> I found some related functions like .Last or reg.fnalizer and setHook
> or packageEvent but they are about closing a session or don't have a
> specific event for when uninstalling packages via (remove.packages). I
> appreciate any feedback, thanks in advance.
>
> Best wishes and a happy new year,
>
> Llu?s
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>

From kent@r|emondy @end|ng |rom gm@||@com  Fri Jan 10 15:45:00 2025
From: kent@r|emondy @end|ng |rom gm@||@com (Kent Riemondy)
Date: Fri, 10 Jan 2025 07:45:00 -0700
Subject: [R-pkg-devel] addressing a CRAN submission pre-test clang-san
 warning
Message-ID: <CA+cnB_jbABqxCOsxuCA1-E5sJOf0qZBwrC7t1gNSAH3sHCPKig@mail.gmail.com>

Hi,
  I maintain a package on CRAN (valr) and recently submitted a new version.
The package is failing CRAN pre-test checks due to the warning below from
the clang-san test. The cleancall.c file referenced in the warning isn't in
valr's source code, nor direct dependencies, but eventually I believe
tracks back to the purrr package. Does anyone have any advice for how to
replicate or address this warning?

Flavor: r-devel-linux-x86_64-debian-special-clang-san
Check: Post-processing issues found for clang-san, Result: WARNING
  File: valr-Ex.Rout
  cleancall.c:110:46: runtime error: call to function cb_progress_done
through pointer to incorrect function type 'void (*)(void *)'

  File: tests/testthat.Rout
  cleancall.c:110:46: runtime error: call to function cb_progress_done
through pointer to incorrect function type 'void (*)(void *)'

package source: https://github.com/rnabioco/valr
pre-test artifacts:
https://win-builder.r-project.org/incoming_pretest/valr_0.8.3_20250108_153335/specialChecks/clang-san
/

Thanks in advance,
Kent

	[[alternative HTML version deleted]]


From |kry|ov @end|ng |rom d|@root@org  Fri Jan 10 16:06:52 2025
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Fri, 10 Jan 2025 18:06:52 +0300
Subject: [R-pkg-devel] 
 [SPAM Warning!] addressing a CRAN submission pre-test
 clang-san warning
In-Reply-To: <CA+cnB_jbABqxCOsxuCA1-E5sJOf0qZBwrC7t1gNSAH3sHCPKig@mail.gmail.com>
References: <CA+cnB_jbABqxCOsxuCA1-E5sJOf0qZBwrC7t1gNSAH3sHCPKig@mail.gmail.com>
Message-ID: <20250110180652.2d7bbc89@arachnoid>

? Fri, 10 Jan 2025 07:45:00 -0700
Kent Riemondy <kent.riemondy at gmail.com> ?????:

>   cleancall.c:110:46: runtime error: call to function cb_progress_done
> through pointer to incorrect function type 'void (*)(void *)'

This is a (mostly harmless) error in the purrr package:
https://stat.ethz.ch/pipermail/r-package-devel/2024q4/011230.html

It has recently been reported to the package maintainers:
https://github.com/tidyverse/purrr/issues/1157

Instead of casting the cb_progress_done function pointer to (void
(*)(void*)), the function needs to accept (void*) and cast the argument
to SEXP in the function body.

-- 
Best regards,
Ivan


From kent@r|emondy @end|ng |rom gm@||@com  Fri Jan 10 16:21:27 2025
From: kent@r|emondy @end|ng |rom gm@||@com (Kent Riemondy)
Date: Fri, 10 Jan 2025 08:21:27 -0700
Subject: [R-pkg-devel] 
 [SPAM Warning!] addressing a CRAN submission pre-test
 clang-san warning
In-Reply-To: <20250110180652.2d7bbc89@arachnoid>
References: <CA+cnB_jbABqxCOsxuCA1-E5sJOf0qZBwrC7t1gNSAH3sHCPKig@mail.gmail.com>
 <20250110180652.2d7bbc89@arachnoid>
Message-ID: <CA+cnB_gPGQEDXJHPao2TzQjFzFMg+Akn-Padvn_e1Gd03C=UMg@mail.gmail.com>

Ivan,
  Many thanks for the prompt and helpful response. I hadn't seen the
previous r-package-devel message with the same error. I will explain this
situation to CRAN which hopefully will allow valr to stay on CRAN while I
work to get the suggested fix implemented in purrr.

Thanks,
Kent


On Fri, Jan 10, 2025 at 8:08?AM Ivan Krylov <ikrylov at disroot.org> wrote:

> ? Fri, 10 Jan 2025 07:45:00 -0700
> Kent Riemondy <kent.riemondy at gmail.com> ?????:
>
> >   cleancall.c:110:46: runtime error: call to function cb_progress_done
> > through pointer to incorrect function type 'void (*)(void *)'
>
> This is a (mostly harmless) error in the purrr package:
> https://stat.ethz.ch/pipermail/r-package-devel/2024q4/011230.html
>
> It has recently been reported to the package maintainers:
> https://github.com/tidyverse/purrr/issues/1157
>
> Instead of casting the cb_progress_done function pointer to (void
> (*)(void*)), the function needs to accept (void*) and cast the argument
> to SEXP in the function body.
>
> --
> Best regards,
> Ivan
>

	[[alternative HTML version deleted]]


From pep|jn@devr|e@ @end|ng |rom out|ook@com  Fri Jan 10 18:00:04 2025
From: pep|jn@devr|e@ @end|ng |rom out|ook@com (Pepijn de Vries)
Date: Fri, 10 Jan 2025 17:00:04 +0000
Subject: [R-pkg-devel] gcc-san check warns for non-portable flags
Message-ID: <AM8PR10MB4660B3C058C111F115FC8A9DA71C2@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>

Dear fellow package developers,

There were multiple issues with a package I maintain: @CRAN: <https://cran.r-project.org/package=adfExplorer> @source: <https://github.com/pepijn-devries/adfExplorer/>. As far as I can tell all issues listed @CRAN were fixed in the latest version (available from GitHub and R-Universe). However, when submitting to CRAN, the special gcc san check complains about non-portable flags (see below).

I cannot reproduce this warning myself. As far as I can tell, I don't set these flags myself (neither in the configure script nor in makevars.in). I suspect that these flags are set by the machine that performs the checks. How do I pass this check? Or should I report it to CRAN as a false negative result?

Many thanks for your help.

Kind regards,

Pepijn

> Flavor: r-devel-windows-x86_64, r-devel-linux-x86_64-debian-special-clang-san
> Check: *, Result: OK
>  ?
> Flavor: r-devel-linux-x86_64-debian-special-gcc-san
> Check: compilation flags used, Result: WARNING
> ?Compilation used the following non-portable flag(s):
>  ? ?'-Wno-deprecated-declarations' '-Wno-ignored-attributes'
>  ? ?'-Wno-stringop-truncation'
>  ?including flag(s) suppressing warnings


From d@v|d@gohe| @end|ng |rom @rd@t@@|r  Fri Jan 10 18:17:39 2025
From: d@v|d@gohe| @end|ng |rom @rd@t@@|r (David Gohel)
Date: Fri, 10 Jan 2025 17:17:39 +0000
Subject: [R-pkg-devel] gcc-san check warns for non-portable flags
In-Reply-To: <AM8PR10MB4660B3C058C111F115FC8A9DA71C2@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>
References: <AM8PR10MB4660B3C058C111F115FC8A9DA71C2@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>
Message-ID: <MRXP264MB0328A82A5EB35DFAAB4BAAA0FA1C2@MRXP264MB0328.FRAP264.PROD.OUTLOOK.COM>

I had the same this week.

Yes, you should answer these are false negative results.

KR,
David

De : R-package-devel <r-package-devel-bounces at r-project.org> de la part de Pepijn de Vries <pepijn.devries at outlook.com>
Date : vendredi, 10 janvier 2025 ? 18:00
? : Ivan Krylov via R-package-devel <r-package-devel at r-project.org>
Objet : [R-pkg-devel] gcc-san check warns for non-portable flags
Dear fellow package developers,

There were multiple issues with a package I maintain: @CRAN: <https://cran.r-project.org/package=adfExplorer> @source: <https://github.com/pepijn-devries/adfExplorer/>. As far as I can tell all issues listed @CRAN were fixed in the latest version (available from GitHub and R-Universe). However, when submitting to CRAN, the special gcc san check complains about non-portable flags (see below).

I cannot reproduce this warning myself. As far as I can tell, I don't set these flags myself (neither in the configure script nor in makevars.in). I suspect that these flags are set by the machine that performs the checks. How do I pass this check? Or should I report it to CRAN as a false negative result?

Many thanks for your help.

Kind regards,

Pepijn

> Flavor: r-devel-windows-x86_64, r-devel-linux-x86_64-debian-special-clang-san
> Check: *, Result: OK
>
> Flavor: r-devel-linux-x86_64-debian-special-gcc-san
> Check: compilation flags used, Result: WARNING
>  Compilation used the following non-portable flag(s):
>     '-Wno-deprecated-declarations' '-Wno-ignored-attributes'
>     '-Wno-stringop-truncation'
>   including flag(s) suppressing warnings

______________________________________________
R-package-devel at r-project.org mailing list
https://stat.ethz.ch/mailman/listinfo/r-package-devel

	[[alternative HTML version deleted]]


From pep|jn@devr|e@ @end|ng |rom out|ook@com  Fri Jan 10 21:19:27 2025
From: pep|jn@devr|e@ @end|ng |rom out|ook@com (Pepijn de Vries)
Date: Fri, 10 Jan 2025 20:19:27 +0000
Subject: [R-pkg-devel] gcc-san check warns for non-portable flags
In-Reply-To: <MRXP264MB0328A82A5EB35DFAAB4BAAA0FA1C2@MRXP264MB0328.FRAP264.PROD.OUTLOOK.COM>
References: <AM8PR10MB4660B3C058C111F115FC8A9DA71C2@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>
 <MRXP264MB0328A82A5EB35DFAAB4BAAA0FA1C2@MRXP264MB0328.FRAP264.PROD.OUTLOOK.COM>
Message-ID: <AM8PR10MB4660414895B1D16891E4AEB9A71C2@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>

Hi David,

Thanks for the quick response. I will report it.

Pepijn

________________________________________
Van:?R-package-devel <r-package-devel-bounces at r-project.org> namens David Gohel <david.gohel at ardata.fr>
Verzonden:?vrijdag 10 januari 2025 18:17
Aan:?r-package-devel at r-project.org <r-package-devel at r-project.org>
Onderwerp:?Re: [R-pkg-devel] gcc-san check warns for non-portable flags
?
I had the same this week.

Yes, you should answer these are false negative results.

KR,
David

De : R-package-devel <r-package-devel-bounces at r-project.org> de la part de Pepijn de Vries <pepijn.devries at outlook.com>
Date : vendredi, 10 janvier 2025 ? 18:00
? : Ivan Krylov via R-package-devel <r-package-devel at r-project.org>
Objet : [R-pkg-devel] gcc-san check warns for non-portable flags
Dear fellow package developers,

There were multiple issues with a package I maintain: @CRAN: <https://cran.r-project.org/package=adfExplorer> @source: <https://github.com/pepijn-devries/adfExplorer/>. As far as I can tell all issues listed @CRAN were fixed in the latest version (available from GitHub and R-Universe). However, when submitting to CRAN, the special gcc san check complains about non-portable flags (see below).

I cannot reproduce this warning myself. As far as I can tell, I don't set these flags myself (neither in the configure script nor in makevars.in). I suspect that these flags are set by the machine that performs the checks. How do I pass this check? Or should I report it to CRAN as a false negative result?

Many thanks for your help.

Kind regards,

Pepijn

> Flavor: r-devel-windows-x86_64, r-devel-linux-x86_64-debian-special-clang-san
> Check: *, Result: OK
>
> Flavor: r-devel-linux-x86_64-debian-special-gcc-san
> Check: compilation flags used, Result: WARNING
>? Compilation used the following non-portable flag(s):
>???? '-Wno-deprecated-declarations' '-Wno-ignored-attributes'
>???? '-Wno-stringop-truncation'
>?? including flag(s) suppressing warnings

______________________________________________
R-package-devel at r-project.org mailing list
https://stat.ethz.ch/mailman/listinfo/r-package-devel

??????? [[alternative HTML version deleted]]

From |uk@@@@chne|derb@uer @end|ng |rom gm@||@com  Sat Jan 11 10:37:20 2025
From: |uk@@@@chne|derb@uer @end|ng |rom gm@||@com (Lukas Schneiderbauer)
Date: Sat, 11 Jan 2025 10:37:20 +0100
Subject: [R-pkg-devel] SystemRequirements & configure check for FFTW with
 single precision support
Message-ID: <CAHETjtZcmar26ud0s0yn9RGQXwjKtVpkT3gt+o2DGfAyR-T=qg@mail.gmail.com>

Hi list,

I am working on getting a package <https://github.com/lschneiderbauer/fCWTr> to
CRAN. It depends on the FFTW library <https://www.fftw.org/> that is built
with single precision support. I am stuck in the submission process and I
require your help.

Before I come to my questions, some key facts about the package:

The package has an autoconf configure script that uses (among other things,
like OpenMP checks, etc..) AC_SEARCH_LIBS to check whether required
functions of the library 'fftwf' exist, if yes, it adds the corresponding
compiler/linker flags; if no, it errs with a descriptive error message.

The CRAN Windows as well as Linux build service included fftwf in their
fftw build out of the box, and so building there was no problem, R CMD
Check passes there. In the past, building for MacOS was more trouble, since
its fftw package does not include a single-precision build. I reached out
to Simon Urbanek, and he was so kind as to add an appropriate new recipe
"fftw-s" that provided an fftw version with single precision support. As of
now, R CMD check also passes cleanly on the MacOS build service, thanks to
Simon Urbanek's efforts.

Now, I am stuck at submission for two reasons:
1. The SystemRequirements specification in the DESCRIPTION file is
incorrect.
2. It is said that "the package needs a configure check for fftwf".

Add 1.
Initially, I had no mention of the "single precision" version of fftw,
because I thought it is included everywhere by default. It was stated that
I need to add that information. I naturally complied.
This is my current version:
"SystemRequirements: fftw3 (including single precision support fftw3f),
fftw3f_omp (optional), OpenMP (optional)"
In the second subscription run, I was told to add "fftw-s" since I require
the fftw-s package on MacOS. This does not make much sense to me since
"fftw-s" is only the name of this package on Simon Urbanek's MacOS build
service. The library file itself is still called fftwf, like it is on any
other platform. If I added "fftw-s", I would also need to explain that this
is only valid for MacOS which seems to make the SystemRequirements
unnecessary verbose.
* Can someone explain the reason behind this request to me?
* How exactly should I add "fftw-s" to pass the submission process?

Add 2.
I tried to explain now for the second time in the submission notes, that a
check is already in place (see the AC_SEARCH_LIBS paragraph above). But my
explanation gets ignored.
* What am I doing wrong?
* What additional configure checks do I need to add to the package?

Thanks a lot for your help!
Sincerely, Lukas Schneiderbauer

	[[alternative HTML version deleted]]


From edd @end|ng |rom deb|@n@org  Sat Jan 11 19:52:59 2025
From: edd @end|ng |rom deb|@n@org (Dirk Eddelbuettel)
Date: Sat, 11 Jan 2025 12:52:59 -0600
Subject: [R-pkg-devel] 
 SystemRequirements & configure check for FFTW with
 single precision support
In-Reply-To: <CAHETjtZcmar26ud0s0yn9RGQXwjKtVpkT3gt+o2DGfAyR-T=qg@mail.gmail.com>
References: <CAHETjtZcmar26ud0s0yn9RGQXwjKtVpkT3gt+o2DGfAyR-T=qg@mail.gmail.com>
Message-ID: <26498.48651.572674.777799@rob.eddelbuettel.com>


Lukas,

It is, as you noticed, complicated.

One way forward might be to rely on what you can rely on (i.e. a suitable
system fftw on two of the three platforms) and to embed and locally build
where not. Nowadays a number of packages embedding external libraries and
resorting to eg cmake to build locally to provide what their R package needs
(pak now rebuilds curl, igraph 'vendors' a number of external libraries, as
does duckdb and so on), and so on. It is one approach. Others download if
they must (i.e. what I once added to nloptr) but CRAN now leans more against
downloads at build time. [1]

The problem is that SystemRequirements: is all we have to solve a cross-OS,
cross-platform, cross-distro (for Linux), cross-release, ... dependency
issue.  Something for which a (commonly) single-line of free form text is not
all that well suited. But anything more formal would be need to reliably
address the cross-product of cpu architecture, operating system,
flavour/distro, release, ... Not easy for (less than) a handful of already
stretched volunteers.

So this is a hard problem; if it could be fixed easily it would have been
addressed in the 25+ plus years of CRAN.

Cheers, Dirk

PS For the smaller subset of three releases for (currently) one architecture,
one platform, and one distribution flavor this has been address using the
existence of system package manager: r2u covers this reliably and gets you
(CRAN) package binaries for Ubuntu with full and complete system dependency
integration, see https://eddelbuettel.github.io/r2u -- but it is hard /
impossible to generalise to other OSs without a similar package manager.

-- 
dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org


From |kry|ov @end|ng |rom d|@root@org  Sat Jan 11 20:09:57 2025
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Sat, 11 Jan 2025 22:09:57 +0300
Subject: [R-pkg-devel] 
 SystemRequirements & configure check for FFTW with
 single precision support
In-Reply-To: <CAHETjtZcmar26ud0s0yn9RGQXwjKtVpkT3gt+o2DGfAyR-T=qg@mail.gmail.com>
References: <CAHETjtZcmar26ud0s0yn9RGQXwjKtVpkT3gt+o2DGfAyR-T=qg@mail.gmail.com>
Message-ID: <20250111220957.6f839b0d@Tarkus>

? Sat, 11 Jan 2025 10:37:20 +0100
Lukas Schneiderbauer <lukas.schneiderbauer at gmail.com> ?????:

> I was told to add "fftw-s" since I require the fftw-s package on
> MacOS.

> * Can someone explain the reason behind this request to me?

While the SystemRequirements: field currently contains free-form text,
eventually we might be able to evolve it into something
machine-readable to install the system-level dependencies
automatically. Since the macOS packages are built using the recipes
system to provide the dependencies, it makes certain sense to list the
name of the recipe for their sake, in addition to the name of the
shared library.

> * How exactly should I add "fftw-s" to pass the submission process?

I've tried looking for examples using

db <- tools::CRAN_package_db()
subset(db, grepl('recipe|mac', SystemRequirements, ignore.case=TRUE))

...but found nothing relevant. How about something like the following?

SystemRequirements:
 fftw3 (including single precision support fftw3f; 'fftw-s' macOS
 recipe), fftw3f_omp (optional), OpenMP (optional)

> I tried to explain now for the second time in the submission notes,
> that a check is already in place (see the AC_SEARCH_LIBS paragraph
> above). But my explanation gets ignored.

I'm sorry for asking this admittedly thick question, but are you sure
it's not just R CMD check --as-cran repeating the X-CRAN-Comment: field
(which includes the phrase about not testing for single-precision
FFTW)? Does the rejection e-mail say "please fix and resubmit", list
specific problems, or ask for specific actions?

> * What additional configure checks do I need to add to the package?

The configure test for -lfftwf seems fine to me.

I wouldn't test for OpenMP's omp.h because testing for a working OpenMP
installation is fraught with peril and corner cases [*], but you pick
up R's OpenMP flags correctly and have appropriate #ifdef _OPENMP
sections in the source code, so that shouldn't cause you any real
problems.

-- 
Best regards,
Ivan

[*] https://github.com/Rdatatable/data.table/pull/6642


