From rhe|p @end|ng |rom eoo@@dd@@n|  Tue Oct  1 09:32:59 2024
From: rhe|p @end|ng |rom eoo@@dd@@n| (Jan van der Laan)
Date: Tue, 1 Oct 2024 09:32:59 +0200
Subject: [R-pkg-devel] Deprecating apparent S3 method, changing name
In-Reply-To: <SY4PR01MB56580A1C36102B5DB3462AE4AC6A2@SY4PR01MB5658.ausprd01.prod.outlook.com>
References: <SY4PR01MB56581D25A3BD15AC4CB3F882AC692@SY4PR01MB5658.ausprd01.prod.outlook.com>
 <20240926234842.286fed70@Tarkus>
 <SY4PR01MB56580A1C36102B5DB3462AE4AC6A2@SY4PR01MB5658.ausprd01.prod.outlook.com>
Message-ID: <ea61f7fb-b212-46ff-870e-4e82b3ba4e70@eoos.dds.nl>



On 9/26/24 23:48, Murray Efford via R-package-devel wrote:

> I am tossing up between (i) appealing to CRAN to allow the submission through with NOTEs until it feels safe to remove the functions with misleading names altogether, and (ii) removing them now and warning users about the new names in an  onLoad message.


A third solution would be to create a `esa.plot` method that redirects 
the user to `esaPlot` etc. So you create a function `esa.plot`. Its 
arguments should match those of the `esa` generic. If the `esaPlot` 
function has completely different arguments, you could have this 
`esa.plot` function give an error, redirecting the user to `esaPlot`.

You will still need to document the `esa.plot` function as a method to 
prevent warnings/notes:

\usage{
\method{esa}{plot}(..)
}

And you should export it:

export(esa.plot)

So that it can be called directly. To prevent that the `esa.plot` is 
called when a user passes a `plot` object to the `esa` generic, you 
could use the solution mentioned below:



> ________________________________
> From: Ivan Krylov <ikrylov at disroot.org>
> 
> Theoretically speaking, if there was a place in your package where you
> called the esa() generic with a user-supplied object, esa.plot() would
> be a reachable S3 method, because the user would be able to construct
> structure(list(), class = 'plot') and give it to your package code to
> call esa(plot_object) and have it dispatched to esa.plot(). (Which
> wouldn't be useful to the user, but that's how S3 works.)
>

In NAMESPACE you can do:

S3method(esa, plot, esaplotmethod)

To register `esaplotmethod` as the method that is called when using 
`esa` with an object of type `plot`. This would prevent this issue. 
However, this probably (can't test as the note doesn't happen on my 
system) doesn't resolve the issue with the NOTE.


Best,
Jan


From yuy@ng@@t@t @end|ng |rom gm@||@com  Tue Oct  1 03:30:44 2024
From: yuy@ng@@t@t @end|ng |rom gm@||@com (Yu Yang)
Date: Mon, 30 Sep 2024 21:30:44 -0400
Subject: [R-pkg-devel] Question about Debian installation error
Message-ID: <617BD822-1EE1-4928-AA9F-42CDFB069B84@gmail.com>

Hi R-package-devel team, 

  I have a question about installation error on Debian. 

  I recently updated my package ?glmtlp? to meet the ?_PACKAGE? requirement and to deal with the ?noRemap" requirement. I only modified the DESCRIPTION and glmtlp-package.R file and fixed a few typos. R CMD check showed no errors in my local machine (MacOS), but when I submitted to CRAN, it said installation error on Debian. 

  The log file is at: https://win-builder.r-project.org/incoming_pretest/glmtlp_2.0.2_20240930_002619/Debian/00install.out. 

  I also used devtools::use_github_action() to check and found the installation error occurred in ubuntu-latest (devel) but not the others, as shown below.
 ?

  My guess was that the Makevars file was not correctly written. I am not an expert in this and I tried different options, but none of them worked. Do you have any suggestions in handling this?

  Thank you so much for your time and help!

Best,
Yu

From |kry|ov @end|ng |rom d|@root@org  Tue Oct  1 12:39:21 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Tue, 1 Oct 2024 13:39:21 +0300
Subject: [R-pkg-devel] Question about Debian installation error
In-Reply-To: <617BD822-1EE1-4928-AA9F-42CDFB069B84@gmail.com>
References: <617BD822-1EE1-4928-AA9F-42CDFB069B84@gmail.com>
Message-ID: <20241001133921.3296a176@arachnoid>

Hi Yu and welcome to R-package-devel! You're now part of the team as
well.

? Mon, 30 Sep 2024 21:30:44 -0400
Yu Yang <yuyang.stat at gmail.com> ?????:

>   I recently updated my package ?glmtlp? to meet the ?_PACKAGE?
> requirement and to deal with the ?noRemap" requirement. I only
> modified the DESCRIPTION and glmtlp-package.R file and fixed a few
> typos. R CMD check showed no errors in my local machine (MacOS), but
> when I submitted to CRAN, it said installation error on Debian. 
> 
>   The log file is at:
> https://win-builder.r-project.org/incoming_pretest/glmtlp_2.0.2_20240930_002619/Debian/00install.out. 

Thank you for providing the link to the failing example. The
screenshot(?) didn't come through [1]; this mailing list only accepts
plain text messages and a restricted set of attachment types, so it's
best to compose in plain text as well.

The reason your package is failing is because your C++ code calls R API
functions by their short ("remapped") names, and this will no longer
work in the next version of R. This has been mentioned in the news for
R-devel [2,3]. The remapping is described in "Writing R Extensions",
chapter 6 [4] (and a bit more at the end, shortly before chapter 7).

In short, to reproduce the error outside of R-devel, you need to
#define R_NO_REMAP before #including R API (or provide the -DR_NO_REMAP
command-line switch to the compiler), and then fix it by finding every
remapped name in your code and replacing it by the full name (typically
by prepending Rf_ to it).

You're not the first package author to have problems with C++ code due
to R_NO_REMAP [5]. There's now an incomplete, unofficial set of
manpage-style API documentation (made possible by Luke Tierney's effort
to export a list of API functions programmatically via tools:::funAPI)
where you can find both full and remapped names for most of "ordinary"
R API and slightly less than a half of experimental R API [6]. Thanks
to Erez Shomron, there's also information about when a lot of the
functions had been introduced.

The reason we have remapping in the first place is that for historical
reasons, R API contained a lot of functions with "ordinary" names, such
as "length", which conflicted with other C functions named "length" in
the same namespace. This problem has been solved at the cost of
introducing a more manageable problem by remapping: the "real" names of
the conflicting functions now start with Rf_ (e.g. "Rf_length"), and to
avoid breaking all existing code (including R itself), R uses the C
preprocessor to replace the short names with the full names on the fly:
"#define length Rf_length" and so on.

Unfortunately, that still leads to conflicts when you need to use
something named "length" (e.g. [7]) in a source file that #includes the
R API. You type s.length(), and the preprocessor patches that to
s.Rf_length(), and everything breaks. Since C++ code is the most
affected by this, the R developers are now disabling it for all C++
code.

Hope this helps!

-- 
Best regards,
Ivan

[1]
https://stat.ethz.ch/pipermail/r-package-devel/2024q4/011121.html

[2]
https://developer.r-project.org/blosxom.cgi/R-devel/NEWS/2024/04/14#n2024-04-14

[3]
https://stat.ethz.ch/R-manual/R-devel/doc/html/NEWS.html

[4]
https://cran.r-project.org/doc/manuals/R-exts.html#The-R-API

[5]
https://stat.ethz.ch/pipermail/r-package-devel/2024q2/010913.html

[6]
https://aitap.codeberg.page/R-api/#nrows
https://aitap.codeberg.page/R-api/#XLENGTH
https://aitap.codeberg.page/R-api/#allocVector

[7]
https://en.cppreference.com/w/cpp/string/basic_string/size


From |kry|ov @end|ng |rom d|@root@org  Tue Oct  1 13:45:37 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Tue, 1 Oct 2024 14:45:37 +0300
Subject: [R-pkg-devel] Deprecating apparent S3 method, changing name
In-Reply-To: <38d9bf9a-6ab4-4e3a-9790-511159aab23c@dds.nl>
References: <SY4PR01MB56581D25A3BD15AC4CB3F882AC692@SY4PR01MB5658.ausprd01.prod.outlook.com>
 <20240926234842.286fed70@Tarkus>
 <SY4PR01MB56580A1C36102B5DB3462AE4AC6A2@SY4PR01MB5658.ausprd01.prod.outlook.com>
 <38d9bf9a-6ab4-4e3a-9790-511159aab23c@dds.nl>
Message-ID: <20241001144537.2bec7355@arachnoid>

? Tue, 1 Oct 2024 09:00:24 +0200
Jan van der Laan <eoos at dds.nl> ?????:

> S3method(esa, plot, esaplotmethod)
> 
> To register `esaplotmethod` as the method that is called when using 
> `esa` with an object of type `plot`. This would prevent this issue. 
> However, this probably (can't test as the note doesn't happen on my 
> system) doesn't resolve the issue with the NOTE.

Excellent idea, thank you! It does work for R CMD check as well:

Sys.setenv("_R_CHECK_S3_METHODS_SHOW_POSSIBLE_ISSUES_" = 'TRUE')
tools::checkS3methods(dir = '.') # used to show esa.plot as well
# Apparent methods for exported generics not registered:
#   fxi.contour fxi.mode

No need for extra bits or attributes on the esa.plot function, just
register a method for "esa" generic, "plot" class to prevent S3
dispatch from reaching the function in question.

-- 
Best regards,
Ivan


From murr@y@e||ord @end|ng |rom ot@go@@c@nz  Wed Oct  2 03:04:29 2024
From: murr@y@e||ord @end|ng |rom ot@go@@c@nz (Murray Efford)
Date: Wed, 2 Oct 2024 01:04:29 +0000
Subject: [R-pkg-devel] Deprecating apparent S3 method, changing name
In-Reply-To: <20241001144537.2bec7355@arachnoid>
References: <SY4PR01MB56581D25A3BD15AC4CB3F882AC692@SY4PR01MB5658.ausprd01.prod.outlook.com>
 <20240926234842.286fed70@Tarkus>
 <SY4PR01MB56580A1C36102B5DB3462AE4AC6A2@SY4PR01MB5658.ausprd01.prod.outlook.com>
 <38d9bf9a-6ab4-4e3a-9790-511159aab23c@dds.nl>
 <20241001144537.2bec7355@arachnoid>
Message-ID: <SY4PR01MB56586DA4A75D7199ED7D6DCDAC702@SY4PR01MB5658.ausprd01.prod.outlook.com>

Almost too good to be true: with this in my NAMESPACE

export (esa.plot)
S3method(esa,plot)

it seems I can deprecate esa.plot by the usual route (calling .Deprecated and passing call through to the new function esaPlot).

Thanks!
Murray
________________________________
From: Ivan Krylov <ikrylov at disroot.org>
Sent: Wednesday, 2 October 2024 00:45
To: Jan van der Laan <eoos at dds.nl>
Cc: Murray Efford <murray.efford at otago.ac.nz>; Murray Efford via R-package-devel <r-package-devel at r-project.org>
Subject: Re: [R-pkg-devel] Deprecating apparent S3 method, changing name

? Tue, 1 Oct 2024 09:00:24 +0200
Jan van der Laan <eoos at dds.nl> ?????:

> S3method(esa, plot, esaplotmethod)
>
> To register `esaplotmethod` as the method that is called when using
> `esa` with an object of type `plot`. This would prevent this issue.
> However, this probably (can't test as the note doesn't happen on my
> system) doesn't resolve the issue with the NOTE.

Excellent idea, thank you! It does work for R CMD check as well:

Sys.setenv("_R_CHECK_S3_METHODS_SHOW_POSSIBLE_ISSUES_" = 'TRUE')
tools::checkS3methods(dir = '.') # used to show esa.plot as well
# Apparent methods for exported generics not registered:
#   fxi.contour fxi.mode

No need for extra bits or attributes on the esa.plot function, just
register a method for "esa" generic, "plot" class to prevent S3
dispatch from reaching the function in question.

--
Best regards,
Ivan

	[[alternative HTML version deleted]]


From yuy@ng@@t@t @end|ng |rom gm@||@com  Wed Oct  2 03:05:03 2024
From: yuy@ng@@t@t @end|ng |rom gm@||@com (Yu Yang)
Date: Tue, 1 Oct 2024 21:05:03 -0400
Subject: [R-pkg-devel] Question about Debian installation error
In-Reply-To: <20241001133921.3296a176@arachnoid>
References: <617BD822-1EE1-4928-AA9F-42CDFB069B84@gmail.com>
 <20241001133921.3296a176@arachnoid>
Message-ID: <9389AB20-E775-41AF-A4B6-ABA18B32B652@gmail.com>

Hi Ivan, 

  Thank you so much for your help! I have fixed the issue following your advice!

  May you have a great day!

Best,
Yu


> On Oct 1, 2024, at 6:39?AM, Ivan Krylov <ikrylov at disroot.org> wrote:
> 
> Hi Yu and welcome to R-package-devel! You're now part of the team as
> well.
> 
> ? Mon, 30 Sep 2024 21:30:44 -0400
> Yu Yang <yuyang.stat at gmail.com> ?????:
> 
>>  I recently updated my package ?glmtlp? to meet the ?_PACKAGE?
>> requirement and to deal with the ?noRemap" requirement. I only
>> modified the DESCRIPTION and glmtlp-package.R file and fixed a few
>> typos. R CMD check showed no errors in my local machine (MacOS), but
>> when I submitted to CRAN, it said installation error on Debian. 
>> 
>>  The log file is at:
>> https://win-builder.r-project.org/incoming_pretest/glmtlp_2.0.2_20240930_002619/Debian/00install.out.
> 
> Thank you for providing the link to the failing example. The
> screenshot(?) didn't come through [1]; this mailing list only accepts
> plain text messages and a restricted set of attachment types, so it's
> best to compose in plain text as well.
> 
> The reason your package is failing is because your C++ code calls R API
> functions by their short ("remapped") names, and this will no longer
> work in the next version of R. This has been mentioned in the news for
> R-devel [2,3]. The remapping is described in "Writing R Extensions",
> chapter 6 [4] (and a bit more at the end, shortly before chapter 7).
> 
> In short, to reproduce the error outside of R-devel, you need to
> #define R_NO_REMAP before #including R API (or provide the -DR_NO_REMAP
> command-line switch to the compiler), and then fix it by finding every
> remapped name in your code and replacing it by the full name (typically
> by prepending Rf_ to it).
> 
> You're not the first package author to have problems with C++ code due
> to R_NO_REMAP [5]. There's now an incomplete, unofficial set of
> manpage-style API documentation (made possible by Luke Tierney's effort
> to export a list of API functions programmatically via tools:::funAPI)
> where you can find both full and remapped names for most of "ordinary"
> R API and slightly less than a half of experimental R API [6]. Thanks
> to Erez Shomron, there's also information about when a lot of the
> functions had been introduced.
> 
> The reason we have remapping in the first place is that for historical
> reasons, R API contained a lot of functions with "ordinary" names, such
> as "length", which conflicted with other C functions named "length" in
> the same namespace. This problem has been solved at the cost of
> introducing a more manageable problem by remapping: the "real" names of
> the conflicting functions now start with Rf_ (e.g. "Rf_length"), and to
> avoid breaking all existing code (including R itself), R uses the C
> preprocessor to replace the short names with the full names on the fly:
> "#define length Rf_length" and so on.
> 
> Unfortunately, that still leads to conflicts when you need to use
> something named "length" (e.g. [7]) in a source file that #includes the
> R API. You type s.length(), and the preprocessor patches that to
> s.Rf_length(), and everything breaks. Since C++ code is the most
> affected by this, the R developers are now disabling it for all C++
> code.
> 
> Hope this helps!
> 
> -- 
> Best regards,
> Ivan
> 
> [1]
> https://stat.ethz.ch/pipermail/r-package-devel/2024q4/011121.html
> 
> [2]
> https://developer.r-project.org/blosxom.cgi/R-devel/NEWS/2024/04/14#n2024-04-14
> 
> [3]
> https://stat.ethz.ch/R-manual/R-devel/doc/html/NEWS.html
> 
> [4]
> https://cran.r-project.org/doc/manuals/R-exts.html#The-R-API
> 
> [5]
> https://stat.ethz.ch/pipermail/r-package-devel/2024q2/010913.html
> 
> [6]
> https://aitap.codeberg.page/R-api/#nrows
> https://aitap.codeberg.page/R-api/#XLENGTH
> https://aitap.codeberg.page/R-api/#allocVector
> 
> [7]
> https://en.cppreference.com/w/cpp/string/basic_string/size


From m@||ory@||ynn @end|ng |rom @t@t@ubc@c@  Wed Oct  9 22:26:24 2024
From: m@||ory@||ynn @end|ng |rom @t@t@ubc@c@ (Mallory Flynn)
Date: Wed, 9 Oct 2024 13:26:24 -0700
Subject: [R-pkg-devel] Question about examples/tests run-time
Message-ID: <78E66F51-2437-43C6-B4CD-C6A43A8984E6@stat.ubc.ca>

Hello,

I am hoping this is the correct way to pose a question about my submission, which I can?t seem to fix 2 NOTES for.  They are related to run time:
Flavor: r-devel-windows-x86_64
Check: examples, Result: NOTE
Examples with CPU (user + system) or elapsed time > 10s
           user system elapsed
countTree 17.66   0.13   17.78
estTree   17.52   0.02   17.54
wmmTree   15.70   0.02   15.72

Flavor: r-devel-linux-x86_64-debian-gcc
Check: examples, Result: NOTE
Examples with CPU (user + system) or elapsed time > 5s
            user system elapsed
countTree 14.218  0.077  14.401
wmmTree   14.049  0.028  14.086
estTree   14.046  0.012  14.066

The package enables easy implementation of a sampling method for population size estimation on a highly correlated tree - since it?s sequentially sampled, it?s expected to run long compared to other functionality, even on smaller examples. 
I have added many layers to try to shorten examples and tests, including ?donttest?, ?dontrun?, ?if (interactive())?, and reducing toy examples to what I believe is the smallest they can be to still demonstrate utility.  I also included the ?skip_on_cran()? function in tests which run longer.

Does anyone else have any ideas on how I can eliminate these notes?

Any help is very much appreciated!!
Thank you!

From j@|me@@@|v@dor @end|ng |rom |de@@yb|t@@com  Wed Oct  9 22:42:24 2024
From: j@|me@@@|v@dor @end|ng |rom |de@@yb|t@@com (Jaime Salvador)
Date: Wed, 9 Oct 2024 20:42:24 +0000
Subject: [R-pkg-devel] Help with 2 NOTES
Message-ID: <em79af66bf-7e90-400c-88a2-733409da284a@d22f2075.com>

How I can solve this NOTES:


* checking CRAN incoming feasibility ... [3s/5s] NOTE
Maintainer: ?Jaime Salvador <
jaime.salvador at ideasybits.com<mailto:jaime.salvador at ideasybits.com>>?

New submission

Possibly misspelled words in DESCRIPTION:
  DICX (12:67)
  RXDB (12:59)
  Redatam (2:34, 12:40)



* checking for detritus in the temp directory ... NOTE

Found the following files/directories:
  ?redatam?



Thanks

-------------------------------------
Jaime Salvador
| Ideas&Bits
| mobile: +593 0987285748
| email: jaime.salvador at ideasybits.com<mailto:jaime.salvador at ideasybits.com>
| site: www.ideasybits.com<https://urldefense.com/v3/__http:/www.ideasybits.com__;!!C3eXzRIY6Mw!YcjWo_ljX1Mppy0kki8QDmz6mHQIrU1XSABeGK31GmB50zdsNenbNNyRCZvpmI0lgbWo$>



	[[alternative HTML version deleted]]


From ||u|@@rev|||@ @end|ng |rom gm@||@com  Thu Oct 10 00:00:48 2024
From: ||u|@@rev|||@ @end|ng |rom gm@||@com (=?UTF-8?Q?Llu=C3=ADs_Revilla?=)
Date: Thu, 10 Oct 2024 00:00:48 +0200
Subject: [R-pkg-devel] Question about examples/tests run-time
In-Reply-To: <78E66F51-2437-43C6-B4CD-C6A43A8984E6@stat.ubc.ca>
References: <78E66F51-2437-43C6-B4CD-C6A43A8984E6@stat.ubc.ca>
Message-ID: <CAN+W6_vmbnEX4BgcYoHoQJ4h-T9WnCyyYbcw38nuX3w_fMVQrQ@mail.gmail.com>

Dear Mallory,

It would help a little bit if we know the package and we can check the
examples and code.
Perhaps it can help this little explanation of when to use donttest,
dontrun and other options:
https://contributor.r-project.org/cran-cookbook/general_issues.html#structuring-of-examples
If it is still too long I would leave the representative example for a
vignette or demo (or an article if you use pkgdown) and show how to use the
different parameters of your functions in the examples.

Best,

On Wed, 9 Oct 2024 at 23:04, Mallory Flynn <mallory.flynn at stat.ubc.ca>
wrote:

> Hello,
>
> I am hoping this is the correct way to pose a question about my
> submission, which I can?t seem to fix 2 NOTES for.  They are related to run
> time:
> Flavor: r-devel-windows-x86_64
> Check: examples, Result: NOTE
> Examples with CPU (user + system) or elapsed time > 10s
>            user system elapsed
> countTree 17.66   0.13   17.78
> estTree   17.52   0.02   17.54
> wmmTree   15.70   0.02   15.72
>
> Flavor: r-devel-linux-x86_64-debian-gcc
> Check: examples, Result: NOTE
> Examples with CPU (user + system) or elapsed time > 5s
>             user system elapsed
> countTree 14.218  0.077  14.401
> wmmTree   14.049  0.028  14.086
> estTree   14.046  0.012  14.066
>
> The package enables easy implementation of a sampling method for
> population size estimation on a highly correlated tree - since it?s
> sequentially sampled, it?s expected to run long compared to other
> functionality, even on smaller examples.
> I have added many layers to try to shorten examples and tests, including
> ?donttest?, ?dontrun?, ?if (interactive())?, and reducing toy examples to
> what I believe is the smallest they can be to still demonstrate utility.  I
> also included the ?skip_on_cran()? function in tests which run longer.
>
> Does anyone else have any ideas on how I can eliminate these notes?
>
> Any help is very much appreciated!!
> Thank you!
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>

	[[alternative HTML version deleted]]


From |kry|ov @end|ng |rom d|@root@org  Thu Oct 10 10:30:18 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Thu, 10 Oct 2024 11:30:18 +0300
Subject: [R-pkg-devel] Help with 2 NOTES
In-Reply-To: <em79af66bf-7e90-400c-88a2-733409da284a@d22f2075.com>
References: <em79af66bf-7e90-400c-88a2-733409da284a@d22f2075.com>
Message-ID: <20241010113018.079bb0c9@Tarkus>

Dear Jaime Salvador,

Welcome to R-package-devel!

? Wed, 9 Oct 2024 20:42:24 +0000
Jaime Salvador <jaime.salvador at ideasybits.com> ?????:

> New submission

This one is expected for new packages.

> Possibly misspelled words in DESCRIPTION:
>   DICX (12:67)
>   RXDB (12:59)
>   Redatam (2:34, 12:40)

Wrap the abbreviations and software names into 'single quotes':
https://contributor.r-project.org/cran-cookbook/description_issues.html#formatting-software-names.
Some of the acronyms may need to be explained in the submission
comments in the CRAN web form.

I see you've tried to put the acronyms into the WORDLIST, but I think
the interface for spell-checking the package is different (see
?'aspell-utils') and involves saving vectors of words into .rds files
in .aspell and describing them in .aspell/defaults.R.

(If anything reads WORDLIST, why doesn't grep -r WORDLIST src on the R
source code show anything?)

> * checking for detritus in the temp directory ... NOTE
> 
> Found the following files/directories:
>   ?redatam?

Some code from your package that ran during R CMD check (it's usually
examples or tests) created the file named "redatam" in the temporary
directory and didn't remove it afterwards. I'm not seeing any R code do
this, so it must be something in the libredengine DLL. Can you make it
remove its temporary files during _redatam_redatam_destroy()?

There are more serious problems not flagged by R CMD check.

Your code downloads a binary DLL during the configuration stage. What
is the license under which it is shipped? Will it work on macOS? CRAN
policy recommends including sources or downloading (and compiling on
the fly) a fixed version rather than the latest one, although I know
of exceptions for some open-source libraries.

Almost all your examples are wrapped in \dontrun{}. Generally, this is
only allowed for code that absolutely has no chance of running as
written, for example, due to a missing API key:
https://contributor.r-project.org/cran-cookbook/general_issues.html#structuring-of-examples

Your NAMESPACE contains a lot of extraneous stuff. You intend for the
user to call functions redatam.open(), redatam.query(), and so on, but
roxygen2 misinterpreted those as S3 methods and registered them for the
S3 generic redatam, which doesn't do anything and isn't properly
documented. It's best to get rid of the S3 generic and only export the
functions by name (e.g. export(redatam.open, redatam.query)) instead of
resorting to exportPattern("^[[:alpha:]]+"). Maybe it's best to just
avoid dots in the function names altogether, lest something else
misinterprets them as S3 methods.

Your "Description:" field says "you need R (>=4.0)", which is better
expressed as a separate field, "Depends: R (>= 4.0)".

-- 
Best regards,
Ivan


From j@|me@@@|v@dor @end|ng |rom |de@@yb|t@@com  Thu Oct 10 15:10:39 2024
From: j@|me@@@|v@dor @end|ng |rom |de@@yb|t@@com (Jaime Salvador)
Date: Thu, 10 Oct 2024 13:10:39 +0000
Subject: [R-pkg-devel] Help with 2 NOTES
In-Reply-To: <20241010113018.079bb0c9@Tarkus>
References: <em79af66bf-7e90-400c-88a2-733409da284a@d22f2075.com>
 <20241010113018.079bb0c9@Tarkus>
Message-ID: <em629f01a5-d4de-4ffd-9986-b3808e6cec1f@7660d48a.com>

Hi Ivan,

Thanks for you reply, I appreciate your help.

Actually, with your help, I fixex the issues :


  *   I enclose between single quotes Redata, RXDB and DICX
  *   I fixed the version of binaries downloaded, for example redatamx-core-linux-20241010.zip
  *   The binary DLL/so library generate a LOG file in temp/redatam directory, so I remove the directory in .onUnload
  *   The \dontrun in examples. To run the examples, we need a database, the package doesn't include a sample database, so the code can't be run. I remove \dontrun in functions that can run without a database (for example redatam_version)
  *   All the exported functions, now have the name redatam_XXX (where XXX is open, close, etc.)

Regarding to the DLL downloading during the configurarion, REDATAM is not an open source software (the source code is controlled by CELADE-CEPAL), but the binary is freely  distributed, you can get a copy from https://redatam.org/es/aplicaciones (Redatam X version)

Thanks


-------------------------------------
Jaime Salvador
| Ideas&Bits
| mobile: +593 0987285748
| email: jaime.salvador at ideasybits.com<mailto:jaime.salvador at ideasybits.com>
| site: www.ideasybits.com<https://urldefense.com/v3/__http:/www.ideasybits.com__;!!C3eXzRIY6Mw!YcjWo_ljX1Mppy0kki8QDmz6mHQIrU1XSABeGK31GmB50zdsNenbNNyRCZvpmI0lgbWo$>



------ Mensaje original ------
De "Ivan Krylov" <ikrylov at disroot.org<mailto:ikrylov at disroot.org>>
Para "Jaime Salvador" <jaime.salvador at ideasybits.com<mailto:jaime.salvador at ideasybits.com>>
Cc "r-package-devel at r-project.org" <r-package-devel at r-project.org<mailto:r-package-devel at r-project.org>>
Fecha 10/10/2024 3:30:18
Asunto Re: [R-pkg-devel] Help with 2 NOTES

Dear Jaime Salvador,

Welcome to R-package-devel!

? Wed, 9 Oct 2024 20:42:24 +0000
Jaime Salvador <jaime.salvador at ideasybits.com<mailto:jaime.salvador at ideasybits.com>> ?????:

New submission

This one is expected for new packages.

Possibly misspelled words in DESCRIPTION:
DICX (12:67)
RXDB (12:59)
Redatam (2:34, 12:40)

Wrap the abbreviations and software names into 'single quotes':
https://contributor.r-project.org/cran-cookbook/description_issues.html#formatting-software-names.
Some of the acronyms may need to be explained in the submission
comments in the CRAN web form.

I see you've tried to put the acronyms into the WORDLIST, but I think
the interface for spell-checking the package is different (see
?'aspell-utils') and involves saving vectors of words into .rds files
in .aspell and describing them in .aspell/defaults.R.

(If anything reads WORDLIST, why doesn't grep -r WORDLIST src on the R
source code show anything?)

* checking for detritus in the temp directory ... NOTE

Found the following files/directories:
?redatam?

Some code from your package that ran during R CMD check (it's usually
examples or tests) created the file named "redatam" in the temporary
directory and didn't remove it afterwards. I'm not seeing any R code do
this, so it must be something in the libredengine DLL. Can you make it
remove its temporary files during _redatam_redatam_destroy()?

There are more serious problems not flagged by R CMD check.

Your code downloads a binary DLL during the configuration stage. What
is the license under which it is shipped? Will it work on macOS? CRAN
policy recommends including sources or downloading (and compiling on
the fly) a fixed version rather than the latest one, although I know
of exceptions for some open-source libraries.

Almost all your examples are wrapped in \dontrun{}. Generally, this is
only allowed for code that absolutely has no chance of running as
written, for example, due to a missing API key:
https://contributor.r-project.org/cran-cookbook/general_issues.html#structuring-of-examples

Your NAMESPACE contains a lot of extraneous stuff. You intend for the
user to call functions redatam.open(), redatam.query(), and so on, but
roxygen2 misinterpreted those as S3 methods and registered them for the
S3 generic redatam, which doesn't do anything and isn't properly
documented. It's best to get rid of the S3 generic and only export the
functions by name (e.g. export(redatam.open, redatam.query)) instead of
resorting to exportPattern("^[[:alpha:]]+"). Maybe it's best to just
avoid dots in the function names altogether, lest something else
misinterprets them as S3 methods.

Your "Description:" field says "you need R (>=4.0)", which is better
expressed as a separate field, "Depends: R (>= 4.0)".

--
Best regards,
Ivan

	[[alternative HTML version deleted]]


From |kry|ov @end|ng |rom d|@root@org  Thu Oct 10 15:29:17 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Thu, 10 Oct 2024 16:29:17 +0300
Subject: [R-pkg-devel] Help with 2 NOTES
In-Reply-To: <em629f01a5-d4de-4ffd-9986-b3808e6cec1f@7660d48a.com>
References: <em79af66bf-7e90-400c-88a2-733409da284a@d22f2075.com>
 <20241010113018.079bb0c9@Tarkus>
 <em629f01a5-d4de-4ffd-9986-b3808e6cec1f@7660d48a.com>
Message-ID: <20241010162917.214ee9af@arachnoid>

? Thu, 10 Oct 2024 13:10:39 +0000
Jaime Salvador <jaime.salvador at ideasybits.com> ?????:

>   *   The \dontrun in examples. To run the examples, we need a
> database, the package doesn't include a sample database, so the code
> can't be run. I remove \dontrun in functions that can run without a
> database (for example redatam_version)

That makes perfect sense. Can you provide a small example database as
part of the package? It's best to exercise as much of the code of
package as reasonably possible in tests and examples. If not, leaving
\dontrun{} in is indeed the right choice.

> Regarding to the DLL downloading during the configurarion, REDATAM is
> not an open source software (the source code is controlled by
> CELADE-CEPAL), but the binary is freely  distributed, you can get a
> copy from https://redatam.org/es/aplicaciones (Redatam X version)

Thank you for clarifying that. It may help to follow the example of the
'Rblpapi' package <https://CRAN.R-project.org/package=Rblpapi> in
specifying the license covering the package as a whole. In particular,
you need to ensure that CRAN has the right to redistribute Redatam DLLs
as part of the binary packages they compile. I'm not seeing a license
covering the downloads at https://redatam.org/es/aplicaciones or
https://redatam.org/en/software.

Good luck! For best results next time you have a question, please
provide a link to the latest version of the package source code.

-- 
Best regards,
Ivan


From d@v|d_j_z|mmerm@nn @end|ng |rom hotm@||@com  Wed Oct 16 19:38:27 2024
From: d@v|d_j_z|mmerm@nn @end|ng |rom hotm@||@com (D Z)
Date: Wed, 16 Oct 2024 17:38:27 +0000
Subject: [R-pkg-devel] Installation took CPU time elapsed time for
 rust-based package
Message-ID: <PAVPR03MB101039EE8E46028FAFFD96737D3452@PAVPR03MB10103.eurprd03.prod.outlook.com>

Hi all,
I have a new package that I submitted to CRAN, that uses rust (for reference, it's called rtiktoken and can be found here: https://github.com/DavZim/rtiktoken).
The submission failed as 1-2 NOTEs were found, most importantly: Installation took CPU time 7.2 times elapsed time.

In both my Makevars and Makevars.win files, I specify to use 2 cores for cargo build on CRAN machines (see below or here https://github.com/DavZim/rtiktoken/blob/master/src/Makevars#L21C2-L25C4) but I still get the NOTE. Furthermore, I only get this on Debian but not on Windows.

if [ -n "$_R_CHECK_LIMIT_CORES" ]; then \
? export BUILDFLAGS="-j 2 --offline"; \
else \
?export BUILDFLAGS="--offline"; \
fi
...
cargo build ${BUILDFLAGS} --lib --release --manifest-path=./rust/Cargo.toml --target-dir $(TARGET_DIR)

The check results are here

  *
Windows: https://win-builder.r-project.org/incoming_pretest/rtiktoken_0.0.3_20241016_135446/Windows/00check.log (1 NOTE about misspelled words and a URL not being available)
  *
Debian:https://win-builder.r-project.org/incoming_pretest/rtiktoken_0.0.3_20241016_135446/Debian/00check.log (2 NOTEs: installation time and misspelled words)

Now I am wondering if there is anything that I can do about this NOTE or if I should ignore it.
I did not find any reference to this in the "Using Rust in CRAN Packages" nor in other CRAN packages that use rust (eg gifski, string2path, arcpbf), but I might have missed something.

I found also the CARGO_BUILD_JOBS flag for rust (https://doc.rust-lang.org/cargo/reference/environment-variables.html) but as I can't reproduce the error locally (or on other GitHub Actions runners), I don't want to trial-and-test-it on CRAN servers.

Thanks, any help is appreciated!
David





	[[alternative HTML version deleted]]


From |kry|ov @end|ng |rom d|@root@org  Wed Oct 16 20:50:29 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Wed, 16 Oct 2024 21:50:29 +0300
Subject: [R-pkg-devel] Installation took CPU time elapsed time for
 rust-based package
In-Reply-To: <PAVPR03MB101039EE8E46028FAFFD96737D3452@PAVPR03MB10103.eurprd03.prod.outlook.com>
References: <PAVPR03MB101039EE8E46028FAFFD96737D3452@PAVPR03MB10103.eurprd03.prod.outlook.com>
Message-ID: <20241016215029.3694e8d0@Tarkus>

? Wed, 16 Oct 2024 17:38:27 +0000
D Z <david_j_zimmermann at hotmail.com> ?????:

> if [ -n "$_R_CHECK_LIMIT_CORES" ]; then \
> ? export BUILDFLAGS="-j 2 --offline"; \

This environment variable is spelled with an extra underscore:
https://cran.r-project.org/doc/manuals/r-devel/R-ints.html#index-_005fR_005fCHECK_005fLIMIT_005fCORES_005f

At least one of Josiah's packages instead relies on the user setting
the NOT_CRAN environment variable:
https://github.com/extendr/b64/blob/67ff753f71676870e3b04657909050ae10ec2145/src/Makevars#L10-L28

> Now I am wondering if there is anything that I can do about this NOTE
> or if I should ignore it.
> I did not find any reference to this in the "Using Rust in CRAN
> Packages"

"Not taking more than two parallel processes or threads during the CRAN
check" is a more general requirement for all packages, regardless of
whether they use Rust. A package that uses cmake -GNinja without
limiting the number of compiler processes or gives the -j$(nproc)
argument to a Make subprocess would have received this NOTE as well.

-- 
Best regards,
Ivan


From jo@|@h@p@rry @end|ng |rom gm@||@com  Wed Oct 16 21:30:54 2024
From: jo@|@h@p@rry @end|ng |rom gm@||@com (Josiah Parry)
Date: Wed, 16 Oct 2024 12:30:54 -0700
Subject: [R-pkg-devel] Installation took CPU time elapsed time for
 rust-based package
In-Reply-To: <20241016215029.3694e8d0@Tarkus>
References: <PAVPR03MB101039EE8E46028FAFFD96737D3452@PAVPR03MB10103.eurprd03.prod.outlook.com>
 <20241016215029.3694e8d0@Tarkus>
Message-ID: <CAL3ufUK9VLDvZVHGzHFzwzPfXzdDnqnSmniqrv9DtmXtO4KBWA@mail.gmail.com>

Thanks, Ivan! Yes, I would use the NOT_CRAN flag. But in the case of that
package, the CRAN_FLAGS are not set dynamically.
It would be a welcome PR to rextendr if anyone more comfortable with Make
would like to. The current
template Makevars is at
https://github.com/extendr/rextendr/blob/main/inst/templates/cran/Makevars.

David, it looks like you went about crafting your CRAN-compliance by
hand?hats off! If you want to be a little more
hands off in the future, you can check out the development version of
{rextendr} https://extendr.github.io/rextendr/dev/reference/cran.html
which provides Makevars and configure scripts that are CRAN compatible.

The general workflow for a new package would be something like:

usethis::create_package()
rextendr::use_extendr()
rextendr::use_cran_defaults()
rextendr::use_msrv("1.69") # or whatever MSRV you have
rextendr::vendor_pkgs()

If you, or anyone else for that matter, have additional questions, I
recommend joining the
extendr discord at https://discord.gg/Mt4Kauus.

For more "formal" questions a GitHub discussion or issue is also welcome
https://github.com/extendr/extendr/discussions


On Wed, Oct 16, 2024 at 11:50?AM Ivan Krylov via R-package-devel <
r-package-devel at r-project.org> wrote:

> ? Wed, 16 Oct 2024 17:38:27 +0000
> D Z <david_j_zimmermann at hotmail.com> ?????:
>
> > if [ -n "$_R_CHECK_LIMIT_CORES" ]; then \
> >  export BUILDFLAGS="-j 2 --offline"; \
>
> This environment variable is spelled with an extra underscore:
>
> https://cran.r-project.org/doc/manuals/r-devel/R-ints.html#index-_005fR_005fCHECK_005fLIMIT_005fCORES_005f
>
> At least one of Josiah's packages instead relies on the user setting
> the NOT_CRAN environment variable:
>
> https://github.com/extendr/b64/blob/67ff753f71676870e3b04657909050ae10ec2145/src/Makevars#L10-L28
>
> > Now I am wondering if there is anything that I can do about this NOTE
> > or if I should ignore it.
> > I did not find any reference to this in the "Using Rust in CRAN
> > Packages"
>
> "Not taking more than two parallel processes or threads during the CRAN
> check" is a more general requirement for all packages, regardless of
> whether they use Rust. A package that uses cmake -GNinja without
> limiting the number of compiler processes or gives the -j$(nproc)
> argument to a Make subprocess would have received this NOTE as well.
>
> --
> Best regards,
> Ivan
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>

	[[alternative HTML version deleted]]


From m|ch@e|@m@hony @end|ng |rom c@nt@b@net  Wed Oct 16 22:04:54 2024
From: m|ch@e|@m@hony @end|ng |rom c@nt@b@net (Michael Mahony)
Date: Wed, 16 Oct 2024 20:04:54 +0000
Subject: [R-pkg-devel] Installation error when submitting package to CRAN
Message-ID: <da2d74d2d92ee1231f083ff304f25d97@cantab.net>



Apologies in advance for not providing a reproducible example, but I am 
unsure how to reproduce the below error, as it did not occur on my 
machine.

I recently submitted a package to CRAN, after which I received an 
automated email from ligges at statistik.tu-dortmund.de, saying my package 
had failed the automated checks. I was advised to ask for help on this 
mailing list if I did not know how to resolve the error.

Details of the automated checks are provided here: 
https://win-builder.r-project.org/incoming_pretest/hhmR_0.0.1_20241015_235116/

Essentially, when trying to install the package for Windows, the 
following error was produced.

```
* installing *source* package 'hhmR' ...
** using staged installation
** R
** data
*** moving datasets to lazyload DB
** inst
** byte-compile and prepare package for lazy loading
Error in loadNamespace(j <- i[[1L]], c(lib.loc, .libPaths()), 
versionCheck = vI[[j]]) :
   there is no package called 'farver'
Calls: <Anonymous> ... loadNamespace -> withRestarts -> withOneRestart 
-> doWithOneRestart
Execution halted
ERROR: lazy loading failed for package 'hhmR'
* removing 'd:/RCompile/CRANincoming/R-devel/lib/hhmR'
```

This error has never occurred before when testing the package using 
`devtools` or `rhub`. I imagine I probably need to add `library(farver)` 
somewhere in my package, but am unsure where.

If anyone has any advice about how to resolve this issue I would be very 
greatful.

Thank you in advance,

Michael
	[[alternative HTML version deleted]]


From @|mon@urb@nek @end|ng |rom R-project@org  Thu Oct 17 02:00:43 2024
From: @|mon@urb@nek @end|ng |rom R-project@org (Simon Urbanek)
Date: Thu, 17 Oct 2024 13:00:43 +1300
Subject: [R-pkg-devel] 
 Installation error when submitting package to CRAN
In-Reply-To: <da2d74d2d92ee1231f083ff304f25d97@cantab.net>
References: <da2d74d2d92ee1231f083ff304f25d97@cantab.net>
Message-ID: <D894D9F4-EF5F-4465-82A8-B55D96898232@R-project.org>

See the error - that looks like a temporary issue. I'd contact CRAN or resubmit.

Cheers,
Simon



> On Oct 17, 2024, at 09:04, Michael Mahony <michael.mahony at cantab.net> wrote:
> 
> 
> 
> Apologies in advance for not providing a reproducible example, but I am 
> unsure how to reproduce the below error, as it did not occur on my 
> machine.
> 
> I recently submitted a package to CRAN, after which I received an 
> automated email from ligges at statistik.tu-dortmund.de, saying my package 
> had failed the automated checks. I was advised to ask for help on this 
> mailing list if I did not know how to resolve the error.
> 
> Details of the automated checks are provided here: 
> https://win-builder.r-project.org/incoming_pretest/hhmR_0.0.1_20241015_235116/
> 
> Essentially, when trying to install the package for Windows, the 
> following error was produced.
> 
> ```
> * installing *source* package 'hhmR' ...
> ** using staged installation
> ** R
> ** data
> *** moving datasets to lazyload DB
> ** inst
> ** byte-compile and prepare package for lazy loading
> Error in loadNamespace(j <- i[[1L]], c(lib.loc, .libPaths()), 
> versionCheck = vI[[j]]) :
>   there is no package called 'farver'
> Calls: <Anonymous> ... loadNamespace -> withRestarts -> withOneRestart 
> -> doWithOneRestart
> Execution halted
> ERROR: lazy loading failed for package 'hhmR'
> * removing 'd:/RCompile/CRANincoming/R-devel/lib/hhmR'
> ```
> 
> This error has never occurred before when testing the package using 
> `devtools` or `rhub`. I imagine I probably need to add `library(farver)` 
> somewhere in my package, but am unsure where.
> 
> If anyone has any advice about how to resolve this issue I would be very 
> greatful.
> 
> Thank you in advance,
> 
> Michael
> [[alternative HTML version deleted]]
> 
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
> 


From jdnewm|| @end|ng |rom dcn@d@v|@@c@@u@  Thu Oct 17 02:46:52 2024
From: jdnewm|| @end|ng |rom dcn@d@v|@@c@@u@ (Jeff Newmiller)
Date: Wed, 16 Oct 2024 17:46:52 -0700
Subject: [R-pkg-devel] 
 Installation error when submitting package to CRAN
In-Reply-To: <da2d74d2d92ee1231f083ff304f25d97@cantab.net>
References: <da2d74d2d92ee1231f083ff304f25d97@cantab.net>
Message-ID: <A2D47FF5-6AFA-4A1C-8C36-57B44EDA31F5@dcn.davis.ca.us>

You should not use "library(anything)" in a package. You should rely on the Imports: field in the DESCRIPTION file along with importFrom() in your NAMESPACE file, or the Suggests: field in the DESCRIPTION file and if (requireNamespace("anypackage"))  {anypackage::somefun} else {# avoid using anypackage}. See WRE 1.1.3.1.

But in this particular case this might be a temporary glitch on the CRAN server.

On October 16, 2024 1:04:54 PM PDT, Michael Mahony <michael.mahony at cantab.net> wrote:
>
>
>Apologies in advance for not providing a reproducible example, but I am 
>unsure how to reproduce the below error, as it did not occur on my 
>machine.
>
>I recently submitted a package to CRAN, after which I received an 
>automated email from ligges at statistik.tu-dortmund.de, saying my package 
>had failed the automated checks. I was advised to ask for help on this 
>mailing list if I did not know how to resolve the error.
>
>Details of the automated checks are provided here: 
>https://win-builder.r-project.org/incoming_pretest/hhmR_0.0.1_20241015_235116/
>
>Essentially, when trying to install the package for Windows, the 
>following error was produced.
>
>```
>* installing *source* package 'hhmR' ...
>** using staged installation
>** R
>** data
>*** moving datasets to lazyload DB
>** inst
>** byte-compile and prepare package for lazy loading
>Error in loadNamespace(j <- i[[1L]], c(lib.loc, .libPaths()), 
>versionCheck = vI[[j]]) :
>   there is no package called 'farver'
>Calls: <Anonymous> ... loadNamespace -> withRestarts -> withOneRestart 
>-> doWithOneRestart
>Execution halted
>ERROR: lazy loading failed for package 'hhmR'
>* removing 'd:/RCompile/CRANincoming/R-devel/lib/hhmR'
>```
>
>This error has never occurred before when testing the package using 
>`devtools` or `rhub`. I imagine I probably need to add `library(farver)` 
>somewhere in my package, but am unsure where.
>
>If anyone has any advice about how to resolve this issue I would be very 
>greatful.
>
>Thank you in advance,
>
>Michael
>	[[alternative HTML version deleted]]
>
>______________________________________________
>R-package-devel at r-project.org mailing list
>https://stat.ethz.ch/mailman/listinfo/r-package-devel

-- 
Sent from my phone. Please excuse my brevity.


From ||gge@ @end|ng |rom @t@t|@t|k@tu-dortmund@de  Thu Oct 17 10:33:33 2024
From: ||gge@ @end|ng |rom @t@t|@t|k@tu-dortmund@de (Uwe Ligges)
Date: Thu, 17 Oct 2024 10:33:33 +0200
Subject: [R-pkg-devel] 
 Installation error when submitting package to CRAN
In-Reply-To: <A2D47FF5-6AFA-4A1C-8C36-57B44EDA31F5@dcn.davis.ca.us>
References: <da2d74d2d92ee1231f083ff304f25d97@cantab.net>
 <A2D47FF5-6AFA-4A1C-8C36-57B44EDA31F5@dcn.davis.ca.us>
Message-ID: <e9240ba7-4447-41a3-bc97-7350bcdd78ca@statistik.tu-dortmund.de>

1. I looked, and farver is not declared in your DESCRIPTION file as any 
dependency. Is it used by another package you depend on?


2. We also see:

Flavor: r-devel-linux-x86_64-debian-gcc
Check: DESCRIPTION meta-information, Result: NOTE
   License stub is invalid DCF.

and

   License components with restrictions and base license permitting such:
     MIT + file LICENSE
   File 'LICENSE':
     MIT License

     Copyright (c) 2024 sgmmahon

     Permission is ....

Please only ship the CRAN template for the MIT license.

3. In the Description field you have
"... (e.g. `dendextend`) ..."
Please use straight rather than directed quotes.

Please fix and resubmit.

Best,
Uwe Ligges






On 17.10.2024 02:46, Jeff Newmiller via R-package-devel wrote:
> You should not use "library(anything)" in a package. You should rely on the Imports: field in the DESCRIPTION file along with importFrom() in your NAMESPACE file, or the Suggests: field in the DESCRIPTION file and if (requireNamespace("anypackage"))  {anypackage::somefun} else {# avoid using anypackage}. See WRE 1.1.3.1.
> 
> But in this particular case this might be a temporary glitch on the CRAN server.
> 
> On October 16, 2024 1:04:54 PM PDT, Michael Mahony <michael.mahony at cantab.net> wrote:
>>
>>
>> Apologies in advance for not providing a reproducible example, but I am
>> unsure how to reproduce the below error, as it did not occur on my
>> machine.
>>
>> I recently submitted a package to CRAN, after which I received an
>> automated email from ligges at statistik.tu-dortmund.de, saying my package
>> had failed the automated checks. I was advised to ask for help on this
>> mailing list if I did not know how to resolve the error.
>>
>> Details of the automated checks are provided here:
>> https://win-builder.r-project.org/incoming_pretest/hhmR_0.0.1_20241015_235116/
>>
>> Essentially, when trying to install the package for Windows, the
>> following error was produced.
>>
>> ```
>> * installing *source* package 'hhmR' ...
>> ** using staged installation
>> ** R
>> ** data
>> *** moving datasets to lazyload DB
>> ** inst
>> ** byte-compile and prepare package for lazy loading
>> Error in loadNamespace(j <- i[[1L]], c(lib.loc, .libPaths()),
>> versionCheck = vI[[j]]) :
>>    there is no package called 'farver'
>> Calls: <Anonymous> ... loadNamespace -> withRestarts -> withOneRestart
>> -> doWithOneRestart
>> Execution halted
>> ERROR: lazy loading failed for package 'hhmR'
>> * removing 'd:/RCompile/CRANincoming/R-devel/lib/hhmR'
>> ```
>>
>> This error has never occurred before when testing the package using
>> `devtools` or `rhub`. I imagine I probably need to add `library(farver)`
>> somewhere in my package, but am unsure where.
>>
>> If anyone has any advice about how to resolve this issue I would be very
>> greatful.
>>
>> Thank you in advance,
>>
>> Michael
>> 	[[alternative HTML version deleted]]
>>
>> ______________________________________________
>> R-package-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-package-devel
> 

From |kry|ov @end|ng |rom d|@root@org  Thu Oct 17 10:52:46 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Thu, 17 Oct 2024 11:52:46 +0300
Subject: [R-pkg-devel] 
 Installation error when submitting package to CRAN
In-Reply-To: <e9240ba7-4447-41a3-bc97-7350bcdd78ca@statistik.tu-dortmund.de>
References: <da2d74d2d92ee1231f083ff304f25d97@cantab.net>
 <A2D47FF5-6AFA-4A1C-8C36-57B44EDA31F5@dcn.davis.ca.us>
 <e9240ba7-4447-41a3-bc97-7350bcdd78ca@statistik.tu-dortmund.de>
Message-ID: <20241017115246.210db267@Tarkus>

On Thu, 17 Oct 2024 10:33:33 +0200
Uwe Ligges <ligges at statistik.tu-dortmund.de> wrote:

> I looked, and farver is not declared in your DESCRIPTION file as any 
> dependency. Is it used by another package you depend on?

It's a transitive dependency via hhmR's Imports: patchwork, which in
turn Imports: farver.

> Please only ship the CRAN template for the MIT license.

Michael: for more information, see RShowDoc("MIT") and
<https://contributor.r-project.org/cran-cookbook/description_issues.html#license-files>.

-- 
Best regards,
Ivan


From ||gge@ @end|ng |rom @t@t|@t|k@tu-dortmund@de  Thu Oct 17 10:55:25 2024
From: ||gge@ @end|ng |rom @t@t|@t|k@tu-dortmund@de (Uwe Ligges)
Date: Thu, 17 Oct 2024 10:55:25 +0200
Subject: [R-pkg-devel] 
 Installation error when submitting package to CRAN
In-Reply-To: <20241017115246.210db267@Tarkus>
References: <da2d74d2d92ee1231f083ff304f25d97@cantab.net>
 <A2D47FF5-6AFA-4A1C-8C36-57B44EDA31F5@dcn.davis.ca.us>
 <e9240ba7-4447-41a3-bc97-7350bcdd78ca@statistik.tu-dortmund.de>
 <20241017115246.210db267@Tarkus>
Message-ID: <f34fe95d-6898-45b2-af89-e0055fae7215@statistik.tu-dortmund.de>

Indeed, thank you, Ivan.
Then it was a temporary hicc up on the build server and should work for 
the resubmission of the fixed package.

Best,
Uwe

On 17.10.2024 10:52, Ivan Krylov wrote:
> On Thu, 17 Oct 2024 10:33:33 +0200
> Uwe Ligges <ligges at statistik.tu-dortmund.de> wrote:
> 
>> I looked, and farver is not declared in your DESCRIPTION file as any
>> dependency. Is it used by another package you depend on?
> 
> It's a transitive dependency via hhmR's Imports: patchwork, which in
> turn Imports: farver.
> 
>> Please only ship the CRAN template for the MIT license.
> 
> Michael: for more information, see RShowDoc("MIT") and
> <https://contributor.r-project.org/cran-cookbook/description_issues.html#license-files>.
> 

From no@h@gre||er @end|ng |rom gm@||@com  Thu Oct 24 18:55:32 2024
From: no@h@gre||er @end|ng |rom gm@||@com (Noah Greifer)
Date: Thu, 24 Oct 2024 12:55:32 -0400
Subject: [R-pkg-devel] check_equal() test fails on ATLAS
Message-ID: <CAPhhD8mY0FNaQJmdag+TFz4uQ+yYOdNZMjgy5B9GXkRvp5+2ng@mail.gmail.com>

Hello all,

My package *WeightIt* is failing
<https://cran.r-project.org/web/checks/check_results_WeightIt.html> the
CRAN test on ATLAS. The failure is due
<https://www.stats.ox.ac.uk/pub/bdr/Rblas/ATLAS/WeightIt.out> to a failed
*testthat* test comparing two covariance matrices using check_equal(). A
few things are confusing to me, so I'm not sure how to solve it.

First, the covariance matrices should be identical; there is no random
component in their computation and the the only difference in the calls
used to generate them are whether an argument is omitted or whether it is
explicitly set to its default (i.e., the purpose of the test is to ensure
the default argument corresponds to the supplied argument). I am willing to
accept that there is some non-deterministic process in ATLAS, e.g., where
convergence is measured based on time rather than number of iterations,
though I don't know if this is actually the case.

Second, the package tests have passed on previous CRAN checks (this is
weeks after this version was accepted to CRAN), on all other versions of R,
and in the rhub test
<https://github.com/ngreifer/WeightIt/actions/runs/11489721542/job/31979056981#step:6:124>
with ATLAS.

Does anyone have any advice on how to solve this? I know I can change the
tolerance argument to check_equal() but this is a case where the output
should be identical. I cannot reproduce the problem with rhub, so I can't
see where the problem is. Could this be a false alarm due to caching?
Thanks for any insights.

Noah

	[[alternative HTML version deleted]]


From ge|bjeremy22 @end|ng |rom gm@||@com  Sat Oct 26 18:18:07 2024
From: ge|bjeremy22 @end|ng |rom gm@||@com (=?UTF-8?B?asOpcsOpbXkgR2VsYg==?=)
Date: Sat, 26 Oct 2024 12:18:07 -0400
Subject: [R-pkg-devel] 
 *** caught segfault *** address (nil), cause 'unknown'
Message-ID: <CACSk52-bmXQzSBXwp+Q2jvK0ucw=_-XAt1iw3HVV=+-9PwGPRQ@mail.gmail.com>

Dear R packages developers,

I am the maintainer of the package spNetwork. It has been removed from CRAN
recently because of an issue with the new compiler clang19. The error came
from one of the dependencies: the package BH giving access to the boost c++
library (https://github.com/eddelbuettel/bh/issues/101).

The boost code has been updated since and I had no choice to include it
directly in my own package and remove the dependency to BH because its
maintainer does not plan a new release before december 2024.

However, there is a new error when I submit the package to CRAN (ubuntu
with clang19). The full report is here :
https://win-builder.r-project.org/incoming_pretest/spNetwork_0.4.4.4_20241026_034629/specialChecks/clang19/package/00install.out

The error occurred during the installation of the package, and the message
is not very helpful :

 *** caught segfault ***
address (nil), cause 'unknown'

It seems that the error is happening when loading a c++ module of my
package

Traceback:
 1: Module(module, mustStart = TRUE, where = env)
 2: doTryCatch(return(expr), name, parentenv, handler)
 3: tryCatchOne(expr, names, parentenv, handlers[[1L]])
 4: tryCatchList(expr, classes, parentenv, handlers)
 5: tryCatch(Module(module, mustStart = TRUE, where = env), error =
function(e) e)
 6: loadModule(module = "spatial_index_cpp", what = TRUE, env = ns,
 loadNow = TRUE)


It is rather strange because I have not edited this module since the last
version and the package is installing correctly on other platforms. I also
tried to validate it with rhub and it worked well even with ubuntu and
clang19 :
https://github.com/JeremyGelb/spNetwork/actions/runs/11527593888/job/32093568292

Does someone have an idea about what could be causing this error during the
installation ? Any help would be highly appreciated.

I have a specific branch in gihtub for this issue :
https://github.com/JeremyGelb/spNetwork/tree/refs/heads/CRAN-v4.

All the best
-- 

*J?r?my GELB*
Conseiller en gestion et analyse de donn?es ? l'ARTM
Docteur en ?tudes Urbaines

438 389 6398
gelbjeremy22 at gmail.com

	[[alternative HTML version deleted]]


From g|@nm@rco@|bert| @end|ng |rom gm@||@com  Sun Oct 27 11:03:41 2024
From: g|@nm@rco@|bert| @end|ng |rom gm@||@com (Gianmarco Alberti)
Date: Sun, 27 Oct 2024 11:03:41 +0100
Subject: [R-pkg-devel] DESCRIPTION file corrections for accepted package
Message-ID: <CAMQoV_oo3ry2ZAsLDRMRASM9LE9ciOOy8a9W-Ykj9269gh=Bgg@mail.gmail.com>

Dear R Package Developers,
I am seeking guidance regarding a situation with my package 'chisquare'
(version 1.1) on CRAN.

Current situation:

1. The package was submitted and (automatically) accepted to CRAN (version
1.1) after thorough local testing and complete devtools checks
(check_win_oldrelease(), check_win_release(), check_win_devel())

2. After acceptance, I received a request to make formatting changes to the
DESCRIPTION file by November 2, 2024:
-Remove version specifications for graphics and stats in Imports
-Update R version dependency format from R (>= 4.0.0) to R (>= 4.0)

3. Upon attempting to submit these formatting changes, I received a warning
about "Insufficient package version (submitted: 1.1, existing: 1.1)". I am
well aware that this warning typically indicates the need to increment the
version number for new submissions of existing packages, as per CRAN
policies.

This creates a procedural challenge:
-I need to make the requested DESCRIPTION file changes to retain the package
-The changes are purely formatting-related, not functional (all checks pass)
-I cannot submit without changing the version number
-However, incrementing the version number seems disproportionate for
formatting changes.

I would greatly appreciate guidance on the proper way to handle this
situation.
What is the recommended approach for submitting DESCRIPTION file formatting
corrections for an already-accepted package, given that incrementing the
version number might seem a bit disproportionate?

Thank you for your time and assistance.

	[[alternative HTML version deleted]]


From murdoch@dunc@n @end|ng |rom gm@||@com  Sun Oct 27 11:49:05 2024
From: murdoch@dunc@n @end|ng |rom gm@||@com (Duncan Murdoch)
Date: Sun, 27 Oct 2024 06:49:05 -0400
Subject: [R-pkg-devel] DESCRIPTION file corrections for accepted package
In-Reply-To: <CAMQoV_oo3ry2ZAsLDRMRASM9LE9ciOOy8a9W-Ykj9269gh=Bgg@mail.gmail.com>
References: <CAMQoV_oo3ry2ZAsLDRMRASM9LE9ciOOy8a9W-Ykj9269gh=Bgg@mail.gmail.com>
Message-ID: <142292b0-f4e2-4a96-b77e-a337d287606a@gmail.com>

On 2024-10-27 6:03 a.m., Gianmarco Alberti wrote:
> Dear R Package Developers,
> I am seeking guidance regarding a situation with my package 'chisquare'
> (version 1.1) on CRAN.
> 
> Current situation:
> 
> 1. The package was submitted and (automatically) accepted to CRAN (version
> 1.1) after thorough local testing and complete devtools checks
> (check_win_oldrelease(), check_win_release(), check_win_devel())
> 
> 2. After acceptance, I received a request to make formatting changes to the
> DESCRIPTION file by November 2, 2024:
> -Remove version specifications for graphics and stats in Imports
> -Update R version dependency format from R (>= 4.0.0) to R (>= 4.0)
> 
> 3. Upon attempting to submit these formatting changes, I received a warning
> about "Insufficient package version (submitted: 1.1, existing: 1.1)". I am
> well aware that this warning typically indicates the need to increment the
> version number for new submissions of existing packages, as per CRAN
> policies.
> 
> This creates a procedural challenge:
> -I need to make the requested DESCRIPTION file changes to retain the package
> -The changes are purely formatting-related, not functional (all checks pass)
> -I cannot submit without changing the version number
> -However, incrementing the version number seems disproportionate for
> formatting changes.
> 
> I would greatly appreciate guidance on the proper way to handle this
> situation.
> What is the recommended approach for submitting DESCRIPTION file formatting
> corrections for an already-accepted package, given that incrementing the
> version number might seem a bit disproportionate?
> 
> Thank you for your time and assistance.

The simplest thing is to just update the version.  Use 1.1.1 if you 
don't want to go to 1.2.

Duncan Murdoch


From g|@nm@rco@|bert| @end|ng |rom gm@||@com  Sun Oct 27 12:48:28 2024
From: g|@nm@rco@|bert| @end|ng |rom gm@||@com (Gianmarco Alberti)
Date: Sun, 27 Oct 2024 12:48:28 +0100
Subject: [R-pkg-devel] DESCRIPTION file corrections for accepted package
In-Reply-To: <142292b0-f4e2-4a96-b77e-a337d287606a@gmail.com>
References: <CAMQoV_oo3ry2ZAsLDRMRASM9LE9ciOOy8a9W-Ykj9269gh=Bgg@mail.gmail.com>
 <142292b0-f4e2-4a96-b77e-a337d287606a@gmail.com>
Message-ID: <CAMQoV_qqOx8AGcosji0QrvV2Vc-nnXE0cC5xZjkrssCLC+K6pA@mail.gmail.com>

Dear Duncan,

Thank you for the straightforward guidance.

My initial query stemmed from a concern about versioning consistency - I
thought that once using three digits (1.1.1), I would need to maintain that
format (e.g., 1.2.0) in future updates. Your suggestion clarified that I
can use 1.1.1 for these formatting changes and still use 1.2 for future
substantial updates.

Best regards,

Gm

Il giorno dom 27 ott 2024 alle ore 11:49 Duncan Murdoch <
murdoch.duncan at gmail.com> ha scritto:

> On 2024-10-27 6:03 a.m., Gianmarco Alberti wrote:
> > Dear R Package Developers,
> > I am seeking guidance regarding a situation with my package 'chisquare'
> > (version 1.1) on CRAN.
> >
> > Current situation:
> >
> > 1. The package was submitted and (automatically) accepted to CRAN
> (version
> > 1.1) after thorough local testing and complete devtools checks
> > (check_win_oldrelease(), check_win_release(), check_win_devel())
> >
> > 2. After acceptance, I received a request to make formatting changes to
> the
> > DESCRIPTION file by November 2, 2024:
> > -Remove version specifications for graphics and stats in Imports
> > -Update R version dependency format from R (>= 4.0.0) to R (>= 4.0)
> >
> > 3. Upon attempting to submit these formatting changes, I received a
> warning
> > about "Insufficient package version (submitted: 1.1, existing: 1.1)". I
> am
> > well aware that this warning typically indicates the need to increment
> the
> > version number for new submissions of existing packages, as per CRAN
> > policies.
> >
> > This creates a procedural challenge:
> > -I need to make the requested DESCRIPTION file changes to retain the
> package
> > -The changes are purely formatting-related, not functional (all checks
> pass)
> > -I cannot submit without changing the version number
> > -However, incrementing the version number seems disproportionate for
> > formatting changes.
> >
> > I would greatly appreciate guidance on the proper way to handle this
> > situation.
> > What is the recommended approach for submitting DESCRIPTION file
> formatting
> > corrections for an already-accepted package, given that incrementing the
> > version number might seem a bit disproportionate?
> >
> > Thank you for your time and assistance.
>
> The simplest thing is to just update the version.  Use 1.1.1 if you
> don't want to go to 1.2.
>
> Duncan Murdoch
>
>

	[[alternative HTML version deleted]]


From murdoch@dunc@n @end|ng |rom gm@||@com  Sun Oct 27 14:16:36 2024
From: murdoch@dunc@n @end|ng |rom gm@||@com (Duncan Murdoch)
Date: Sun, 27 Oct 2024 09:16:36 -0400
Subject: [R-pkg-devel] DESCRIPTION file corrections for accepted package
In-Reply-To: <CAMQoV_qqOx8AGcosji0QrvV2Vc-nnXE0cC5xZjkrssCLC+K6pA@mail.gmail.com>
References: <CAMQoV_oo3ry2ZAsLDRMRASM9LE9ciOOy8a9W-Ykj9269gh=Bgg@mail.gmail.com>
 <142292b0-f4e2-4a96-b77e-a337d287606a@gmail.com>
 <CAMQoV_qqOx8AGcosji0QrvV2Vc-nnXE0cC5xZjkrssCLC+K6pA@mail.gmail.com>
Message-ID: <49f94200-e26a-4d4d-9934-988b5ec82269@gmail.com>

I don't think R will enforce a 3 part version just because you used it 
once.  You might have other reasons to try to maintain versioning 
consistency.

Duncan Murdoch

On 2024-10-27 7:48 a.m., Gianmarco Alberti wrote:
> Dear Duncan,
> 
> Thank you for the straightforward guidance.
> 
> My initial query stemmed from a concern about versioning consistency - I 
> thought that once using three digits (1.1.1), I would need to maintain 
> that format (e.g., 1.2.0) in future updates. Your suggestion clarified 
> that I can use 1.1.1 for these formatting changes and still use 1.2 for 
> future substantial updates.
> 
> Best regards,
> 
> Gm
> 
> 
> Il giorno dom 27 ott 2024 alle ore 11:49 Duncan Murdoch 
> <murdoch.duncan at gmail.com <mailto:murdoch.duncan at gmail.com>> ha scritto:
> 
>     On 2024-10-27 6:03 a.m., Gianmarco Alberti wrote:
>      > Dear R Package Developers,
>      > I am seeking guidance regarding a situation with my package
>     'chisquare'
>      > (version 1.1) on CRAN.
>      >
>      > Current situation:
>      >
>      > 1. The package was submitted and (automatically) accepted to CRAN
>     (version
>      > 1.1) after thorough local testing and complete devtools checks
>      > (check_win_oldrelease(), check_win_release(), check_win_devel())
>      >
>      > 2. After acceptance, I received a request to make formatting
>     changes to the
>      > DESCRIPTION file by November 2, 2024:
>      > -Remove version specifications for graphics and stats in Imports
>      > -Update R version dependency format from R (>= 4.0.0) to R (>= 4.0)
>      >
>      > 3. Upon attempting to submit these formatting changes, I received
>     a warning
>      > about "Insufficient package version (submitted: 1.1, existing:
>     1.1)". I am
>      > well aware that this warning typically indicates the need to
>     increment the
>      > version number for new submissions of existing packages, as per CRAN
>      > policies.
>      >
>      > This creates a procedural challenge:
>      > -I need to make the requested DESCRIPTION file changes to retain
>     the package
>      > -The changes are purely formatting-related, not functional (all
>     checks pass)
>      > -I cannot submit without changing the version number
>      > -However, incrementing the version number seems disproportionate for
>      > formatting changes.
>      >
>      > I would greatly appreciate guidance on the proper way to handle this
>      > situation.
>      > What is the recommended approach for submitting DESCRIPTION file
>     formatting
>      > corrections for an already-accepted package, given that
>     incrementing the
>      > version number might seem a bit disproportionate?
>      >
>      > Thank you for your time and assistance.
> 
>     The simplest thing is to just update the version.? Use 1.1.1 if you
>     don't want to go to 1.2.
> 
>     Duncan Murdoch
>


From |kry|ov @end|ng |rom d|@root@org  Mon Oct 28 12:42:53 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Mon, 28 Oct 2024 14:42:53 +0300
Subject: [R-pkg-devel] 
 *** caught segfault *** address (nil), cause 'unknown'
In-Reply-To: <CACSk52-bmXQzSBXwp+Q2jvK0ucw=_-XAt1iw3HVV=+-9PwGPRQ@mail.gmail.com>
References: <CACSk52-bmXQzSBXwp+Q2jvK0ucw=_-XAt1iw3HVV=+-9PwGPRQ@mail.gmail.com>
Message-ID: <20241028144253.6e3c3988@arachnoid>

? Sat, 26 Oct 2024 12:18:07 -0400
j?r?my Gelb <gelbjeremy22 at gmail.com> ?????:

>  *** caught segfault ***
> address (nil), cause 'unknown'
> 
> It seems that the error is happening when loading a c++ module of my
> package
> 
> Traceback:
>  1: Module(module, mustStart = TRUE, where = env)
>  2: doTryCatch(return(expr), name, parentenv, handler)
>  3: tryCatchOne(expr, names, parentenv, handlers[[1L]])
>  4: tryCatchList(expr, classes, parentenv, handlers)
>  5: tryCatch(Module(module, mustStart = TRUE, where = env), error =
> function(e) e)
>  6: loadModule(module = "spatial_index_cpp", what = TRUE, env = ns,
>  loadNow = TRUE)
> 
> 
> It is rather strange because I have not edited this module since the
> last version and the package is installing correctly on other
> platforms

Perplexing. The method that usually works - starting a fresh Debian
trixie/sid virtual machine, installing clang-19 and R
build-dependencies, compiling R from source (with OR without
CXXFLAGS=-stdlib=libc++), installing fresh dependencies from CRAN
source packages and running R CMD check --as-cran - did not reproduce
the null pointer dereference and the crash.

The compiler versions did not exactly match (current Debian testing has
newer clang-19 than 19.1.0 that had compiled R or 19.1.1 that compiled
your package), but that looks very minor.

Although there was no crash on Windows, the Windows compilation log is
full of warnings about potential null pointer dereference:

https://win-builder.r-project.org/incoming_pretest/spNetwork_0.4.4.4_20241026_034629/Windows/00install.out

../inst/i/b/concept/detail/general.hpp:50:47: warning: 'this' pointer is null [-Wnonnull]
   50 |     static void failed() { ((Model*)0)->~Model(); }
      |                            ~~~~~~~~~~~~~~~~~~~^~
../inst/i/b/concept/usage.hpp:20:5: note: in a call to non-static member function 'boost::concepts::usage_requirements<Model>::~usage_requirements() [with Model = boost::geometry::concepts::Box<boost::geometry::model::box<boost::geometry::model::point<double, 2, boost::geometry::cs::cartesian> > >]'
   20 |     ~usage_requirements() { ((Model*)0)->~Model(); }
      |     ^

I see that, for example,
boost::geometry::concepts::Box<boost::geometry::model::box>::dimension_checker::apply()
creates a null pointer boost::geometry::model::box * b = 0 and then
calls geometry::set<...>(*b, geometry::get<...>(*b)). This _could_ be a
red herring, but class boost::geometry::model::box has member
variables. Could a previous version of the clang-19 compiler have
failed to elide member variable access in this call for some reason?
(According to the standard, having a null `this` pointer is always
undefined behaviour, so the compiler would not be exactly wrong to make
the application crash if this code is ever reached.)

-- 
Best regards,
Ivan


From jo@h@m@u|r|ch @end|ng |rom gm@||@com  Mon Oct 28 16:41:07 2024
From: jo@h@m@u|r|ch @end|ng |rom gm@||@com (Joshua Ulrich)
Date: Mon, 28 Oct 2024 10:41:07 -0500
Subject: [R-pkg-devel] DESCRIPTION file corrections for accepted package
In-Reply-To: <49f94200-e26a-4d4d-9934-988b5ec82269@gmail.com>
References: <CAMQoV_oo3ry2ZAsLDRMRASM9LE9ciOOy8a9W-Ykj9269gh=Bgg@mail.gmail.com>
 <142292b0-f4e2-4a96-b77e-a337d287606a@gmail.com>
 <CAMQoV_qqOx8AGcosji0QrvV2Vc-nnXE0cC5xZjkrssCLC+K6pA@mail.gmail.com>
 <49f94200-e26a-4d4d-9934-988b5ec82269@gmail.com>
Message-ID: <CAPPM_gS21xVZ7Fyh+xwQ3nGjUx4KdQyp7MF9hQR1t8ea0hhkwA@mail.gmail.com>

`R CMD check` uses the `package_version()` function to check that the
submitted package version is > the version on CRAN. You can use it to
check Duncan's hypothesis:

R$ # current update with 3-part version
R$ package_version("1.1.1") > package_version("1.1")
[1] TRUE
R$ # next update with only a 2-part version
R$ package_version("1.2") > package_version("1.1.1")
[1] TRUE


On Sun, Oct 27, 2024 at 8:16?AM Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
>
> I don't think R will enforce a 3 part version just because you used it
> once.  You might have other reasons to try to maintain versioning
> consistency.
>
> Duncan Murdoch
>
> On 2024-10-27 7:48 a.m., Gianmarco Alberti wrote:
> > Dear Duncan,
> >
> > Thank you for the straightforward guidance.
> >
> > My initial query stemmed from a concern about versioning consistency - I
> > thought that once using three digits (1.1.1), I would need to maintain
> > that format (e.g., 1.2.0) in future updates. Your suggestion clarified
> > that I can use 1.1.1 for these formatting changes and still use 1.2 for
> > future substantial updates.
> >
> > Best regards,
> >
> > Gm
> >
> >
> > Il giorno dom 27 ott 2024 alle ore 11:49 Duncan Murdoch
> > <murdoch.duncan at gmail.com <mailto:murdoch.duncan at gmail.com>> ha scritto:
> >
> >     On 2024-10-27 6:03 a.m., Gianmarco Alberti wrote:
> >      > Dear R Package Developers,
> >      > I am seeking guidance regarding a situation with my package
> >     'chisquare'
> >      > (version 1.1) on CRAN.
> >      >
> >      > Current situation:
> >      >
> >      > 1. The package was submitted and (automatically) accepted to CRAN
> >     (version
> >      > 1.1) after thorough local testing and complete devtools checks
> >      > (check_win_oldrelease(), check_win_release(), check_win_devel())
> >      >
> >      > 2. After acceptance, I received a request to make formatting
> >     changes to the
> >      > DESCRIPTION file by November 2, 2024:
> >      > -Remove version specifications for graphics and stats in Imports
> >      > -Update R version dependency format from R (>= 4.0.0) to R (>= 4.0)
> >      >
> >      > 3. Upon attempting to submit these formatting changes, I received
> >     a warning
> >      > about "Insufficient package version (submitted: 1.1, existing:
> >     1.1)". I am
> >      > well aware that this warning typically indicates the need to
> >     increment the
> >      > version number for new submissions of existing packages, as per CRAN
> >      > policies.
> >      >
> >      > This creates a procedural challenge:
> >      > -I need to make the requested DESCRIPTION file changes to retain
> >     the package
> >      > -The changes are purely formatting-related, not functional (all
> >     checks pass)
> >      > -I cannot submit without changing the version number
> >      > -However, incrementing the version number seems disproportionate for
> >      > formatting changes.
> >      >
> >      > I would greatly appreciate guidance on the proper way to handle this
> >      > situation.
> >      > What is the recommended approach for submitting DESCRIPTION file
> >     formatting
> >      > corrections for an already-accepted package, given that
> >     incrementing the
> >      > version number might seem a bit disproportionate?
> >      >
> >      > Thank you for your time and assistance.
> >
> >     The simplest thing is to just update the version.  Use 1.1.1 if you
> >     don't want to go to 1.2.
> >
> >     Duncan Murdoch
> >
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel



-- 
Joshua Ulrich  |  about.me/joshuaulrich
FOSS Trading  |  www.fosstrading.com


From georg|@bo@hn@kov @end|ng |rom m@nche@ter@@c@uk  Mon Oct 28 17:56:17 2024
From: georg|@bo@hn@kov @end|ng |rom m@nche@ter@@c@uk (Georgi Boshnakov)
Date: Mon, 28 Oct 2024 16:56:17 +0000
Subject: [R-pkg-devel] DESCRIPTION file corrections for accepted package
In-Reply-To: <CAPPM_gS21xVZ7Fyh+xwQ3nGjUx4KdQyp7MF9hQR1t8ea0hhkwA@mail.gmail.com>
References: <CAMQoV_oo3ry2ZAsLDRMRASM9LE9ciOOy8a9W-Ykj9269gh=Bgg@mail.gmail.com>
 <142292b0-f4e2-4a96-b77e-a337d287606a@gmail.com>
 <CAMQoV_qqOx8AGcosji0QrvV2Vc-nnXE0cC5xZjkrssCLC+K6pA@mail.gmail.com>
 <49f94200-e26a-4d4d-9934-988b5ec82269@gmail.com>
 <CAPPM_gS21xVZ7Fyh+xwQ3nGjUx4KdQyp7MF9hQR1t8ea0hhkwA@mail.gmail.com>
Message-ID: <LO0P265MB6325B421A9C4EE0D7E3999ADAE4A2@LO0P265MB6325.GBRP265.PROD.OUTLOOK.COM>

Also, v1.1 = v1.1.0:

>  package_version("1.1.0") > package_version("1.1")
[1] FALSE
>  package_version("1.1.0") == package_version("1.1")
[1] TRUE

If you adopt the 2-digit versions but decide to keep the possibility for 3-letter ones for minor fixes (bugs; fixing CRAN NOTES, minor bugs etc.), always use the four-digit development versions, e.g. 1.1.0.9000 after release of 1.1, to keep the possibility for 1.2 or 1.1.1 for the following release.

Georgi Boshnakov

________________________________________
From: R-package-devel <r-package-devel-bounces at r-project.org> on behalf of Joshua Ulrich <josh.m.ulrich at gmail.com>
Sent: 28 October 2024 15:41
To: Duncan Murdoch
Cc: R Package Development
Subject: Re: [R-pkg-devel] DESCRIPTION file corrections for accepted package

`R CMD check` uses the `package_version()` function to check that the submitted package version is > the version on CRAN. You can use it to check Duncan's hypothesis: R$ # current update with 3-part version R$ package_version("1.?1.?1") >
ZjQcmQRYFpfptBannerStart
This Message Is From a New External Sender
You have not previously corresponded with this sender. Please exercise caution when opening links or attachments included in this message.

ZjQcmQRYFpfptBannerEnd

`R CMD check` uses the `package_version()` function to check that the
submitted package version is > the version on CRAN. You can use it to
check Duncan's hypothesis:

R$ # current update with 3-part version
R$ package_version("1.1.1") > package_version("1.1")
[1] TRUE
R$ # next update with only a 2-part version
R$ package_version("1.2") > package_version("1.1.1")
[1] TRUE


On Sun, Oct 27, 2024 at 8:16?AM Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
>
> I don't think R will enforce a 3 part version just because you used it
> once.  You might have other reasons to try to maintain versioning
> consistency.
>
> Duncan Murdoch
>
> On 2024-10-27 7:48 a.m., Gianmarco Alberti wrote:
> > Dear Duncan,
> >
> > Thank you for the straightforward guidance.
> >
> > My initial query stemmed from a concern about versioning consistency - I
> > thought that once using three digits (1.1.1), I would need to maintain
> > that format (e.g., 1.2.0) in future updates. Your suggestion clarified
> > that I can use 1.1.1 for these formatting changes and still use 1.2 for
> > future substantial updates.
> >
> > Best regards,
> >
> > Gm
> >
> >
> > Il giorno dom 27 ott 2024 alle ore 11:49 Duncan Murdoch
> > <murdoch.duncan at gmail.com <mailto:murdoch.duncan at gmail.com>> ha scritto:
> >
> >     On 2024-10-27 6:03 a.m., Gianmarco Alberti wrote:
> >      > Dear R Package Developers,
> >      > I am seeking guidance regarding a situation with my package
> >     'chisquare'
> >      > (version 1.1) on CRAN.
> >      >
> >      > Current situation:
> >      >
> >      > 1. The package was submitted and (automatically) accepted to CRAN
> >     (version
> >      > 1.1) after thorough local testing and complete devtools checks
> >      > (check_win_oldrelease(), check_win_release(), check_win_devel())
> >      >
> >      > 2. After acceptance, I received a request to make formatting
> >     changes to the
> >      > DESCRIPTION file by November 2, 2024:
> >      > -Remove version specifications for graphics and stats in Imports
> >      > -Update R version dependency format from R (>= 4.0.0) to R (>= 4.0)
> >      >
> >      > 3. Upon attempting to submit these formatting changes, I received
> >     a warning
> >      > about "Insufficient package version (submitted: 1.1, existing:
> >     1.1)". I am
> >      > well aware that this warning typically indicates the need to
> >     increment the
> >      > version number for new submissions of existing packages, as per CRAN
> >      > policies.
> >      >
> >      > This creates a procedural challenge:
> >      > -I need to make the requested DESCRIPTION file changes to retain
> >     the package
> >      > -The changes are purely formatting-related, not functional (all
> >     checks pass)
> >      > -I cannot submit without changing the version number
> >      > -However, incrementing the version number seems disproportionate for
> >      > formatting changes.
> >      >
> >      > I would greatly appreciate guidance on the proper way to handle this
> >      > situation.
> >      > What is the recommended approach for submitting DESCRIPTION file
> >     formatting
> >      > corrections for an already-accepted package, given that
> >     incrementing the
> >      > version number might seem a bit disproportionate?
> >      >
> >      > Thank you for your time and assistance.
> >
> >     The simplest thing is to just update the version.  Use 1.1.1 if you
> >     don't want to go to 1.2.
> >
> >     Duncan Murdoch
> >
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://urldefense.com/v3/__https://stat.ethz.ch/mailman/listinfo/r-package-devel__;!!PDiH4ENfjr2_Jw!DCS7NzQVm5Q1FFruS86zOyiLNBS9_EZ46Qpjb7Ks8TvH80ChDrXf8l5x94KXWZtPgoOExpq8805sRyJ_Zz_aNn7qkCwbNu8XZ0yf$[stat[.]ethz[.]ch]



--
Joshua Ulrich  |  about.me/joshuaulrich
FOSS Trading  |  https://urldefense.com/v3/__http://www.fosstrading.com__;!!PDiH4ENfjr2_Jw!DCS7NzQVm5Q1FFruS86zOyiLNBS9_EZ46Qpjb7Ks8TvH80ChDrXf8l5x94KXWZtPgoOExpq8805sRyJ_Zz_aNn7qkCwbNgL0eU2t$[fosstrading[.]com]

______________________________________________
R-package-devel at r-project.org mailing list
https://urldefense.com/v3/__https://stat.ethz.ch/mailman/listinfo/r-package-devel__;!!PDiH4ENfjr2_Jw!DCS7NzQVm5Q1FFruS86zOyiLNBS9_EZ46Qpjb7Ks8TvH80ChDrXf8l5x94KXWZtPgoOExpq8805sRyJ_Zz_aNn7qkCwbNu8XZ0yf$[stat[.]ethz[.]ch]


From murdoch@dunc@n @end|ng |rom gm@||@com  Mon Oct 28 18:03:31 2024
From: murdoch@dunc@n @end|ng |rom gm@||@com (Duncan Murdoch)
Date: Mon, 28 Oct 2024 13:03:31 -0400
Subject: [R-pkg-devel] DESCRIPTION file corrections for accepted package
In-Reply-To: <LO0P265MB6325B421A9C4EE0D7E3999ADAE4A2@LO0P265MB6325.GBRP265.PROD.OUTLOOK.COM>
References: <CAMQoV_oo3ry2ZAsLDRMRASM9LE9ciOOy8a9W-Ykj9269gh=Bgg@mail.gmail.com>
 <142292b0-f4e2-4a96-b77e-a337d287606a@gmail.com>
 <CAMQoV_qqOx8AGcosji0QrvV2Vc-nnXE0cC5xZjkrssCLC+K6pA@mail.gmail.com>
 <49f94200-e26a-4d4d-9934-988b5ec82269@gmail.com>
 <CAPPM_gS21xVZ7Fyh+xwQ3nGjUx4KdQyp7MF9hQR1t8ea0hhkwA@mail.gmail.com>
 <LO0P265MB6325B421A9C4EE0D7E3999ADAE4A2@LO0P265MB6325.GBRP265.PROD.OUTLOOK.COM>
Message-ID: <aa5fa16b-194a-44af-81bb-8f7a173ad5f2@gmail.com>

On 2024-10-28 12:56 p.m., Georgi Boshnakov wrote:
> Also, v1.1 = v1.1.0:
> 
>>   package_version("1.1.0") > package_version("1.1")
> [1] FALSE
>>   package_version("1.1.0") == package_version("1.1")
> [1] TRUE
> 
> If you adopt the 2-digit versions but decide to keep the possibility for 3-letter ones for minor fixes (bugs; fixing CRAN NOTES, minor bugs etc.), always use the four-digit development versions, e.g. 1.1.0.9000 after release of 1.1, to keep the possibility for 1.2 or 1.1.1 for the following release.

That's one strategy, but it's not the one I use.  I generally increment 
the 3rd digit whenever I make a bug fix or minor change to the source. 
I won't necessarily release every one of those, but they'll be available 
on Github, and if I get a bug report that has been dealt with, I can say 
things like "that was fixed in version 1.2.12.  You can get 1.2.14 from 
Github using this code: ...., or wait a couple of months until a later 
version is released on CRAN".  I dislike Hadley's x.y.z.9000 scheme.

Duncan Murdoch


From @|mon@urb@nek @end|ng |rom R-project@org  Tue Oct 29 23:04:14 2024
From: @|mon@urb@nek @end|ng |rom R-project@org (Simon Urbanek)
Date: Wed, 30 Oct 2024 11:04:14 +1300
Subject: [R-pkg-devel] DESCRIPTION file corrections for accepted package
In-Reply-To: <CAMQoV_oo3ry2ZAsLDRMRASM9LE9ciOOy8a9W-Ykj9269gh=Bgg@mail.gmail.com>
References: <CAMQoV_oo3ry2ZAsLDRMRASM9LE9ciOOy8a9W-Ykj9269gh=Bgg@mail.gmail.com>
Message-ID: <780B18B5-3792-4532-B9E3-7374B2AEADE0@R-project.org>



> On 27 Oct 2024, at 23:03, Gianmarco Alberti <gianmarcoalberti at gmail.com> wrote:
> 
> Dear R Package Developers,
> I am seeking guidance regarding a situation with my package 'chisquare'
> (version 1.1) on CRAN.
> 
> Current situation:
> 
> 1. The package was submitted and (automatically) accepted to CRAN (version
> 1.1) after thorough local testing and complete devtools checks
> (check_win_oldrelease(), check_win_release(), check_win_devel())
> 
> 2. After acceptance, I received a request to make formatting changes to the
> DESCRIPTION file by November 2, 2024:
> -Remove version specifications for graphics and stats in Imports
> -Update R version dependency format from R (>= 4.0.0) to R (>= 4.0)
> 
> 3. Upon attempting to submit these formatting changes, I received a warning
> about "Insufficient package version (submitted: 1.1, existing: 1.1)". I am
> well aware that this warning typically indicates the need to increment the
> version number for new submissions of existing packages, as per CRAN
> policies.
> 
> This creates a procedural challenge:
> -I need to make the requested DESCRIPTION file changes to retain the package
> -The changes are purely formatting-related, not functional (all checks pass)
> -I cannot submit without changing the version number
> -However, incrementing the version number seems disproportionate for
> formatting changes.
> 


But it is not. ANY change requires a version bump. You cannot have two files with different content yet the same version - the whole point of version is to uniquely identify content. Whether the change is just cosmetic or not is irrelevant (in your case it is actually functional so not even a question). As Rob Gentleman is fond of saying, version numbers are cheap ;). In your case I?d just use 1.1-1 (see semantic versioning which is highly recommended to follow)

Cheers,
Simon



> I would greatly appreciate guidance on the proper way to handle this
> situation.
> What is the recommended approach for submitting DESCRIPTION file formatting
> corrections for an already-accepted package, given that incrementing the
> version number might seem a bit disproportionate?
> 
> Thank you for your time and assistance.
> 
> [[alternative HTML version deleted]]
> 
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
> 


From k@||eng|u @end|ng |rom gm@||@com  Wed Oct 30 03:21:16 2024
From: k@||eng|u @end|ng |rom gm@||@com (Kaifeng Lu)
Date: Tue, 29 Oct 2024 22:21:16 -0400
Subject: [R-pkg-devel] clang-san issue with R vignettes using ggplot2
Message-ID: <CAAsVnmJ_j-Pf=b7Cq4q7UAMa9V1CLVuPsnnHUFORSoP66f5e4g@mail.gmail.com>

Dear friends,

I received clang-san error messages for all vignettes that include ggplot2
figures when submitting an R package to CRAN. Please see below for an
example.

How can I resolve this problem without replacing the ggplot2 figures with
base R plots?

Thank you in advance for your help.

Regards,
Kaifeng

--- re-building ?tsegest.Rmd? using rmarkdown
  ** Processing:
/home/hornik/tmp/CRAN_special_clang-san/trtswitch.Rcheck/vign_test/trtswitch/vignettes/tsegest_files/figure-html/km-1.png
  288x288 pixels, 8 bits/pixel, 256 colors in palette
  Reducing image to 8 bits/pixel, grayscale
  Input IDAT size = 4659 bytes
  Input file size = 5517 bytes

  Trying:
    zc = 9  zm = 8  zs = 0  f = 0		IDAT size = 4256
    zc = 9  zm = 8  zs = 1  f = 0		IDAT size = 4226
    zc = 1  zm = 8  zs = 2  f = 0
    zc = 9  zm = 8  zs = 3  f = 0
    zc = 9  zm = 8  zs = 0  f = 5
    zc = 9  zm = 8  zs = 1  f = 5
    zc = 1  zm = 8  zs = 2  f = 5
    zc = 9  zm = 8  zs = 3  f = 5

  Selecting parameters:
    zc = 9  zm = 8  zs = 1  f = 0		IDAT size = 4226

  Output IDAT size = 4226 bytes (433 bytes decrease)
  Output file size = 4304 bytes (1213 bytes = 21.99% decrease)

  ** Processing:
/home/hornik/tmp/CRAN_special_clang-san/trtswitch.Rcheck/vign_test/trtswitch/vignettes/tsegest_files/figure-html/Z(psi)-1.png
  288x288 pixels, 8 bits/pixel, 256 colors in palette
  Reducing image to 8 bits/pixel, grayscale
  Input IDAT size = 5933 bytes
  Input file size = 6791 bytes

  Trying:
    zc = 9  zm = 8  zs = 0  f = 0		IDAT size = 5349
    zc = 9  zm = 8  zs = 1  f = 0
    zc = 1  zm = 8  zs = 2  f = 0
    zc = 9  zm = 8  zs = 3  f = 0
    zc = 9  zm = 8  zs = 0  f = 5
    zc = 9  zm = 8  zs = 1  f = 5
    zc = 1  zm = 8  zs = 2  f = 5
    zc = 9  zm = 8  zs = 3  f = 5

  Selecting parameters:
    zc = 9  zm = 8  zs = 0  f = 0		IDAT size = 5349

  Output IDAT size = 5349 bytes (584 bytes decrease)
  Output file size = 5427 bytes (1364 bytes = 20.09% decrease)

  --- finished re-building ?tsegest.Rmd?

  +-+tsegest.html

  =================================================================
  ==1429888==ERROR: LeakSanitizer: detected memory leaks

  Direct leak of 7680 byte(s) in 12 object(s) allocated from:
      #0 0x55b3e7ff95d0 in realloc
(/home/hornik/tmp/R-d-clang-xtra/bin/exec/R+0xc65d0) (BuildId:
71b7cc9351bcc02083f9df16c056d5fba06ed51c)
      #1 0x7f61fcbd7d28
(/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0x24d28) (BuildId:
4b26d8a18d92f6f97cf8eccd56f114fb89e44039)

  Direct leak of 6656 byte(s) in 26 object(s) allocated from:
      #0 0x55b3e7ff91b3 in malloc
(/home/hornik/tmp/R-d-clang-xtra/bin/exec/R+0xc61b3) (BuildId:
71b7cc9351bcc02083f9df16c056d5fba06ed51c)
      #1 0x7f61fcbd7c81
(/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0x24c81) (BuildId:
4b26d8a18d92f6f97cf8eccd56f114fb89e44039)

  Indirect leak of 25920 byte(s) in 810 object(s) allocated from:
      #0 0x55b3e7ff91b3 in malloc
(/home/hornik/tmp/R-d-clang-xtra/bin/exec/R+0xc61b3) (BuildId:
71b7cc9351bcc02083f9df16c056d5fba06ed51c)
      #1 0x7f61fcbc198f
(/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0xe98f) (BuildId:
4b26d8a18d92f6f97cf8eccd56f114fb89e44039)

  Indirect leak of 11982 byte(s) in 994 object(s) allocated from:
      #0 0x55b3e7fe0ebe in strdup
(/home/hornik/tmp/R-d-clang-xtra/bin/exec/R+0xadebe) (BuildId:
71b7cc9351bcc02083f9df16c056d5fba06ed51c)
      #1 0x7f61fcbd74d7 in FcValueSave
(/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0x244d7) (BuildId:
4b26d8a18d92f6f97cf8eccd56f114fb89e44039)

  Indirect leak of 8768 byte(s) in 274 object(s) allocated from:
      #0 0x55b3e7ff939d in calloc
(/home/hornik/tmp/R-d-clang-xtra/bin/exec/R+0xc639d) (BuildId:
71b7cc9351bcc02083f9df16c056d5fba06ed51c)
      #1 0x7f61fcbd8450
(/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0x25450) (BuildId:
4b26d8a18d92f6f97cf8eccd56f114fb89e44039)

  Indirect leak of 5376 byte(s) in 168 object(s) allocated from:
      #0 0x55b3e7ff939d in calloc
(/home/hornik/tmp/R-d-clang-xtra/bin/exec/R+0xc639d) (BuildId:
71b7cc9351bcc02083f9df16c056d5fba06ed51c)
      #1 0x7f61fcbd7862
(/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0x24862) (BuildId:
4b26d8a18d92f6f97cf8eccd56f114fb89e44039)

  Indirect leak of 1152 byte(s) in 36 object(s) allocated from:
      #0 0x55b3e7ff939d in calloc
(/home/hornik/tmp/R-d-clang-xtra/bin/exec/R+0xc639d) (BuildId:
71b7cc9351bcc02083f9df16c056d5fba06ed51c)
      #1 0x7f61fcbd770f
(/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0x2470f) (BuildId:
4b26d8a18d92f6f97cf8eccd56f114fb89e44039)

  Indirect leak of 384 byte(s) in 12 object(s) allocated from:
      #0 0x55b3e7ff939d in calloc
(/home/hornik/tmp/R-d-clang-xtra/bin/exec/R+0xc639d) (BuildId:
71b7cc9351bcc02083f9df16c056d5fba06ed51c)
      #1 0x7f61fcbd777f
(/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0x2477f) (BuildId:
4b26d8a18d92f6f97cf8eccd56f114fb89e44039)

  Indirect leak of 288 byte(s) in 6 object(s) allocated from:
      #0 0x55b3e7ff91b3 in malloc
(/home/hornik/tmp/R-d-clang-xtra/bin/exec/R+0xc61b3) (BuildId:
71b7cc9351bcc02083f9df16c056d5fba06ed51c)
      #1 0x7f61fcbd0d2f in FcLangSetCopy
(/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0x1dd2f) (BuildId:
4b26d8a18d92f6f97cf8eccd56f114fb89e44039)

	[[alternative HTML version deleted]]


From bbo|ker @end|ng |rom gm@||@com  Wed Oct 30 03:36:54 2024
From: bbo|ker @end|ng |rom gm@||@com (Ben Bolker)
Date: Tue, 29 Oct 2024 22:36:54 -0400
Subject: [R-pkg-devel] clang-san issue with R vignettes using ggplot2
In-Reply-To: <CAAsVnmJ_j-Pf=b7Cq4q7UAMa9V1CLVuPsnnHUFORSoP66f5e4g@mail.gmail.com>
References: <CAAsVnmJ_j-Pf=b7Cq4q7UAMa9V1CLVuPsnnHUFORSoP66f5e4g@mail.gmail.com>
Message-ID: <CABghstSTk=-pmb9NX4Crnn+1p27vAizSS1k6zK3-CaZMs8003A@mail.gmail.com>

Can you tell us more about/point us to the code for the plots that are
triggering these errors? (eg, are you using unusual fonts or other
settings?)

On Tue, Oct 29, 2024, 10:22 PM Kaifeng Lu <kaifenglu at gmail.com> wrote:

> Dear friends,
>
> I received clang-san error messages for all vignettes that include ggplot2
> figures when submitting an R package to CRAN. Please see below for an
> example.
>
> How can I resolve this problem without replacing the ggplot2 figures with
> base R plots?
>
> Thank you in advance for your help.
>
> Regards,
> Kaifeng
>
> --- re-building ?tsegest.Rmd? using rmarkdown
>   ** Processing:
>
> /home/hornik/tmp/CRAN_special_clang-san/trtswitch.Rcheck/vign_test/trtswitch/vignettes/tsegest_files/figure-html/km-1.png
>   288x288 pixels, 8 bits/pixel, 256 colors in palette
>   Reducing image to 8 bits/pixel, grayscale
>   Input IDAT size = 4659 bytes
>   Input file size = 5517 bytes
>
>   Trying:
>     zc = 9  zm = 8  zs = 0  f = 0               IDAT size = 4256
>     zc = 9  zm = 8  zs = 1  f = 0               IDAT size = 4226
>     zc = 1  zm = 8  zs = 2  f = 0
>     zc = 9  zm = 8  zs = 3  f = 0
>     zc = 9  zm = 8  zs = 0  f = 5
>     zc = 9  zm = 8  zs = 1  f = 5
>     zc = 1  zm = 8  zs = 2  f = 5
>     zc = 9  zm = 8  zs = 3  f = 5
>
>   Selecting parameters:
>     zc = 9  zm = 8  zs = 1  f = 0               IDAT size = 4226
>
>   Output IDAT size = 4226 bytes (433 bytes decrease)
>   Output file size = 4304 bytes (1213 bytes = 21.99% decrease)
>
>   ** Processing:
>
> /home/hornik/tmp/CRAN_special_clang-san/trtswitch.Rcheck/vign_test/trtswitch/vignettes/tsegest_files/figure-html/Z(psi)-1.png
>   288x288 pixels, 8 bits/pixel, 256 colors in palette
>   Reducing image to 8 bits/pixel, grayscale
>   Input IDAT size = 5933 bytes
>   Input file size = 6791 bytes
>
>   Trying:
>     zc = 9  zm = 8  zs = 0  f = 0               IDAT size = 5349
>     zc = 9  zm = 8  zs = 1  f = 0
>     zc = 1  zm = 8  zs = 2  f = 0
>     zc = 9  zm = 8  zs = 3  f = 0
>     zc = 9  zm = 8  zs = 0  f = 5
>     zc = 9  zm = 8  zs = 1  f = 5
>     zc = 1  zm = 8  zs = 2  f = 5
>     zc = 9  zm = 8  zs = 3  f = 5
>
>   Selecting parameters:
>     zc = 9  zm = 8  zs = 0  f = 0               IDAT size = 5349
>
>   Output IDAT size = 5349 bytes (584 bytes decrease)
>   Output file size = 5427 bytes (1364 bytes = 20.09% decrease)
>
>   --- finished re-building ?tsegest.Rmd?
>
>   +-+tsegest.html
>
>   =================================================================
>   ==1429888==ERROR: LeakSanitizer: detected memory leaks
>
>   Direct leak of 7680 byte(s) in 12 object(s) allocated from:
>       #0 0x55b3e7ff95d0 in realloc
> (/home/hornik/tmp/R-d-clang-xtra/bin/exec/R+0xc65d0) (BuildId:
> 71b7cc9351bcc02083f9df16c056d5fba06ed51c)
>       #1 0x7f61fcbd7d28
> (/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0x24d28) (BuildId:
> 4b26d8a18d92f6f97cf8eccd56f114fb89e44039)
>
>   Direct leak of 6656 byte(s) in 26 object(s) allocated from:
>       #0 0x55b3e7ff91b3 in malloc
> (/home/hornik/tmp/R-d-clang-xtra/bin/exec/R+0xc61b3) (BuildId:
> 71b7cc9351bcc02083f9df16c056d5fba06ed51c)
>       #1 0x7f61fcbd7c81
> (/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0x24c81) (BuildId:
> 4b26d8a18d92f6f97cf8eccd56f114fb89e44039)
>
>   Indirect leak of 25920 byte(s) in 810 object(s) allocated from:
>       #0 0x55b3e7ff91b3 in malloc
> (/home/hornik/tmp/R-d-clang-xtra/bin/exec/R+0xc61b3) (BuildId:
> 71b7cc9351bcc02083f9df16c056d5fba06ed51c)
>       #1 0x7f61fcbc198f
> (/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0xe98f) (BuildId:
> 4b26d8a18d92f6f97cf8eccd56f114fb89e44039)
>
>   Indirect leak of 11982 byte(s) in 994 object(s) allocated from:
>       #0 0x55b3e7fe0ebe in strdup
> (/home/hornik/tmp/R-d-clang-xtra/bin/exec/R+0xadebe) (BuildId:
> 71b7cc9351bcc02083f9df16c056d5fba06ed51c)
>       #1 0x7f61fcbd74d7 in FcValueSave
> (/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0x244d7) (BuildId:
> 4b26d8a18d92f6f97cf8eccd56f114fb89e44039)
>
>   Indirect leak of 8768 byte(s) in 274 object(s) allocated from:
>       #0 0x55b3e7ff939d in calloc
> (/home/hornik/tmp/R-d-clang-xtra/bin/exec/R+0xc639d) (BuildId:
> 71b7cc9351bcc02083f9df16c056d5fba06ed51c)
>       #1 0x7f61fcbd8450
> (/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0x25450) (BuildId:
> 4b26d8a18d92f6f97cf8eccd56f114fb89e44039)
>
>   Indirect leak of 5376 byte(s) in 168 object(s) allocated from:
>       #0 0x55b3e7ff939d in calloc
> (/home/hornik/tmp/R-d-clang-xtra/bin/exec/R+0xc639d) (BuildId:
> 71b7cc9351bcc02083f9df16c056d5fba06ed51c)
>       #1 0x7f61fcbd7862
> (/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0x24862) (BuildId:
> 4b26d8a18d92f6f97cf8eccd56f114fb89e44039)
>
>   Indirect leak of 1152 byte(s) in 36 object(s) allocated from:
>       #0 0x55b3e7ff939d in calloc
> (/home/hornik/tmp/R-d-clang-xtra/bin/exec/R+0xc639d) (BuildId:
> 71b7cc9351bcc02083f9df16c056d5fba06ed51c)
>       #1 0x7f61fcbd770f
> (/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0x2470f) (BuildId:
> 4b26d8a18d92f6f97cf8eccd56f114fb89e44039)
>
>   Indirect leak of 384 byte(s) in 12 object(s) allocated from:
>       #0 0x55b3e7ff939d in calloc
> (/home/hornik/tmp/R-d-clang-xtra/bin/exec/R+0xc639d) (BuildId:
> 71b7cc9351bcc02083f9df16c056d5fba06ed51c)
>       #1 0x7f61fcbd777f
> (/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0x2477f) (BuildId:
> 4b26d8a18d92f6f97cf8eccd56f114fb89e44039)
>
>   Indirect leak of 288 byte(s) in 6 object(s) allocated from:
>       #0 0x55b3e7ff91b3 in malloc
> (/home/hornik/tmp/R-d-clang-xtra/bin/exec/R+0xc61b3) (BuildId:
> 71b7cc9351bcc02083f9df16c056d5fba06ed51c)
>       #1 0x7f61fcbd0d2f in FcLangSetCopy
> (/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0x1dd2f) (BuildId:
> 4b26d8a18d92f6f97cf8eccd56f114fb89e44039)
>
>         [[alternative HTML version deleted]]
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>

	[[alternative HTML version deleted]]


From |kry|ov @end|ng |rom d|@root@org  Wed Oct 30 07:57:29 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Wed, 30 Oct 2024 09:57:29 +0300
Subject: [R-pkg-devel] clang-san issue with R vignettes using ggplot2
In-Reply-To: <CAAsVnmJ_j-Pf=b7Cq4q7UAMa9V1CLVuPsnnHUFORSoP66f5e4g@mail.gmail.com>
References: <CAAsVnmJ_j-Pf=b7Cq4q7UAMa9V1CLVuPsnnHUFORSoP66f5e4g@mail.gmail.com>
Message-ID: <20241030095729.79f4e0dd@Tarkus>

? Tue, 29 Oct 2024 22:21:16 -0400
Kaifeng Lu <kaifenglu at gmail.com> ?????:

>   ==1429888==ERROR: LeakSanitizer: detected memory leaks
> 
>   Direct leak of 7680 byte(s) in 12 object(s) allocated from:
>       #0 0x55b3e7ff95d0 in realloc
> (/home/hornik/tmp/R-d-clang-xtra/bin/exec/R+0xc65d0) (BuildId:
> 71b7cc9351bcc02083f9df16c056d5fba06ed51c)
>       #1 0x7f61fcbd7d28
> (/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0x24d28) (BuildId:
> 4b26d8a18d92f6f97cf8eccd56f114fb89e44039)

I found the link to the full test output at
<https://win-builder.r-project.org/incoming_pretest/trtswitch_0.1.1_20241030_031632/>
(it's best to link to the check logs and source code when seeking help
here) and I don't think these are caused by your code. fontconfig leaks
small amounts of memory by itself, without your package:

$ build-san/bin/R -q -s -e 'png("/dev/null"); plot(1,1); dev.off()'
null device
 1

=================================================================                                                    
==22925==ERROR: LeakSanitizer: detected memory leaks            

Direct leak of 6912 byte(s) in 27 object(s) allocated from:                  
    #0 0x7f1154cb89cf in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:69
    #1 0x7f1149857431  (/usr/lib/x86_64-linux-gnu/libfontconfig.so.1+0x23431)
<...>
SUMMARY: AddressSanitizer: 45733 byte(s) leaked in 1474 allocation(s).

I think that this check may need suppressions at least for fontconfig:
<https://github.com/google/sanitizers/wiki/AddressSanitizerLeakSanitizer#suppressions>.
Alternatively, Prof. Kurt Hornik may set the environment variable
ASAN_OPTIONS="detect_leaks=0" like done by Prof. Brian D. Ripley:
https://www.stats.ox.ac.uk/pub/bdr/memtests/README.txt

-- 
Best regards,
Ivan


From k@||eng|u @end|ng |rom gm@||@com  Thu Oct 31 17:06:25 2024
From: k@||eng|u @end|ng |rom gm@||@com (Kaifeng Lu)
Date: Thu, 31 Oct 2024 12:06:25 -0400
Subject: [R-pkg-devel] Warnings related to functions from the survival
 package
Message-ID: <CAAsVnmJ=EurBKD6ber9umE68bH5ZO6HhmHuhX4ryHbWgXJ+cqQ@mail.gmail.com>

Dear friends,

I received the following warning messages related to functions from the
survival package. I didn't directly use the functions mentioned below:
coxph_wtest, agsurv5, survdiff2, and coxmart. I believe they are used by
higher-level functions from the survival package, such as survdiff and
coxph, which I used in my unit tests. Does anyone know how to get rid of
suchwarning to pass the CRAN checks?

Thank you very much in advance for your help.

Regards,
Kaifeng


package trtswitch_0.1.1.tar.gz does not pass the incoming checks
automatically, please see the following pre-tests (additional issue checks):
Windows: <
https://win-builder.r-project.org/incoming_pretest/trtswitch_0.1.1_20241031_134058/Windows/00check.log
>
Status: OK
Debian: <
https://win-builder.r-project.org/incoming_pretest/trtswitch_0.1.1_20241031_134058/Debian/00check.log
>
Status: OK

Additional issues checked: <
https://win-builder.r-project.org/incoming_pretest/trtswitch_0.1.1_20241031_134058/specialChecks/
>
clang-san: Status: WARNING

More details are given in the directory:
<
https://win-builder.r-project.org/incoming_pretest/trtswitch_0.1.1_20241031_134058/
>
The files will be removed after roughly 7 days.


Flavor: r-devel-linux-x86_64-debian-special-clang-san
Check: *, Result: NA


Flavor: r-devel-linux-x86_64-debian-special-clang-san
Check: Post-processing issues found for clang-san, Result: WARNING
  File: tests/testthat.Rout
  /home/hornik/src/R/src/main/dotcode.c:1978:2: runtime error: call to
function coxph_wtest through pointer to incorrect function type 'void
(*)(void *, void *, void *, void *, void *, void *)'
  /home/hornik/src/R/src/main/dotcode.c:1994:2: runtime error: call to
function agsurv5 through pointer to incorrect function type 'void (*)(void
*, void *, void *, void *, void *, void *, void *, void *, void *, void *)'
  /home/hornik/src/R/src/main/dotcode.c:2008:2: runtime error: call to
function survdiff2 through pointer to incorrect function type 'void
(*)(void *, void *, void *, void *, void *, void *, void *, void *, void *,
void *, void *, void *, void *)'
  /home/hornik/src/R/src/main/dotcode.c:1986:2: runtime error: call to
function coxmart through pointer to incorrect function type 'void (*)(void
*, void *, void *, void *, void *, void *, void *, void *)'

	[[alternative HTML version deleted]]


From |kry|ov @end|ng |rom d|@root@org  Thu Oct 31 17:39:14 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Thu, 31 Oct 2024 19:39:14 +0300
Subject: [R-pkg-devel] Warnings related to functions from the survival
 package
In-Reply-To: <CAAsVnmJ=EurBKD6ber9umE68bH5ZO6HhmHuhX4ryHbWgXJ+cqQ@mail.gmail.com>
References: <CAAsVnmJ=EurBKD6ber9umE68bH5ZO6HhmHuhX4ryHbWgXJ+cqQ@mail.gmail.com>
Message-ID: <20241031193914.54310b7e@arachnoid>

? Thu, 31 Oct 2024 12:06:25 -0400
Kaifeng Lu <kaifenglu at gmail.com> ?????:

>   /home/hornik/src/R/src/main/dotcode.c:1978:2: runtime error: call to
> function coxph_wtest through pointer to incorrect function type 'void
> (*)(void *, void *, void *, void *, void *, void *)'
>   /home/hornik/src/R/src/main/dotcode.c:1994:2: runtime error: call to
> function agsurv5 through pointer to incorrect function type 'void
> (*)(void *, void *, void *, void *, void *, void *, void *, void *,
> void *, void *)' /home/hornik/src/R/src/main/dotcode.c:2008:2:
> runtime error: call to function survdiff2 through pointer to
> incorrect function type 'void (*)(void *, void *, void *, void *,
> void *, void *, void *, void *, void *, void *, void *, void *, void
> *)' /home/hornik/src/R/src/main/dotcode.c:1986:2: runtime error: call
> to function coxmart through pointer to incorrect function type 'void
> (*)(void *, void *, void *, void *, void *, void *, void *, void *)'

This is something R does to call all .C() / .Fortran() functions. For
example, coxph_wtest actually takes int*, int*, double*, double*,
double*, double *, but R assumes that the calling convention is the
same as if it took 6 times void* and calls it through a pointer of a
different type [1]. In practice it works well, but formally, calling a
function through a pointer of a different type is undefined behaviour.
Unfortunately, there is no easy way to call arbitrary functions, like
.C() and .Fortran() do, without either breaking some rules (which
happens here) or generating function calls at runtime (like some
foreign function interfaces do, which is less portable).

This check may need suppressions for src/main/dotcode.c or special
attributes [2] on R's do_dotCode.

-- 
Best regards,
Ivan

[1]
https://github.com/r-devel/r-svn/blob/91a84c048a26b2b776603482545e4678625a54c3/src/main/dotcode.c#L1977-L1979

[2]
https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html#issue-suppression


From tom@@@k@||ber@ @end|ng |rom gm@||@com  Thu Oct 31 17:59:01 2024
From: tom@@@k@||ber@ @end|ng |rom gm@||@com (Tomas Kalibera)
Date: Thu, 31 Oct 2024 17:59:01 +0100
Subject: [R-pkg-devel] Warnings related to functions from the survival
 package
In-Reply-To: <20241031193914.54310b7e@arachnoid>
References: <CAAsVnmJ=EurBKD6ber9umE68bH5ZO6HhmHuhX4ryHbWgXJ+cqQ@mail.gmail.com>
 <20241031193914.54310b7e@arachnoid>
Message-ID: <f78c3ec9-30ba-4edb-afe2-0244dff37715@gmail.com>


On 10/31/24 17:39, Ivan Krylov via R-package-devel wrote:
> ? Thu, 31 Oct 2024 12:06:25 -0400
> Kaifeng Lu <kaifenglu at gmail.com> ?????:
>
>>    /home/hornik/src/R/src/main/dotcode.c:1978:2: runtime error: call to
>> function coxph_wtest through pointer to incorrect function type 'void
>> (*)(void *, void *, void *, void *, void *, void *)'
>>    /home/hornik/src/R/src/main/dotcode.c:1994:2: runtime error: call to
>> function agsurv5 through pointer to incorrect function type 'void
>> (*)(void *, void *, void *, void *, void *, void *, void *, void *,
>> void *, void *)' /home/hornik/src/R/src/main/dotcode.c:2008:2:
>> runtime error: call to function survdiff2 through pointer to
>> incorrect function type 'void (*)(void *, void *, void *, void *,
>> void *, void *, void *, void *, void *, void *, void *, void *, void
>> *)' /home/hornik/src/R/src/main/dotcode.c:1986:2: runtime error: call
>> to function coxmart through pointer to incorrect function type 'void
>> (*)(void *, void *, void *, void *, void *, void *, void *, void *)'
> This is something R does to call all .C() / .Fortran() functions. For
> example, coxph_wtest actually takes int*, int*, double*, double*,
> double*, double *, but R assumes that the calling convention is the
> same as if it took 6 times void* and calls it through a pointer of a
> different type [1]. In practice it works well, but formally, calling a
> function through a pointer of a different type is undefined behaviour.
> Unfortunately, there is no easy way to call arbitrary functions, like
> .C() and .Fortran() do, without either breaking some rules (which
> happens here) or generating function calls at runtime (like some
> foreign function interfaces do, which is less portable).
>
> This check may need suppressions for src/main/dotcode.c or special
> attributes [2] on R's do_dotCode.

Yes, yes. This is in base R and can be ignored by package authors.

We might consider outsourcing this e.g. to libffi at some point, but for 
now, if you know an elegant, minimal way how to suppress this, and have 
the time and energy, a patch would be welcome. We've known about this 
since the start of this year, but it hasn't gotten high enough on 
anyone's priority list, and then popped up here.

Best
Tomas

>


From n|ko@bo@@e @end|ng |rom gm@||@com  Thu Oct 31 18:04:47 2024
From: n|ko@bo@@e @end|ng |rom gm@||@com (Nikos Bosse)
Date: Thu, 31 Oct 2024 18:04:47 +0100
Subject: [R-pkg-devel] HTML validation error in roxygen2 generated
 documentation
Message-ID: <084d69e2-dc9e-41ba-aab9-21c0a5ef054f@Spark>

Dear list,

I'm trying to submit an updated version of R package scoringutils to CRAN (https://github.com/epiforecasts/scoringutils). I built the package using `R CMD build` with Roxygen2 7.3.2 both on Mac and on Ubuntu.

I'm seeing a NOTE related to several HTML validation problems (see below).

These are some of the offending Rd files and corresponding source files:

? https://github.com/epiforecasts/scoringutils/blob/main/man/ae_median_quantile.Rd, https://github.com/epiforecasts/scoringutils/blob/efb41afd9925ffc4b62963abc0642cc1f7447c22/R/metrics-quantile.R#L559
? https://github.com/epiforecasts/scoringutils/blob/main/man/dss_sample.Rd, https://github.com/epiforecasts/scoringutils/blob/efb41afd9925ffc4b62963abc0642cc1f7447c22/R/metrics-sample.R#L224
? https://github.com/epiforecasts/scoringutils/blob/main/man/interpolate_median.Rd, https://github.com/epiforecasts/scoringutils/blob/efb41afd9925ffc4b62963abc0642cc1f7447c22/R/metrics-quantile.R#L530


I suspect the issue might be related to images that get added using the following code (https://github.com/epiforecasts/scoringutils/blob/efb41afd9925ffc4b62963abc0642cc1f7447c22/R/documentation-templates.R#L106):

```
#' Illustration of required inputs for sample-based forecasts
#' @details # Input format
#' \if{html}{
#'? ?\out{<div style="text-align: left">}
#'? ?\figure{metrics-sample.png}{options: style="width:750px;max-width:100\%;"}
#'? ?\out{</div>}
#' }
#' \if{latex}{
#'? ?\figure{metrics-sample.png}
#' }
#' @name illustration-input-metric-sample
#' @keywords internal
NULL
```

I've tried changing @details to @section, tried adding linebreaks, but that didn't help, unfortunately.
Any help would be much appreciated, thank you!

Best wishes,
Nikos


CRAN Note:

Flavor: r-devel-linux-x86_64-debian-gcc, r-devel-windows-x86_64
Check: HTML version of manual, Result: NOTE
?Found the following HTML validation problems:
?ae_median_quantile.html:79:1 (ae_median_quantile.Rd:41): Warning: inserting implicit <p>
?ae_median_quantile.html:79:1 (ae_median_quantile.Rd:41): Warning: trimming empty <p>
?ae_median_sample.html:71:1 (ae_median_sample.Rd:35): Warning: inserting implicit <p>
?ae_median_sample.html:71:1 (ae_median_sample.Rd:35): Warning: trimming empty <p>
?bias_quantile.html:133:1 (bias_quantile.Rd:85): Warning: inserting implicit <p>
?bias_quantile.html:133:1 (bias_quantile.Rd:85): Warning: trimming empty <p>
?bias_sample.html:94:1 (bias_sample.Rd:56): Warning: inserting implicit <p>
?bias_sample.html:94:1 (bias_sample.Rd:56): Warning: trimming empty <p>
?crps_sample.html:107:1 (crps_sample.Rd:73): Warning: inserting implicit <p>
?crps_sample.html:107:1 (crps_sample.Rd:73): Warning: trimming empty <p>
?dss_sample.html:70:1 (dss_sample.Rd:35): Warning: inserting implicit <p>
?dss_sample.html:70:1 (dss_sample.Rd:35): Warning: trimming empty <p>
?get_metrics.forecast_binary.html:82:1 (get_metrics.forecast_binary.Rd:39): Warning: inserting implicit <p>
?get_metrics.forecast_binary.html:82:1 (get_metrics.forecast_binary.Rd:39): Warning: trimming empty <p>
?get_metrics.forecast_point.html:92:1 (get_metrics.forecast_point.Rd:50): Warning: inserting implicit <p>
?get_metrics.forecast_point.html:92:1 (get_metrics.forecast_point.Rd:50): Warning: trimming empty <p>
?get_metrics.forecast_quantile.html:104:1 (get_metrics.forecast_quantile.Rd:52): Warning: inserting implicit <p>
?get_metrics.forecast_quantile.html:104:1 (get_metrics.forecast_quantile.Rd:52): Warning: trimming empty <p>
?get_metrics.forecast_sample.html:100:1 (get_metrics.forecast_sample.Rd:44): Warning: inserting implicit <p>
?get_metrics.forecast_sample.html:100:1 (get_metrics.forecast_sample.Rd:44): Warning: trimming empty <p>
?get_pairwise_comparisons.html:43:1 (get_pairwise_comparisons.Rd:74): Warning: inserting implicit <p>
?get_pairwise_comparisons.html:43:1 (get_pairwise_comparisons.Rd:74): Warning: trimming empty <p>
?illustration-input-metric-binary-point.html:35:1 (illustration-input-metric-binary-point.Rd:17): Warning: inserting implicit <p>
?illustration-input-metric-binary-point.html:35:1 (illustration-input-metric-binary-point.Rd:17): Warning: trimming empty <p>
?illustration-input-metric-nominal.html:35:1 (illustration-input-metric-nominal.Rd:17): Warning: inserting implicit <p>
?illustration-input-metric-nominal.html:35:1 (illustration-input-metric-nominal.Rd:17): Warning: trimming empty <p>
?illustration-input-metric-quantile.html:35:1 (illustration-input-metric-quantile.Rd:17): Warning: inserting implicit <p>
?illustration-input-metric-quantile.html:35:1 (illustration-input-metric-quantile.Rd:17): Warning: trimming empty <p>
?illustration-input-metric-sample.html:35:1 (illustration-input-metric-sample.Rd:17): Warning: inserting implicit <p>
?illustration-input-metric-sample.html:35:1 (illustration-input-metric-sample.Rd:17): Warning: trimming empty <p>
?interpolate_median.html:67:1 (interpolate_median.Rd:34): Warning: inserting implicit <p>
?interpolate_median.html:67:1 (interpolate_median.Rd:34): Warning: trimming empty <p>
?interval_coverage.html:83:1 (interval_coverage.Rd:46): Warning: inserting implicit <p>
?interval_coverage.html:83:1 (interval_coverage.Rd:46): Warning: trimming empty <p>
?logs_sample.html:81:1 (logs_sample.Rd:46): Warning: inserting implicit <p>
?logs_sample.html:81:1 (logs_sample.Rd:46): Warning: trimming empty <p>
?mad_sample.html:77:1 (mad_sample.Rd:42): Warning: inserting implicit <p>
?mad_sample.html:77:1 (mad_sample.Rd:42): Warning: trimming empty <p>
?pit_histogram_sample.html:120:32 (pit_histogram_sample.Rd:84): Warning: trimming empty <code>
?pit_histogram_sample.html:127:32 (pit_histogram_sample.Rd:90): Warning: trimming empty <code>
?quantile_score.html:119:1 (quantile_score.Rd:76): Warning: inserting implicit <p>
?quantile_score.html:119:1 (quantile_score.Rd:76): Warning: trimming empty <p>
?scoring-functions-binary.html:112:1 (scoring-functions-binary.Rd:78): Warning: inserting implicit <p>
?scoring-functions-binary.html:112:1 (scoring-functions-binary.Rd:78): Warning: trimming empty <p>
?scoring-functions-nominal.html:73:1 (scoring-functions-nominal.Rd:38): Warning: inserting implicit <p>
?scoring-functions-nominal.html:73:1 (scoring-functions-nominal.Rd:38): Warning: trimming empty <p>
?se_mean_sample.html:64:1 (se_mean_sample.Rd:34): Warning: inserting implicit <p>
?se_mean_sample.html:64:1 (se_mean_sample.Rd:34): Warning: trimming empty <p>
?wis.html:210:1 (wis.Rd:169): Warning: inserting implicit <p>
?wis.html:210:1 (wis.Rd:169): Warning: trimming empty <p>








R version 4.3.1 (2023-06-16)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 22.04.2 LTS

Matrix products: default
BLAS:? ?/usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3
LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so;??LAPACK version 3.10.0

locale:
?[1] LC_CTYPE=en_US.UTF-8? ? ? ?LC_NUMERIC=C
?[3] LC_TIME=en_US.UTF-8?? ? ? ?LC_COLLATE=en_US.UTF-8
?[5] LC_MONETARY=en_US.UTF-8?? ?LC_MESSAGES=en_US.UTF-8
?[7] LC_PAPER=en_US.UTF-8? ? ? ?LC_NAME=C
?[9] LC_ADDRESS=C? ? ? ? ? ? ? ?LC_TELEPHONE=C
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C

time zone: Etc/UTC
tzcode source: system (glibc)

attached base packages:
[1] stats? ? ?graphics??grDevices utils? ? ?datasets??methods? ?base

loaded via a namespace (and not attached):
[1] compiler_4.3.1 tools_4.3.1

	[[alternative HTML version deleted]]


From |kry|ov @end|ng |rom d|@root@org  Thu Oct 31 19:06:08 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Thu, 31 Oct 2024 21:06:08 +0300
Subject: [R-pkg-devel] HTML validation error in roxygen2 generated
 documentation
In-Reply-To: <084d69e2-dc9e-41ba-aab9-21c0a5ef054f@Spark>
References: <084d69e2-dc9e-41ba-aab9-21c0a5ef054f@Spark>
Message-ID: <20241031210608.3c959584@Tarkus>

? Thu, 31 Oct 2024 18:04:47 +0100
Nikos Bosse <nikosbosse at gmail.com> ?????:

> ?Found the following HTML validation problems:
> ?ae_median_quantile.html:79:1 (ae_median_quantile.Rd:41): Warning:
> inserting implicit <p>
> ae_median_quantile.html:79:1 (ae_median_quantile.Rd:41): Warning:
> trimming empty <p>

Thank you for providing the links to the source code!

This can be diagnosed using R CMD Rdconv:

R CMD Rdconv -o ae_median_quantile.html -t html ae_median_quantile.Rd
tidy ae_median_quantile.html >/dev/null

Here are the lines around the problematic part of the HTML document:

-----------------------------------8<-----------------------------------
<h3>Input format</h3>


<div style="text-align: left">
<p><img src="../help/figures/metrics-quantile.png"
style="width:750px;max-width:100%;" alt="metrics-quantile.png" /> </div>


</p> <!-- here: inserting implicit <p>, trimming empty <p> -->
-----------------------------------8<-----------------------------------

This </p> is inserted here by Rd2HTML to terminate the paragraph
started above (I think by \figure if not by \section). Rd2HTML doesn't
know that you started and ended a <div> before this line, which
implicitly ended the previous <p>, which makes the present </p> an
error.

The only way I was able to silence the warning while preserving the
existing tag structure was to make it \out{</div><p>} to start the new
paragraph and provide some text for the auto-inserted </p> to finish
it. Maybe you'll come up with a better fix that doesn't rely on Rd2HTML
auto-inserting the terminating </p>. I'm not sure, but could it help to
set style="text-align: left;..." on \figure itself, without the <div>?

-- 
Best regards,
Ivan


From |kry|ov @end|ng |rom d|@root@org  Thu Oct 31 21:06:06 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Thu, 31 Oct 2024 23:06:06 +0300
Subject: [R-pkg-devel] Warnings related to functions from the survival
 package
In-Reply-To: <f78c3ec9-30ba-4edb-afe2-0244dff37715@gmail.com>
References: <CAAsVnmJ=EurBKD6ber9umE68bH5ZO6HhmHuhX4ryHbWgXJ+cqQ@mail.gmail.com>
 <20241031193914.54310b7e@arachnoid>
 <f78c3ec9-30ba-4edb-afe2-0244dff37715@gmail.com>
Message-ID: <20241031230606.641cf104@Tarkus>

On Thu, 31 Oct 2024 17:59:01 +0100
Tomas Kalibera <tomas.kalibera at gmail.com> wrote:

> for now, if you know an elegant, minimal way how to suppress
> this, and have the time and energy, a patch would be welcome

A fresh R-4.4.2 build compiled with clang-19 -fsanitize=function gives
the error:

$ bin/R -q -s -e 'library(survival); survdiff(Surv(futime, fustat) ~ rx,data=ovarian)'
dotcode.c:2008:2: runtime error: call to function survdiff2 through pointer to incorrect function type 'void (*)(void *, void *, void *, void *, void *, void *, void *, void *, void *, void *, void *, void *, void *)'
/tmp/RtmpW0SC00/R.INSTALL5d1b3402d0c5/survival/src/survdiff2.c:10: note: survdiff2 defined here
SUMMARY: UndefinedBehaviorSanitizer: undefined-behavior dotcode.c:2008:2 

A suppression file will avoid the error without patching R:

$ cat dotcode.supp 
function:dotcode.c

or more fine-grained:

$ cat dotcode.supp
function:do_dotCode

$ UBSAN_OPTIONS="suppressions=$(realpath dotcode.supp)" bin/R -q -s -e 'library(survival); survdiff(Surv(futime, fustat) ~ rx,data=ovarian)'
Call:
survdiff(formula = Surv(futime, fustat) ~ rx, data = ovarian)
<and so on>

Alternatively, the following patch will also suppress the error:

--- src/main/dotcode.c     2024-03-26 23:02:08.000000000 +0000
+++ src/main/dotcode.c  2024-10-31 19:53:36.272334541 +0000
@@ -1658,6 +1658,9 @@
 #define FILL 0xee
 #define NG 64
 
+#ifdef __clang__
+__attribute__((no_sanitize("function")))
+#endif
 attribute_hidden SEXP do_dotCode(SEXP call, SEXP op, SEXP args, SEXP env)
 {
     void **cargs, **cargs0 = NULL /* -Wall */;

I hope I understood you correctly that you're looking for a tested
workaround.

-- 
Best regards,
Ivan


From n|ko@bo@@e @end|ng |rom gm@||@com  Thu Oct 31 21:32:34 2024
From: n|ko@bo@@e @end|ng |rom gm@||@com (Nikos Bosse)
Date: Thu, 31 Oct 2024 21:32:34 +0100
Subject: [R-pkg-devel] HTML validation error in roxygen2 generated
 documentation
In-Reply-To: <20241031210608.3c959584@Tarkus>
References: <084d69e2-dc9e-41ba-aab9-21c0a5ef054f@Spark>
 <20241031210608.3c959584@Tarkus>
Message-ID: <c0a29815-a074-4e2b-a0e7-f945bd072fe7@Spark>

Hi Ivan,

Thanks SO much for your quick help. Removing the <div> did not work. However, I now did

```
#' \if{html}{
#'? ?\out{<div style="text-align: left">}
#'? ?\figure{metrics-binary-point.png}{options: style="width:750px;max-width:100\%;"}
#'? ?\out{</div><p>}
#'? ?Overview of required input format for binary and point forecasts
#' }
```

with an addition <p> and some text, following your suggestion. And that worked like a charm. Also thank your for showing me R CMD Rdconv.

You made my day!
With gratitude and best regards,
Nikos
On 31 Oct 2024 at 19:06 +0100, Ivan Krylov <ikrylov at disroot.org>, wrote:
> ? Thu, 31 Oct 2024 18:04:47 +0100
> Nikos Bosse <nikosbosse at gmail.com> ?????:
>
> > ?Found the following HTML validation problems:
> > ?ae_median_quantile.html:79:1 (ae_median_quantile.Rd:41): Warning:
> > inserting implicit <p>
> > ae_median_quantile.html:79:1 (ae_median_quantile.Rd:41): Warning:
> > trimming empty <p>
>
> Thank you for providing the links to the source code!
>
> This can be diagnosed using R CMD Rdconv:
>
> R CMD Rdconv -o ae_median_quantile.html -t html ae_median_quantile.Rd
> tidy ae_median_quantile.html >/dev/null
>
> Here are the lines around the problematic part of the HTML document:
>
> -----------------------------------8<-----------------------------------
> <h3>Input format</h3>
>
>
> <div style="text-align: left">
> <p><img src="../help/figures/metrics-quantile.png"
> style="width:750px;max-width:100%;" alt="metrics-quantile.png" /> </div>
>
>
> </p> <!-- here: inserting implicit <p>, trimming empty <p> -->
> -----------------------------------8<-----------------------------------
>
> This </p> is inserted here by Rd2HTML to terminate the paragraph
> started above (I think by \figure if not by \section). Rd2HTML doesn't
> know that you started and ended a <div> before this line, which
> implicitly ended the previous <p>, which makes the present </p> an
> error.
>
> The only way I was able to silence the warning while preserving the
> existing tag structure was to make it \out{</div><p>} to start the new
> paragraph and provide some text for the auto-inserted </p> to finish
> it. Maybe you'll come up with a better fix that doesn't rely on Rd2HTML
> auto-inserting the terminating </p>. I'm not sure, but could it help to
> set style="text-align: left;..." on \figure itself, without the <div>?
>
> --
> Best regards,
> Ivan

	[[alternative HTML version deleted]]


From tom@@@k@||ber@ @end|ng |rom gm@||@com  Fri Nov  1 09:56:01 2024
From: tom@@@k@||ber@ @end|ng |rom gm@||@com (Tomas Kalibera)
Date: Fri, 1 Nov 2024 09:56:01 +0100
Subject: [R-pkg-devel] Warnings related to functions from the survival
 package
In-Reply-To: <20241031230606.641cf104@Tarkus>
References: <CAAsVnmJ=EurBKD6ber9umE68bH5ZO6HhmHuhX4ryHbWgXJ+cqQ@mail.gmail.com>
 <20241031193914.54310b7e@arachnoid>
 <f78c3ec9-30ba-4edb-afe2-0244dff37715@gmail.com>
 <20241031230606.641cf104@Tarkus>
Message-ID: <89aeae5f-efe8-4d85-a328-9688f6fd5460@gmail.com>


On 10/31/24 21:06, Ivan Krylov wrote:
> On Thu, 31 Oct 2024 17:59:01 +0100
> Tomas Kalibera <tomas.kalibera at gmail.com> wrote:
>
>> for now, if you know an elegant, minimal way how to suppress
>> this, and have the time and energy, a patch would be welcome
> A fresh R-4.4.2 build compiled with clang-19 -fsanitize=function gives
> the error:
>
> $ bin/R -q -s -e 'library(survival); survdiff(Surv(futime, fustat) ~ rx,data=ovarian)'
> dotcode.c:2008:2: runtime error: call to function survdiff2 through pointer to incorrect function type 'void (*)(void *, void *, void *, void *, void *, void *, void *, void *, void *, void *, void *, void *, void *)'
> /tmp/RtmpW0SC00/R.INSTALL5d1b3402d0c5/survival/src/survdiff2.c:10: note: survdiff2 defined here
> SUMMARY: UndefinedBehaviorSanitizer: undefined-behavior dotcode.c:2008:2
>
> A suppression file will avoid the error without patching R:
>
> $ cat dotcode.supp
> function:dotcode.c
>
> or more fine-grained:
>
> $ cat dotcode.supp
> function:do_dotCode
>
> $ UBSAN_OPTIONS="suppressions=$(realpath dotcode.supp)" bin/R -q -s -e 'library(survival); survdiff(Surv(futime, fustat) ~ rx,data=ovarian)'
> Call:
> survdiff(formula = Surv(futime, fustat) ~ rx, data = ovarian)
> <and so on>
>
> Alternatively, the following patch will also suppress the error:
>
> --- src/main/dotcode.c     2024-03-26 23:02:08.000000000 +0000
> +++ src/main/dotcode.c  2024-10-31 19:53:36.272334541 +0000
> @@ -1658,6 +1658,9 @@
>   #define FILL 0xee
>   #define NG 64
>   
> +#ifdef __clang__
> +__attribute__((no_sanitize("function")))
> +#endif
>   attribute_hidden SEXP do_dotCode(SEXP call, SEXP op, SEXP args, SEXP env)
>   {
>       void **cargs, **cargs0 = NULL /* -Wall */;
>
> I hope I understood you correctly that you're looking for a tested
> workaround.

Thanks, yes - and there is also attribute_no_sanitizer_instrumentation 
in Defn.h - but isn't there a finer-grained way to suppress reports just 
of this particular issue, ideally at finer granularity than a function?

Tomas

>


From |kry|ov @end|ng |rom d|@root@org  Fri Nov  1 17:40:58 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Fri, 1 Nov 2024 19:40:58 +0300
Subject: [R-pkg-devel] Warnings related to functions from the survival
 package
In-Reply-To: <89aeae5f-efe8-4d85-a328-9688f6fd5460@gmail.com>
References: <CAAsVnmJ=EurBKD6ber9umE68bH5ZO6HhmHuhX4ryHbWgXJ+cqQ@mail.gmail.com>
 <20241031193914.54310b7e@arachnoid>
 <f78c3ec9-30ba-4edb-afe2-0244dff37715@gmail.com>
 <20241031230606.641cf104@Tarkus>
 <89aeae5f-efe8-4d85-a328-9688f6fd5460@gmail.com>
Message-ID: <20241101194058.48917be7@arachnoid>

On Fri, 1 Nov 2024 09:56:01 +0100
Tomas Kalibera <tomas.kalibera at gmail.com> wrote:

> isn't there a finer-grained way to suppress reports just 
> of this particular issue, ideally at finer granularity than a
> function?

The line saying "function:do_dotCode" in the suppression file will
suppress errors just for mismatched function pointer types inside
do_dotCode(), because "function" is the name of this check [1]. Here's
do_dotCode with a different error added:

bin/R -q -s -e 'library(survival); survdiff(Surv(futime, fustat) ~
rx,data=ovarian)'

dotcode.c:1958:9: runtime error: 1e+100 is outside the range of
representable values of type 'int'
SUMMARY: UndefinedBehaviorSanitizer: undefined-behavior dotcode.c:1958:9
dotcode.c:2012:2: runtime error: call to function survdiff2 through
pointer to incorrect function type
'void (*)(void *, void *, void *, void *, void *, void *, void *, void
*, void *, void *, void *, void
*, void *)'
/tmp/RtmpVPlRnI/R.INSTALL65eb26c0356f/survival/src/survdiff2.c:10:
note: survdiff2 defined here
SUMMARY: UndefinedBehaviorSanitizer: undefined-behavior dotcode.c:2012:2

UBSAN_OPTIONS="suppressions=$(realpath dotcode.supp)" \
bin/R -q -s -e 'library(survival); survdiff(Surv(futime, fustat) ~
rx,data=ovarian)'

dotcode.c:1958:9: runtime error: 1e+100 is outside the range of
representable values of type 'int'

I don't think UBSan can suppress errors in a more precise manner. The
documentation only mentions files, functions ans libraries. Best I
could find was a 2020 comment [2] suggesting to separate the offending
code into a function and let the optimiser inline it.

-- 
Best regards,
Ivan

[1]
https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html#runtime-suppressions

[2]
https://bugs.llvm.org/show_bug.cgi?id=19834#c11


From t|@goo||voto @end|ng |rom gm@||@com  Sun Nov  3 15:02:49 2024
From: t|@goo||voto @end|ng |rom gm@||@com (Tiago Olivoto)
Date: Sun, 3 Nov 2024 11:02:49 -0300
Subject: [R-pkg-devel] Cascade effect of non-available packages?
Message-ID: <CAMyz+tV14n8i9TUp_LbWpoe1ZU7YDidijbaafwfAjxcpPimGbA@mail.gmail.com>

Dear R-devs,

I?ve just submitted a bug-fix release of my package, pliman, to address
some reported errors. However, the new version, pliman_3.0.0.tar.gz, did
not pass the incoming checks automatically.

When testing locally using devtools::check() encountered no errors,
warnings, or notes. However, one error was flagged in the "Additional
issues checked" section, as seen here:
https://www.stats.ox.ac.uk/pub/bdr/noSuggests/pliman.out. This error has
already been addressed in the latest submission by including a check_ebi()
function to verify whether EBImage (from Bioconductor) is available before
running code that depends on it.

Today, I noticed that several stable packages, such as Rcpp and sf, were
unavailable during the check process for this submission. This wasn?t an
issue in the previously published version of pliman. Could this be a
temporary problem with the package availability on CRAN?

Here is the link to the checks for the new version of pliman. Any insights
or suggestions you might have would be greatly appreciated.

Thank you for your time and assistance.

Olivoto



--------------------
Windows: <
https://win-builder.r-project.org/incoming_pretest/pliman_3.0.0_20241102_181842/Windows/00check.log
>
Status: 1 NOTE
Debian: <
https://win-builder.r-project.org/incoming_pretest/pliman_3.0.0_20241102_181842/Debian/00check.log
>
Status: 1 NOTE

Additional issues checked: <
https://win-builder.r-project.org/incoming_pretest/pliman_3.0.0_20241102_181842/specialChecks/
>
noSuggests: Status: 1 ERROR, 1 NOTE

Last released version's CRAN status: OK: 5, NOTE: 7, ERROR: 1
See: <https://CRAN.R-project.org/web/checks/check_results_pliman.html
<https://cran.r-project.org/web/checks/check_results_pliman.html>>

Last released version's additional issues:
  noSuggests <https://www.stats.ox.ac.uk/pub/bdr/noSuggests/pliman.out>

CRAN Web: <https://cran.r-project.org/package=pliman>

Please fix all problems and resubmit a fixed version via the webform.
If you are not sure how to fix the problems shown, please ask for help on
the R-package-devel mailing list:
<https://stat.ethz.ch/mailman/listinfo/r-package-devel>
If you are fairly certain the rejection is a false positive, please
reply-all to this message and explain.

More details are given in the directory:
<
https://win-builder.r-project.org/incoming_pretest/pliman_3.0.0_20241102_181842/
>
The files will be removed after roughly 7 days.

-------------------------

	[[alternative HTML version deleted]]


From edd @end|ng |rom deb|@n@org  Sun Nov  3 15:17:21 2024
From: edd @end|ng |rom deb|@n@org (Dirk Eddelbuettel)
Date: Sun, 3 Nov 2024 08:17:21 -0600
Subject: [R-pkg-devel] Cascade effect of non-available packages?
In-Reply-To: <CAMyz+tV14n8i9TUp_LbWpoe1ZU7YDidijbaafwfAjxcpPimGbA@mail.gmail.com>
References: <CAMyz+tV14n8i9TUp_LbWpoe1ZU7YDidijbaafwfAjxcpPimGbA@mail.gmail.com>
Message-ID: <26407.34289.794293.355518@rob.eddelbuettel.com>


On 3 November 2024 at 11:02, Tiago Olivoto wrote:
| Today, I noticed that several stable packages, such as Rcpp and sf, were
| unavailable during the check process for this submission. This wasn?t an
| issue in the previously published version of pliman. Could this be a
| temporary problem with the package availability on CRAN?

I could be. (Auto-)build systems for 21k packages and 3 architectures can be
fragile, and we are in time of transition (R 4.4.2 just came about) so this
could have been spurious.  If in doubt, check the status of a given package
at its CRAN page. But I looked at the log links yu provided, and I saw no
build failure over 'missing Rcpp and/or sf' there.  Can you point us to an
error?

Moreover, reading
  https://win-builder.r-project.org/incoming_pretest/pliman_3.0.0_20241102_181842/specialChecks/noSuggests/summary.txt
I do not see your aforementioned 'check_ebi()' function at work. The
suggested package is not present, you are asked to not fail and just skip
but do not seem to do so. I think you need to fix that, and that the CRAN
messaging is fairly clear and standard here. I may of course have missed
something in which case 'my bad'.

Dirk

-- 
dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org


From georg|@bo@hn@kov @end|ng |rom m@nche@ter@@c@uk  Sun Nov  3 17:09:58 2024
From: georg|@bo@hn@kov @end|ng |rom m@nche@ter@@c@uk (Georgi Boshnakov)
Date: Sun, 3 Nov 2024 16:09:58 +0000
Subject: [R-pkg-devel] Cascade effect of non-available packages?
In-Reply-To: <26407.34289.794293.355518@rob.eddelbuettel.com>
References: <CAMyz+tV14n8i9TUp_LbWpoe1ZU7YDidijbaafwfAjxcpPimGbA@mail.gmail.com>
 <26407.34289.794293.355518@rob.eddelbuettel.com>
Message-ID: <LO0P265MB63251DB0F09F095AC05294ACAE502@LO0P265MB6325.GBRP265.PROD.OUTLOOK.COM>

A lot of packages are erring on CRAN at the moment. From time to time weird things happen en masse. It is better to wait a little for intermittent problems to clear themselves out, especially during the weekend.

Georgi Boshnakov

Sent from Outlook for Android<https://aka.ms/AAb9ysg>
________________________________
From: R-package-devel <r-package-devel-bounces at r-project.org> on behalf of Dirk Eddelbuettel <edd at debian.org>
Sent: Sunday, November 3, 2024 2:17:21 PM
To: Tiago Olivoto <tiagoolivoto at gmail.com>
Cc: R Package Devel <r-package-devel at r-project.org>
Subject: Re: [R-pkg-devel] Cascade effect of non-available packages?


On 3 November 2024 at 11:02, Tiago Olivoto wrote:
| Today, I noticed that several stable packages, such as Rcpp and sf, were
| unavailable during the check process for this submission. This wasn?t an
| issue in the previously published version of pliman. Could this be a
| temporary problem with the package availability on CRAN?

I could be. (Auto-)build systems for 21k packages and 3 architectures can be
fragile, and we are in time of transition (R 4.4.2 just came about) so this
could have been spurious.  If in doubt, check the status of a given package
at its CRAN page. But I looked at the log links yu provided, and I saw no
build failure over 'missing Rcpp and/or sf' there.  Can you point us to an
error?

Moreover, reading
  https://urldefense.com/v3/__https://win-builder.r-project.org/incoming_pretest/pliman_3.0.0_20241102_181842/specialChecks/noSuggests/summary.txt__;!!PDiH4ENfjr2_Jw!Af5Xuvyms6hGqaC8rcf5EXqH8icVsEPEbdr4dvBxDrdeNRZb4hlwLZo9QccOefhWkiYMiOT4lFhp93zWR5eCbGaJ$ [win-builder[.]r-project[.]org]
I do not see your aforementioned 'check_ebi()' function at work. The
suggested package is not present, you are asked to not fail and just skip
but do not seem to do so. I think you need to fix that, and that the CRAN
messaging is fairly clear and standard here. I may of course have missed
something in which case 'my bad'.

Dirk

--
dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org

______________________________________________
R-package-devel at r-project.org mailing list
https://urldefense.com/v3/__https://stat.ethz.ch/mailman/listinfo/r-package-devel__;!!PDiH4ENfjr2_Jw!Af5Xuvyms6hGqaC8rcf5EXqH8icVsEPEbdr4dvBxDrdeNRZb4hlwLZo9QccOefhWkiYMiOT4lFhp93zWR1sto-Mt$ [stat[.]ethz[.]ch]

	[[alternative HTML version deleted]]


From t|@goo||voto @end|ng |rom gm@||@com  Sun Nov  3 17:35:44 2024
From: t|@goo||voto @end|ng |rom gm@||@com (Tiago Olivoto)
Date: Sun, 3 Nov 2024 13:35:44 -0300
Subject: [R-pkg-devel] Cascade effect of non-available packages?
In-Reply-To: <LO0P265MB63251DB0F09F095AC05294ACAE502@LO0P265MB6325.GBRP265.PROD.OUTLOOK.COM>
References: <CAMyz+tV14n8i9TUp_LbWpoe1ZU7YDidijbaafwfAjxcpPimGbA@mail.gmail.com>
 <26407.34289.794293.355518@rob.eddelbuettel.com>
 <LO0P265MB63251DB0F09F095AC05294ACAE502@LO0P265MB6325.GBRP265.PROD.OUTLOOK.COM>
Message-ID: <CAMyz+tUq7L2KJHOVce8oZCiuyrvh0mEa=6R9tWU602b_RrBThw@mail.gmail.com>

Dear all,
Thanks for your prompt reply.

Dear Dirk, check_ebi() was added in the new version at the location I
believe might be triggering the error:

https://github.com/NEPEM-UFSC/pliman/blob/24a1781073f9b1a3141002f0985b0542b1f7178d/R/utils_imagem.R#L317

check_ebi <- function(){
  if(!requireNamespace("EBImage", quietly = TRUE)) {
    if(interactive() == TRUE){
      inst <-
        switch(menu(c("Yes", "No"), title = "Package {EBImage} required but
not installed.\nDo you want to install it now?"),
               "yes", "no")
      if(inst == "yes"){
        if(!requireNamespace("BiocManager", quietly = TRUE)) {
          install.packages("BiocManager", quiet = TRUE)
        }
        BiocManager::install("EBImage",
                             update = FALSE,
                             ask = FALSE,
                             quiet = TRUE)
      } else{
        message("To use {pliman}, first install {EBImage} following the
directions at 'https://bioconductor.org/packages/EBImage'")
      }
    }
  }
}

Looking just now to the function, I realized that it will only work in an
interactive section. I'm not sure if it could be the source of the error
during the checks, because the latest stable version of pliman already
contained it and worked with no erros (but this could be related to the new
version of R or something indirectly related to it).

Anyway, I would appreciate any suggestions to make check_ebi() more robust,
mainly regarding on the way it is handled in the automatic CRAN checks.


Best regards,



Em dom., 3 de nov. de 2024 ?s 13:10, Georgi Boshnakov <
georgi.boshnakov at manchester.ac.uk> escreveu:

> A lot of packages are erring on CRAN at the moment. From time to time
> weird things happen en masse. It is better to wait a little for
> intermittent problems to clear themselves out, especially during the
> weekend.
>
> Georgi Boshnakov
>
> Sent from Outlook for Android <https://aka.ms/AAb9ysg>
> ------------------------------
> *From:* R-package-devel <r-package-devel-bounces at r-project.org> on behalf
> of Dirk Eddelbuettel <edd at debian.org>
> *Sent:* Sunday, November 3, 2024 2:17:21 PM
> *To:* Tiago Olivoto <tiagoolivoto at gmail.com>
> *Cc:* R Package Devel <r-package-devel at r-project.org>
> *Subject:* Re: [R-pkg-devel] Cascade effect of non-available packages?
>
>
> On 3 November 2024 at 11:02, Tiago Olivoto wrote:
> | Today, I noticed that several stable packages, such as Rcpp and sf, were
> | unavailable during the check process for this submission. This wasn?t an
> | issue in the previously published version of pliman. Could this be a
> | temporary problem with the package availability on CRAN?
>
> I could be. (Auto-)build systems for 21k packages and 3 architectures can
> be
> fragile, and we are in time of transition (R 4.4.2 just came about) so this
> could have been spurious.  If in doubt, check the status of a given package
> at its CRAN page. But I looked at the log links yu provided, and I saw no
> build failure over 'missing Rcpp and/or sf' there.  Can you point us to an
> error?
>
> Moreover, reading
>
> https://urldefense.com/v3/__https://win-builder.r-project.org/incoming_pretest/pliman_3.0.0_20241102_181842/specialChecks/noSuggests/summary.txt__;!!PDiH4ENfjr2_Jw!Af5Xuvyms6hGqaC8rcf5EXqH8icVsEPEbdr4dvBxDrdeNRZb4hlwLZo9QccOefhWkiYMiOT4lFhp93zWR5eCbGaJ$
> [win-builder[.]r-project[.]org]
> I do not see your aforementioned 'check_ebi()' function at work. The
> suggested package is not present, you are asked to not fail and just skip
> but do not seem to do so. I think you need to fix that, and that the CRAN
> messaging is fairly clear and standard here. I may of course have missed
> something in which case 'my bad'.
>
> Dirk
>
> --
> dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
>
> https://urldefense.com/v3/__https://stat.ethz.ch/mailman/listinfo/r-package-devel__;!!PDiH4ENfjr2_Jw!Af5Xuvyms6hGqaC8rcf5EXqH8icVsEPEbdr4dvBxDrdeNRZb4hlwLZo9QccOefhWkiYMiOT4lFhp93zWR1sto-Mt$
> [stat[.]ethz[.]ch]
>

	[[alternative HTML version deleted]]


From edd @end|ng |rom deb|@n@org  Sun Nov  3 18:08:52 2024
From: edd @end|ng |rom deb|@n@org (Dirk Eddelbuettel)
Date: Sun, 3 Nov 2024 11:08:52 -0600
Subject: [R-pkg-devel] Cascade effect of non-available packages?
In-Reply-To: <CAMyz+tUq7L2KJHOVce8oZCiuyrvh0mEa=6R9tWU602b_RrBThw@mail.gmail.com>
References: <CAMyz+tV14n8i9TUp_LbWpoe1ZU7YDidijbaafwfAjxcpPimGbA@mail.gmail.com>
 <26407.34289.794293.355518@rob.eddelbuettel.com>
 <LO0P265MB63251DB0F09F095AC05294ACAE502@LO0P265MB6325.GBRP265.PROD.OUTLOOK.COM>
 <CAMyz+tUq7L2KJHOVce8oZCiuyrvh0mEa=6R9tWU602b_RrBThw@mail.gmail.com>
Message-ID: <26407.44580.950632.162385@rob.eddelbuettel.com>


Tiago,

Looking at https://www.stats.ox.ac.uk/pub/bdr/noSuggests/pliman.out
we see it errors after trying '* checking examples ...':

   * checking examples ... ERROR
   Running examples in ?pliman-Ex.R? failed
   The error most likely occurred in:
   
   > ### Name: as_image
   > ### Title: Create an 'Image' object
   > ### Aliases: as_image
   > 
   > ### ** Examples
   > 
   > img <-
   + as_image(rnorm(150 * 150 * 3),
   +          dim = c(150, 150, 3),
   +          colormode = 'Color')
   Error in loadNamespace(x) : there is no package called ?EBImage?
   Calls: as_image ... loadNamespace -> withRestarts -> withOneRestart -> doWithOneRestart
   Execution halted
   * checking PDF version of manual ... [12s/12s] OK

Looking at as_image.Rd in https://github.com/NEPEM-UFSC/pliman/blob/24a1781073f9b1a3141002f0985b0542b1f7178d/man/as_image.Rd
we see that you do have an \donttest{} there but that alone does not protect
you. Instead of

   \examples{
   \donttest{
   library(pliman)
   img <-
   as_image(rnorm(150 * 150 * 3),
            dim = c(150, 150, 3),
            colormode = 'Color')
   plot(img)
   }

I would do something like

  if (interactive() && requireNamespace("EBImage", quietly=TRUE)) {
    library(pliman)
    img <- as_image(rnorm(150 * 150 * 3), dim = c(150, 150, 3), colormode = 'Color')
    plot(img)
  }

where you could of course put that condition into a helper function.

Hope this helps,  Dirk

-- 
dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org


From tom@@@k@||ber@ @end|ng |rom gm@||@com  Mon Nov  4 11:08:36 2024
From: tom@@@k@||ber@ @end|ng |rom gm@||@com (Tomas Kalibera)
Date: Mon, 4 Nov 2024 11:08:36 +0100
Subject: [R-pkg-devel] Warnings related to functions from the survival
 package
In-Reply-To: <20241101194058.48917be7@arachnoid>
References: <CAAsVnmJ=EurBKD6ber9umE68bH5ZO6HhmHuhX4ryHbWgXJ+cqQ@mail.gmail.com>
 <20241031193914.54310b7e@arachnoid>
 <f78c3ec9-30ba-4edb-afe2-0244dff37715@gmail.com>
 <20241031230606.641cf104@Tarkus>
 <89aeae5f-efe8-4d85-a328-9688f6fd5460@gmail.com>
 <20241101194058.48917be7@arachnoid>
Message-ID: <edde9ed3-a248-495b-9094-42545a7ea7ed@gmail.com>


On 11/1/24 17:40, Ivan Krylov wrote:
> On Fri, 1 Nov 2024 09:56:01 +0100
> Tomas Kalibera <tomas.kalibera at gmail.com> wrote:
>
>> isn't there a finer-grained way to suppress reports just
>> of this particular issue, ideally at finer granularity than a
>> function?
> The line saying "function:do_dotCode" in the suppression file will
> suppress errors just for mismatched function pointer types inside
> do_dotCode(), because "function" is the name of this check [1]. Here's
> do_dotCode with a different error added:
>
> bin/R -q -s -e 'library(survival); survdiff(Surv(futime, fustat) ~
> rx,data=ovarian)'
>
> dotcode.c:1958:9: runtime error: 1e+100 is outside the range of
> representable values of type 'int'
> SUMMARY: UndefinedBehaviorSanitizer: undefined-behavior dotcode.c:1958:9
> dotcode.c:2012:2: runtime error: call to function survdiff2 through
> pointer to incorrect function type
> 'void (*)(void *, void *, void *, void *, void *, void *, void *, void
> *, void *, void *, void *, void
> *, void *)'
> /tmp/RtmpVPlRnI/R.INSTALL65eb26c0356f/survival/src/survdiff2.c:10:
> note: survdiff2 defined here
> SUMMARY: UndefinedBehaviorSanitizer: undefined-behavior dotcode.c:2012:2
>
> UBSAN_OPTIONS="suppressions=$(realpath dotcode.supp)" \
> bin/R -q -s -e 'library(survival); survdiff(Surv(futime, fustat) ~
> rx,data=ovarian)'
>
> dotcode.c:1958:9: runtime error: 1e+100 is outside the range of
> representable values of type 'int'
>
> I don't think UBSan can suppress errors in a more precise manner. The
> documentation only mentions files, functions ans libraries. Best I
> could find was a 2020 comment [2] suggesting to separate the offending
> code into a function and let the optimiser inline it.
I feared that might be the case, thanks for looking this up,
Tomas
>


From t|@goo||voto @end|ng |rom gm@||@com  Mon Nov  4 11:25:54 2024
From: t|@goo||voto @end|ng |rom gm@||@com (Tiago Olivoto)
Date: Mon, 4 Nov 2024 07:25:54 -0300
Subject: [R-pkg-devel] Cascade effect of non-available packages?
In-Reply-To: <26407.44580.950632.162385@rob.eddelbuettel.com>
References: <CAMyz+tV14n8i9TUp_LbWpoe1ZU7YDidijbaafwfAjxcpPimGbA@mail.gmail.com>
 <26407.34289.794293.355518@rob.eddelbuettel.com>
 <LO0P265MB63251DB0F09F095AC05294ACAE502@LO0P265MB6325.GBRP265.PROD.OUTLOOK.COM>
 <CAMyz+tUq7L2KJHOVce8oZCiuyrvh0mEa=6R9tWU602b_RrBThw@mail.gmail.com>
 <26407.44580.950632.162385@rob.eddelbuettel.com>
Message-ID: <CAMyz+tXUBsx3tO3B561=-dNZk_DK-JOprm9LimygsH3wf07q=Q@mail.gmail.com>

Dear Dirk,
Thank you so much for your tips.
I'll implement them and try a new submission.

Best regards,
Olivoto


Em dom., 3 de nov. de 2024 ?s 14:08, Dirk Eddelbuettel <edd at debian.org>
escreveu:

>
> Tiago,
>
> Looking at https://www.stats.ox.ac.uk/pub/bdr/noSuggests/pliman.out
> we see it errors after trying '* checking examples ...':
>
>    * checking examples ... ERROR
>    Running examples in ?pliman-Ex.R? failed
>    The error most likely occurred in:
>
>    > ### Name: as_image
>    > ### Title: Create an 'Image' object
>    > ### Aliases: as_image
>    >
>    > ### ** Examples
>    >
>    > img <-
>    + as_image(rnorm(150 * 150 * 3),
>    +          dim = c(150, 150, 3),
>    +          colormode = 'Color')
>    Error in loadNamespace(x) : there is no package called ?EBImage?
>    Calls: as_image ... loadNamespace -> withRestarts -> withOneRestart ->
> doWithOneRestart
>    Execution halted
>    * checking PDF version of manual ... [12s/12s] OK
>
> Looking at as_image.Rd in
> https://github.com/NEPEM-UFSC/pliman/blob/24a1781073f9b1a3141002f0985b0542b1f7178d/man/as_image.Rd
> we see that you do have an \donttest{} there but that alone does not
> protect
> you. Instead of
>
>    \examples{
>    \donttest{
>    library(pliman)
>    img <-
>    as_image(rnorm(150 * 150 * 3),
>             dim = c(150, 150, 3),
>             colormode = 'Color')
>    plot(img)
>    }
>
> I would do something like
>
>   if (interactive() && requireNamespace("EBImage", quietly=TRUE)) {
>     library(pliman)
>     img <- as_image(rnorm(150 * 150 * 3), dim = c(150, 150, 3), colormode
> = 'Color')
>     plot(img)
>   }
>
> where you could of course put that condition into a helper function.
>
> Hope this helps,  Dirk
>
> --
> dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org
>

	[[alternative HTML version deleted]]


From tdhock5 @end|ng |rom gm@||@com  Mon Nov  4 22:33:40 2024
From: tdhock5 @end|ng |rom gm@||@com (Toby Hocking)
Date: Mon, 4 Nov 2024 16:33:40 -0500
Subject: [R-pkg-devel] new version jumps in minor?
Message-ID: <CALK03d21pQLFDuUnoLRJ5PaGTZWf5tDbq-aAZGqWcrtT0+nWDQ@mail.gmail.com>

Dear CRAN
I see a new NOTE, and I wonder if you would consider undoing this new
addition to checks? This would cause all of my packages to fail auto
checks, which would cause a lot of extra false positives, and lots of
extra work for both me and the CRAN team who works on approving
submissions which do not pass auto checks.
Thanks for your consideration

* checking CRAN incoming feasibility ... [11s] NOTE
Maintainer: 'Toby Hocking <toby.hocking at r-project.org>'

Version jumps in minor (submitted: 2024.11.2, existing: 2024.1.24)


From murdoch@dunc@n @end|ng |rom gm@||@com  Mon Nov  4 23:32:35 2024
From: murdoch@dunc@n @end|ng |rom gm@||@com (Duncan Murdoch)
Date: Mon, 4 Nov 2024 17:32:35 -0500
Subject: [R-pkg-devel] new version jumps in minor?
In-Reply-To: <CALK03d21pQLFDuUnoLRJ5PaGTZWf5tDbq-aAZGqWcrtT0+nWDQ@mail.gmail.com>
References: <CALK03d21pQLFDuUnoLRJ5PaGTZWf5tDbq-aAZGqWcrtT0+nWDQ@mail.gmail.com>
Message-ID: <5437c552-4b76-4eb8-bc0e-efbfa14279b6@gmail.com>

On 2024-11-04 4:33 p.m., Toby Hocking wrote:
> Dear CRAN
> I see a new NOTE, and I wonder if you would consider undoing this new
> addition to checks? This would cause all of my packages to fail auto
> checks, which would cause a lot of extra false positives, and lots of
> extra work for both me and the CRAN team who works on approving
> submissions which do not pass auto checks.
> Thanks for your consideration
> 
> * checking CRAN incoming feasibility ... [11s] NOTE
> Maintainer: 'Toby Hocking <toby.hocking at r-project.org>'
> 
> Version jumps in minor (submitted: 2024.11.2, existing: 2024.1.24)

Was your package auto-rejected with this note?  Not all notes trigger a 
rejection, some (like the maintainer note just above) are just for 
information.

Duncan Murdoch


From ro||turner @end|ng |rom po@teo@net  Tue Nov  5 00:31:55 2024
From: ro||turner @end|ng |rom po@teo@net (Rolf Turner)
Date: Mon,  4 Nov 2024 23:31:55 +0000
Subject: [R-pkg-devel] new version jumps in minor?
In-Reply-To: <CALK03d21pQLFDuUnoLRJ5PaGTZWf5tDbq-aAZGqWcrtT0+nWDQ@mail.gmail.com>
References: <CALK03d21pQLFDuUnoLRJ5PaGTZWf5tDbq-aAZGqWcrtT0+nWDQ@mail.gmail.com>
Message-ID: <20241105123155.7ab0eecf@elderly-dell>


On Mon, 4 Nov 2024 16:33:40 -0500
Toby Hocking <tdhock5 at gmail.com> wrote:

<SNIP>

> Version jumps in minor (submitted: 2024.11.2, existing: 2024.1.24)

It looks to me that you are setting your version numbers in an
unorthodox manner, which could/will confuse the living Drambuie out of
people.

I conjecture that you are setting your version number to represent the
relevant date.  E.g. 2024.11.2  means 2 November, 2024 and 2024.1.24
means 24 January 2024.

In my understanding, the usual convention is for the version number to
be of the form l.m.n (or l.m-n) --- major.minor.patch (or
major.minor-patch).  The date should be specified in the *Date* field of
the DESCRIPTION file.

It probably does not matter a hell of a lot.  "Writing R Extensions"
just says that the version number should be "a sequence of at least two
(and usually three) non-negative integers separated by single ?.? or
?-? characters".

However you might save yourself some "NOTEs" by adhering to the
"l.m.n" convention and incrementing the components sequentially.

cheers,

Rolf Turner

-- 
Honorary Research Fellow
Department of Statistics
University of Auckland
Stats. Dep't. (secretaries) phone:
         +64-9-373-7599 ext. 89622
Home phone: +64-9-480-4619


From jo@|@h@p@rry @end|ng |rom gm@||@com  Tue Nov  5 01:02:26 2024
From: jo@|@h@p@rry @end|ng |rom gm@||@com (Josiah Parry)
Date: Mon, 4 Nov 2024 16:02:26 -0800
Subject: [R-pkg-devel] new version jumps in minor?
In-Reply-To: <20241105123155.7ab0eecf@elderly-dell>
References: <CALK03d21pQLFDuUnoLRJ5PaGTZWf5tDbq-aAZGqWcrtT0+nWDQ@mail.gmail.com>
 <20241105123155.7ab0eecf@elderly-dell>
Message-ID: <CAL3ufUJ+g7p=66QoEbScj++x6CrC-uH+MDXFtoNphCnkbeE0BQ@mail.gmail.com>

Rolf,

The versioning method they?re using is referred to as CalVer
https://calver.org/ (not as catchy as SemVer) and it is actually quite
useful! With one look at the version you can get a good sense of it?s
general release date.

Posit, for example, moved their professional products to use this
versioning method a number of years ago.

I wouldn?t poopoo it so quickly!

On Mon, Nov 4, 2024 at 15:32 Rolf Turner <rolfturner at posteo.net> wrote:

>
> On Mon, 4 Nov 2024 16:33:40 -0500
> Toby Hocking <tdhock5 at gmail.com> wrote:
>
> <SNIP>
>
> > Version jumps in minor (submitted: 2024.11.2, existing: 2024.1.24)
>
> It looks to me that you are setting your version numbers in an
> unorthodox manner, which could/will confuse the living Drambuie out of
> people.
>
> I conjecture that you are setting your version number to represent the
> relevant date.  E.g. 2024.11.2  means 2 November, 2024 and 2024.1.24
> means 24 January 2024.
>
> In my understanding, the usual convention is for the version number to
> be of the form l.m.n (or l.m-n) --- major.minor.patch (or
> major.minor-patch).  The date should be specified in the *Date* field of
> the DESCRIPTION file.
>
> It probably does not matter a hell of a lot.  "Writing R Extensions"
> just says that the version number should be "a sequence of at least two
> (and usually three) non-negative integers separated by single ?.? or
> ?-? characters".
>
> However you might save yourself some "NOTEs" by adhering to the
> "l.m.n" convention and incrementing the components sequentially.
>
> cheers,
>
> Rolf Turner
>
> --
> Honorary Research Fellow
> Department of Statistics
> University of Auckland
> Stats. Dep't. (secretaries) phone:
>          +64-9-373-7599 ext. 89622
> Home phone: +64-9-480-4619
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>

	[[alternative HTML version deleted]]


From ||gge@ @end|ng |rom @t@t|@t|k@tu-dortmund@de  Tue Nov  5 10:10:15 2024
From: ||gge@ @end|ng |rom @t@t|@t|k@tu-dortmund@de (Uwe Ligges)
Date: Tue, 5 Nov 2024 10:10:15 +0100
Subject: [R-pkg-devel] new version jumps in minor?
In-Reply-To: <CAL3ufUJ+g7p=66QoEbScj++x6CrC-uH+MDXFtoNphCnkbeE0BQ@mail.gmail.com>
References: <CALK03d21pQLFDuUnoLRJ5PaGTZWf5tDbq-aAZGqWcrtT0+nWDQ@mail.gmail.com>
 <20241105123155.7ab0eecf@elderly-dell>
 <CAL3ufUJ+g7p=66QoEbScj++x6CrC-uH+MDXFtoNphCnkbeE0BQ@mail.gmail.com>
Message-ID: <798b3f75-8722-4091-8b97-e76cd5994bb3@statistik.tu-dortmund.de>

CRAN does not object to these versioning, the notes are not the reason 
for rejection. Who told they are?

Best,
Uwe Ligges




On 05.11.2024 01:02, Josiah Parry wrote:
> Rolf,
> 
> The versioning method they?re using is referred to as CalVer
> https://calver.org/ (not as catchy as SemVer) and it is actually quite
> useful! With one look at the version you can get a good sense of it?s
> general release date.
> 
> Posit, for example, moved their professional products to use this
> versioning method a number of years ago.
> 
> I wouldn?t poopoo it so quickly!
> 
> On Mon, Nov 4, 2024 at 15:32 Rolf Turner <rolfturner at posteo.net> wrote:
> 
>>
>> On Mon, 4 Nov 2024 16:33:40 -0500
>> Toby Hocking <tdhock5 at gmail.com> wrote:
>>
>> <SNIP>
>>
>>> Version jumps in minor (submitted: 2024.11.2, existing: 2024.1.24)
>>
>> It looks to me that you are setting your version numbers in an
>> unorthodox manner, which could/will confuse the living Drambuie out of
>> people.
>>
>> I conjecture that you are setting your version number to represent the
>> relevant date.  E.g. 2024.11.2  means 2 November, 2024 and 2024.1.24
>> means 24 January 2024.
>>
>> In my understanding, the usual convention is for the version number to
>> be of the form l.m.n (or l.m-n) --- major.minor.patch (or
>> major.minor-patch).  The date should be specified in the *Date* field of
>> the DESCRIPTION file.
>>
>> It probably does not matter a hell of a lot.  "Writing R Extensions"
>> just says that the version number should be "a sequence of at least two
>> (and usually three) non-negative integers separated by single ?.? or
>> ?-? characters".
>>
>> However you might save yourself some "NOTEs" by adhering to the
>> "l.m.n" convention and incrementing the components sequentially.
>>
>> cheers,
>>
>> Rolf Turner
>>
>> --
>> Honorary Research Fellow
>> Department of Statistics
>> University of Auckland
>> Stats. Dep't. (secretaries) phone:
>>           +64-9-373-7599 ext. 89622
>> Home phone: +64-9-480-4619
>>
>> ______________________________________________
>> R-package-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>>
> 
> 	[[alternative HTML version deleted]]
> 
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel

From tdhock5 @end|ng |rom gm@||@com  Tue Nov  5 20:29:02 2024
From: tdhock5 @end|ng |rom gm@||@com (Toby Hocking)
Date: Tue, 5 Nov 2024 14:29:02 -0500
Subject: [R-pkg-devel] new version jumps in minor?
In-Reply-To: <798b3f75-8722-4091-8b97-e76cd5994bb3@statistik.tu-dortmund.de>
References: <CALK03d21pQLFDuUnoLRJ5PaGTZWf5tDbq-aAZGqWcrtT0+nWDQ@mail.gmail.com>
 <20241105123155.7ab0eecf@elderly-dell>
 <CAL3ufUJ+g7p=66QoEbScj++x6CrC-uH+MDXFtoNphCnkbeE0BQ@mail.gmail.com>
 <798b3f75-8722-4091-8b97-e76cd5994bb3@statistik.tu-dortmund.de>
Message-ID: <CALK03d1UNZDVSichET6qw4R7xDKJqgU+pw7n0QQNnX=eaewJeg@mail.gmail.com>

I thought that the auto-check robot only accepts submissions which
have Status: OK? (no NOTEs at all)
Is it documented somewhere which NOTEs are allowed by the auto-check service?

On Tue, Nov 5, 2024 at 4:10?AM Uwe Ligges
<ligges at statistik.tu-dortmund.de> wrote:
>
> CRAN does not object to these versioning, the notes are not the reason
> for rejection. Who told they are?
>
> Best,
> Uwe Ligges
>
>
>
>
> On 05.11.2024 01:02, Josiah Parry wrote:
> > Rolf,
> >
> > The versioning method they?re using is referred to as CalVer
> > https://calver.org/ (not as catchy as SemVer) and it is actually quite
> > useful! With one look at the version you can get a good sense of it?s
> > general release date.
> >
> > Posit, for example, moved their professional products to use this
> > versioning method a number of years ago.
> >
> > I wouldn?t poopoo it so quickly!
> >
> > On Mon, Nov 4, 2024 at 15:32 Rolf Turner <rolfturner at posteo.net> wrote:
> >
> >>
> >> On Mon, 4 Nov 2024 16:33:40 -0500
> >> Toby Hocking <tdhock5 at gmail.com> wrote:
> >>
> >> <SNIP>
> >>
> >>> Version jumps in minor (submitted: 2024.11.2, existing: 2024.1.24)
> >>
> >> It looks to me that you are setting your version numbers in an
> >> unorthodox manner, which could/will confuse the living Drambuie out of
> >> people.
> >>
> >> I conjecture that you are setting your version number to represent the
> >> relevant date.  E.g. 2024.11.2  means 2 November, 2024 and 2024.1.24
> >> means 24 January 2024.
> >>
> >> In my understanding, the usual convention is for the version number to
> >> be of the form l.m.n (or l.m-n) --- major.minor.patch (or
> >> major.minor-patch).  The date should be specified in the *Date* field of
> >> the DESCRIPTION file.
> >>
> >> It probably does not matter a hell of a lot.  "Writing R Extensions"
> >> just says that the version number should be "a sequence of at least two
> >> (and usually three) non-negative integers separated by single ?.? or
> >> ?-? characters".
> >>
> >> However you might save yourself some "NOTEs" by adhering to the
> >> "l.m.n" convention and incrementing the components sequentially.
> >>
> >> cheers,
> >>
> >> Rolf Turner
> >>
> >> --
> >> Honorary Research Fellow
> >> Department of Statistics
> >> University of Auckland
> >> Stats. Dep't. (secretaries) phone:
> >>           +64-9-373-7599 ext. 89622
> >> Home phone: +64-9-480-4619
> >>
> >> ______________________________________________
> >> R-package-devel at r-project.org mailing list
> >> https://stat.ethz.ch/mailman/listinfo/r-package-devel
> >>
> >
> >       [[alternative HTML version deleted]]
> >
> > ______________________________________________
> > R-package-devel at r-project.org mailing list
> > https://stat.ethz.ch/mailman/listinfo/r-package-devel
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From |kw@|mmo @end|ng |rom gm@||@com  Tue Nov  5 20:54:29 2024
From: |kw@|mmo @end|ng |rom gm@||@com (Iris Simmons)
Date: Tue, 5 Nov 2024 14:54:29 -0500
Subject: [R-pkg-devel] new version jumps in minor?
In-Reply-To: <CALK03d1UNZDVSichET6qw4R7xDKJqgU+pw7n0QQNnX=eaewJeg@mail.gmail.com>
References: <CALK03d21pQLFDuUnoLRJ5PaGTZWf5tDbq-aAZGqWcrtT0+nWDQ@mail.gmail.com>
 <20241105123155.7ab0eecf@elderly-dell>
 <CAL3ufUJ+g7p=66QoEbScj++x6CrC-uH+MDXFtoNphCnkbeE0BQ@mail.gmail.com>
 <798b3f75-8722-4091-8b97-e76cd5994bb3@statistik.tu-dortmund.de>
 <CALK03d1UNZDVSichET6qw4R7xDKJqgU+pw7n0QQNnX=eaewJeg@mail.gmail.com>
Message-ID: <CADNULg-weXvi-jOk0S4XwEVbnjAb22YoJUWDBfNSqwvJ=LV3tw@mail.gmail.com>

The auto checker will publish an R package that has Status: OK and no
Note_to_CRAN_maintainers.

The auto checker will reject an R package that has WARNINGs and/or ERRORS.

The auto checker will flag an R package for manual inspection otherwise. A
CRAN team member will see your NOTE and know it's nothing to worry about
and publish it anyway. I've had similar before, and I've waited at most 5
hours for someone to check and approve it.

On Tue, Nov 5, 2024, 14:29 Toby Hocking <tdhock5 at gmail.com> wrote:

> I thought that the auto-check robot only accepts submissions which
> have Status: OK? (no NOTEs at all)
> Is it documented somewhere which NOTEs are allowed by the auto-check
> service?
>
> On Tue, Nov 5, 2024 at 4:10?AM Uwe Ligges
> <ligges at statistik.tu-dortmund.de> wrote:
> >
> > CRAN does not object to these versioning, the notes are not the reason
> > for rejection. Who told they are?
> >
> > Best,
> > Uwe Ligges
> >
> >
> >
> >
> > On 05.11.2024 01:02, Josiah Parry wrote:
> > > Rolf,
> > >
> > > The versioning method they?re using is referred to as CalVer
> > > https://calver.org/ (not as catchy as SemVer) and it is actually quite
> > > useful! With one look at the version you can get a good sense of it?s
> > > general release date.
> > >
> > > Posit, for example, moved their professional products to use this
> > > versioning method a number of years ago.
> > >
> > > I wouldn?t poopoo it so quickly!
> > >
> > > On Mon, Nov 4, 2024 at 15:32 Rolf Turner <rolfturner at posteo.net>
> wrote:
> > >
> > >>
> > >> On Mon, 4 Nov 2024 16:33:40 -0500
> > >> Toby Hocking <tdhock5 at gmail.com> wrote:
> > >>
> > >> <SNIP>
> > >>
> > >>> Version jumps in minor (submitted: 2024.11.2, existing: 2024.1.24)
> > >>
> > >> It looks to me that you are setting your version numbers in an
> > >> unorthodox manner, which could/will confuse the living Drambuie out of
> > >> people.
> > >>
> > >> I conjecture that you are setting your version number to represent the
> > >> relevant date.  E.g. 2024.11.2  means 2 November, 2024 and 2024.1.24
> > >> means 24 January 2024.
> > >>
> > >> In my understanding, the usual convention is for the version number to
> > >> be of the form l.m.n (or l.m-n) --- major.minor.patch (or
> > >> major.minor-patch).  The date should be specified in the *Date* field
> of
> > >> the DESCRIPTION file.
> > >>
> > >> It probably does not matter a hell of a lot.  "Writing R Extensions"
> > >> just says that the version number should be "a sequence of at least
> two
> > >> (and usually three) non-negative integers separated by single ?.? or
> > >> ?-? characters".
> > >>
> > >> However you might save yourself some "NOTEs" by adhering to the
> > >> "l.m.n" convention and incrementing the components sequentially.
> > >>
> > >> cheers,
> > >>
> > >> Rolf Turner
> > >>
> > >> --
> > >> Honorary Research Fellow
> > >> Department of Statistics
> > >> University of Auckland
> > >> Stats. Dep't. (secretaries) phone:
> > >>           +64-9-373-7599 ext. 89622
> > >> Home phone: +64-9-480-4619
> > >>
> > >> ______________________________________________
> > >> R-package-devel at r-project.org mailing list
> > >> https://stat.ethz.ch/mailman/listinfo/r-package-devel
> > >>
> > >
> > >       [[alternative HTML version deleted]]
> > >
> > > ______________________________________________
> > > R-package-devel at r-project.org mailing list
> > > https://stat.ethz.ch/mailman/listinfo/r-package-devel
> > ______________________________________________
> > R-package-devel at r-project.org mailing list
> > https://stat.ethz.ch/mailman/listinfo/r-package-devel
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>

	[[alternative HTML version deleted]]


From ||gge@ @end|ng |rom @t@t|@t|k@tu-dortmund@de  Wed Nov  6 10:01:33 2024
From: ||gge@ @end|ng |rom @t@t|@t|k@tu-dortmund@de (Uwe Ligges)
Date: Wed, 6 Nov 2024 10:01:33 +0100
Subject: [R-pkg-devel] new version jumps in minor?
In-Reply-To: <CADNULg-weXvi-jOk0S4XwEVbnjAb22YoJUWDBfNSqwvJ=LV3tw@mail.gmail.com>
References: <CALK03d21pQLFDuUnoLRJ5PaGTZWf5tDbq-aAZGqWcrtT0+nWDQ@mail.gmail.com>
 <20241105123155.7ab0eecf@elderly-dell>
 <CAL3ufUJ+g7p=66QoEbScj++x6CrC-uH+MDXFtoNphCnkbeE0BQ@mail.gmail.com>
 <798b3f75-8722-4091-8b97-e76cd5994bb3@statistik.tu-dortmund.de>
 <CALK03d1UNZDVSichET6qw4R7xDKJqgU+pw7n0QQNnX=eaewJeg@mail.gmail.com>
 <CADNULg-weXvi-jOk0S4XwEVbnjAb22YoJUWDBfNSqwvJ=LV3tw@mail.gmail.com>
Message-ID: <c6a85e38-7870-42a2-b888-47b6b9d39e97@statistik.tu-dortmund.de>



On 05.11.2024 20:54, Iris Simmons wrote:
> The auto checker will publish an R package that has Status: OK and no
> Note_to_CRAN_maintainers.
> 
> The auto checker will reject an R package that has WARNINGs and/or ERRORS.
> 
> The auto checker will flag an R package for manual inspection otherwise. A
> CRAN team member will see your NOTE and know it's nothing to worry about
> and publish it anyway. I've had similar before, and I've waited at most 5
> hours for someone to check and approve it.

This is much more difficult.

Most notes are actually also auo rejected, but not all, and that is a 
moving target, as we try to automate as much as possible.

Jumps in version numbers or results of spell check have a non neglible 
probability of false positives, hence get manually inspected once raised 
by the auto check system.

In this case the jump 1 --> 11 was flagged, because many people actually 
mean 1.1 instead, but it got manually confirmed and published.

Best,
Uwe Ligges





> On Tue, Nov 5, 2024, 14:29 Toby Hocking <tdhock5 at gmail.com> wrote:
> 
>> I thought that the auto-check robot only accepts submissions which
>> have Status: OK? (no NOTEs at all)
>> Is it documented somewhere which NOTEs are allowed by the auto-check
>> service?
>>
>> On Tue, Nov 5, 2024 at 4:10?AM Uwe Ligges
>> <ligges at statistik.tu-dortmund.de> wrote:
>>>
>>> CRAN does not object to these versioning, the notes are not the reason
>>> for rejection. Who told they are?
>>>
>>> Best,
>>> Uwe Ligges
>>>
>>>
>>>
>>>
>>> On 05.11.2024 01:02, Josiah Parry wrote:
>>>> Rolf,
>>>>
>>>> The versioning method they?re using is referred to as CalVer
>>>> https://calver.org/ (not as catchy as SemVer) and it is actually quite
>>>> useful! With one look at the version you can get a good sense of it?s
>>>> general release date.
>>>>
>>>> Posit, for example, moved their professional products to use this
>>>> versioning method a number of years ago.
>>>>
>>>> I wouldn?t poopoo it so quickly!
>>>>
>>>> On Mon, Nov 4, 2024 at 15:32 Rolf Turner <rolfturner at posteo.net>
>> wrote:
>>>>
>>>>>
>>>>> On Mon, 4 Nov 2024 16:33:40 -0500
>>>>> Toby Hocking <tdhock5 at gmail.com> wrote:
>>>>>
>>>>> <SNIP>
>>>>>
>>>>>> Version jumps in minor (submitted: 2024.11.2, existing: 2024.1.24)
>>>>>
>>>>> It looks to me that you are setting your version numbers in an
>>>>> unorthodox manner, which could/will confuse the living Drambuie out of
>>>>> people.
>>>>>
>>>>> I conjecture that you are setting your version number to represent the
>>>>> relevant date.  E.g. 2024.11.2  means 2 November, 2024 and 2024.1.24
>>>>> means 24 January 2024.
>>>>>
>>>>> In my understanding, the usual convention is for the version number to
>>>>> be of the form l.m.n (or l.m-n) --- major.minor.patch (or
>>>>> major.minor-patch).  The date should be specified in the *Date* field
>> of
>>>>> the DESCRIPTION file.
>>>>>
>>>>> It probably does not matter a hell of a lot.  "Writing R Extensions"
>>>>> just says that the version number should be "a sequence of at least
>> two
>>>>> (and usually three) non-negative integers separated by single ?.? or
>>>>> ?-? characters".
>>>>>
>>>>> However you might save yourself some "NOTEs" by adhering to the
>>>>> "l.m.n" convention and incrementing the components sequentially.
>>>>>
>>>>> cheers,
>>>>>
>>>>> Rolf Turner
>>>>>
>>>>> --
>>>>> Honorary Research Fellow
>>>>> Department of Statistics
>>>>> University of Auckland
>>>>> Stats. Dep't. (secretaries) phone:
>>>>>            +64-9-373-7599 ext. 89622
>>>>> Home phone: +64-9-480-4619
>>>>>
>>>>> ______________________________________________
>>>>> R-package-devel at r-project.org mailing list
>>>>> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>>>>>
>>>>
>>>>        [[alternative HTML version deleted]]
>>>>
>>>> ______________________________________________
>>>> R-package-devel at r-project.org mailing list
>>>> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>>> ______________________________________________
>>> R-package-devel at r-project.org mailing list
>>> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>>
>> ______________________________________________
>> R-package-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>>
> 
> 	[[alternative HTML version deleted]]
> 
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel

From tdhock5 @end|ng |rom gm@||@com  Thu Nov  7 18:58:24 2024
From: tdhock5 @end|ng |rom gm@||@com (Toby Hocking)
Date: Thu, 7 Nov 2024 12:58:24 -0500
Subject: [R-pkg-devel] new version jumps in minor?
In-Reply-To: <c6a85e38-7870-42a2-b888-47b6b9d39e97@statistik.tu-dortmund.de>
References: <CALK03d21pQLFDuUnoLRJ5PaGTZWf5tDbq-aAZGqWcrtT0+nWDQ@mail.gmail.com>
 <20241105123155.7ab0eecf@elderly-dell>
 <CAL3ufUJ+g7p=66QoEbScj++x6CrC-uH+MDXFtoNphCnkbeE0BQ@mail.gmail.com>
 <798b3f75-8722-4091-8b97-e76cd5994bb3@statistik.tu-dortmund.de>
 <CALK03d1UNZDVSichET6qw4R7xDKJqgU+pw7n0QQNnX=eaewJeg@mail.gmail.com>
 <CADNULg-weXvi-jOk0S4XwEVbnjAb22YoJUWDBfNSqwvJ=LV3tw@mail.gmail.com>
 <c6a85e38-7870-42a2-b888-47b6b9d39e97@statistik.tu-dortmund.de>
Message-ID: <CALK03d3ZAoF6uh=2Yv3n8QBQXbeNRmKcuwjHT535a8bDDDBmEw@mail.gmail.com>

great thanks for the explanation Uwe

On Wed, Nov 6, 2024 at 4:01?AM Uwe Ligges
<ligges at statistik.tu-dortmund.de> wrote:
>
>
>
> On 05.11.2024 20:54, Iris Simmons wrote:
> > The auto checker will publish an R package that has Status: OK and no
> > Note_to_CRAN_maintainers.
> >
> > The auto checker will reject an R package that has WARNINGs and/or ERRORS.
> >
> > The auto checker will flag an R package for manual inspection otherwise. A
> > CRAN team member will see your NOTE and know it's nothing to worry about
> > and publish it anyway. I've had similar before, and I've waited at most 5
> > hours for someone to check and approve it.
>
> This is much more difficult.
>
> Most notes are actually also auo rejected, but not all, and that is a
> moving target, as we try to automate as much as possible.
>
> Jumps in version numbers or results of spell check have a non neglible
> probability of false positives, hence get manually inspected once raised
> by the auto check system.
>
> In this case the jump 1 --> 11 was flagged, because many people actually
> mean 1.1 instead, but it got manually confirmed and published.
>
> Best,
> Uwe Ligges
>
>
>
>
>
> > On Tue, Nov 5, 2024, 14:29 Toby Hocking <tdhock5 at gmail.com> wrote:
> >
> >> I thought that the auto-check robot only accepts submissions which
> >> have Status: OK? (no NOTEs at all)
> >> Is it documented somewhere which NOTEs are allowed by the auto-check
> >> service?
> >>
> >> On Tue, Nov 5, 2024 at 4:10?AM Uwe Ligges
> >> <ligges at statistik.tu-dortmund.de> wrote:
> >>>
> >>> CRAN does not object to these versioning, the notes are not the reason
> >>> for rejection. Who told they are?
> >>>
> >>> Best,
> >>> Uwe Ligges
> >>>
> >>>
> >>>
> >>>
> >>> On 05.11.2024 01:02, Josiah Parry wrote:
> >>>> Rolf,
> >>>>
> >>>> The versioning method they?re using is referred to as CalVer
> >>>> https://calver.org/ (not as catchy as SemVer) and it is actually quite
> >>>> useful! With one look at the version you can get a good sense of it?s
> >>>> general release date.
> >>>>
> >>>> Posit, for example, moved their professional products to use this
> >>>> versioning method a number of years ago.
> >>>>
> >>>> I wouldn?t poopoo it so quickly!
> >>>>
> >>>> On Mon, Nov 4, 2024 at 15:32 Rolf Turner <rolfturner at posteo.net>
> >> wrote:
> >>>>
> >>>>>
> >>>>> On Mon, 4 Nov 2024 16:33:40 -0500
> >>>>> Toby Hocking <tdhock5 at gmail.com> wrote:
> >>>>>
> >>>>> <SNIP>
> >>>>>
> >>>>>> Version jumps in minor (submitted: 2024.11.2, existing: 2024.1.24)
> >>>>>
> >>>>> It looks to me that you are setting your version numbers in an
> >>>>> unorthodox manner, which could/will confuse the living Drambuie out of
> >>>>> people.
> >>>>>
> >>>>> I conjecture that you are setting your version number to represent the
> >>>>> relevant date.  E.g. 2024.11.2  means 2 November, 2024 and 2024.1.24
> >>>>> means 24 January 2024.
> >>>>>
> >>>>> In my understanding, the usual convention is for the version number to
> >>>>> be of the form l.m.n (or l.m-n) --- major.minor.patch (or
> >>>>> major.minor-patch).  The date should be specified in the *Date* field
> >> of
> >>>>> the DESCRIPTION file.
> >>>>>
> >>>>> It probably does not matter a hell of a lot.  "Writing R Extensions"
> >>>>> just says that the version number should be "a sequence of at least
> >> two
> >>>>> (and usually three) non-negative integers separated by single ?.? or
> >>>>> ?-? characters".
> >>>>>
> >>>>> However you might save yourself some "NOTEs" by adhering to the
> >>>>> "l.m.n" convention and incrementing the components sequentially.
> >>>>>
> >>>>> cheers,
> >>>>>
> >>>>> Rolf Turner
> >>>>>
> >>>>> --
> >>>>> Honorary Research Fellow
> >>>>> Department of Statistics
> >>>>> University of Auckland
> >>>>> Stats. Dep't. (secretaries) phone:
> >>>>>            +64-9-373-7599 ext. 89622
> >>>>> Home phone: +64-9-480-4619
> >>>>>
> >>>>> ______________________________________________
> >>>>> R-package-devel at r-project.org mailing list
> >>>>> https://stat.ethz.ch/mailman/listinfo/r-package-devel
> >>>>>
> >>>>
> >>>>        [[alternative HTML version deleted]]
> >>>>
> >>>> ______________________________________________
> >>>> R-package-devel at r-project.org mailing list
> >>>> https://stat.ethz.ch/mailman/listinfo/r-package-devel
> >>> ______________________________________________
> >>> R-package-devel at r-project.org mailing list
> >>> https://stat.ethz.ch/mailman/listinfo/r-package-devel
> >>
> >> ______________________________________________
> >> R-package-devel at r-project.org mailing list
> >> https://stat.ethz.ch/mailman/listinfo/r-package-devel
> >>
> >
> >       [[alternative HTML version deleted]]
> >
> > ______________________________________________
> > R-package-devel at r-project.org mailing list
> > https://stat.ethz.ch/mailman/listinfo/r-package-devel


From jo@|@h@p@rry @end|ng |rom gm@||@com  Fri Nov  8 20:21:16 2024
From: jo@|@h@p@rry @end|ng |rom gm@||@com (Josiah Parry)
Date: Fri, 8 Nov 2024 11:21:16 -0800
Subject: [R-pkg-devel] Alternative to ifeq for Makevars
Message-ID: <CAL3ufUKNA5bqwMASsk6E0ZwtiU4LmMQc076q+fRiE9GC2+6uKg@mail.gmail.com>

I am working on refactoring some Makevars files and I am quite stuck. I
want to conditionally set the value of CRAN_FLAGS like so in my Makevars
files

ifeq ($(NOT_CRAN), false)
  CRAN_FLAGS = -j 2 --offline
else
  CRAN_FLAGS =
endif

Using ifeq appears to be the only way to get the value of CRAN_FLAGS to
persist within the $(STATILIB) portion of the Makevars file.

However, this results in a Warning

checking for GNU extensions in Makefiles ... WARNING
  Found the following file(s) containing GNU extensions:
    src/Makevars
  Portable Makefiles do not use GNU extensions such as +=, :=, $(shell),
  $(wildcard), ifeq ... endif, .NOTPARALLEL See section ?Writing portable
  packages? in the ?Writing R Extensions? manual.

How do other people address this?

	[[alternative HTML version deleted]]


From |kry|ov @end|ng |rom d|@root@org  Fri Nov  8 20:33:45 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Fri, 8 Nov 2024 22:33:45 +0300
Subject: [R-pkg-devel] Alternative to ifeq for Makevars
In-Reply-To: <CAL3ufUKNA5bqwMASsk6E0ZwtiU4LmMQc076q+fRiE9GC2+6uKg@mail.gmail.com>
References: <CAL3ufUKNA5bqwMASsk6E0ZwtiU4LmMQc076q+fRiE9GC2+6uKg@mail.gmail.com>
Message-ID: <20241108223345.7fce261c@Tarkus>

? Fri, 8 Nov 2024 11:21:16 -0800
Josiah Parry <josiah.parry at gmail.com> ?????:

> I want to conditionally set the value of CRAN_FLAGS like so in my
> Makevars files
> 
> ifeq ($(NOT_CRAN), false)
>   CRAN_FLAGS = -j 2 --offline
> else
>   CRAN_FLAGS =
> endif

Unless a better approach surfaces (detect the environment variable in
the configure script and generate src/Makevars from src/Makevars.in?),
you may be interested in the following movfuscator-like
POSIX-compatible trick: https://nullprogram.com/blog/2016/04/30/

EXTRA_FLAGS_true =
EXTRA_FLAGS_ = -j 2 --offline
EXTRA_FLAGS = $(EXTRA_FLAGS_$(NOT_CRAN))

(This one is untested, sorry.)

-- 
Best regards,
Ivan


From jo@|@h@p@rry @end|ng |rom gm@||@com  Fri Nov  8 20:44:15 2024
From: jo@|@h@p@rry @end|ng |rom gm@||@com (Josiah Parry)
Date: Fri, 8 Nov 2024 11:44:15 -0800
Subject: [R-pkg-devel] Alternative to ifeq for Makevars
In-Reply-To: <20241108223345.7fce261c@Tarkus>
References: <CAL3ufUKNA5bqwMASsk6E0ZwtiU4LmMQc076q+fRiE9GC2+6uKg@mail.gmail.com>
 <20241108223345.7fce261c@Tarkus>
Message-ID: <CAL3ufUKyRFw9Wdrfups+dSOuafmdzoE0va5B6Bm5d1QSufxWeA@mail.gmail.com>

Thanks, Ivan!

Do you know of any good documentation on the use of Makevars.in with
configure?
The @VARNAME@ syntax is quite confusing and isn't explained in WRE from
what I can tell.

On Fri, Nov 8, 2024 at 11:33?AM Ivan Krylov <ikrylov at disroot.org> wrote:

> ? Fri, 8 Nov 2024 11:21:16 -0800
> Josiah Parry <josiah.parry at gmail.com> ?????:
>
> > I want to conditionally set the value of CRAN_FLAGS like so in my
> > Makevars files
> >
> > ifeq ($(NOT_CRAN), false)
> >   CRAN_FLAGS = -j 2 --offline
> > else
> >   CRAN_FLAGS =
> > endif
>
> Unless a better approach surfaces (detect the environment variable in
> the configure script and generate src/Makevars from src/Makevars.in?),
> you may be interested in the following movfuscator-like
> POSIX-compatible trick: https://nullprogram.com/blog/2016/04/30/
>
> EXTRA_FLAGS_true =
> EXTRA_FLAGS_ = -j 2 --offline
> EXTRA_FLAGS = $(EXTRA_FLAGS_$(NOT_CRAN))
>
> (This one is untested, sorry.)
>
> --
> Best regards,
> Ivan
>

	[[alternative HTML version deleted]]


From |kry|ov @end|ng |rom d|@root@org  Fri Nov  8 21:04:14 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Fri, 8 Nov 2024 23:04:14 +0300
Subject: [R-pkg-devel] Alternative to ifeq for Makevars
In-Reply-To: <CAL3ufUKyRFw9Wdrfups+dSOuafmdzoE0va5B6Bm5d1QSufxWeA@mail.gmail.com>
References: <CAL3ufUKNA5bqwMASsk6E0ZwtiU4LmMQc076q+fRiE9GC2+6uKg@mail.gmail.com>
 <20241108223345.7fce261c@Tarkus>
 <CAL3ufUKyRFw9Wdrfups+dSOuafmdzoE0va5B6Bm5d1QSufxWeA@mail.gmail.com>
Message-ID: <20241108230414.2f5b338e@Tarkus>

? Fri, 8 Nov 2024 11:44:15 -0800
Josiah Parry <josiah.parry at gmail.com> ?????:

> Do you know of any good documentation on the use of Makevars.in with
> configure?

A configure script for an R package could be any POSIX-compatible shell
script, including a hand-written one that substitutes strings using sed
[*], or even one that delegates to R [**]. If you do want to use GNU
Autoconf, the relevant sections of the manual are 4.8 and 7.2:
https://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.72/html_node/Makefile-Substitutions.html
https://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.72/html_node/Setting-Output-Variables.html

-- 
Best regards,
Ivan

[*] https://github.com/jeroen/V8/blob/master/configure
[**] https://github.com/kevinushey/configure


From jo@|@h@p@rry @end|ng |rom gm@||@com  Fri Nov  8 22:55:27 2024
From: jo@|@h@p@rry @end|ng |rom gm@||@com (Josiah Parry)
Date: Fri, 8 Nov 2024 13:55:27 -0800
Subject: [R-pkg-devel] Alternative to ifeq for Makevars
In-Reply-To: <20241108230414.2f5b338e@Tarkus>
References: <CAL3ufUKNA5bqwMASsk6E0ZwtiU4LmMQc076q+fRiE9GC2+6uKg@mail.gmail.com>
 <20241108223345.7fce261c@Tarkus>
 <CAL3ufUKyRFw9Wdrfups+dSOuafmdzoE0va5B6Bm5d1QSufxWeA@mail.gmail.com>
 <20241108230414.2f5b338e@Tarkus>
Message-ID: <CAL3ufUK48h+TY1JAuQOeuMX3GqSp5ARPvhh=rsPzVAAkrnzB3w@mail.gmail.com>

Thanks, Ivan! I've been able to get quite far based on the code in
data.table*
which uses sed to generate the Makevars from the Makevars.in file. The new
challenge is that the Makevars file needs to be deleted after building.

The approach I have now is a cleanup script with only rm -rf src/Makevars.

This works *only* when --preclean or --clean is called. SO I'm not sure if
it is a
permanent solution. For example devtools::document() doesn't run the clean
step nor does pkgbuild::compile_dll().

I may keep banging my head against the keyboard on this...

*
https://github.com/Rdatatable/data.table/blob/08e94b7f4af3fc4403959282bf81c490ebdf9e72/src/Makevars.in#L7

On Fri, Nov 8, 2024 at 12:04?PM Ivan Krylov <ikrylov at disroot.org> wrote:

> ? Fri, 8 Nov 2024 11:44:15 -0800
> Josiah Parry <josiah.parry at gmail.com> ?????:
>
> > Do you know of any good documentation on the use of Makevars.in with
> > configure?
>
> A configure script for an R package could be any POSIX-compatible shell
> script, including a hand-written one that substitutes strings using sed
> [*], or even one that delegates to R [**]. If you do want to use GNU
> Autoconf, the relevant sections of the manual are 4.8 and 7.2:
>
> https://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.72/html_node/Makefile-Substitutions.html
>
> https://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.72/html_node/Setting-Output-Variables.html
>
> --
> Best regards,
> Ivan
>
> [*] https://github.com/jeroen/V8/blob/master/configure
> [**] https://github.com/kevinushey/configure
>

	[[alternative HTML version deleted]]


From murdoch@dunc@n @end|ng |rom gm@||@com  Sat Nov  9 01:00:25 2024
From: murdoch@dunc@n @end|ng |rom gm@||@com (Duncan Murdoch)
Date: Fri, 8 Nov 2024 19:00:25 -0500
Subject: [R-pkg-devel] Alternative to ifeq for Makevars
In-Reply-To: <CAL3ufUK48h+TY1JAuQOeuMX3GqSp5ARPvhh=rsPzVAAkrnzB3w@mail.gmail.com>
References: <CAL3ufUKNA5bqwMASsk6E0ZwtiU4LmMQc076q+fRiE9GC2+6uKg@mail.gmail.com>
 <20241108223345.7fce261c@Tarkus>
 <CAL3ufUKyRFw9Wdrfups+dSOuafmdzoE0va5B6Bm5d1QSufxWeA@mail.gmail.com>
 <20241108230414.2f5b338e@Tarkus>
 <CAL3ufUK48h+TY1JAuQOeuMX3GqSp5ARPvhh=rsPzVAAkrnzB3w@mail.gmail.com>
Message-ID: <f44f3604-7248-4e5c-9650-9e3fff32e648@gmail.com>

On 2024-11-08 4:55 p.m., Josiah Parry wrote:
> Thanks, Ivan! I've been able to get quite far based on the code in
> data.table*
> which uses sed to generate the Makevars from the Makevars.in file. The new
> challenge is that the Makevars file needs to be deleted after building.

I am pretty sure it does not need to be deleted. Just ignore it in the 
build (i.e. list it in .Rbuildignore, so it doesn't end up in the 
tarball, and each system installing the package recreates it).

Duncan Murdoch

> 
> The approach I have now is a cleanup script with only rm -rf src/Makevars.
> 
> This works *only* when --preclean or --clean is called. SO I'm not sure if
> it is a
> permanent solution. For example devtools::document() doesn't run the clean
> step nor does pkgbuild::compile_dll().
> 
> I may keep banging my head against the keyboard on this...
> 
> *
> https://github.com/Rdatatable/data.table/blob/08e94b7f4af3fc4403959282bf81c490ebdf9e72/src/Makevars.in#L7
> 
> On Fri, Nov 8, 2024 at 12:04?PM Ivan Krylov <ikrylov at disroot.org> wrote:
> 
>> ? Fri, 8 Nov 2024 11:44:15 -0800
>> Josiah Parry <josiah.parry at gmail.com> ?????:
>>
>>> Do you know of any good documentation on the use of Makevars.in with
>>> configure?
>>
>> A configure script for an R package could be any POSIX-compatible shell
>> script, including a hand-written one that substitutes strings using sed
>> [*], or even one that delegates to R [**]. If you do want to use GNU
>> Autoconf, the relevant sections of the manual are 4.8 and 7.2:
>>
>> https://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.72/html_node/Makefile-Substitutions.html
>>
>> https://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.72/html_node/Setting-Output-Variables.html
>>
>> --
>> Best regards,
>> Ivan
>>
>> [*] https://github.com/jeroen/V8/blob/master/configure
>> [**] https://github.com/kevinushey/configure
>>
> 
> 	[[alternative HTML version deleted]]
> 
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From tony_@_w||ke@ @end|ng |rom out|ook@com  Sat Nov  9 07:44:27 2024
From: tony_@_w||ke@ @end|ng |rom out|ook@com (Tony Wilkes)
Date: Sat, 9 Nov 2024 06:44:27 +0000
Subject: [R-pkg-devel] Why is Rf_Seql hidden?
Message-ID: <AS4P195MB14303DC7A2F4E9C48B00F194BE5D2@AS4P195MB1430.EURP195.PROD.OUTLOOK.COM>

Hi everyone,

Checking if 2 strings are equal, when these strings might be of different encoding, whilst still maintaining good performance, can be quite difficult.
But R seems to manage reasonably well.
It appears that R uses Rf_seql() to check if 2 strings are equal.
But Rf_seql is not public in R's C API; it is hidden.
So I have 2 questions:

1) ?Why is Rf_Seql() hidden? (what would be the problem if it were made public?)
2) What would be an alternative way to re-create Rf_Seql (a way that is relatively stable)? (An example C function that re-creates Rf_seql() using R's public C Api would be really nice.)

Kind regards,


Tony.


	[[alternative HTML version deleted]]


From |kry|ov @end|ng |rom d|@root@org  Sat Nov  9 08:19:52 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Sat, 09 Nov 2024 10:19:52 +0300
Subject: [R-pkg-devel] Why is Rf_Seql hidden?
In-Reply-To: <AS4P195MB14303DC7A2F4E9C48B00F194BE5D2@AS4P195MB1430.EURP195.PROD.OUTLOOK.COM>
References: <AS4P195MB14303DC7A2F4E9C48B00F194BE5D2@AS4P195MB1430.EURP195.PROD.OUTLOOK.COM>
Message-ID: <3D866938-A47C-4FC2-9C36-42206B8CEFD1@disroot.org>

9 ?????? 2024 ?. 09:44:27 GMT+03:00, Tony Wilkes <tony_a_wilkes at outlook.com> ?????: 
> 1) ?Why is Rf_Seql() hidden? (what would be the problem if it were made public?)

It accepts two SEXP arguments but then performs operations on them that are only valid for CHARSXP objects. This might be unsafe.

> 2) What would be an alternative way to re-create Rf_Seql (a way that is relatively stable)?

How about R_compute_identical()? It tests for TYPEOF() equality and then quickly jumps to Seql() for CHARSXP values. It's listed among "experimental" APIs and so may grow more flags [*] in the future, but they don't seem relevant for CHARSXPs.

-- 
Best regards,
Ivan

[*] Unofficial description: https://aitap.codeberg.page/R-api/#R_005fcompute_005fidentical


From @pencer@gr@ve@ @end|ng |rom e||ect|vede|en@e@org  Sun Nov 10 06:56:49 2024
From: @pencer@gr@ve@ @end|ng |rom e||ect|vede|en@e@org (Spencer Graves)
Date: Sat, 9 Nov 2024 23:56:49 -0600
Subject: [R-pkg-devel] Forbidden URLs?
Message-ID: <7d46f530-7b16-4bef-996a-5ecf8869e0d9@effectivedefense.org>

Hello:


	  I'm getting:


Found the following (possibly) invalid URLs:
   URL: https://bioguide.congress.gov/
     From: man/readDW_NOMINATE.Rd
     Status: 403
     Message: Forbidden
   URL: https://www.bls.gov/cps/
     From: inst/doc/UpdatingUSGDPpresidents.html
     Status: 403
     Message: Forbidden
	

	  These are in:


https://win-builder.r-project.org/9SsxyKVoV7n1/00check.log


	  Searching for "forbidden" in "Writing R Extensions" or in a web 
search has given me nothing.


	  These are only NOTES. Should I ignore them is submitting to CRAN?


	  Thanks,
	  Spencer Graves


From berw|n@tur|@ch @end|ng |rom gm@||@com  Sun Nov 10 07:33:45 2024
From: berw|n@tur|@ch @end|ng |rom gm@||@com (Berwin A Turlach)
Date: Sun, 10 Nov 2024 14:33:45 +0800
Subject: [R-pkg-devel] Forbidden URLs?
In-Reply-To: <7d46f530-7b16-4bef-996a-5ecf8869e0d9@effectivedefense.org>
References: <7d46f530-7b16-4bef-996a-5ecf8869e0d9@effectivedefense.org>
Message-ID: <20241110143345.4694cf5f@dep59159.uniwa.uwa.edu.au>

G'day Spencer,

On Sat, 9 Nov 2024 23:56:49 -0600
Spencer Graves <spencer.graves at effectivedefense.org> wrote:

> 	  Searching for "forbidden" in "Writing R Extensions" or in a
> web search has given me nothing.

Probably the wrong place to look. :)  These messages have nothing to do
with writing extensions for R but with CRAN policies.  So more relevant
are:
	https://cran.r-project.org/web/packages/policies.html
and
	https://cran.r-project.org/web/packages/URL_checks.html
(latter linked from the former).

Not sure what the current state is, but IIRC in the past some websites
blocked requests for URLs during these checks as they thought a
crawler/robot was accessing their site.  As long as you are sure the
URL is accessible under normal circumstances by all (most?) users it
should be fine, you might just have to explain this in a note when
submitting your package.

Cheers,

	Berwin


From ||gge@ @end|ng |rom @t@t|@t|k@tu-dortmund@de  Sun Nov 10 14:35:10 2024
From: ||gge@ @end|ng |rom @t@t|@t|k@tu-dortmund@de (Uwe Ligges)
Date: Sun, 10 Nov 2024 14:35:10 +0100
Subject: [R-pkg-devel] Forbidden URLs?
In-Reply-To: <7d46f530-7b16-4bef-996a-5ecf8869e0d9@effectivedefense.org>
References: <7d46f530-7b16-4bef-996a-5ecf8869e0d9@effectivedefense.org>
Message-ID: <12955f7c-0c9c-4ad5-ad7b-8e1e932b3be9@statistik.tu-dortmund.de>

These can be ignored: The websites report "Forbidden" state when the 
script asks for headers to verify the URLs are correct.
Not much you can do unless the websites are under your control.

Best,
Uwe Ligges



On 10.11.2024 06:56, Spencer Graves wrote:
> Hello:
> 
> 
>  ????? I'm getting:
> 
> 
> Found the following (possibly) invalid URLs:
>  ? URL: https://bioguide.congress.gov/
>  ??? From: man/readDW_NOMINATE.Rd
>  ??? Status: 403
>  ??? Message: Forbidden
>  ? URL: https://www.bls.gov/cps/
>  ??? From: inst/doc/UpdatingUSGDPpresidents.html
>  ??? Status: 403
>  ??? Message: Forbidden
> 
> 
>  ????? These are in:
> 
> 
> https://win-builder.r-project.org/9SsxyKVoV7n1/00check.log
> 
> 
>  ????? Searching for "forbidden" in "Writing R Extensions" or in a web 
> search has given me nothing.
> 
> 
>  ????? These are only NOTES. Should I ignore them is submitting to CRAN?
> 
> 
>  ????? Thanks,
>  ????? Spencer Graves
> 
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel

From @pencer@gr@ve@ @end|ng |rom e||ect|vede|en@e@org  Sun Nov 10 14:38:16 2024
From: @pencer@gr@ve@ @end|ng |rom e||ect|vede|en@e@org (Spencer Graves)
Date: Sun, 10 Nov 2024 07:38:16 -0600
Subject: [R-pkg-devel] Forbidden URLs?
In-Reply-To: <12955f7c-0c9c-4ad5-ad7b-8e1e932b3be9@statistik.tu-dortmund.de>
References: <7d46f530-7b16-4bef-996a-5ecf8869e0d9@effectivedefense.org>
 <12955f7c-0c9c-4ad5-ad7b-8e1e932b3be9@statistik.tu-dortmund.de>
Message-ID: <ad288d37-eb1e-43da-8270-cd875c6563bc@effectivedefense.org>

Hi, Uwe, Kelly and Berwin:


	  Thanks for the replies.


	  Checking my "cran-comments.md" file after Berwin's reply, I found 
that I had documented two similar problems in 2022. One of these new 
problems was present in 2022 but not flagged then. The other is new. I 
documented them both in "cran-comments.md".


	  Thanks again,
	  Spencer Graves


p.s. If my memory worked better, I may not have needed to bother 
R-pkg-devel. (I don't think this memory problem is a symptom of dementia 
or senility, as I remember not remembering well decades ago ;-)


On 11/10/24 07:35, Uwe Ligges wrote:
> These can be ignored: The websites report "Forbidden" state when the 
> script asks for headers to verify the URLs are correct.
> Not much you can do unless the websites are under your control.
> 
> Best,
> Uwe Ligges
> 
> 
> 
> On 10.11.2024 06:56, Spencer Graves wrote:
>> Hello:
>>
>>
>> ?????? I'm getting:
>>
>>
>> Found the following (possibly) invalid URLs:
>> ?? URL: https://bioguide.congress.gov/
>> ???? From: man/readDW_NOMINATE.Rd
>> ???? Status: 403
>> ???? Message: Forbidden
>> ?? URL: https://www.bls.gov/cps/
>> ???? From: inst/doc/UpdatingUSGDPpresidents.html
>> ???? Status: 403
>> ???? Message: Forbidden
>>
>>
>> ?????? These are in:
>>
>>
>> https://win-builder.r-project.org/9SsxyKVoV7n1/00check.log
>>
>>
>> ?????? Searching for "forbidden" in "Writing R Extensions" or in a web 
>> search has given me nothing.
>>
>>
>> ?????? These are only NOTES. Should I ignore them is submitting to CRAN?
>>
>>
>> ?????? Thanks,
>> ?????? Spencer Graves
>>
>> ______________________________________________
>> R-package-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From ro||turner @end|ng |rom po@teo@net  Sun Nov 10 23:25:51 2024
From: ro||turner @end|ng |rom po@teo@net (Rolf Turner)
Date: Sun, 10 Nov 2024 22:25:51 +0000
Subject: [R-pkg-devel] Forbidden URLs?
In-Reply-To: <ad288d37-eb1e-43da-8270-cd875c6563bc@effectivedefense.org>
References: <7d46f530-7b16-4bef-996a-5ecf8869e0d9@effectivedefense.org>
 <12955f7c-0c9c-4ad5-ad7b-8e1e932b3be9@statistik.tu-dortmund.de>
 <ad288d37-eb1e-43da-8270-cd875c6563bc@effectivedefense.org>
Message-ID: <20241111112551.61fe1ea5@elderly-dell>


On Sun, 10 Nov 2024 07:38:16 -0600
Spencer Graves <spencer.graves at effectivedefense.org> wrote:


<SNIP>

> p.s. If my memory worked better, I may not have needed to bother 
> R-pkg-devel. (I don't think this memory problem is a symptom of
> dementia or senility, as I remember not remembering well decades ago.)

Fortune nomination.

cheers,

Rolf

-- 
Honorary Research Fellow
Department of Statistics
University of Auckland
Stats. Dep't. (secretaries) phone:
         +64-9-373-7599 ext. 89622
Home phone: +64-9-480-4619


From m@@epu|ved@ @end|ng |rom m@||@utoronto@c@  Sat Nov  9 18:34:07 2024
From: m@@epu|ved@ @end|ng |rom m@||@utoronto@c@ (Mauricio Vargas Sepulveda)
Date: Sat, 9 Nov 2024 17:34:07 +0000
Subject: [R-pkg-devel] Possible false negative for compiled C++ code in CRAN
 checks
Message-ID: <YT2PPFFFCD7005701B25728913116FEEC8BDD5E2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>

Dear Developers,

I am writing to ask for insights on how to fix the errors in the Redatam package and get it  back to CRAN.

CRAN reported memory leaks for:

CLAN/ASAN: https://www.stats.ox.ac.uk/pub/bdr/memtests/clang-ASAN/redatam/00check.log
CLANG/UBSAN: https://www.stats.ox.ac.uk/pub/bdr/memtests/gcc-UBSAN/redatam/00check.log

The log reads:

"HINT: if you don't care about these errors you may set ASAN_OPTIONS=detect_container_overflow=0.
If you suspect a false positive see also: https://github.com/google/sanitizers/wiki/AddressSanitizerContainerOverflow.
SUMMARY: AddressSanitizer: container-overflow .../src/redatamlib/ByteArrayReader.cpp:170:23 in RedatamLib::ByteArrayReader::ReadByte()"

After asking on Stack Overflow (https://stackoverflow.com/q/79171799/3720258), it was suggested that I set 'CXXFLAGS="-stdlib=libc++"' in 'configure'. The question is very long and provides all the details that I skip here.

After googling and exploring different steps, I managed to run a Docker image that imitates CRAN's clang ASAN/UBSAN test, but adding 'CXXFLAGS' not only made the error persist, but also create a note about overwriting options.

According to a Microsoft thread, the problem is not the Redatam package's code, but the release of 'libc' that comes with the image (see https://github.com/microsoft/DirectXShaderCompiler/issues/5971). They suggest compiling 'libc' yourself instead of using the precompiled version. I would need to explore with a Fedora 36 image with Clang 19 with a compiled libc and explore if there is a difference.

I took a 'computer programming' class where I learned a bit of theory and how to write C++ using GCC and testing with 'valgrind' in the Ubuntu machines from the lab.

I am not an IT expert, and I honestly would like to fix this issue because I already have users emailing me because they use this package for "data archeology" and I use it for the same reason for my research in Political Science.

The alternative is to use old hardware and a point-and-click tool on Windows 98/XP, which is why I keep my old ThinkPad X200 and an external DVD reader. It not feasible to read old census data with modern hardware, which is a problem derived from it being in a closed source format. Even worse, some recent census data comes with an installer that does not work on Windows 10+, and that I was able to restore by using Wine on my main modern laptop.

Best wishes,

_
Mauricio "Pach?" Vargas Sep?lveda
PhD Student, Political Science
University of Toronto


From |kry|ov @end|ng |rom d|@root@org  Mon Nov 11 10:48:40 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Mon, 11 Nov 2024 12:48:40 +0300
Subject: [R-pkg-devel] 
 Possible false negative for compiled C++ code in CRAN checks
In-Reply-To: <YT2PPFFFCD7005701B25728913116FEEC8BDD5E2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
References: <YT2PPFFFCD7005701B25728913116FEEC8BDD5E2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
Message-ID: <20241111124840.55248fa6@Tarkus>

Dear Mauricio Vargas Sepulveda,

Welcome to R-package-devel!

? Sat, 9 Nov 2024 17:34:07 +0000
Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca> ?????:

> CRAN reported memory leaks for:
> 
> CLAN/ASAN:
> https://www.stats.ox.ac.uk/pub/bdr/memtests/clang-ASAN/redatam/00check.log
> CLANG/UBSAN:
> https://www.stats.ox.ac.uk/pub/bdr/memtests/gcc-UBSAN/redatam/00check.log

These include container-overflow at
src/redatamlib/ByteArrayReader.cpp:170:23 and method calls with `this`
being a null pointer at src/redatamlib/FuzzyVariableParser.cpp:47 and
src/redatamlib/Entity.cpp:52.

A container-overflow in ByteArrayReader::ReadByte is dangerous because
the code is reading past the end of the vector populated with known
data. While the code doesn't crash, the remainder of the vector could
contain anything. This could invalidate the conclusions of a scientific
work if they end up being based on random contents of uninitialised
memory. You need to find out why m_currPos exceeds the number of bytes
in the array and prevent it from happening.

Calling methods on a null pointer is also an error in the code. This is
quite confusing, but I have a guess for what might be causing this:

  for (size_t i = 0; i < entities.size() - 1; ++i) {
    ret.push_back(
        {entities[i].GetBounds().second, entities[i + 1].GetBounds().first});
  }

If entities.size() is 0, entities.size() - 1 will overflow to a large
positive number, due to std::vector<T>::size_type being unsigned. The
loop will proceed accessing out-of-bounds elements of 'entities' until
something will cause it to crash. The guess could be completely wrong,
unfortunately.

Have you fixed these problems since v2.0.0?

> After asking on Stack Overflow
> (https://stackoverflow.com/q/79171799/3720258), it was suggested that
> I set 'CXXFLAGS="-stdlib=libc++"' in 'configure'. The question is
> very long and provides all the details that I skip here.

I am not seeing alloc-dealloc-mismatch in the CRAN checks, neither in
the links you provided, nor in the latest pretest results at
<https://win-builder.r-project.org/incoming_pretest/redatam_2.0.3_20241107_154750/>.
I think that these indicate a problem with the way your GitHub actions
are set up. Have you received a CRAN check report with
alloc-dealloc-mismatch in it?

I've tried to compare the versions visible in the CRAN archive but
couldn't get far because there was a lot of formatting changes. What
exactly are the problems for which your latest submission of v2.0.3 has
been archived? Do you need help reproducing the container-overflow
and/or null object pointer errors?

-- 
Best regards,
Ivan


From @|ex@nder@p@te @end|ng |rom m@nche@ter@@c@uk  Mon Nov 11 14:22:43 2024
From: @|ex@nder@p@te @end|ng |rom m@nche@ter@@c@uk (Alexander Pate)
Date: Mon, 11 Nov 2024 13:22:43 +0000
Subject: [R-pkg-devel] Creating temporary files in tests/examples/vignettes
 - adhering to CRAN policies
Message-ID: <CWLP265MB20671BECDB67CB453264BA26B8582@CWLP265MB2067.GBRP265.PROD.OUTLOOK.COM>

Hello,

The CRAN policies (https://cran.r-project.org/web/packages/policies.html) for R package development state:

"Packages should not write in the user's home filespace (including clipboards), nor anywhere else on the file system apart from the R session's temporary directory (or during installation in the location pointed to by TMPDIR: and such usage should be cleaned up)."

If a file is created in the R session's temporary directory, does it then need to be cleaned up? Or does it only apply "during installation in the location pointed to by TMPDIR". I am unsure, given the "and such usage should be cleaned up" is contained within the brackets, whether it applies to creating files in the temporary directory during function examples/vignettes/tests.

For example, the following command will create an SQLite database in the R session's temporary directory:

testdb <- RSQLite::dbConnect(RSQLite::SQLite(), tempfile("temp"))

Suppose a package function (called: myfunc) runs this command. Should the file created in the temporary directory have to be removed after running an example of myfunc, or a test for myfunc, or when myfunc is used in a vignette?

I think part of my confusion comes from not understanding what TMPDIR is during installation. Is this just the temporary directory used when vignettes are built during package installation? In which case they are effectively the same thing?

Many thanks


	[[alternative HTML version deleted]]


From ke||ey @end|ng |rom d@|@c@  Mon Nov 11 15:26:12 2024
From: ke||ey @end|ng |rom d@|@c@ (Daniel Kelley)
Date: Mon, 11 Nov 2024 14:26:12 +0000
Subject: [R-pkg-devel] 
 Creating temporary files in tests/examples/vignettes
 - adhering to CRAN policies
In-Reply-To: <CWLP265MB20671BECDB67CB453264BA26B8582@CWLP265MB2067.GBRP265.PROD.OUTLOOK.COM>
References: <CWLP265MB20671BECDB67CB453264BA26B8582@CWLP265MB2067.GBRP265.PROD.OUTLOOK.COM>
Message-ID: <BB20527F-9F22-49F4-AA14-049830468BA2@dal.ca>

I think the idea is to do as below.  You can also make temporary directories in a similar way.

        tempFile <- tempfile()
        # write to tempFile, and use it anyway you like
        unlink(tempFile)

> On Nov 11, 2024, at 9:22?AM, Alexander Pate <alexander.pate at manchester.ac.uk> wrote:
> 
> CAUTION: The Sender of this email is not from within Dalhousie.
> 
> Hello,
> 
> The CRAN policies (https://cran.r-project.org/web/packages/policies.html) for R package development state:
> 
> "Packages should not write in the user's home filespace (including clipboards), nor anywhere else on the file system apart from the R session's temporary directory (or during installation in the location pointed to by TMPDIR: and such usage should be cleaned up)."
> 
> If a file is created in the R session's temporary directory, does it then need to be cleaned up? Or does it only apply "during installation in the location pointed to by TMPDIR". I am unsure, given the "and such usage should be cleaned up" is contained within the brackets, whether it applies to creating files in the temporary directory during function examples/vignettes/tests.
> 
> For example, the following command will create an SQLite database in the R session's temporary directory:
> 
> testdb <- RSQLite::dbConnect(RSQLite::SQLite(), tempfile("temp"))
> 
> Suppose a package function (called: myfunc) runs this command. Should the file created in the temporary directory have to be removed after running an example of myfunc, or a test for myfunc, or when myfunc is used in a vignette?
> 
> I think part of my confusion comes from not understanding what TMPDIR is during installation. Is this just the temporary directory used when vignettes are built during package installation? In which case they are effectively the same thing?
> 
> Many thanks
> 
> 
>        [[alternative HTML version deleted]]
> 
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From m@@epu|ved@ @end|ng |rom m@||@utoronto@c@  Tue Nov 12 01:44:57 2024
From: m@@epu|ved@ @end|ng |rom m@||@utoronto@c@ (Mauricio Vargas Sepulveda)
Date: Tue, 12 Nov 2024 00:44:57 +0000
Subject: [R-pkg-devel] 
 Possible false negative for compiled C++ code in CRAN checks
In-Reply-To: <20241111124840.55248fa6@Tarkus>
References: <YT2PPFFFCD7005701B25728913116FEEC8BDD5E2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241111124840.55248fa6@Tarkus>
Message-ID: <YT2PPFFFCD70057CF5F7C2CA2439229E0B6DD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>

Dear Prof. Dr.  Ivan Krylov,

I hope you are doing well.

Thanks for your prompt reply. I shall try to implement a fix and resumit based on this. It is a valuable suggestion.
??
Mauricio "Pach?" Vargas Sep?lveda
PhD Student, Political Science
University of Toronto


________________________________________
From: Ivan Krylov <ikrylov at disroot.org>
Sent: November 11, 2024 4:48 AM
To: Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca>
Cc: r-package-devel at r-project.org <r-package-devel at r-project.org>
Subject: Re: [R-pkg-devel] Possible false negative for compiled C++ code in CRAN checks

[You don't often get email from ikrylov at disroot.org. Learn why this is important at https://aka.ms/LearnAboutSenderIdentification ]

Dear Mauricio Vargas Sepulveda,

Welcome to R-package-devel!

? Sat, 9 Nov 2024 17:34:07 +0000
Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca> ?????:

> CRAN reported memory leaks for:
>
> CLAN/ASAN:
> https://www.stats.ox.ac.uk/pub/bdr/memtests/clang-ASAN/redatam/00check.log
> CLANG/UBSAN:
> https://www.stats.ox.ac.uk/pub/bdr/memtests/gcc-UBSAN/redatam/00check.log

These include container-overflow at
src/redatamlib/ByteArrayReader.cpp:170:23 and method calls with `this`
being a null pointer at src/redatamlib/FuzzyVariableParser.cpp:47 and
src/redatamlib/Entity.cpp:52.

A container-overflow in ByteArrayReader::ReadByte is dangerous because
the code is reading past the end of the vector populated with known
data. While the code doesn't crash, the remainder of the vector could
contain anything. This could invalidate the conclusions of a scientific
work if they end up being based on random contents of uninitialised
memory. You need to find out why m_currPos exceeds the number of bytes
in the array and prevent it from happening.

Calling methods on a null pointer is also an error in the code. This is
quite confusing, but I have a guess for what might be causing this:

  for (size_t i = 0; i < entities.size() - 1; ++i) {
    ret.push_back(
        {entities[i].GetBounds().second, entities[i + 1].GetBounds().first});
  }

If entities.size() is 0, entities.size() - 1 will overflow to a large
positive number, due to std::vector<T>::size_type being unsigned. The
loop will proceed accessing out-of-bounds elements of 'entities' until
something will cause it to crash. The guess could be completely wrong,
unfortunately.

Have you fixed these problems since v2.0.0?

> After asking on Stack Overflow
> (https://stackoverflow.com/q/79171799/3720258), it was suggested that
> I set 'CXXFLAGS="-stdlib=libc++"' in 'configure'. The question is
> very long and provides all the details that I skip here.

I am not seeing alloc-dealloc-mismatch in the CRAN checks, neither in
the links you provided, nor in the latest pretest results at
<https://win-builder.r-project.org/incoming_pretest/redatam_2.0.3_20241107_154750/>.
I think that these indicate a problem with the way your GitHub actions
are set up. Have you received a CRAN check report with
alloc-dealloc-mismatch in it?

I've tried to compare the versions visible in the CRAN archive but
couldn't get far because there was a lot of formatting changes. What
exactly are the problems for which your latest submission of v2.0.3 has
been archived? Do you need help reproducing the container-overflow
and/or null object pointer errors?

--
Best regards,
Ivan

From m@@epu|ved@ @end|ng |rom m@||@utoronto@c@  Tue Nov 12 05:02:17 2024
From: m@@epu|ved@ @end|ng |rom m@||@utoronto@c@ (Mauricio Vargas Sepulveda)
Date: Tue, 12 Nov 2024 04:02:17 +0000
Subject: [R-pkg-devel] 
 Possible false negative for compiled C++ code in CRAN checks
In-Reply-To: <YT2PPFFFCD70057CF5F7C2CA2439229E0B6DD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
References: <YT2PPFFFCD7005701B25728913116FEEC8BDD5E2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241111124840.55248fa6@Tarkus>
 <YT2PPFFFCD70057CF5F7C2CA2439229E0B6DD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
Message-ID: <YT2PPFFFCD700570537573F529D215EC62ADD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>

The issue persists, and I really appreciate the help. The last comment in Stack Overflow (https://stackoverflow.com/questions/79171799/addresssanitizer-error-alloc-dealloc-mismatch-operator-new-vs-free-in-r-packa?noredirect=1#comment139621299_79171799) suggests a false positive, and if that is the case, should I add that as a note when resubmitting?

For v2.0.3 I implemented a full refactor, where I simplified the code considerably while trying to solve what looks to be a false positive.

Now I implemented a "patch" based on the suggestion:

  vector<pair<size_t, size_t>> ret;

  // ADDED //
  if (entities.empty() || entities.size() == 0) {
    return ret;
  }
  ////////////

  for (size_t i = 0; i < entities.size() - 1; ++i) {
    ret.push_back(
        {entities[i].GetBounds().second, entities[i + 1].GetBounds().first});
  }

After testing with the R-Hub image "Clang Asan" with this code:

  # Define the package directory and Docker image
  PACKAGE_DIR=$(pwd)
  DOCKER_IMAGE="ghcr.io/r-hub/containers/clang-asan:latest"

  # Pull the Docker image
  docker pull $DOCKER_IMAGE

  # Run the R CMD check inside the Docker container
  docker run --rm -v "$PACKAGE_DIR":/workspace -w /workspace $DOCKER_IMAGE bash -c "
   Rscript -e 'if (!requireNamespace(\"pak\", quietly = TRUE)) { install.packages(\"pak\", repos = \"https://r-lib.github.io/p/pak/dev//") }'
   Rscript -e 'pak::pkg_install(\"decor\", dependencies = TRUE)'
   Rscript -e 'pak::pkg_install(\"rcmdcheck\", dependencies = TRUE)'
   Rscript -e 'pak::pkg_install(\"pkgbuild\", dependencies = TRUE)'
   Rscript -e 'pak::pkg_install(\".\", dependencies = TRUE)'
   Rscript -e 'pkgbuild::check_build_tools(debug = TRUE)'
   Rscript -e 'rcmdcheck::rcmdcheck(args = c(\"--no-manual\", \"--as-cran\"), build_args = \"--no-manual\", error_on = \"error\")'
  "

I get the following output:

    #2 0x7bc709b3e119 in RedatamLib::ByteArrayReader::MovePos(int) readers/ByteArrayReader.cpp:99:44
    #3 0x7bc709b3e119 in RedatamLib::ByteArrayReader::ReadByte() readers/ByteArrayReader.cpp:172:3
    #4 0x7bc709b3d2a6 in RedatamLib::ByteArrayReader::ReadInt16LE() readers/ByteArrayReader.cpp:178:32
    #5 0x7bc709b3d2a6 in RedatamLib::ByteArrayReader::TryReadStr(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>*, bool) readers/ByteArrayReader.cpp:110:20
    #6 0x7bc709b4778a in RedatamLib::FuzzyEntityParser::TryGetEntity() readers/FuzzyEntityParser.cpp:44:17
    #7 0x7bc709b4601b in RedatamLib::FuzzyEntityParser::ParseEntities() readers/FuzzyEntityParser.cpp:18:14
    #8 0x7bc709baaaa7 in RedatamLib::RedatamDatabase::OpenDictionary(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&) entities/RedatamDatabase.cpp:31:25
    #9 0x7bc709baa876 in RedatamLib::RedatamDatabase::RedatamDatabase(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&) entities/RedatamDatabase.cpp:18:3
    #10 0x7bc709bb76f8 in export_redatam_to_list_(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>) /tmp/RtmpEHQaSu/file136708ed8/redatam.Rcheck/00_pkg_src/redatam/src/main.cpp:13:33
    #11 0x7bc709bb8438 in _redatam_export_redatam_to_list_ src/cpp11.cpp:12:27
    #12 0x7bc757f3a700 in R_doDotCall /tmp/R-devel/src/main/dotcode.c:754:11

   SUMMARY: AddressSanitizer: alloc-dealloc-mismatch (/opt/R/devel-asan/lib/R/bin/exec/R+0xc6306) (BuildId: 178e357df79b1589a38c1949da5e5f022d4bb535) in free
   ==4218==HINT: if you don't care about these errors you may set ASAN_OPTIONS=alloc_dealloc_mismatch=0
   ==4218==ABORTING

  2 errors ? | 0 warnings ? | 2 notes ?
  Error: R CMD check found ERRORs


??
Mauricio "Pach?" Vargas Sep?lveda
PhD Student, Political Science
University of Toronto


________________________________________
From: Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca>
Sent: November 11, 2024 7:44 PM
To: Ivan Krylov <ikrylov at disroot.org>
Cc: r-package-devel at r-project.org <r-package-devel at r-project.org>
Subject: Re: [R-pkg-devel] Possible false negative for compiled C++ code in CRAN checks

Dear Prof. Dr.  Ivan Krylov,

I hope you are doing well.

Thanks for your prompt reply. I shall try to implement a fix and resumit based on this. It is a valuable suggestion.
??
Mauricio "Pach?" Vargas Sep?lveda
PhD Student, Political Science
University of Toronto


________________________________________
From: Ivan Krylov <ikrylov at disroot.org>
Sent: November 11, 2024 4:48 AM
To: Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca>
Cc: r-package-devel at r-project.org <r-package-devel at r-project.org>
Subject: Re: [R-pkg-devel] Possible false negative for compiled C++ code in CRAN checks

[You don't often get email from ikrylov at disroot.org. Learn why this is important at https://aka.ms/LearnAboutSenderIdentification ]

Dear Mauricio Vargas Sepulveda,

Welcome to R-package-devel!

? Sat, 9 Nov 2024 17:34:07 +0000
Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca> ?????:

> CRAN reported memory leaks for:
>
> CLAN/ASAN:
> https://www.stats.ox.ac.uk/pub/bdr/memtests/clang-ASAN/redatam/00check.log
> CLANG/UBSAN:
> https://www.stats.ox.ac.uk/pub/bdr/memtests/gcc-UBSAN/redatam/00check.log

These include container-overflow at
src/redatamlib/ByteArrayReader.cpp:170:23 and method calls with `this`
being a null pointer at src/redatamlib/FuzzyVariableParser.cpp:47 and
src/redatamlib/Entity.cpp:52.

A container-overflow in ByteArrayReader::ReadByte is dangerous because
the code is reading past the end of the vector populated with known
data. While the code doesn't crash, the remainder of the vector could
contain anything. This could invalidate the conclusions of a scientific
work if they end up being based on random contents of uninitialised
memory. You need to find out why m_currPos exceeds the number of bytes
in the array and prevent it from happening.

Calling methods on a null pointer is also an error in the code. This is
quite confusing, but I have a guess for what might be causing this:

  for (size_t i = 0; i < entities.size() - 1; ++i) {
    ret.push_back(
        {entities[i].GetBounds().second, entities[i + 1].GetBounds().first});
  }

If entities.size() is 0, entities.size() - 1 will overflow to a large
positive number, due to std::vector<T>::size_type being unsigned. The
loop will proceed accessing out-of-bounds elements of 'entities' until
something will cause it to crash. The guess could be completely wrong,
unfortunately.

Have you fixed these problems since v2.0.0?

> After asking on Stack Overflow
> (https://stackoverflow.com/q/79171799/3720258), it was suggested that
> I set 'CXXFLAGS="-stdlib=libc++"' in 'configure'. The question is
> very long and provides all the details that I skip here.

I am not seeing alloc-dealloc-mismatch in the CRAN checks, neither in
the links you provided, nor in the latest pretest results at
<https://win-builder.r-project.org/incoming_pretest/redatam_2.0.3_20241107_154750/>.
I think that these indicate a problem with the way your GitHub actions
are set up. Have you received a CRAN check report with
alloc-dealloc-mismatch in it?

I've tried to compare the versions visible in the CRAN archive but
couldn't get far because there was a lot of formatting changes. What
exactly are the problems for which your latest submission of v2.0.3 has
been archived? Do you need help reproducing the container-overflow
and/or null object pointer errors?

--
Best regards,
Ivan

From @pencer@gr@ve@ @end|ng |rom e||ect|vede|en@e@org  Tue Nov 12 08:53:08 2024
From: @pencer@gr@ve@ @end|ng |rom e||ect|vede|en@e@org (Spencer Graves)
Date: Tue, 12 Nov 2024 01:53:08 -0600
Subject: [R-pkg-devel] Found the following HTML validation problems: in R
 CMD check --as-cran
Message-ID: <b39ad7b5-7cba-4a78-bc4b-624d18981bf6@effectivedefense.org>

Hello, All:


	  In running "R CMD check --as-cran Ecfun_0.3-5.tar.gz" on my local 
macOS 15.0.1 system, 00check.log contains "Found the following HTML 
validation problems:" followed by 501 lines like the following:


Arrows.html:15:44 (Arrows.Rd:3): Error: <main> is not recognized!
Arrows.html:15:44 (Arrows.Rd:3): Warning: discarding unexpected <main>
Arrows.html:97:1 (Arrows.Rd:59): Warning: discarding unexpected </main>
Arrows.html:4:1 (Arrows.Rd:3): Warning: <link> inserting "type" attribute
Arrows.html:12:1 (Arrows.Rd:3): Warning: <script> proprietary attribute 
"onload"
Arrows.html:12:1 (Arrows.Rd:3): Warning: <script> inserting "type" attribute
Arrows.html:17:1 (Arrows.Rd:3): Warning: <table> lacks "summary" attribute
Arrows.html:42:1 (Arrows.Rd:18): Warning: <table> lacks "summary" attribute
Arrows.html:43:339 (Arrows.Rd:18): Warning: <code> attribute "id" has 
invalid value "..."


	  Lines like this seem to appear roughly for ~each(?) of the 59 *.Rd 
file in my man directory. However, 501 is not evenly divisible by 59, 
which means that the number of lines like this is not the same for every 
*.Rd file.


	  Suggestions?
	  This looks like a problem with "R CMD check --as-cran" and NOT with 
Ecfun. However, I felt a need to ask.


	  Thanks,
	  Spencer Graves


p.s. This package is on GitHub at:


https://github.com/sbgraves237/Ecfun


From |kry|ov @end|ng |rom d|@root@org  Tue Nov 12 09:03:18 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Tue, 12 Nov 2024 11:03:18 +0300
Subject: [R-pkg-devel] 
 Found the following HTML validation problems: in R
 CMD check --as-cran
In-Reply-To: <b39ad7b5-7cba-4a78-bc4b-624d18981bf6@effectivedefense.org>
References: <b39ad7b5-7cba-4a78-bc4b-624d18981bf6@effectivedefense.org>
Message-ID: <20241112110318.20242345@Tarkus>

? Tue, 12 Nov 2024 01:53:08 -0600
Spencer Graves <spencer.graves at effectivedefense.org> ?????:

> 	  In running "R CMD check --as-cran Ecfun_0.3-5.tar.gz" on my
> local macOS 15.0.1 system, 00check.log contains "Found the following
> HTML validation problems:" followed by 501 lines like the following

When you run `tidy --version`, what does it say? If it doesn't say at
least version 5.0.0 (or shows you a build date instead of the version),
this is the wrong version of HTML-Tidy and you can safely discard the
output: https://bugs.r-project.org/show_bug.cgi?id=18731

-- 
Best regards,
Ivan


From @pencer@gr@ve@ @end|ng |rom e||ect|vede|en@e@org  Tue Nov 12 10:04:50 2024
From: @pencer@gr@ve@ @end|ng |rom e||ect|vede|en@e@org (Spencer Graves)
Date: Tue, 12 Nov 2024 03:04:50 -0600
Subject: [R-pkg-devel] 
 Found the following HTML validation problems: in R
 CMD check --as-cran
In-Reply-To: <20241112110318.20242345@Tarkus>
References: <b39ad7b5-7cba-4a78-bc4b-624d18981bf6@effectivedefense.org>
 <20241112110318.20242345@Tarkus>
Message-ID: <53e662dd-f46e-4af1-9a96-33953bc9d4ef@effectivedefense.org>

Hi, Ivan:


	  Thanks very much.


On 11/12/24 02:03, Ivan Krylov wrote:
> ? Tue, 12 Nov 2024 01:53:08 -0600
> Spencer Graves <spencer.graves at effectivedefense.org> ?????:
> 
>> 	  In running "R CMD check --as-cran Ecfun_0.3-5.tar.gz" on my
>> local macOS 15.0.1 system, 00check.log contains "Found the following
>> HTML validation problems:" followed by 501 lines like the following
> 
> When you run `tidy --version`, what does it say? If it doesn't say at
> least version 5.0.0 (or shows you a build date instead of the version),
> this is the wrong version of HTML-Tidy and you can safely discard the
> output: https://bugs.r-project.org/show_bug.cgi?id=18731
> 


...% `tidy --version


HTML Tidy for Mac OS X released on 31 October 2006 - Apple Inc. build 1509


https://stackoverflow.com/questions/13380012/tidy-html5-on-mac-os-how-to-install


	  I did:


brew update


brew upgrade


  brew install tidy-html5


	  AND this problem disappeared.


	  Thanks again,
	  Spencer Graves


From |kry|ov @end|ng |rom d|@root@org  Tue Nov 12 11:56:34 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Tue, 12 Nov 2024 13:56:34 +0300
Subject: [R-pkg-devel] 
 Possible false negative for compiled C++ code in CRAN checks
In-Reply-To: <YT2PPFFFCD700570537573F529D215EC62ADD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
References: <YT2PPFFFCD7005701B25728913116FEEC8BDD5E2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241111124840.55248fa6@Tarkus>
 <YT2PPFFFCD70057CF5F7C2CA2439229E0B6DD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <YT2PPFFFCD700570537573F529D215EC62ADD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
Message-ID: <20241112135634.44ceb4a9@arachnoid>

? Tue, 12 Nov 2024 04:02:17 +0000
Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca> ?????:

> For v2.0.3 I implemented a full refactor, where I simplified the code
> considerably while trying to solve what looks to be a false positive.
> 
> Now I implemented a "patch" based on the suggestion:

I see the change on GitHub [1], made back on October 22nd, but I am not
seeing these checks in your latest submission to CRAN [2] from November
7th. Before you have implemented [1], have you been able to reproduce
the errors that your package received on CRAN, that is, the
container-overflow and the null object pointers?

I've just noticed that FuzzyVariableParser::ParseAllVariables is using
std::thread::hardware_concurrency(). CRAN uses a shared computer with
many cores to test many packages at the same time, so the code most
likely needs to limit itself to two threads during tests and examples
[3].

>    SUMMARY: AddressSanitizer: alloc-dealloc-mismatch
> (/opt/R/devel-asan/lib/R/bin/exec/R+0xc6306) (BuildId:
> 178e357df79b1589a38c1949da5e5f022d4bb535) in free

This is an error you're getting when testing with an R-hub image. R-hub
is not CRAN. You've performed good investigative work to reduce the
issue you're seeing on R-hub for the StackOverflow question [4], but it
looks like this particular problem is already reported to R-hub
developers [5] and it's not what got your latest CRAN submission
archived.

When your latest submission, redatam_2.0.3.tar.gz, was archived, you
should have received an e-mail from CRAN. Was it about the package
failing automatic checks? Were there any other comments? Did the e-mail
highlight any issues in particular?

I do see the problem in [6], but it's hard to diagnose by itself. I was
able to reproduce it (but only after compiling everything with
-shared-san and providing the necessary LD_LIBRARY_PATH, otherwise
packages using C++ failed to load; I also had to manually set
UBSAN_OPTIONS=print_stacktrace=1 to find out where the overflow
originates):

> read_redatam(paste(dout, "cg15.dic", sep = "/"))
Opening dictionary file...
/usr/bin/../lib/gcc/x86_64-linux-gnu/14/../../../../include/c++/14/bits/basic_string.h:1272:9: runtime error: addition of unsigned offset to 0x7f38f12bcc30 overflowed to 0x7f38f12bcc2f
    #0 0x7f38e859a15f in std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char>>::operator[](unsigned long) /usr/bin/../lib/gcc/x86_64-linux-gnu/14/../../../../include/c++/14/bits/basic_string.h:1272:9
    #1 0x7f38e859a15f in std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char>>::back() /usr/bin/../lib/gcc/x86_64-linux-gnu/14/../../../../include/c++/14/bits/basic_string.h:1353:9
    #2 0x7f38e859a15f in RedatamLib::ListExporter::ListExporter(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char>> const&) /root/redatam.Rcheck/00_pkg_src/redatam/src/redatamlib/exporters/RListExporter.cpp:16:21
    #3 0x7f38e85a7d60 in RedatamLib::RedatamDatabase::ExportRLists() const /root/redatam.Rcheck/00_pkg_src/redatam/src/redatamlib/entities/RedatamDatabase.cpp:23:16
    #4 0x7f38e85b2224 in export_redatam_to_list_(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char>>) /root/redatam.Rcheck/00_pkg_src/redatam/src/main.cpp:13:15
    #5 0x7f38e85b3068 in _redatam_export_redatam_to_list_ /root/redatam.Rcheck/00_pkg_src/redatam/src/cpp11.cpp:12:27
    #6 0x55b5da67bf6a in R_doDotCall /root/R/src/main/../../../R-svn/src/main/dotcode.c:754:11

The corresponding lines of the source code are:

ListExporter::ListExporter(const std::string &outputDirectory)
    : m_path(outputDirectory) {
  if ('/' != m_path.back()) { // <-- here
    m_path.append("/");
  }
}

Looks like the code is calling .back() on an empty string. This also
needs to be prevented somehow.

To summarise, I recommend to do the following for the next submission:

 - make sure the fix for the UBSan issues from [7] is included and note
   it in the submission comments
 - avoid using more than two threads during R CMD check
 - fix the empty string issue from [6] and note it in the submission
   comments
 - fix any other issues noted in the CRAN correspondence and note it in
   the submission comments
 - do not mention the alloc-free-mismatch problem in the submission
   comments

Good luck! I hope this helps and there won't be any more issues hiding
in the code.

-- 
Best regards,
Ivan

[1] 
https://github.com/pachadotdev/open-redatam/commit/5399332f26fde8029cc7f78e0f889dfd983504c2

[2]
https://cran.r-project.org/incoming/archive/redatam_2.0.3.tar.gz

[3]
https://contributor.r-project.org/cran-cookbook/code_issues.html#using-more-than-2-cores

[4]
https://stackoverflow.com/q/79171799

[5]
https://github.com/r-hub/rhub/issues/598
There's no actual alloc-free-mismatch, it's a false positive due to the
way libc++ (correctly) uses the delete operator:
https://github.com/llvm/llvm-project/issues/59432

[6]
https://win-builder.r-project.org/incoming_pretest/redatam_2.0.3_20241107_154750/specialChecks/clang-san/summary.txt

[7]
https://www.stats.ox.ac.uk/pub/bdr/memtests/clang-ASAN/redatam/00check.log
https://www.stats.ox.ac.uk/pub/bdr/memtests/gcc-UBSAN/redatam/00check.log


From pep|jn@devr|e@ @end|ng |rom out|ook@com  Tue Nov 12 13:40:24 2024
From: pep|jn@devr|e@ @end|ng |rom out|ook@com (Pepijn de Vries)
Date: Tue, 12 Nov 2024 12:40:24 +0000
Subject: [R-pkg-devel] CRAN build error on Windows
Message-ID: <AS8PR10MB466318BEE8305A6903DBD580A7592@AS8PR10MB4663.EURPRD10.PROD.OUTLOOK.COM>

Hi r-package-devel team,

I'm author of the ProTrackR2 package and have recently submitted a new release to CRAN. It builds without problems on all operating systems, except for Windows:

https://cran.r-project.org/web/checks/check_results_ProTrackR2.html

At first I thought it might be a problem caused by my 'configure.win' script, which would be strange since it remained unchanged since the previously submitted version (which built without problems on Windows). Also, the package builds without problems on Windows machines at r-universe and the rhub checks. This is why I'm beginning to suspect that this is an issue with the CRAN Windows machine. The install.log from CRAN reports:

"Cannot create temporary file in D:\temp\2024_11_12_ 1_50_00_12637\: No such file or directory"

After snooping around I found another (unrelated) package with exactly the same problem:

https://cran.r-project.org/web/checks/check_results_Amelia.html

This package has a completely different setup (no configure script, and it uses Rcpp instead of cpp11).

My question is: how can I figure out if something is wrong with my package setup, or whether this is an issue at CRAN with building for Windows?

Thanks in advance for your help!


From Luc@DeW||de @end|ng |rom UGent@be  Tue Nov 12 15:06:53 2024
From: Luc@DeW||de @end|ng |rom UGent@be (Luc De Wilde)
Date: Tue, 12 Nov 2024 14:06:53 +0000
Subject: [R-pkg-devel] New package with C++ code causes R abort in RStudio,
 not in R console.
Message-ID: <AM0PR09MB3843B5A6489B9D868B68F8C498592@AM0PR09MB3843.eurprd09.prod.outlook.com>

Dear R package developers,

I'm helping with the development of the lavaan package (see https://lavaan.ugent.be/) and currently writing a C++ version of the parser of the model syntax in lavaan. The package with C++ code is in  https://github.com/lucdw/lavaanC.?

When testing with a bunch of models, there is one model that causes an abort of the R session in RStudio (on Windows), but in the R console or in a batch job it causes no errors. The model is the following :?
model <- '?
?   F1 =~ "a b"*X1
? ? F2 =~ a * X1 + 3*X2 # dat is hier een beetje commentaar
? ? # efa block 2
? ? efa("efa2")*f3 +
? ? efa("efa2")*f4 =~ y1 + y2 + y3 + y1:y3
? ? f4 := 3.14159 * F2
? ? F1 ~ start(0.76)*F2 + a*F2
? ? a == (b + f3)^2
? ? b1 > exp(b2 + b3) '

and the translation can be tested - after installing lavaanC - with?

lavaanC::lav_parse_model_string_c(model)

As mentioned, this causes an abort of the R session when executed in RStudio on Windows (10 or 11), but passes without problem in the R console or a batch job. 

Because many users are using RStudio I 'd like to tackle this problem, but don't know how to pinpoint the cause of the problem. I hope some of you have an idea how to handle this problem ...

All the best,


Luc De Wilde


From m@@epu|ved@ @end|ng |rom m@||@utoronto@c@  Tue Nov 12 17:01:34 2024
From: m@@epu|ved@ @end|ng |rom m@||@utoronto@c@ (Mauricio Vargas Sepulveda)
Date: Tue, 12 Nov 2024 16:01:34 +0000
Subject: [R-pkg-devel] 
 Possible false negative for compiled C++ code in CRAN checks
In-Reply-To: <20241112135634.44ceb4a9@arachnoid>
References: <YT2PPFFFCD7005701B25728913116FEEC8BDD5E2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241111124840.55248fa6@Tarkus>
 <YT2PPFFFCD70057CF5F7C2CA2439229E0B6DD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <YT2PPFFFCD700570537573F529D215EC62ADD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241112135634.44ceb4a9@arachnoid>
Message-ID: <YT2PPFFFCD700574402F067CF21834F38FCDD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>

Dear Prof. Dr. Kryov,

Thanks a lot.

Apologies if the email has an odd format, I have a modified Outlook UI that makes everything "curious".

After taking each of the suggestions, now I get this with Clang-ASAN on R-Hub:

> 0 errors | 0 warnings | 2 note
> Package was archived on CRAN
> CRAN repository db overrides: X-CRAN-Comment: Archived on 2024-11-06 for repeated policy violation. Repeatedy spamming a team member's personal email address in HTML.
> checking compilation flags used ... NOTE Compilation used the following non-portable flag(s): ?-Wp,-D_FORTIFY_SOURCE=3?

This is great. Thanks a lot. I would like to add you to AUTHORS.md or as "ctb" to list your contribution. Hopefully it can be re-accepted.

The first note was because I was asking about this same issue when CRAN notified me. Now I make sure to use non-HTML email when sending R-related emails.

So far, this is the only useful communication I received about this. On Stack Overflow I only got "-1".

I added the changes here: https://github.com/pachadotdev/open-redatam/commit/d8955195d4e13fd7794de56d24b4238b7a7ec26f

Best wishes,

??
Mauricio "Pach?" Vargas Sep?lveda
PhD Student, Political Science
University of Toronto


________________________________________
From: Ivan Krylov <ikrylov at disroot.org>
Sent: November 12, 2024 5:56 AM
To: Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca>
Cc: r-package-devel at r-project.org <r-package-devel at r-project.org>
Subject: Re: [R-pkg-devel] Possible false negative for compiled C++ code in CRAN checks

? Tue, 12 Nov 2024 04:02:17 +0000
Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca> ?????:

> For v2.0.3 I implemented a full refactor, where I simplified the code
> considerably while trying to solve what looks to be a false positive.
>
> Now I implemented a "patch" based on the suggestion:

I see the change on GitHub [1], made back on October 22nd, but I am not
seeing these checks in your latest submission to CRAN [2] from November
7th. Before you have implemented [1], have you been able to reproduce
the errors that your package received on CRAN, that is, the
container-overflow and the null object pointers?

I've just noticed that FuzzyVariableParser::ParseAllVariables is using
std::thread::hardware_concurrency(). CRAN uses a shared computer with
many cores to test many packages at the same time, so the code most
likely needs to limit itself to two threads during tests and examples
[3].

>    SUMMARY: AddressSanitizer: alloc-dealloc-mismatch
> (/opt/R/devel-asan/lib/R/bin/exec/R+0xc6306) (BuildId:
> 178e357df79b1589a38c1949da5e5f022d4bb535) in free

This is an error you're getting when testing with an R-hub image. R-hub
is not CRAN. You've performed good investigative work to reduce the
issue you're seeing on R-hub for the StackOverflow question [4], but it
looks like this particular problem is already reported to R-hub
developers [5] and it's not what got your latest CRAN submission
archived.

When your latest submission, redatam_2.0.3.tar.gz, was archived, you
should have received an e-mail from CRAN. Was it about the package
failing automatic checks? Were there any other comments? Did the e-mail
highlight any issues in particular?

I do see the problem in [6], but it's hard to diagnose by itself. I was
able to reproduce it (but only after compiling everything with
-shared-san and providing the necessary LD_LIBRARY_PATH, otherwise
packages using C++ failed to load; I also had to manually set
UBSAN_OPTIONS=print_stacktrace=1 to find out where the overflow
originates):

> read_redatam(paste(dout, "cg15.dic", sep = "/"))
Opening dictionary file...
/usr/bin/../lib/gcc/x86_64-linux-gnu/14/../../../../include/c++/14/bits/basic_string.h:1272:9: runtime error: addition of unsigned offset to 0x7f38f12bcc30 overflowed to 0x7f38f12bcc2f
    #0 0x7f38e859a15f in std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char>>::operator[](unsigned long) /usr/bin/../lib/gcc/x86_64-linux-gnu/14/../../../../include/c++/14/bits/basic_string.h:1272:9
    #1 0x7f38e859a15f in std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char>>::back() /usr/bin/../lib/gcc/x86_64-linux-gnu/14/../../../../include/c++/14/bits/basic_string.h:1353:9
    #2 0x7f38e859a15f in RedatamLib::ListExporter::ListExporter(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char>> const&) /root/redatam.Rcheck/00_pkg_src/redatam/src/redatamlib/exporters/RListExporter.cpp:16:21
    #3 0x7f38e85a7d60 in RedatamLib::RedatamDatabase::ExportRLists() const /root/redatam.Rcheck/00_pkg_src/redatam/src/redatamlib/entities/RedatamDatabase.cpp:23:16
    #4 0x7f38e85b2224 in export_redatam_to_list_(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char>>) /root/redatam.Rcheck/00_pkg_src/redatam/src/main.cpp:13:15
    #5 0x7f38e85b3068 in _redatam_export_redatam_to_list_ /root/redatam.Rcheck/00_pkg_src/redatam/src/cpp11.cpp:12:27
    #6 0x55b5da67bf6a in R_doDotCall /root/R/src/main/../../../R-svn/src/main/dotcode.c:754:11

The corresponding lines of the source code are:

ListExporter::ListExporter(const std::string &outputDirectory)
    : m_path(outputDirectory) {
  if ('/' != m_path.back()) { // <-- here
    m_path.append("/");
  }
}

Looks like the code is calling .back() on an empty string. This also
needs to be prevented somehow.

To summarise, I recommend to do the following for the next submission:

 - make sure the fix for the UBSan issues from [7] is included and note
   it in the submission comments
 - avoid using more than two threads during R CMD check
 - fix the empty string issue from [6] and note it in the submission
   comments
 - fix any other issues noted in the CRAN correspondence and note it in
   the submission comments
 - do not mention the alloc-free-mismatch problem in the submission
   comments

Good luck! I hope this helps and there won't be any more issues hiding
in the code.

--
Best regards,
Ivan

[1]
https://github.com/pachadotdev/open-redatam/commit/5399332f26fde8029cc7f78e0f889dfd983504c2

[2]
https://cran.r-project.org/incoming/archive/redatam_2.0.3.tar.gz

[3]
https://contributor.r-project.org/cran-cookbook/code_issues.html#using-more-than-2-cores

[4]
https://stackoverflow.com/q/79171799

[5]
https://github.com/r-hub/rhub/issues/598
There's no actual alloc-free-mismatch, it's a false positive due to the
way libc++ (correctly) uses the delete operator:
https://github.com/llvm/llvm-project/issues/59432

[6]
https://win-builder.r-project.org/incoming_pretest/redatam_2.0.3_20241107_154750/specialChecks/clang-san/summary.txt

[7]
https://www.stats.ox.ac.uk/pub/bdr/memtests/clang-ASAN/redatam/00check.log
https://www.stats.ox.ac.uk/pub/bdr/memtests/gcc-UBSAN/redatam/00check.log

From edd @end|ng |rom deb|@n@org  Tue Nov 12 17:47:19 2024
From: edd @end|ng |rom deb|@n@org (Dirk Eddelbuettel)
Date: Tue, 12 Nov 2024 10:47:19 -0600
Subject: [R-pkg-devel] CRAN build error on Windows
In-Reply-To: <AS8PR10MB466318BEE8305A6903DBD580A7592@AS8PR10MB4663.EURPRD10.PROD.OUTLOOK.COM>
References: <AS8PR10MB466318BEE8305A6903DBD580A7592@AS8PR10MB4663.EURPRD10.PROD.OUTLOOK.COM>
Message-ID: <26419.34455.556919.593429@rob.eddelbuettel.com>


On 12 November 2024 at 12:40, Pepijn de Vries wrote:
| "Cannot create temporary file in D:\temp\2024_11_12_ 1_50_00_12637\: No such file or directory"

Based on your quote and the log [1] it looks like you have a space in the
directory name. Windows can accommodate these but you must then quote them
prperly. A more defensive mechanism is to not have spaces there in the first
so may call `sub()` on the path replacing ' ' with '_'.
 
Dirk

[1] https://www.r-project.org/nosvn/R.check/r-devel-windows-x86_64/ProTrackR2-00install.html

-- 
dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org


From edd @end|ng |rom deb|@n@org  Tue Nov 12 17:47:28 2024
From: edd @end|ng |rom deb|@n@org (Dirk Eddelbuettel)
Date: Tue, 12 Nov 2024 10:47:28 -0600
Subject: [R-pkg-devel] CRAN build error on Windows
In-Reply-To: <AS8PR10MB466318BEE8305A6903DBD580A7592@AS8PR10MB4663.EURPRD10.PROD.OUTLOOK.COM>
References: <AS8PR10MB466318BEE8305A6903DBD580A7592@AS8PR10MB4663.EURPRD10.PROD.OUTLOOK.COM>
Message-ID: <26419.34464.99541.550806@rob.eddelbuettel.com>


On 12 November 2024 at 12:40, Pepijn de Vries wrote:
| "Cannot create temporary file in D:\temp\2024_11_12_ 1_50_00_12637\: No such file or directory"

Based on your quote and the log [1] it looks like you have a space in the
directory name. Windows can accommodate these but you must then quote them
prperly. A more defensive mechanism is to not have spaces there in the first
so may call `sub()` on the path replacing ' ' with '_'.
 
Dirk

[1] https://www.r-project.org/nosvn/R.check/r-devel-windows-x86_64/ProTrackR2-00install.html

-- 
dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org


From vo|ody@ @end|ng |rom m|nd@pr|ng@com  Tue Nov 12 18:15:03 2024
From: vo|ody@ @end|ng |rom m|nd@pr|ng@com (Vladimir Dergachev)
Date: Tue, 12 Nov 2024 12:15:03 -0500 (EST)
Subject: [R-pkg-devel] 
 New package with C++ code causes R abort in RStudio,
 not in R console.
In-Reply-To: <AM0PR09MB3843B5A6489B9D868B68F8C498592@AM0PR09MB3843.eurprd09.prod.outlook.com>
References: <AM0PR09MB3843B5A6489B9D868B68F8C498592@AM0PR09MB3843.eurprd09.prod.outlook.com>
Message-ID: <alpine.DEB.2.22.394.2411121206480.3374@iridium>


Hi Luc,

   The standard tools for writing parsers are "flex" and "bison" - they 
generate code automatically and so can save you a lot of effort. For 
language with simple syntax you can get away with just using "flex".

   Here are some examples:

Flex:

https://westes.github.io/flex/manual/Simple-Examples.html#Simple-Examples

Bison:

https://www.gnu.org/software/bison/manual/bison.html#Infix-Calc

best

Vladimir Dergachev

On Tue, 12 Nov 2024, Luc De Wilde wrote:

> Dear R package developers,
>
> I'm helping with the development of the lavaan package (see https://lavaan.ugent.be/) and currently writing a C++ version of the parser of the model syntax in lavaan. The package with C++ code is in  https://github.com/lucdw/lavaanC.?
>
> When testing with a bunch of models, there is one model that causes an abort of the R session in RStudio (on Windows), but in the R console or in a batch job it causes no errors. The model is the following :?
> model <- '?
> ?   F1 =~ "a b"*X1
> ? ? F2 =~ a * X1 + 3*X2 # dat is hier een beetje commentaar
> ? ? # efa block 2
> ? ? efa("efa2")*f3 +
> ? ? efa("efa2")*f4 =~ y1 + y2 + y3 + y1:y3
> ? ? f4 := 3.14159 * F2
> ? ? F1 ~ start(0.76)*F2 + a*F2
> ? ? a == (b + f3)^2
> ? ? b1 > exp(b2 + b3) '
>
> and the translation can be tested - after installing lavaanC - with?
>
> lavaanC::lav_parse_model_string_c(model)
>
> As mentioned, this causes an abort of the R session when executed in RStudio on Windows (10 or 11), but passes without problem in the R console or a batch job.
>
> Because many users are using RStudio I 'd like to tackle this problem, but don't know how to pinpoint the cause of the problem. I hope some of you have an idea how to handle this problem ...
>
> All the best,
>
>
> Luc De Wilde
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>

From m@@epu|ved@ @end|ng |rom m@||@utoronto@c@  Tue Nov 12 18:37:40 2024
From: m@@epu|ved@ @end|ng |rom m@||@utoronto@c@ (Mauricio Vargas Sepulveda)
Date: Tue, 12 Nov 2024 17:37:40 +0000
Subject: [R-pkg-devel] 
 Possible false negative for compiled C++ code in CRAN checks
In-Reply-To: <YT2PPFFFCD700574402F067CF21834F38FCDD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
References: <YT2PPFFFCD7005701B25728913116FEEC8BDD5E2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241111124840.55248fa6@Tarkus>
 <YT2PPFFFCD70057CF5F7C2CA2439229E0B6DD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <YT2PPFFFCD700570537573F529D215EC62ADD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241112135634.44ceb4a9@arachnoid>
 <YT2PPFFFCD700574402F067CF21834F38FCDD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
Message-ID: <QB1PPF4A6194682D335931D60BE683F6DB3DD592@QB1PPF4A6194682.CANPRD01.PROD.OUTLOOK.COM>

Dear R Developers,

I hope you are doing well.

I re-sent my package and I still see:

  1.
https://win-builder.r-project.org/incoming_pretest/redatam_2.0.3_20241112_165458/specialChecks/clang-san/outputs.txt
  2.
https://win-builder.r-project.org/incoming_pretest/redatam_2.0.3_20241112_165458/specialChecks/gcc-san/outputs.txt

As it was discussed in:

1. "Possible false negative for compiled C++ code in CRAN checks" (this R developers mailing list)
2. "AddressSanitizer Error (alloc-dealloc-mismatch, operator new vs free) in R Package with C++ Code Using libc++ and CLANG-ASAN/UBSAN" (Stackoverflow, https://stackoverflow.com/questions/79171799/addresssanitizer-error-alloc-dealloc-mismatch-operator-new-vs-free-in-r-packa?noredirect=1#comment139621299_79171799)
3. "clang-asan: use clang 19 as CRAN does" (GitHub, https://github.com/r-hub/containers/pull/79#issuecomment-2470390769)

The package was tested with Clang 19 on Fedora 36 and Ubuntu 22, and as S.O. reads "it is likely a false positive in the container used by R-Hub as discussed in this [#598] issue at its repo but not a false positive but an actual error as shown in the setup at CRAN (different container)."

The R-Hub container was fixed with a pull request I sent, and now it passes the checks. The CRAN errors were addressed as mentioned in the mailing list.

I am also using "-Wall -O0 -pedantic" and "-UDEBUG -g" to check locally, and I am also using all the available R-Hub images (27 different configurations, as in https://github.com/pachadotdev/open-redatam/actions/runs/11801021816)

I would really appreciate some guidance here before re-submitting.

Best wishes,


????

Mauricio "Pach??" Vargas Sep??lveda

PhD Student, Political Science
University of Toronto



________________________________
From: Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca>
Sent: November 12, 2024 11:01 AM
To: Ivan Krylov <ikrylov at disroot.org>
Cc: r-package-devel at r-project.org <r-package-devel at r-project.org>
Subject: Re: [R-pkg-devel] Possible false negative for compiled C++ code in CRAN checks

Dear Prof. Dr. Kryov,

Thanks a lot.

Apologies if the email has an odd format, I have a modified Outlook UI that makes everything "curious".

After taking each of the suggestions, now I get this with Clang-ASAN on R-Hub:

> 0 errors | 0 warnings | 2 note
> Package was archived on CRAN
> CRAN repository db overrides: X-CRAN-Comment: Archived on 2024-11-06 for repeated policy violation. Repeatedy spamming a team member's personal email address in HTML.
> checking compilation flags used ... NOTE Compilation used the following non-portable flag(s): ??-Wp,-D_FORTIFY_SOURCE=3??

This is great. Thanks a lot. I would like to add you to AUTHORS.md or as "ctb" to list your contribution. Hopefully it can be re-accepted.

The first note was because I was asking about this same issue when CRAN notified me. Now I make sure to use non-HTML email when sending R-related emails.

So far, this is the only useful communication I received about this. On Stack Overflow I only got "-1".

I added the changes here: https://github.com/pachadotdev/open-redatam/commit/d8955195d4e13fd7794de56d24b4238b7a7ec26f

Best wishes,

????
Mauricio "Pach??" Vargas Sep??lveda
PhD Student, Political Science
University of Toronto


________________________________________
From: Ivan Krylov <ikrylov at disroot.org>
Sent: November 12, 2024 5:56 AM
To: Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca>
Cc: r-package-devel at r-project.org <r-package-devel at r-project.org>
Subject: Re: [R-pkg-devel] Possible false negative for compiled C++ code in CRAN checks

?? Tue, 12 Nov 2024 04:02:17 +0000
Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca> ??????:

> For v2.0.3 I implemented a full refactor, where I simplified the code
> considerably while trying to solve what looks to be a false positive.
>
> Now I implemented a "patch" based on the suggestion:

I see the change on GitHub [1], made back on October 22nd, but I am not
seeing these checks in your latest submission to CRAN [2] from November
7th. Before you have implemented [1], have you been able to reproduce
the errors that your package received on CRAN, that is, the
container-overflow and the null object pointers?

I've just noticed that FuzzyVariableParser::ParseAllVariables is using
std::thread::hardware_concurrency(). CRAN uses a shared computer with
many cores to test many packages at the same time, so the code most
likely needs to limit itself to two threads during tests and examples
[3].

>    SUMMARY: AddressSanitizer: alloc-dealloc-mismatch
> (/opt/R/devel-asan/lib/R/bin/exec/R+0xc6306) (BuildId:
> 178e357df79b1589a38c1949da5e5f022d4bb535) in free

This is an error you're getting when testing with an R-hub image. R-hub
is not CRAN. You've performed good investigative work to reduce the
issue you're seeing on R-hub for the StackOverflow question [4], but it
looks like this particular problem is already reported to R-hub
developers [5] and it's not what got your latest CRAN submission
archived.

When your latest submission, redatam_2.0.3.tar.gz, was archived, you
should have received an e-mail from CRAN. Was it about the package
failing automatic checks? Were there any other comments? Did the e-mail
highlight any issues in particular?

I do see the problem in [6], but it's hard to diagnose by itself. I was
able to reproduce it (but only after compiling everything with
-shared-san and providing the necessary LD_LIBRARY_PATH, otherwise
packages using C++ failed to load; I also had to manually set
UBSAN_OPTIONS=print_stacktrace=1 to find out where the overflow
originates):

> read_redatam(paste(dout, "cg15.dic", sep = "/"))
Opening dictionary file...
/usr/bin/../lib/gcc/x86_64-linux-gnu/14/../../../../include/c++/14/bits/basic_string.h:1272:9: runtime error: addition of unsigned offset to 0x7f38f12bcc30 overflowed to 0x7f38f12bcc2f
    #0 0x7f38e859a15f in std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char>>::operator[](unsigned long) /usr/bin/../lib/gcc/x86_64-linux-gnu/14/../../../../include/c++/14/bits/basic_string.h:1272:9
    #1 0x7f38e859a15f in std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char>>::back() /usr/bin/../lib/gcc/x86_64-linux-gnu/14/../../../../include/c++/14/bits/basic_string.h:1353:9
    #2 0x7f38e859a15f in RedatamLib::ListExporter::ListExporter(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char>> const&) /root/redatam.Rcheck/00_pkg_src/redatam/src/redatamlib/exporters/RListExporter.cpp:16:21
    #3 0x7f38e85a7d60 in RedatamLib::RedatamDatabase::ExportRLists() const /root/redatam.Rcheck/00_pkg_src/redatam/src/redatamlib/entities/RedatamDatabase.cpp:23:16
    #4 0x7f38e85b2224 in export_redatam_to_list_(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char>>) /root/redatam.Rcheck/00_pkg_src/redatam/src/main.cpp:13:15
    #5 0x7f38e85b3068 in _redatam_export_redatam_to_list_ /root/redatam.Rcheck/00_pkg_src/redatam/src/cpp11.cpp:12:27
    #6 0x55b5da67bf6a in R_doDotCall /root/R/src/main/../../../R-svn/src/main/dotcode.c:754:11

The corresponding lines of the source code are:

ListExporter::ListExporter(const std::string &outputDirectory)
    : m_path(outputDirectory) {
  if ('/' != m_path.back()) { // <-- here
    m_path.append("/");
  }
}

Looks like the code is calling .back() on an empty string. This also
needs to be prevented somehow.

To summarise, I recommend to do the following for the next submission:

 - make sure the fix for the UBSan issues from [7] is included and note
   it in the submission comments
 - avoid using more than two threads during R CMD check
 - fix the empty string issue from [6] and note it in the submission
   comments
 - fix any other issues noted in the CRAN correspondence and note it in
   the submission comments
 - do not mention the alloc-free-mismatch problem in the submission
   comments

Good luck! I hope this helps and there won't be any more issues hiding
in the code.

--
Best regards,
Ivan

[1]
https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2Fpachadotdev%2Fopen-redatam%2Fcommit%2F5399332f26fde8029cc7f78e0f889dfd983504c2&data=05%7C02%7Cm.sepulveda%40mail.utoronto.ca%7C1e1a8fc469b049d82c1508dd0308b0d1%7C78aac2262f034b4d9037b46d56c55210%7C0%7C0%7C638670058049707683%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=Y9GdK8O0MMGX%2FBjLqpU7da7VMGJXfeYv3C7v4PHvN%2FI%3D&reserved=0<https://github.com/pachadotdev/open-redatam/commit/5399332f26fde8029cc7f78e0f889dfd983504c2>

[2]
https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fcran.r-project.org%2Fincoming%2Farchive%2Fredatam_2.0.3.tar.gz&data=05%7C02%7Cm.sepulveda%40mail.utoronto.ca%7C1e1a8fc469b049d82c1508dd0308b0d1%7C78aac2262f034b4d9037b46d56c55210%7C0%7C0%7C638670058049727294%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=kBArgyzK12m3U%2F3f2U%2BIDweyYyznZQEFhjXZ9by4WRA%3D&reserved=0<https://cran.r-project.org/incoming/archive/redatam_2.0.3.tar.gz>

[3]
https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fcontributor.r-project.org%2Fcran-cookbook%2Fcode_issues.html%23using-more-than-2-cores&data=05%7C02%7Cm.sepulveda%40mail.utoronto.ca%7C1e1a8fc469b049d82c1508dd0308b0d1%7C78aac2262f034b4d9037b46d56c55210%7C0%7C0%7C638670058049737222%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=grg1UU%2FKj6BhySwAV9aLn%2BqzN78l8BuQTDy71%2BOCGmY%3D&reserved=0<https://contributor.r-project.org/cran-cookbook/code_issues.html#using-more-than-2-cores>

[4]
https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fstackoverflow.com%2Fq%2F79171799&data=05%7C02%7Cm.sepulveda%40mail.utoronto.ca%7C1e1a8fc469b049d82c1508dd0308b0d1%7C78aac2262f034b4d9037b46d56c55210%7C0%7C0%7C638670058049747065%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=wC3%2BnFVKhJuppgiJlX6OMZyKRcZnCRIz%2BftqrRPBztc%3D&reserved=0<https://stackoverflow.com/q/79171799>

[5]
https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2Fr-hub%2Frhub%2Fissues%2F598&data=05%7C02%7Cm.sepulveda%40mail.utoronto.ca%7C1e1a8fc469b049d82c1508dd0308b0d1%7C78aac2262f034b4d9037b46d56c55210%7C0%7C0%7C638670058049756791%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=%2FVDNBLbGM9%2ByHGlpgXRBuWWhviPq%2FHdGxCYyXCs6ys0%3D&reserved=0<https://github.com/r-hub/rhub/issues/598>
There's no actual alloc-free-mismatch, it's a false positive due to the
way libc++ (correctly) uses the delete operator:
https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2Fllvm%2Fllvm-project%2Fissues%2F59432&data=05%7C02%7Cm.sepulveda%40mail.utoronto.ca%7C1e1a8fc469b049d82c1508dd0308b0d1%7C78aac2262f034b4d9037b46d56c55210%7C0%7C0%7C638670058049766535%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=8RXeYSqX09BjLczvg5qO%2FP7joiYeDahKMCB83e4x8YQ%3D&reserved=0<https://github.com/llvm/llvm-project/issues/59432>

[6]
https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fwin-builder.r-project.org%2Fincoming_pretest%2Fredatam_2.0.3_20241107_154750%2FspecialChecks%2Fclang-san%2Fsummary.txt&data=05%7C02%7Cm.sepulveda%40mail.utoronto.ca%7C1e1a8fc469b049d82c1508dd0308b0d1%7C78aac2262f034b4d9037b46d56c55210%7C0%7C0%7C638670058049776187%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=U%2FPeu7qjoLu%2BGjN3sx%2FZ43%2BS5waMgMfV26FI9R40%2BvM%3D&reserved=0<https://win-builder.r-project.org/incoming_pretest/redatam_2.0.3_20241107_154750/specialChecks/clang-san/summary.txt>

[7]
https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fwww.stats.ox.ac.uk%2Fpub%2Fbdr%2Fmemtests%2Fclang-ASAN%2Fredatam%2F00check.log&data=05%7C02%7Cm.sepulveda%40mail.utoronto.ca%7C1e1a8fc469b049d82c1508dd0308b0d1%7C78aac2262f034b4d9037b46d56c55210%7C0%7C0%7C638670058049785895%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=HGE%2BuM83P0TBqCHrBEiX2twRbdKe3vHPbez8%2B5tI9CY%3D&reserved=0<https://www.stats.ox.ac.uk/pub/bdr/memtests/clang-ASAN/redatam/00check.log>
https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fwww.stats.ox.ac.uk%2Fpub%2Fbdr%2Fmemtests%2Fgcc-UBSAN%2Fredatam%2F00check.log&data=05%7C02%7Cm.sepulveda%40mail.utoronto.ca%7C1e1a8fc469b049d82c1508dd0308b0d1%7C78aac2262f034b4d9037b46d56c55210%7C0%7C0%7C638670058049795583%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=OaIvDVSUXmxIHEwMBpLOlgNkpgsNjXlBwJsYWXcBaho%3D&reserved=0<https://www.stats.ox.ac.uk/pub/bdr/memtests/gcc-UBSAN/redatam/00check.log>

	[[alternative HTML version deleted]]


From Luc@DeW||de @end|ng |rom UGent@be  Tue Nov 12 18:49:14 2024
From: Luc@DeW||de @end|ng |rom UGent@be (Luc De Wilde)
Date: Tue, 12 Nov 2024 17:49:14 +0000
Subject: [R-pkg-devel] 
 New package with C++ code causes R abort in RStudio,
 not in R console.
In-Reply-To: <alpine.DEB.2.22.394.2411121206480.3374@iridium>
References: <AM0PR09MB3843B5A6489B9D868B68F8C498592@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <alpine.DEB.2.22.394.2411121206480.3374@iridium>
Message-ID: <AM0PR09MB384359A64AB3DBE1812B9E8B98592@AM0PR09MB3843.eurprd09.prod.outlook.com>

Dear Vladimir,

thank you for your reply.

The model syntax is not simple though and the parser needs to look at the meaning in SEM terms to accept or reject certain things.

Moreover, this is only a first step and later other calculations need to be done in C++, which is why I find it important to know exactly why the code works in R console but not in RStudio, and of course what can be done to make it work in RStudio also.

Kind regards,


Luc De Wilde

________________________________________
Van: Vladimir Dergachev <volodya at mindspring.com>
Verzonden: dinsdag 12 november 2024 18:15
Aan: Luc De Wilde <Luc.DeWilde at UGent.be>
CC: r-package-devel at r-project.org <r-package-devel at r-project.org>; Yves Rosseel <Yves.Rosseel at UGent.be>
Onderwerp: Re: [R-pkg-devel] New package with C++ code causes R abort in RStudio, not in R console.


Hi Luc,

   The standard tools for writing parsers are "flex" and "bison" - they
generate code automatically and so can save you a lot of effort. For
language with simple syntax you can get away with just using "flex".

   Here are some examples:

Flex:

https://westes.github.io/flex/manual/Simple-Examples.html#Simple-Examples

Bison:

https://www.gnu.org/software/bison/manual/bison.html#Infix-Calc

best

Vladimir Dergachev

On Tue, 12 Nov 2024, Luc De Wilde wrote:

> Dear R package developers,
>
> I'm helping with the development of the lavaan package (see https://lavaan.ugent.be/) and currently writing a C++ version of the parser of the model syntax in lavaan. The package with C++ code is in  https://github.com/lucdw/lavaanC.
>
> When testing with a bunch of models, there is one model that causes an abort of the R session in RStudio (on Windows), but in the R console or in a batch job it causes no errors. The model is the following :
> model <- '
>     F1 =~ "a b"*X1
>     F2 =~ a * X1 + 3*X2 # dat is hier een beetje commentaar
>     # efa block 2
>     efa("efa2")*f3 +
>     efa("efa2")*f4 =~ y1 + y2 + y3 + y1:y3
>     f4 := 3.14159 * F2
>     F1 ~ start(0.76)*F2 + a*F2
>     a == (b + f3)^2
>     b1 > exp(b2 + b3) '
>
> and the translation can be tested - after installing lavaanC - with
>
> lavaanC::lav_parse_model_string_c(model)
>
> As mentioned, this causes an abort of the R session when executed in RStudio on Windows (10 or 11), but passes without problem in the R console or a batch job.
>
> Because many users are using RStudio I 'd like to tackle this problem, but don't know how to pinpoint the cause of the problem. I hope some of you have an idea how to handle this problem ...
>
> All the best,
>
>
> Luc De Wilde
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>


From |kry|ov @end|ng |rom d|@root@org  Tue Nov 12 19:44:03 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Tue, 12 Nov 2024 21:44:03 +0300
Subject: [R-pkg-devel] 
 New package with C++ code causes R abort in RStudio,
 not in R console.
In-Reply-To: <AM0PR09MB3843B5A6489B9D868B68F8C498592@AM0PR09MB3843.eurprd09.prod.outlook.com>
References: <AM0PR09MB3843B5A6489B9D868B68F8C498592@AM0PR09MB3843.eurprd09.prod.outlook.com>
Message-ID: <20241112214403.1ab126b0@Tarkus>

? Tue, 12 Nov 2024 14:06:53 +0000
Luc De Wilde <Luc.DeWilde at UGent.be> ?????:

> The package with C++ code is in  https://github.com/lucdw/lavaanC.?
> 
> When testing with a bunch of models, there is one model that causes
> an abort of the R session in RStudio (on Windows), but in the R
> console or in a batch job it causes no errors.

This is a low-confidence guess, but there's a stray src/lavaanC.dll in
the repository. If you install the package straight from the source
directory, you may pick up the *.dll without recompiling it, which may
be incompatible with the version of R running inside RStudio.

If this does reproduce on a clean installation, the most informative
way forward would be to attach a debugger to the RStudio's R process
before it crashes.

-- 
Best regards,
Ivan


From edd @end|ng |rom deb|@n@org  Tue Nov 12 20:25:11 2024
From: edd @end|ng |rom deb|@n@org (Dirk Eddelbuettel)
Date: Tue, 12 Nov 2024 13:25:11 -0600
Subject: [R-pkg-devel] CRAN build error on Windows
In-Reply-To: <26419.34464.99541.550806@rob.eddelbuettel.com>
References: <AS8PR10MB466318BEE8305A6903DBD580A7592@AS8PR10MB4663.EURPRD10.PROD.OUTLOOK.COM>
 <26419.34464.99541.550806@rob.eddelbuettel.com>
Message-ID: <26419.43927.403453.796237@rob.eddelbuettel.com>


On 12 November 2024 at 10:47, Dirk Eddelbuettel wrote:
| 
| On 12 November 2024 at 12:40, Pepijn de Vries wrote:
| | "Cannot create temporary file in D:\temp\2024_11_12_ 1_50_00_12637\: No such file or directory"
| 
| Based on your quote and the log [1] it looks like you have a space in the
| directory name. Windows can accommodate these but you must then quote them
| prperly. A more defensive mechanism is to not have spaces there in the first
| so may call `sub()` on the path replacing ' ' with '_'.

Just saw the same error in a package on mine, updated yesterday. [1]

That makes it more likely that this is a (hopefully transient) issue on the
Windows builder.  Uwe reads this list and may chime in.

Dirk

[1] https://www.r-project.org/nosvn/R.check/r-devel-windows-x86_64/RcppSpdlog-00install.html

-- 
dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org


From |kry|ov @end|ng |rom d|@root@org  Tue Nov 12 21:37:10 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Tue, 12 Nov 2024 23:37:10 +0300
Subject: [R-pkg-devel] 
 Possible false negative for compiled C++ code in CRAN checks
In-Reply-To: <QB1PPF4A6194682D335931D60BE683F6DB3DD592@QB1PPF4A6194682.CANPRD01.PROD.OUTLOOK.COM>
References: <YT2PPFFFCD7005701B25728913116FEEC8BDD5E2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241111124840.55248fa6@Tarkus>
 <YT2PPFFFCD70057CF5F7C2CA2439229E0B6DD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <YT2PPFFFCD700570537573F529D215EC62ADD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241112135634.44ceb4a9@arachnoid>
 <YT2PPFFFCD700574402F067CF21834F38FCDD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <QB1PPF4A6194682D335931D60BE683F6DB3DD592@QB1PPF4A6194682.CANPRD01.PROD.OUTLOOK.COM>
Message-ID: <20241112233710.3b18c120@Tarkus>

? Tue, 12 Nov 2024 17:37:40 +0000
Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca> ?????:

> I re-sent my package and I still see:
> 
>   1.
> https://win-builder.r-project.org/incoming_pretest/redatam_2.0.3_20241112_165458/specialChecks/clang-san/outputs.txt

I understand this doesn't feel like progress, but this time clang-san
is giving your package a clean bill of health. There are no issues to
fix here.

>   2.
> https://win-builder.r-project.org/incoming_pretest/redatam_2.0.3_20241112_165458/specialChecks/gcc-san/outputs.txt

This one, unfortunately, does demonstrate a new error in the package.
The problem with software testing is that it can only demonstrate the
presence of bugs, not their absence. The new error is different from
all the errors we've seen previously. The code at
redatamlib/readers/FuzzyVariableParser.cpp:33:38 performs an integer
division by zero, which crashes the process:

  size_t chunkSize = entities.size() / numThreads;

It's not in the outputs.txt, but in the summary.txt:
https://win-builder.r-project.org/incoming_pretest/redatam_2.0.3_20241112_165458/specialChecks/gcc-san/summary.txt

https://en.cppreference.com/w/cpp/thread/thread/hardware_concurrency
says that std::thread::hardware_concurrency() could plausibly return 0.
Or is this due to empty entities vector?

> I am also using "-Wall -O0 -pedantic" and "-UDEBUG -g" to check
> locally, and I am also using all the available R-Hub images (27
> different configurations, as in
> https://github.com/pachadotdev/open-redatam/actions/runs/11801021816)

Unfortunately, none of these use gcc with UBSanitizer enabled. I think
that the rocker/r-devel-san container [*] image comes closest to the
configuration that fails your package during the CRAN checks. By
running the following commands, I can reproduce the crash:

podman run -it docker.io/rocker/r-devel-san Rdevel
f <- 'https://cran.r-project.org/incoming/archive/redatam_2.0.3.tar.gz'
download.file(f, basename(f))
install.packages(c('data.table','janitor', 'stringi', 'knitr',
'rmarkdown','testthat'))
tools::Rcmd('check redatam_2.0.3.tar.gz')

By installing gdb inside the container, running Rdevel -d gdb and
setting a breakpoint on __ubsan_on_report, I can catch the moment
before the crash:

(gdb) frame 5
#5  0x00007f95bf293a16 in
RedatamLib::FuzzyVariableParser::ParseAllVariables
(this=this at entry=0x7fff80974bd0, entities=std::vector of length 0,
capacity 0) at redatamlib/readers/FuzzyVariableParser.cpp:33
33       size_t chunkSize = entities.size() / numThreads;
(gdb) p entities.size()
$1 = 0
(gdb) p numThreads
$2 = 0
(gdb) p maxThreads 
$3 = 4

The entities vector is empty, and the 0/0 integer division invokes
undefined behaviour.

Would you find it acceptable to also test your package using the
docker.io/rocker/r-devel-san container before the next submission?

-- 
Best regards,
Ivan

[*] https://rocker-project.org/images/base/r-devel.html


From Luc@DeW||de @end|ng |rom UGent@be  Tue Nov 12 22:09:54 2024
From: Luc@DeW||de @end|ng |rom UGent@be (Luc De Wilde)
Date: Tue, 12 Nov 2024 21:09:54 +0000
Subject: [R-pkg-devel] 
 New package with C++ code causes R abort in RStudio,
 not in R console.
In-Reply-To: <20241112214403.1ab126b0@Tarkus>
References: <AM0PR09MB3843B5A6489B9D868B68F8C498592@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <20241112214403.1ab126b0@Tarkus>
Message-ID: <AM0PR09MB384306BE44733AECE667B8CE98592@AM0PR09MB3843.eurprd09.prod.outlook.com>

Dear Ivan,

Thank you for your reply!
The error occurs on my local machine(s), where the dll is always reproduced by the "install package".
I have attached a debugger (from Visual Studio) to the R process, which gives me the message "A breakpoint instruction (__debugbreak() statement or similar call) was executed in rsession-utf8.exe.

When I go to the dll module in the Call Stack I get the message "Binary was not built with debug information". I do not know how to ask R CMD INSTALL to produce info which can be used by a debugger, perhaps you can direct me to the correct information to do so (in Windows)?

Luc

________________________________
Van: Ivan Krylov <ikrylov at disroot.org>
Verzonden: dinsdag 12 november 2024 19:44
Aan: Luc De Wilde <Luc.DeWilde at UGent.be>
CC: r-package-devel at r-project.org <r-package-devel at r-project.org>; Yves Rosseel <Yves.Rosseel at UGent.be>
Onderwerp: Re: [R-pkg-devel] New package with C++ code causes R abort in RStudio, not in R console.

? Tue, 12 Nov 2024 14:06:53 +0000
Luc De Wilde <Luc.DeWilde at UGent.be> ?????:

> The package with C++ code is in  https://eur03.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2Flucdw%2FlavaanC&data=05%7C02%7CLuc.DeWilde%40UGent.be%7C4b0d32b0971e4072fad808dd0349ffd7%7Cd7811cdeecef496c8f91a1786241b99c%7C1%7C0%7C638670338539751490%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C40000%7C%7C%7C&sdata=2IppWyDOPRyhVGDhlARjPGN9XgZcLfRe1ANp%2FSYHHZI%3D&reserved=0<https://github.com/lucdw/lavaanC>.
>
> When testing with a bunch of models, there is one model that causes
> an abort of the R session in RStudio (on Windows), but in the R
> console or in a batch job it causes no errors.

This is a low-confidence guess, but there's a stray src/lavaanC.dll in
the repository. If you install the package straight from the source
directory, you may pick up the *.dll without recompiling it, which may
be incompatible with the version of R running inside RStudio.

If this does reproduce on a clean installation, the most informative
way forward would be to attach a debugger to the RStudio's R process
before it crashes.

--
Best regards,
Ivan

	[[alternative HTML version deleted]]


From |kry|ov @end|ng |rom d|@root@org  Tue Nov 12 22:33:09 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Wed, 13 Nov 2024 00:33:09 +0300
Subject: [R-pkg-devel] 
 New package with C++ code causes R abort in RStudio,
 not in R console.
In-Reply-To: <AM0PR09MB384306BE44733AECE667B8CE98592@AM0PR09MB3843.eurprd09.prod.outlook.com>
References: <AM0PR09MB3843B5A6489B9D868B68F8C498592@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <20241112214403.1ab126b0@Tarkus>
 <AM0PR09MB384306BE44733AECE667B8CE98592@AM0PR09MB3843.eurprd09.prod.outlook.com>
Message-ID: <20241113003309.337d826a@Tarkus>

? Tue, 12 Nov 2024 21:09:54 +0000
Luc De Wilde <Luc.DeWilde at UGent.be> ?????:

> I have attached a debugger (from Visual Studio) to the R process,
> which gives me the message "A breakpoint instruction (__debugbreak()
> statement or similar call) was executed in rsession-utf8.exe.
> 
> When I go to the dll module in the Call Stack I get the message
> "Binary was not built with debug information".

So the crash does happen inside lavaanC.dll, did I get this right?

If you set the environment variable DEBUG to a non-empty string before
compiling the package, the resulting *.dll will have debug information
in the DWARF format (this is set in file.path(R.home('etc'), 'x64',
'Makeconf')). Visual Studio might not work with it, so you could
install gdb into Rtools using pacman, or you could try to give the
executable to Dr. Mingw <https://github.com/jrfonseca/drmingw>.

-- 
Best regards,
Ivan


From vo|ody@ @end|ng |rom m|nd@pr|ng@com  Tue Nov 12 23:50:39 2024
From: vo|ody@ @end|ng |rom m|nd@pr|ng@com (Vladimir Dergachev)
Date: Tue, 12 Nov 2024 17:50:39 -0500 (EST)
Subject: [R-pkg-devel] 
 New package with C++ code causes R abort in RStudio,
 not in R console.
In-Reply-To: <AM0PR09MB384359A64AB3DBE1812B9E8B98592@AM0PR09MB3843.eurprd09.prod.outlook.com>
References: <AM0PR09MB3843B5A6489B9D868B68F8C498592@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <alpine.DEB.2.22.394.2411121206480.3374@iridium>
 <AM0PR09MB384359A64AB3DBE1812B9E8B98592@AM0PR09MB3843.eurprd09.prod.outlook.com>
Message-ID: <alpine.DEB.2.22.394.2411121746070.3374@iridium>


Hi Luc,

On Tue, 12 Nov 2024, Luc De Wilde wrote:

> Dear Vladimir,
>
> thank you for your reply.
>
> The model syntax is not simple though and the parser needs to look at the meaning in SEM terms to accept or reject certain things.

What do you mean by "SEM terms" ? I have not seen a situation yet that a 
grammar could not be handled by bison, it does have mechanism to deal with 
exceptions to pure LR syntax.

>
> Moreover, this is only a first step and later other calculations need to 
> be done in C++, which is why I find it important to know exactly why the 
> code works in R console but not in RStudio, and of course what can be 
> done to make it work in RStudio also.

My thought was that perhaps some sort of memory issues occurs because of 
the hand-written parser.

For example, one possibility is that stack sizes in R and Rstudio could be 
different. So if you are parsing something recursively it might work in 
one and not another.

The parsers generated by flex and bison are designed to handle arbitrary 
length inputs.

best

Vladimir Dergachev

>
> Kind regards,
>
>
> Luc De Wilde
>
> ________________________________________
> Van: Vladimir Dergachev <volodya at mindspring.com>
> Verzonden: dinsdag 12 november 2024 18:15
> Aan: Luc De Wilde <Luc.DeWilde at UGent.be>
> CC: r-package-devel at r-project.org <r-package-devel at r-project.org>; Yves Rosseel <Yves.Rosseel at UGent.be>
> Onderwerp: Re: [R-pkg-devel] New package with C++ code causes R abort in RStudio, not in R console.
>
>
> Hi Luc,
>
>   The standard tools for writing parsers are "flex" and "bison" - they
> generate code automatically and so can save you a lot of effort. For
> language with simple syntax you can get away with just using "flex".
>
>   Here are some examples:
>
> Flex:
>
> https://westes.github.io/flex/manual/Simple-Examples.html#Simple-Examples
>
> Bison:
>
> https://www.gnu.org/software/bison/manual/bison.html#Infix-Calc
>
> best
>
> Vladimir Dergachev
>
> On Tue, 12 Nov 2024, Luc De Wilde wrote:
>
>> Dear R package developers,
>>
>> I'm helping with the development of the lavaan package (see https://lavaan.ugent.be/) and currently writing a C++ version of the parser of the model syntax in lavaan. The package with C++ code is in  https://github.com/lucdw/lavaanC.
>>
>> When testing with a bunch of models, there is one model that causes an abort of the R session in RStudio (on Windows), but in the R console or in a batch job it causes no errors. The model is the following :
>> model <- '
>>     F1 =~ "a b"*X1
>>     F2 =~ a * X1 + 3*X2 # dat is hier een beetje commentaar
>>     # efa block 2
>>     efa("efa2")*f3 +
>>     efa("efa2")*f4 =~ y1 + y2 + y3 + y1:y3
>>     f4 := 3.14159 * F2
>>     F1 ~ start(0.76)*F2 + a*F2
>>     a == (b + f3)^2
>>     b1 > exp(b2 + b3) '
>>
>> and the translation can be tested - after installing lavaanC - with
>>
>> lavaanC::lav_parse_model_string_c(model)
>>
>> As mentioned, this causes an abort of the R session when executed in RStudio on Windows (10 or 11), but passes without problem in the R console or a batch job.
>>
>> Because many users are using RStudio I 'd like to tackle this problem, but don't know how to pinpoint the cause of the problem. I hope some of you have an idea how to handle this problem ...
>>
>> All the best,
>>
>>
>> Luc De Wilde
>>
>> ______________________________________________
>> R-package-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>>
>


From Luc@DeW||de @end|ng |rom UGent@be  Wed Nov 13 09:28:01 2024
From: Luc@DeW||de @end|ng |rom UGent@be (Luc De Wilde)
Date: Wed, 13 Nov 2024 08:28:01 +0000
Subject: [R-pkg-devel] 
 New package with C++ code causes R abort in RStudio,
 not in R console.
In-Reply-To: <20241113003309.337d826a@Tarkus>
References: <AM0PR09MB3843B5A6489B9D868B68F8C498592@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <20241112214403.1ab126b0@Tarkus>
 <AM0PR09MB384306BE44733AECE667B8CE98592@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <20241113003309.337d826a@Tarkus>
Message-ID: <AM0PR09MB3843F0DF1C7BA1A7B2E8E743985A2@AM0PR09MB3843.eurprd09.prod.outlook.com>

Thanks to your instructions I have found the probable reason of the crash: char* items allocated with "new char[...]" were deleted with 'delete' and not with 'delete[]' in one of the destructors. I will recheck my code and retry all tests.

For your information: Visual Studio debugger works with the debug info stored in the dll, it asks for the location of the source file (.cpp) and then shows the correct location of the problematic instruction.

Thanks a lot!

Luc
________________________________
Van: Ivan Krylov <ikrylov at disroot.org>
Verzonden: dinsdag 12 november 2024 22:33
Aan: Luc De Wilde <Luc.DeWilde at UGent.be>
CC: r-package-devel at r-project.org <r-package-devel at r-project.org>
Onderwerp: Re: [R-pkg-devel] New package with C++ code causes R abort in RStudio, not in R console.

? Tue, 12 Nov 2024 21:09:54 +0000
Luc De Wilde <Luc.DeWilde at UGent.be> ?????:

> I have attached a debugger (from Visual Studio) to the R process,
> which gives me the message "A breakpoint instruction (__debugbreak()
> statement or similar call) was executed in rsession-utf8.exe.
>
> When I go to the dll module in the Call Stack I get the message
> "Binary was not built with debug information".

So the crash does happen inside lavaanC.dll, did I get this right?

If you set the environment variable DEBUG to a non-empty string before
compiling the package, the resulting *.dll will have debug information
in the DWARF format (this is set in file.path(R.home('etc'), 'x64',
'Makeconf')). Visual Studio might not work with it, so you could
install gdb into Rtools using pacman, or you could try to give the
executable to Dr. Mingw <https://eur03.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2Fjrfonseca%2Fdrmingw&data=05%7C02%7CLuc.DeWilde%40UGent.be%7C74c6b594e5414ac8486c08dd03619cae%7Cd7811cdeecef496c8f91a1786241b99c%7C1%7C0%7C638670439969607386%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=hiUfEIBkezT%2FoWd%2FC5ZJncKFkTNUZPmqiavOCLOzOUM%3D&reserved=0<https://github.com/jrfonseca/drmingw>>.

--
Best regards,
Ivan

	[[alternative HTML version deleted]]


From ||gge@ @end|ng |rom @t@t|@t|k@tu-dortmund@de  Wed Nov 13 09:57:05 2024
From: ||gge@ @end|ng |rom @t@t|@t|k@tu-dortmund@de (Uwe Ligges)
Date: Wed, 13 Nov 2024 09:57:05 +0100
Subject: [R-pkg-devel] CRAN build error on Windows
In-Reply-To: <26419.43927.403453.796237@rob.eddelbuettel.com>
References: <AS8PR10MB466318BEE8305A6903DBD580A7592@AS8PR10MB4663.EURPRD10.PROD.OUTLOOK.COM>
 <26419.34464.99541.550806@rob.eddelbuettel.com>
 <26419.43927.403453.796237@rob.eddelbuettel.com>
Message-ID: <448fb713-bdcc-432a-947c-c32cdb112b80@statistik.tu-dortmund.de>



On 12.11.2024 20:25, Dirk Eddelbuettel wrote:
> 
> On 12 November 2024 at 10:47, Dirk Eddelbuettel wrote:
> |
> | On 12 November 2024 at 12:40, Pepijn de Vries wrote:
> | | "Cannot create temporary file in D:\temp\2024_11_12_ 1_50_00_12637\: No such file or directory"
> |
> | Based on your quote and the log [1] it looks like you have a space in the
> | directory name. Windows can accommodate these but you must then quote them
> | prperly. A more defensive mechanism is to not have spaces there in the first
> | so may call `sub()` on the path replacing ' ' with '_'.
> 
> Just saw the same error in a package on mine, updated yesterday. [1]
> 
> That makes it more likely that this is a (hopefully transient) issue on the
> Windows builder.  Uwe reads this list and may chime in.
> 
> Dirk
> 
> [1] https://www.r-project.org/nosvn/R.check/r-devel-windows-x86_64/RcppSpdlog-00install.html
> 


You are right, the temp dir got too big to handle and hence I have time 
specific temp dirs now. WHat I did not anticipate is that although 
Windows writes "01" for days, months, minutes, and seconds, it rather 
prints " 1" for hours when asking for %DATE% and %TIME% in a batch file.
Fixed in the meantime and check results should clear up soon.

Best,
Uwe

From pep|jn@devr|e@ @end|ng |rom out|ook@com  Wed Nov 13 12:57:16 2024
From: pep|jn@devr|e@ @end|ng |rom out|ook@com (Pepijn de Vries)
Date: Wed, 13 Nov 2024 11:57:16 +0000
Subject: [R-pkg-devel] CRAN build error on Windows
In-Reply-To: <448fb713-bdcc-432a-947c-c32cdb112b80@statistik.tu-dortmund.de>
References: <AS8PR10MB466318BEE8305A6903DBD580A7592@AS8PR10MB4663.EURPRD10.PROD.OUTLOOK.COM>
 <26419.34464.99541.550806@rob.eddelbuettel.com>
 <26419.43927.403453.796237@rob.eddelbuettel.com>
 <448fb713-bdcc-432a-947c-c32cdb112b80@statistik.tu-dortmund.de>
Message-ID: <AM8PR10MB4660F950E1B4587F06F45804A75A2@AM8PR10MB4660.EURPRD10.PROD.OUTLOOK.COM>

> On 12.11.2024 20:25, Dirk Eddelbuettel wrote:
> >
> > On 12 November 2024 at 10:47, Dirk Eddelbuettel wrote:
> > |
> > | On 12 November 2024 at 12:40, Pepijn de Vries wrote:
> > | | "Cannot create temporary file in D:\temp\2024_11_12_ 1_50_00_12637\: No such file or directory"
> > |
> > | Based on your quote and the log [1] it looks like you have a space in the
> > | directory name. Windows can accommodate these but you must then quote them
> > | prperly. A more defensive mechanism is to not have spaces there in the first
> > | so may call `sub()` on the path replacing ' ' with '_'.
> >
> > Just saw the same error in a package on mine, updated yesterday. [1]
> >
> > That makes it more likely that this is a (hopefully transient) issue on the
> > Windows builder.  Uwe reads this list and may chime in.
> >
> > Dirk
> >
> > [1] https://www.r-project.org/nosvn/R.check/r-devel-windows-x86_64/RcppSpdlog-00install.html
> >
>
>
> You are right, the temp dir got too big to handle and hence I have time
> specific temp dirs now. WHat I did not anticipate is that although
> Windows writes "01" for days, months, minutes, and seconds, it rather
> prints " 1" for hours when asking for %DATE% and %TIME% in a batch file.
> Fixed in the meantime and check results should clear up soon.
>
> Best,
> Uwe

Thanks for the quick responses and fixing this. Indeed, the package has now built without problems.

Kind regards,

Pepijn

From Luc@DeW||de @end|ng |rom UGent@be  Wed Nov 13 16:47:47 2024
From: Luc@DeW||de @end|ng |rom UGent@be (Luc De Wilde)
Date: Wed, 13 Nov 2024 15:47:47 +0000
Subject: [R-pkg-devel] 
 New package with C++ code causes R abort in RStudio,
 not in R console.
In-Reply-To: <20241113003309.337d826a@Tarkus>
References: <AM0PR09MB3843B5A6489B9D868B68F8C498592@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <20241112214403.1ab126b0@Tarkus>
 <AM0PR09MB384306BE44733AECE667B8CE98592@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <20241113003309.337d826a@Tarkus>
Message-ID: <AM0PR09MB3843634119CF54E3C6BED9CF985A2@AM0PR09MB3843.eurprd09.prod.outlook.com>

Dear Ivan,


Unfortunately the error did not go away, after the correction (delete[] where needed) still error free execution in R console but abort of the R process in Rstudio.

The debugger of RStudio did not give any useful information anymore. I then installed Drmingw and attached the R process of Rstudio to it.
When I then execute the tests everything happens error free ...
... until I close the debugger: then RStudio says that there is a fatal error in the R process and aborts it.

So of course I cannot find a cause this way!

Maybe you have an idea how to deal with this?



Luc

________________________________
Van: Ivan Krylov <ikrylov at disroot.org>
Verzonden: dinsdag 12 november 2024 22:33
Aan: Luc De Wilde <Luc.DeWilde at UGent.be>
CC: r-package-devel at r-project.org <r-package-devel at r-project.org>
Onderwerp: Re: [R-pkg-devel] New package with C++ code causes R abort in RStudio, not in R console.

? Tue, 12 Nov 2024 21:09:54 +0000
Luc De Wilde <Luc.DeWilde at UGent.be> ?????:

> I have attached a debugger (from Visual Studio) to the R process,
> which gives me the message "A breakpoint instruction (__debugbreak()
> statement or similar call) was executed in rsession-utf8.exe.
>
> When I go to the dll module in the Call Stack I get the message
> "Binary was not built with debug information".

So the crash does happen inside lavaanC.dll, did I get this right?

If you set the environment variable DEBUG to a non-empty string before
compiling the package, the resulting *.dll will have debug information
in the DWARF format (this is set in file.path(R.home('etc'), 'x64',
'Makeconf')). Visual Studio might not work with it, so you could
install gdb into Rtools using pacman, or you could try to give the
executable to Dr. Mingw <https://eur03.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2Fjrfonseca%2Fdrmingw&data=05%7C02%7CLuc.DeWilde%40UGent.be%7C74c6b594e5414ac8486c08dd03619cae%7Cd7811cdeecef496c8f91a1786241b99c%7C1%7C0%7C638670439969607386%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=hiUfEIBkezT%2FoWd%2FC5ZJncKFkTNUZPmqiavOCLOzOUM%3D&reserved=0<https://github.com/jrfonseca/drmingw>>.

--
Best regards,
Ivan

	[[alternative HTML version deleted]]


From pro|jcn@@h @end|ng |rom gm@||@com  Wed Nov 13 18:14:09 2024
From: pro|jcn@@h @end|ng |rom gm@||@com (J C Nash)
Date: Wed, 13 Nov 2024 12:14:09 -0500
Subject: [R-pkg-devel] Closing a display window from a program
Message-ID: <d87c8648-0c41-406a-a4eb-88a08992b276@gmail.com>

Hi,

I'm trying to prepare a package to manage some diverse data. It is
extremely convenient to display a PDF derived from the data so the user
can verify information that the R script is going to process (even nicer
if on a 2 monitor system). I've 2 issues:

1) I can display the pdf either with file_show() from the fs package
or browseURL(). Both leave the pdf displayed and return to the
R "terminal". But when I finish processing at the end of the script,
I want to have the display close. This seems to need (non-platform-neutral)
use of a system() call to wmctrl, which is only on X-windows systems.
Note that the display tools don't seem to return a handle that I can use to
close the display window some other way. On my system both the tools
for display loaded xreader (I'm on Linux Mint Wilma).

2) the tools also don't seem to offer window size or placement, which
   would be nice.

Suggestions welcome.

John Nash


From @|mon@urb@nek @end|ng |rom R-project@org  Thu Nov 14 09:31:37 2024
From: @|mon@urb@nek @end|ng |rom R-project@org (Simon Urbanek)
Date: Thu, 14 Nov 2024 21:31:37 +1300
Subject: [R-pkg-devel] Closing a display window from a program
In-Reply-To: <d87c8648-0c41-406a-a4eb-88a08992b276@gmail.com>
References: <d87c8648-0c41-406a-a4eb-88a08992b276@gmail.com>
Message-ID: <C88F0B1B-1764-4DA2-9075-C0292F36C711@R-project.org>

John,

does it have to be PDF? Unfortunately, PDF is not easy to deal with in platform-independent way (and generally as well - of all the systems only macOS has native support for it). If you really have no other choice, my only suggestion would be to use poppler to render it so it can be displayed by R directly. Anything else is a bit more convoluted like embedding it in a webpage and hoping the browser has PDF support, but that tends to be pretty clumsy.

Cheers,
Simon


> On Nov 14, 2024, at 6:14 AM, J C Nash <profjcnash at gmail.com> wrote:
> 
> Hi,
> 
> I'm trying to prepare a package to manage some diverse data. It is
> extremely convenient to display a PDF derived from the data so the user
> can verify information that the R script is going to process (even nicer
> if on a 2 monitor system). I've 2 issues:
> 
> 1) I can display the pdf either with file_show() from the fs package
> or browseURL(). Both leave the pdf displayed and return to the
> R "terminal". But when I finish processing at the end of the script,
> I want to have the display close. This seems to need (non-platform-neutral)
> use of a system() call to wmctrl, which is only on X-windows systems.
> Note that the display tools don't seem to return a handle that I can use to
> close the display window some other way. On my system both the tools
> for display loaded xreader (I'm on Linux Mint Wilma).
> 
> 2) the tools also don't seem to offer window size or placement, which
>  would be nice.
> 
> Suggestions welcome.
> 
> John Nash
> 
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
> 


From Luc@DeW||de @end|ng |rom UGent@be  Thu Nov 14 11:41:22 2024
From: Luc@DeW||de @end|ng |rom UGent@be (Luc De Wilde)
Date: Thu, 14 Nov 2024 10:41:22 +0000
Subject: [R-pkg-devel] 
 New package with C++ code causes R abort in RStudio,
 not in R console.
In-Reply-To: <20241113003309.337d826a@Tarkus>
References: <AM0PR09MB3843B5A6489B9D868B68F8C498592@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <20241112214403.1ab126b0@Tarkus>
 <AM0PR09MB384306BE44733AECE667B8CE98592@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <20241113003309.337d826a@Tarkus>
Message-ID: <DB8PR09MB38501E592FBF0606205D4C42985B2@DB8PR09MB3850.eurprd09.prod.outlook.com>

After some corrections (initialization of pointer vars in some structs/classes) I still get the problem in Rstudio, aborting the R process.

This is the dump in Dr.Mingw:
rsession-utf8.exe caused an Unknown [0xC0000374] Exception at location 00007FF96FD68215 in module ntdll.dll.

AddrPC           Params
00007FF96FD68215 0000004BAF5FF9B0 0000000000000000 0000000000000000  ntdll.dll!RtlReportFatalFailure+0x9
00007FF96FD66B09 0000004BAF5F8749 00007FF96FEAB0E0 0000000000000003  ntdll.dll!RtlReportCriticalFailure+0xa9
00007FF96FD0EAE2 0000000000000003 0000004BAF5F8749 00000204D0AC0000  ntdll.dll!RtlpHeapHandleError+0x12
00007FF96FDFF9EA 0000000000000000 00000204D7B6D230 0000004BAF5F8840  ntdll.dll!RtlpHpHeapHandleError+0x7a
00007FF96FD0977B 2AAAAAAAAAAAAAAB 0000004BAF5F8940 0000004BAF5F8940  ntdll.dll!RtlpLogHeapFailure+0x4b
00007FF96FD12486 00000204D0AC0000 0000020400000000 00000204D7B6D240  ntdll.dll!RtlFreeHeap+0x266
00007FF96D96DDAB 0000000000000000 0000000000000000 0000000000000000  ucrtbase.dll!_free_base+0x1b
00007FF65019AB89 0000004BAF5F8940 0000004B00000005 0000004B0000FDE9  rsession-utf8.exe!rd_traceback+0x72a449
00007FF650369484 0000004BAF5F89E0 0000000000000000 0000000000000000  rsession-utf8.exe!rd_traceback+0x8f8d44
00007FF650370672 0000000000000000 0000000000000000 0000000000000000  rsession-utf8.exe!rd_traceback+0x8fff32
00007FF8D0D95328 00000204D0BB44E8 0000000000000000 00007FF800000000  R.dll!Rf_EncodeChar+0x68
00007FF8D0D953E4 00000204D404F240 00000204D0B41060 0000000000000000  R.dll!Rvprintf+0x44
00007FF8D0D95452 0000004BAF5FAC50 00000204DC46BF90 0000000000000000  R.dll!Rprintf+0x22
00007FF8D0C80F74 00000204DBABDC10 00000204D2A62188 00000204D2A594F8  R.dll!R_do_slot_assign+0x3504
00007FF8D0D05200 0000000000000001 00007FF6503BF8E8 00000204D0AC0000  R.dll!R_ParseEvalString+0x59e0
00007FF8D0D1BE74 202020200029226E 0000000000000000 00000204D7457FF0  R.dll!R_ParseEvalString+0x1c654
00007FF8D0D1C17B 00000204D09D2280 0000000000000000 00000204D09D02AC  R.dll!R_ParseEvalString+0x1c95b
00007FF8D0D20320 00000204D38747B0 00000204D3874CF0 0000004BAF5FC330  R.dll!Rf_eval+0x3a20
00007FF8D0D216EF 003100330061002D 00330034002D0066 00000204D38749E0  R.dll!Rf_eval+0x4def
00007FF8D0D1C3DE 0000004B00000007 0000000000800000 0000004BAF5FEBA0  R.dll!R_ParseEvalString+0x1cbbe
00007FF8D0D478FD 0000004BAF5FEBA0 00007FF8D0D1DEDA 0000000000000000  R.dll!Rf_ReplIteration+0x22d
00007FF8D0D47C88 00007FF8D0D45EE1 00000204D0B5E690 0000000000000000  R.dll!Rf_ReplIteration+0x5b8
00007FF8D0D47D22 0000004BAF5FD768 0000004B00000000 0000004BAF5FD701  R.dll!run_Rmainloop+0x52
00007FF65035D0F0 00007FF650354D40 0000000000000000 0000004BAF5FDBB0  rsession-utf8.exe!rd_traceback+0x8ec9b0
00007FF650356E0E 0000000000000000 0000004BAF5FF7C0 0000000000000000  rsession-utf8.exe!rd_traceback+0x8e66ce
00007FF64F8ABDBE 00007FF650BED878 0000000000000000 00000204D0ACEBD0  rsession-utf8.exe!0x2bbdbe
00007FF6507D1BC8 0000000000000000 0000000000000000 0000000000000000  rsession-utf8.exe!rd_traceback+0xd61488
00007FF96E37DBE7 0000000000000000 0000000000000000 000004F0FFFFFB30  KERNEL32.DLL!BaseThreadInitThunk+0x17
00007FF96FDBFBEC 0000000000000000 0000000000000000 0000000000000000  ntdll.dll!RtlUserThreadStart+0x2c


and, although the package dll is not in the stack, I suppose the problem is "connected" to the code that evaluates an expression in R:

SEXP lav_eval(const char* expression, int& error, int varpos)
{
  if (Debug) Rprintf("Eval %s :", expression);
  string strexpr("tryCatch(");
  strexpr+=expression;
  strexpr+=", error = function(e)  NaN)";
  error = 0;
  SEXP cmdSexp, cmdexpr, ans = R_NilValue;
  ParseStatus status;
  cmdSexp = PROTECT(Rf_allocVector(STRSXP, 1));
  SET_STRING_ELT(cmdSexp, 0, Rf_mkChar(strexpr.c_str()));
  cmdexpr = PROTECT(R_ParseVector(cmdSexp, -1, &status, R_NilValue));
  if (status != PARSE_OK) {
    UNPROTECT(2);
    error = (int)(spe_invalidexpr << 24) + varpos;
    return ans;
  }
  /* Loop is needed here as EXPSEXP will be of length > 1 */
  ans = PROTECT(Rf_allocVector(VECSXP, Rf_length(cmdexpr)));
  for(int i = 0; i < Rf_length(cmdexpr); i++)
    SET_VECTOR_ELT(ans, i, Rf_eval(VECTOR_ELT(cmdexpr, i), R_GlobalEnv));
  double* dval;
  if (Rf_isNumeric(VECTOR_ELT(ans, 0))) {
    dval = REAL(VECTOR_ELT(ans, 0));
    if (ISNAN(dval[0]) && !ISNA(dval[0])) {
      error = (int)(spe_invalidexpr << 24) + varpos;
      UNPROTECT(3);
      return ans;
    }
  }
  UNPROTECT(3);
  if (Debug) Rf_PrintValue(ans);
  return VECTOR_ELT(ans, 0);
}


The package was installed with environment variables DEBUG="on" and R_C_BOUNDS_CHECK="yes".

The exception reported is a heap corruption problem.

I hope you, or someone else,  can help me with this problem.

Luc
________________________________________
Van: Ivan Krylov <ikrylov at disroot.org>
Verzonden: dinsdag 12 november 2024 22:33
Aan: Luc De Wilde <Luc.DeWilde at UGent.be>
CC: r-package-devel at r-project.org <r-package-devel at r-project.org>
Onderwerp: Re: [R-pkg-devel] New package with C++ code causes R abort in RStudio, not in R console.

? Tue, 12 Nov 2024 21:09:54 +0000
Luc De Wilde <Luc.DeWilde at UGent.be> ?????:

> I have attached a debugger (from Visual Studio) to the R process,
> which gives me the message "A breakpoint instruction (__debugbreak()
> statement or similar call) was executed in rsession-utf8.exe.
>
> When I go to the dll module in the Call Stack I get the message
> "Binary was not built with debug information".

So the crash does happen inside lavaanC.dll, did I get this right?

If you set the environment variable DEBUG to a non-empty string before
compiling the package, the resulting *.dll will have debug information
in the DWARF format (this is set in file.path(R.home('etc'), 'x64',
'Makeconf')). Visual Studio might not work with it, so you could
install gdb into Rtools using pacman, or you could try to give the
executable to Dr. Mingw <https://github.com/jrfonseca/drmingw>.

--
Best regards,
Ivan


From Luc@DeW||de @end|ng |rom UGent@be  Thu Nov 14 14:08:13 2024
From: Luc@DeW||de @end|ng |rom UGent@be (Luc De Wilde)
Date: Thu, 14 Nov 2024 13:08:13 +0000
Subject: [R-pkg-devel] 
 New package with C++ code causes R abort in RStudio,
 not in R console.
In-Reply-To: <20241113003309.337d826a@Tarkus>
References: <AM0PR09MB3843B5A6489B9D868B68F8C498592@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <20241112214403.1ab126b0@Tarkus>
 <AM0PR09MB384306BE44733AECE667B8CE98592@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <20241113003309.337d826a@Tarkus>
Message-ID: <DB8PR09MB385024061ED407F5A5F99CE7985B2@DB8PR09MB3850.eurprd09.prod.outlook.com>

At last, with checking of the program with address sanitizer in Visual Studio, I found an "off by 1 error" in my code. Now all tests pass without problems in Rstudio.

Thank you very much, Ivan, for helping me with this - new to me - issues!

Luc

________________________________________
Van: Ivan Krylov <ikrylov at disroot.org>
Verzonden: dinsdag 12 november 2024 22:33
Aan: Luc De Wilde <Luc.DeWilde at UGent.be>
CC: r-package-devel at r-project.org <r-package-devel at r-project.org>
Onderwerp: Re: [R-pkg-devel] New package with C++ code causes R abort in RStudio, not in R console.

? Tue, 12 Nov 2024 21:09:54 +0000
Luc De Wilde <Luc.DeWilde at UGent.be> ?????:

> I have attached a debugger (from Visual Studio) to the R process,
> which gives me the message "A breakpoint instruction (__debugbreak()
> statement or similar call) was executed in rsession-utf8.exe.
>
> When I go to the dll module in the Call Stack I get the message
> "Binary was not built with debug information".

So the crash does happen inside lavaanC.dll, did I get this right?

If you set the environment variable DEBUG to a non-empty string before
compiling the package, the resulting *.dll will have debug information
in the DWARF format (this is set in file.path(R.home('etc'), 'x64',
'Makeconf')). Visual Studio might not work with it, so you could
install gdb into Rtools using pacman, or you could try to give the
executable to Dr. Mingw <https://github.com/jrfonseca/drmingw>.

--
Best regards,
Ivan


From m@@epu|ved@ @end|ng |rom m@||@utoronto@c@  Thu Nov 14 17:24:16 2024
From: m@@epu|ved@ @end|ng |rom m@||@utoronto@c@ (Mauricio Vargas Sepulveda)
Date: Thu, 14 Nov 2024 16:24:16 +0000
Subject: [R-pkg-devel] 
 Possible false negative for compiled C++ code in CRAN checks
In-Reply-To: <20241112233710.3b18c120@Tarkus>
References: <YT2PPFFFCD7005701B25728913116FEEC8BDD5E2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241111124840.55248fa6@Tarkus>
 <YT2PPFFFCD70057CF5F7C2CA2439229E0B6DD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <YT2PPFFFCD700570537573F529D215EC62ADD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241112135634.44ceb4a9@arachnoid>
 <YT2PPFFFCD700574402F067CF21834F38FCDD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <QB1PPF4A6194682D335931D60BE683F6DB3DD592@QB1PPF4A6194682.CANPRD01.PROD.OUTLOOK.COM>
 <20241112233710.3b18c120@Tarkus>
Message-ID: <YT2PPFFFCD700572D7D25315A5FFFD31378DD5B2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>

Dear R Developers,

I hope you are doing well.

I managed to create an image that mimic CRAN checks [1].

After enabling the SAN flags, I cannot reproduce the gcc-san error [2].

Should I report this as a false positive?

Links

1. https://github.com/r-hub/containers/pull/81/files
2. https://win-builder.r-project.org/incoming_pretest/redatam_2.0.4_20241114_071006/specialChecks/gcc-san/outputs.txt

Best,

??
Mauricio "Pach?" Vargas Sep?lveda
PhD Student, Political Science
University of Toronto


________________________________________
From: Ivan Krylov <ikrylov at disroot.org>
Sent: November 12, 2024 3:37 PM
To: Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca>
Cc: r-package-devel at r-project.org <r-package-devel at r-project.org>
Subject: Re: [R-pkg-devel] Possible false negative for compiled C++ code in CRAN checks

? Tue, 12 Nov 2024 17:37:40 +0000
Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca> ?????:

> I re-sent my package and I still see:
>
>   1.
> https://win-builder.r-project.org/incoming_pretest/redatam_2.0.3_20241112_165458/specialChecks/clang-san/outputs.txt

I understand this doesn't feel like progress, but this time clang-san
is giving your package a clean bill of health. There are no issues to
fix here.

>   2.
> https://win-builder.r-project.org/incoming_pretest/redatam_2.0.3_20241112_165458/specialChecks/gcc-san/outputs.txt

This one, unfortunately, does demonstrate a new error in the package.
The problem with software testing is that it can only demonstrate the
presence of bugs, not their absence. The new error is different from
all the errors we've seen previously. The code at
redatamlib/readers/FuzzyVariableParser.cpp:33:38 performs an integer
division by zero, which crashes the process:

  size_t chunkSize = entities.size() / numThreads;

It's not in the outputs.txt, but in the summary.txt:
https://win-builder.r-project.org/incoming_pretest/redatam_2.0.3_20241112_165458/specialChecks/gcc-san/summary.txt

https://en.cppreference.com/w/cpp/thread/thread/hardware_concurrency
says that std::thread::hardware_concurrency() could plausibly return 0.
Or is this due to empty entities vector?

> I am also using "-Wall -O0 -pedantic" and "-UDEBUG -g" to check
> locally, and I am also using all the available R-Hub images (27
> different configurations, as in
> https://github.com/pachadotdev/open-redatam/actions/runs/11801021816)

Unfortunately, none of these use gcc with UBSanitizer enabled. I think
that the rocker/r-devel-san container [*] image comes closest to the
configuration that fails your package during the CRAN checks. By
running the following commands, I can reproduce the crash:

podman run -it docker.io/rocker/r-devel-san Rdevel
f <- 'https://cran.r-project.org/incoming/archive/redatam_2.0.3.tar.gz'
download.file(f, basename(f))
install.packages(c('data.table','janitor', 'stringi', 'knitr',
'rmarkdown','testthat'))
tools::Rcmd('check redatam_2.0.3.tar.gz')

By installing gdb inside the container, running Rdevel -d gdb and
setting a breakpoint on __ubsan_on_report, I can catch the moment
before the crash:

(gdb) frame 5
#5  0x00007f95bf293a16 in
RedatamLib::FuzzyVariableParser::ParseAllVariables
(this=this at entry=0x7fff80974bd0, entities=std::vector of length 0,
capacity 0) at redatamlib/readers/FuzzyVariableParser.cpp:33
33       size_t chunkSize = entities.size() / numThreads;
(gdb) p entities.size()
$1 = 0
(gdb) p numThreads
$2 = 0
(gdb) p maxThreads
$3 = 4

The entities vector is empty, and the 0/0 integer division invokes
undefined behaviour.

Would you find it acceptable to also test your package using the
docker.io/rocker/r-devel-san container before the next submission?

--
Best regards,
Ivan

[*] https://rocker-project.org/images/base/r-devel.html

From edd @end|ng |rom deb|@n@org  Thu Nov 14 17:47:21 2024
From: edd @end|ng |rom deb|@n@org (Dirk Eddelbuettel)
Date: Thu, 14 Nov 2024 10:47:21 -0600
Subject: [R-pkg-devel] 
 Possible false negative for compiled C++ code in CRAN checks
In-Reply-To: <YT2PPFFFCD700572D7D25315A5FFFD31378DD5B2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
References: <YT2PPFFFCD7005701B25728913116FEEC8BDD5E2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241111124840.55248fa6@Tarkus>
 <YT2PPFFFCD70057CF5F7C2CA2439229E0B6DD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <YT2PPFFFCD700570537573F529D215EC62ADD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241112135634.44ceb4a9@arachnoid>
 <YT2PPFFFCD700574402F067CF21834F38FCDD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <QB1PPF4A6194682D335931D60BE683F6DB3DD592@QB1PPF4A6194682.CANPRD01.PROD.OUTLOOK.COM>
 <20241112233710.3b18c120@Tarkus>
 <YT2PPFFFCD700572D7D25315A5FFFD31378DD5B2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
Message-ID: <26422.10649.828232.822795@rob.eddelbuettel.com>


On 14 November 2024 at 16:24, Mauricio Vargas Sepulveda wrote:
| After enabling the SAN flags, I cannot reproduce the gcc-san error [2].
| 
| Should I report this as a false positive?

No.

Replicating ASAN/UBSAN issues is known to be potentially tricky.

It drove me so batty a decade ago that I created a package (on CRAN at [1])
with _known triggers_ from the corresponding ASAN/UBSAN wiki. They help
ensure a given setup finds what it is supposed to find. (It also helps to
become familiar with ASAN/UBSAN because you can also assert that standard g++
/ clang++ do not necessarily find these. But the newer compilers are getting
better so some issue may now be flagged too.)

We have known-good containers: I maintain two within Rocker, they have weekly
builds, Winston has the ones in the sumu container [2] which many of us
(myself included) use. There is also rhub2 but that failed for me when I
tried a while back, it may be better now.

Sadly the CRAN one is not available as a container. But not reproducing the
CRAN findings does not imply CRAN is wrong. More likely it means your setup
does not (yet ?) match CRAN.

Dirk

[1] https://cran.r-project.org/package=sanitizers
[2] https://github.com/wch/r-debug

-- 
dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org


From |kry|ov @end|ng |rom d|@root@org  Thu Nov 14 21:32:51 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Thu, 14 Nov 2024 23:32:51 +0300
Subject: [R-pkg-devel] 
 New package with C++ code causes R abort in RStudio,
 not in R console.
In-Reply-To: <DB8PR09MB385024061ED407F5A5F99CE7985B2@DB8PR09MB3850.eurprd09.prod.outlook.com>
References: <AM0PR09MB3843B5A6489B9D868B68F8C498592@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <20241112214403.1ab126b0@Tarkus>
 <AM0PR09MB384306BE44733AECE667B8CE98592@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <20241113003309.337d826a@Tarkus>
 <DB8PR09MB385024061ED407F5A5F99CE7985B2@DB8PR09MB3850.eurprd09.prod.outlook.com>
Message-ID: <20241114233251.02e6999d@Tarkus>

? Thu, 14 Nov 2024 13:08:13 +0000
Luc De Wilde <Luc.DeWilde at UGent.be> ?????:

> At last, with checking of the program with address sanitizer in
> Visual Studio, I found an "off by 1 error" in my code. Now all tests
> pass without problems in Rstudio.

Congratulations on being able to solve the problem yourself!

It took me too long to figure out that the syntax errors I was getting
from lavaanC::lav_parse_model_string_c() were due to the invisible
U+00A0 (non-breakable space) characters from the e-mail. Once I ran
lav_parse_model_string_c(gsub('\ua0', ' ', model)) in a sanitized build
of R, I too saw the buffer overflow and a number of memory leaks.

Would you mind sharing with the list how you used address sanitizer
with R on Windows? Did you have to use the clang compiler, or have you
been able to use MSVC? Does Dr. Memory <https://drmemory.org/> find any
additional problems?

-- 
Best regards,
Ivan


From |kry|ov @end|ng |rom d|@root@org  Thu Nov 14 22:50:43 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Fri, 15 Nov 2024 00:50:43 +0300
Subject: [R-pkg-devel] 
 Possible false negative for compiled C++ code in CRAN checks
In-Reply-To: <YT2PPFFFCD700572D7D25315A5FFFD31378DD5B2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
References: <YT2PPFFFCD7005701B25728913116FEEC8BDD5E2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241111124840.55248fa6@Tarkus>
 <YT2PPFFFCD70057CF5F7C2CA2439229E0B6DD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <YT2PPFFFCD700570537573F529D215EC62ADD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241112135634.44ceb4a9@arachnoid>
 <YT2PPFFFCD700574402F067CF21834F38FCDD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <QB1PPF4A6194682D335931D60BE683F6DB3DD592@QB1PPF4A6194682.CANPRD01.PROD.OUTLOOK.COM>
 <20241112233710.3b18c120@Tarkus>
 <YT2PPFFFCD700572D7D25315A5FFFD31378DD5B2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
Message-ID: <20241115005043.1947995d@Tarkus>

? Thu, 14 Nov 2024 16:24:16 +0000
Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca> ?????:

> After enabling the SAN flags, I cannot reproduce the gcc-san error
> [2].

Can you use the rocker/r-devel-san container? It reproduces the problem
for me.

When reading galapagos/cg15.dic, FuzzyEntityParser::ParseEntities()
keeps advancing over the file and failing to parse a single entity
until it eventually calls stop() because it didn't find any entities.

In a non-sanitized build, it first succeeds at 0-based offset 1095. In
a sanitized build, it fails for all offsets. I think this is due to the
ordering of the byte reads:
https://github.com/pachadotdev/open-redatam/blob/bbb65242f1af5f601def1c0b971ed601d459b4f3/src/readers/ByteArrayReader.cpp#L176-L192

In C++, an operation like the following:

static_cast<uint16_t>(ReadByte()) << 8 |
static_cast<uint16_t>(ReadByte());

...depends on the order in which the compiler will choose to evaluate
the calls to static_cast<uint16_t>(ReadByte()), and this order is not
guaranteed to be left-to-right:
https://en.cppreference.com/w/cpp/language/eval_order

I edited all four byte-reading functions and replaced the one-statement
operations with separate statements for each of the byte reads:

--- redatam.orig/src/redatamlib/readers/ByteArrayReader.cpp     2024-11-09 02:12:17.000000000 +0000
+++ redatam.new/src/redatamlib/readers/ByteArrayReader.cpp      2024-11-14 21:25:54.000000000 +0000
@@ -175,23 +175,27 @@
 }

 uint16_t ByteArrayReader::ReadInt16LE() {
-  return static_cast<uint16_t>(ReadByte()) |
-         (static_cast<uint16_t>(ReadByte()) << 8);
+  uint16_t a = static_cast<uint16_t>(ReadByte());
+  uint16_t b = static_cast<uint16_t>(ReadByte()) << 8;
+  return a | b;
 }

 uint32_t ByteArrayReader::ReadInt32LE() {
-  return static_cast<uint32_t>(ReadInt16LE()) |
-         static_cast<uint32_t>(ReadInt16LE()) << 16;
+  uint32_t a = static_cast<uint32_t>(ReadInt16LE());
+  uint32_t b = static_cast<uint32_t>(ReadInt16LE()) << 16;
+  return a | b;
 }

 uint16_t ByteArrayReader::ReadInt16BE() {
-  return (static_cast<uint16_t>(ReadByte()) << 8) |
-         static_cast<uint16_t>(ReadByte());
+ uint16_t a= (static_cast<uint16_t>(ReadByte()) << 8);
+ uint16_t b= static_cast<uint16_t>(ReadByte());
+ return a| b;
 }

 uint32_t ByteArrayReader::ReadInt32BE() {
-  return (static_cast<uint32_t>(ReadInt16BE()) << 16) |
-         static_cast<uint32_t>(ReadInt16BE());
+  uint32_t b = static_cast<uint32_t>(ReadInt16LE()) << 16;
+  uint32_t a = static_cast<uint32_t>(ReadInt16LE());
+  return b | a;
 }

 }  // namespace RedatamLib

...and this seems to make the error vanish. I think I see the
misordering too. In the output of objdump -d
redatam.Rcheck/redatam/libs/redatam.so, I see:

0000000000267010 <_ZN10RedatamLib15ByteArrayReader11ReadInt16LEEv>:

  267028:       e8 93 6f f5 ff          call   1bdfc0 <_ZN10RedatamLib15ByteArrayReader8ReadByteEv at plt>
                                               first_byte <- ReadByte()
  26702d:       41 89 c4                mov    %eax,%r12d
                                               save first byte in r12
  26703d:       41 c1 e4 08             shl    $0x8,%r12d
                                               left-shift the first byte!
  267041:       e8 7a 6f f5 ff          call   1bdfc0 <_ZN10RedatamLib15ByteArrayReader8ReadByteEv at plt>
                                               second byte in eax
  26704a:       44 09 e0                or     %r12d,%eax
                                               OR them together

...which is how you read big-endian numbers, not little-endian ones.

-- 
Best regards,
Ivan


From chok@|@h@|| @end|ng |rom gm@||@com  Thu Nov 14 18:27:02 2024
From: chok@|@h@|| @end|ng |rom gm@||@com (Shail Choksi)
Date: Thu, 14 Nov 2024 12:27:02 -0500
Subject: [R-pkg-devel] Is this an issue with the package submission?
Message-ID: <CAAFj5saKfA4rUUEmh8RmaYxUp+MMDK-GY4GHccsTjqQ4ca02Bw@mail.gmail.com>

Hi,

We submitted a package to CRAN here:
https://win-builder.r-project.org/incoming_pretest/ToxicR_24.10.1.4_20241113_200016/

The process.txt here:
https://win-builder.r-project.org/incoming_pretest/ToxicR_24.10.1.4_20241113_200016/specialChecks/clang-san/process.txt

gives an error. Is this a win-builder issue or a package issue? How do I go
about debugging this?

Thank you,

Shail Choksi

	[[alternative HTML version deleted]]


From |kry|ov @end|ng |rom d|@root@org  Fri Nov 15 08:42:01 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Fri, 15 Nov 2024 10:42:01 +0300
Subject: [R-pkg-devel] Is this an issue with the package submission?
In-Reply-To: <CAAFj5saKfA4rUUEmh8RmaYxUp+MMDK-GY4GHccsTjqQ4ca02Bw@mail.gmail.com>
References: <CAAFj5saKfA4rUUEmh8RmaYxUp+MMDK-GY4GHccsTjqQ4ca02Bw@mail.gmail.com>
Message-ID: <20241115104201.7ad0f1b0@Tarkus>

? Thu, 14 Nov 2024 12:27:02 -0500
Shail Choksi <choksishail at gmail.com> ?????:

> The process.txt here:
> https://win-builder.r-project.org/incoming_pretest/ToxicR_24.10.1.4_20241113_200016/specialChecks/clang-san/process.txt
> 
> gives an error. Is this a win-builder issue or a package issue? How
> do I go about debugging this?

Searching for cleancall.c on CRAN yields the 'cli' package:
https://github.com/cran/cli/blob/79876598df96964dee9032362b0773868d624021/src/cleancall.c#L103-L109

The function cb_progress_done from the 'purrr' package, indeed, takes a
different set of argument types:
https://github.com/cran/purrr/blob/de947f6ca0cefdb95f7f0442b08c12c1ef3368ae/src/map.c#L14-L18

This shouldn't break anything on most modern CPU architectures in
practice (R itself is doing similar tricks in order to implement .C()
and .Fortran()), but it is a formal violation of the C standard (and
would crash on certain weird architectures with very large pointers
that encode type information). Since the error is not in your package,
it should be possible to reply to the automatic e-mail (does it say
reply to all or to reply to cran-submission at r-project.org? I don't
remember) and explain the situation.

-- 
Best regards,
Ivan


From Luc@DeW||de @end|ng |rom UGent@be  Fri Nov 15 09:27:01 2024
From: Luc@DeW||de @end|ng |rom UGent@be (Luc De Wilde)
Date: Fri, 15 Nov 2024 08:27:01 +0000
Subject: [R-pkg-devel] 
 New package with C++ code causes R abort in RStudio,
 not in R console.
In-Reply-To: <20241114233251.02e6999d@Tarkus>
References: <AM0PR09MB3843B5A6489B9D868B68F8C498592@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <20241112214403.1ab126b0@Tarkus>
 <AM0PR09MB384306BE44733AECE667B8CE98592@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <20241113003309.337d826a@Tarkus>
 <DB8PR09MB385024061ED407F5A5F99CE7985B2@DB8PR09MB3850.eurprd09.prod.outlook.com>
 <20241114233251.02e6999d@Tarkus>
Message-ID: <DB8PR09MB3850C37B1BE36D4F532EF1F998242@DB8PR09MB3850.eurprd09.prod.outlook.com>

The 'parser' in lavaanC was written in two parts:
* a part in  pure C/C++ without the R interface things like SEXP, etc. ; taking as input a string (the model) and a bool (produce debuginfo yes/no) , and returning a structure with all parsed information and debuginfo (if requested) or an error code (and position in the model) if an error was detected in the model; (lav_SyntaxParser.cpp + lav_SyntaxParser.h + lav_Util.cpp + lav_Util.h + lav_SmallStringList.h)
* an interface function with R which is callable from R with .Call taking SEXP model and SEXP debug as input and returning a SEXP with the parsed information in about the same format as the lavaan parser written in R returns. This interface function also evaluates the parts of the model syntax that are written as an R expression (and that can be evaluated in the Global environment). (lav_parser_interface.cpp)

The first part of parser was written using Visual Studio (the IDE I know well (for C#) because I wrote many programs in C# in this environment), and I also wrote a main function as 'replacement' for the interface function in R to be able to test this first part in Visual Studio.

When searching for the reason Rstudio aborts the R session when executing tests, I found - thanks to the help of Ivan - that there were some memory allocation or usage problems in my code. Because I work most of the time in Windows and the Address Sanitizer in R is only available on Linux/MacOS (cfr Writing R Extensions 4.3.3) I felt stuck.

Because C/C++ is relatively new to me (about 3 months) I didn't know very well the different tools for C/C++ available in Visual Studio, but looking at the documentation of Dr Memory I realized that there should also be some tools in Visual Studio to check the memory allocation and usage in C++ programs.  So I found that in Visual Studio Project options -> C/C++  -> General there is an option "Enable Address Sanitizer". When I enabled it and ran the tests I found the problematic code where I allocated one byte less then needed to copy a string.

I have looked at the documentation of Dr. Memory but not yet installed it.


Luc

________________________________________
Van: Ivan Krylov <ikrylov at disroot.org>
Verzonden: donderdag 14 november 2024 21:32
Aan: Luc De Wilde <Luc.DeWilde at UGent.be>
CC: r-package-devel at r-project.org <r-package-devel at r-project.org>; Yves Rosseel <Yves.Rosseel at UGent.be>
Onderwerp: Re: [R-pkg-devel] New package with C++ code causes R abort in RStudio, not in R console.

? Thu, 14 Nov 2024 13:08:13 +0000
Luc De Wilde <Luc.DeWilde at UGent.be> ?????:

> At last, with checking of the program with address sanitizer in
> Visual Studio, I found an "off by 1 error" in my code. Now all tests
> pass without problems in Rstudio.

Congratulations on being able to solve the problem yourself!

It took me too long to figure out that the syntax errors I was getting
from lavaanC::lav_parse_model_string_c() were due to the invisible
U+00A0 (non-breakable space) characters from the e-mail. Once I ran
lav_parse_model_string_c(gsub('\ua0', ' ', model)) in a sanitized build
of R, I too saw the buffer overflow and a number of memory leaks.

Would you mind sharing with the list how you used address sanitizer
with R on Windows? Did you have to use the clang compiler, or have you
been able to use MSVC? Does Dr. Memory <https://drmemory.org/> find any
additional problems?

--
Best regards,
Ivan


From m@@epu|ved@ @end|ng |rom m@||@utoronto@c@  Fri Nov 15 13:16:38 2024
From: m@@epu|ved@ @end|ng |rom m@||@utoronto@c@ (Mauricio Vargas Sepulveda)
Date: Fri, 15 Nov 2024 12:16:38 +0000
Subject: [R-pkg-devel] 
 Possible false negative for compiled C++ code in CRAN checks
In-Reply-To: <20241115005043.1947995d@Tarkus>
References: <YT2PPFFFCD7005701B25728913116FEEC8BDD5E2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241111124840.55248fa6@Tarkus>
 <YT2PPFFFCD70057CF5F7C2CA2439229E0B6DD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <YT2PPFFFCD700570537573F529D215EC62ADD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241112135634.44ceb4a9@arachnoid>
 <YT2PPFFFCD700574402F067CF21834F38FCDD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <QB1PPF4A6194682D335931D60BE683F6DB3DD592@QB1PPF4A6194682.CANPRD01.PROD.OUTLOOK.COM>
 <20241112233710.3b18c120@Tarkus>
 <YT2PPFFFCD700572D7D25315A5FFFD31378DD5B2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241115005043.1947995d@Tarkus>
Message-ID: <YT2PPFFFCD70057924C4ACF03BE9598A68EDD242@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>

Dear R Developers,

I implemented Dr. Krylov's fix, and now redatam is back to CRAN (Point 1).

Dr. Eddelbuettel's suggestion about not fully mimicking CRAN gcc-san setup was also correct (Point 2).

Point 1:
- When the big endian issue was described here, I tried the s390x image from R-Hub, which does not work on my laptop. Then I went to a big endian server that we have at UofT and that reproduced the error!

Point 2:
- I was testing with docker.io/rocker/r-devel-san:latest, and I could not replicate the error.
- I ended up using the R-Hub image with https://github.com/r-hub/containers/pull/81#issuecomment-2478009166, and that replicated the error line by line.

Besides it, I implemented the same fix for the command line tool and the Python package. I also changed the example data by aggregating Uruguay's census to show some numbers. Just cutting the levels and show region/city is not informative. Being Redatam a closed format with no standard or specification, I ended up reading the census with my pkg, aggregating with dplyr, saving to CSV, and then converting back to Redatam with a point-and-click tool following an unofficial tutorial from You Tube. There is no easy way  to aggregate and save in the same format as we do with SPSS.

I added Dr. Krylov to ctb for this very useful fix! Thanks a lot to Dr. Krylov and Dr. Eddelbuettel for the suggestions, I was going in circles being unable to replicate the issue and I now asked Dr. Ligges for the possibility to know more about the CRAN specific configuration to add it to R-Hub.

Best,

??
Mauricio "Pach?" Vargas Sep?lveda
PhD Student, Political Science
University of Toronto


________________________________________
From: Ivan Krylov <ikrylov at disroot.org>
Sent: November 14, 2024 4:50 PM
To: Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca>
Cc: r-package-devel at r-project.org <r-package-devel at r-project.org>
Subject: Re: [R-pkg-devel] Possible false negative for compiled C++ code in CRAN checks

? Thu, 14 Nov 2024 16:24:16 +0000
Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca> ?????:

> After enabling the SAN flags, I cannot reproduce the gcc-san error
> [2].

Can you use the rocker/r-devel-san container? It reproduces the problem
for me.

When reading galapagos/cg15.dic, FuzzyEntityParser::ParseEntities()
keeps advancing over the file and failing to parse a single entity
until it eventually calls stop() because it didn't find any entities.

In a non-sanitized build, it first succeeds at 0-based offset 1095. In
a sanitized build, it fails for all offsets. I think this is due to the
ordering of the byte reads:
https://github.com/pachadotdev/open-redatam/blob/bbb65242f1af5f601def1c0b971ed601d459b4f3/src/readers/ByteArrayReader.cpp#L176-L192

In C++, an operation like the following:

static_cast<uint16_t>(ReadByte()) << 8 |
static_cast<uint16_t>(ReadByte());

...depends on the order in which the compiler will choose to evaluate
the calls to static_cast<uint16_t>(ReadByte()), and this order is not
guaranteed to be left-to-right:
https://en.cppreference.com/w/cpp/language/eval_order

I edited all four byte-reading functions and replaced the one-statement
operations with separate statements for each of the byte reads:

--- redatam.orig/src/redatamlib/readers/ByteArrayReader.cpp     2024-11-09 02:12:17.000000000 +0000
+++ redatam.new/src/redatamlib/readers/ByteArrayReader.cpp      2024-11-14 21:25:54.000000000 +0000
@@ -175,23 +175,27 @@
 }

 uint16_t ByteArrayReader::ReadInt16LE() {
-  return static_cast<uint16_t>(ReadByte()) |
-         (static_cast<uint16_t>(ReadByte()) << 8);
+  uint16_t a = static_cast<uint16_t>(ReadByte());
+  uint16_t b = static_cast<uint16_t>(ReadByte()) << 8;
+  return a | b;
 }

 uint32_t ByteArrayReader::ReadInt32LE() {
-  return static_cast<uint32_t>(ReadInt16LE()) |
-         static_cast<uint32_t>(ReadInt16LE()) << 16;
+  uint32_t a = static_cast<uint32_t>(ReadInt16LE());
+  uint32_t b = static_cast<uint32_t>(ReadInt16LE()) << 16;
+  return a | b;
 }

 uint16_t ByteArrayReader::ReadInt16BE() {
-  return (static_cast<uint16_t>(ReadByte()) << 8) |
-         static_cast<uint16_t>(ReadByte());
+ uint16_t a= (static_cast<uint16_t>(ReadByte()) << 8);
+ uint16_t b= static_cast<uint16_t>(ReadByte());
+ return a| b;
 }

 uint32_t ByteArrayReader::ReadInt32BE() {
-  return (static_cast<uint32_t>(ReadInt16BE()) << 16) |
-         static_cast<uint32_t>(ReadInt16BE());
+  uint32_t b = static_cast<uint32_t>(ReadInt16LE()) << 16;
+  uint32_t a = static_cast<uint32_t>(ReadInt16LE());
+  return b | a;
 }

 }  // namespace RedatamLib

...and this seems to make the error vanish. I think I see the
misordering too. In the output of objdump -d
redatam.Rcheck/redatam/libs/redatam.so, I see:

0000000000267010 <_ZN10RedatamLib15ByteArrayReader11ReadInt16LEEv>:

  267028:       e8 93 6f f5 ff          call   1bdfc0 <_ZN10RedatamLib15ByteArrayReader8ReadByteEv at plt>
                                               first_byte <- ReadByte()
  26702d:       41 89 c4                mov    %eax,%r12d
                                               save first byte in r12
  26703d:       41 c1 e4 08             shl    $0x8,%r12d
                                               left-shift the first byte!
  267041:       e8 7a 6f f5 ff          call   1bdfc0 <_ZN10RedatamLib15ByteArrayReader8ReadByteEv at plt>
                                               second byte in eax
  26704a:       44 09 e0                or     %r12d,%eax
                                               OR them together

...which is how you read big-endian numbers, not little-endian ones.

--
Best regards,
Ivan

From edd @end|ng |rom deb|@n@org  Fri Nov 15 15:16:48 2024
From: edd @end|ng |rom deb|@n@org (Dirk Eddelbuettel)
Date: Fri, 15 Nov 2024 08:16:48 -0600
Subject: [R-pkg-devel] 
 Possible false negative for compiled C++ code in CRAN checks
In-Reply-To: <YT2PPFFFCD70057924C4ACF03BE9598A68EDD242@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
References: <YT2PPFFFCD7005701B25728913116FEEC8BDD5E2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241111124840.55248fa6@Tarkus>
 <YT2PPFFFCD70057CF5F7C2CA2439229E0B6DD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <YT2PPFFFCD700570537573F529D215EC62ADD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241112135634.44ceb4a9@arachnoid>
 <YT2PPFFFCD700574402F067CF21834F38FCDD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <QB1PPF4A6194682D335931D60BE683F6DB3DD592@QB1PPF4A6194682.CANPRD01.PROD.OUTLOOK.COM>
 <20241112233710.3b18c120@Tarkus>
 <YT2PPFFFCD700572D7D25315A5FFFD31378DD5B2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241115005043.1947995d@Tarkus>
 <YT2PPFFFCD70057924C4ACF03BE9598A68EDD242@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
Message-ID: <26423.22480.284011.754126@rob.eddelbuettel.com>


On 15 November 2024 at 12:16, Mauricio Vargas Sepulveda wrote:
| [...] and I now asked Dr. Ligges for the possibility to know more about the CRAN specific configuration to add it to R-Hub.

It is (and has always been) documented in a text file on the server 

   https://www.stats.ox.ac.uk/pub/bdr/memtests/README.txt

which is also referenced in a few places (but I forget where, I tend to go
back to my rocker san repos who have it too -- Google gets a few pages of
hits for the URL as a constant quoted string).

Dirk

-- 
dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org


From p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r  Sun Nov 17 14:04:56 2024
From: p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r (Patrick Giraudoux)
Date: Sun, 17 Nov 2024 14:04:56 +0100
Subject: [R-pkg-devel] update.packages Error in if (any(diff)) { : missing
 value where TRUE/FALSE needed
Message-ID: <90618185-a352-49c5-bf68-e4bc5d5b388a@univ-fcomte.fr>

Dear Listers,

Using R version 4.4.1 (2024-06-14 ucrt) package updates were done 
without any trouble up to now. Today I have this error:

(...)
trying URL 
'https://pbil.univ-lyon1.fr/CRAN/bin/windows/contrib/4.4/xfun_0.49.zip'
Content type 'application/zip' length 568935 bytes (555 KB)
downloaded 555 KB

Error in if (any(diff)) { : missing value where TRUE/FALSE needed

Subsequently I have upgraded to R version 4.4.2 (2024-10-31 ucrt), just 
in case, but get the same error when updating packages. [ 
update.packages(ask='graphics',checkBuilt=TRUE) ]

Any idea about what's happening and how to get a workaround ?

Kind regards,

Patrick


	[[alternative HTML version deleted]]


From |kry|ov @end|ng |rom d|@root@org  Sun Nov 17 14:17:31 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Sun, 17 Nov 2024 16:17:31 +0300
Subject: [R-pkg-devel] 
 update.packages Error in if (any(diff)) { : missing
 value where TRUE/FALSE needed
In-Reply-To: <90618185-a352-49c5-bf68-e4bc5d5b388a@univ-fcomte.fr>
References: <90618185-a352-49c5-bf68-e4bc5d5b388a@univ-fcomte.fr>
Message-ID: <20241117161731.7daf0722@Tarkus>

? Sun, 17 Nov 2024 14:04:56 +0100
Patrick Giraudoux <patrick.giraudoux at univ-fcomte.fr> ?????:

> trying URL 
> 'https://pbil.univ-lyon1.fr/CRAN/bin/windows/contrib/4.4/xfun_0.49.zip'
> Content type 'application/zip' length 568935 bytes (555 KB)
> downloaded 555 KB
> 
> Error in if (any(diff)) { : missing value where TRUE/FALSE needed

Looks like the code is failing in tools::checkMD5sums, but I'm not
seeing anything wrong with the package file. Can you set options(error
= recover) and take a look at the local variables at the site of the
error? What are the values of 'x', 'xx', 'nmxx'? What is your
sessionInfo()?

-- 
Best regards,
Ivan


From p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r  Sun Nov 17 14:23:45 2024
From: p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r (Patrick Giraudoux)
Date: Sun, 17 Nov 2024 14:23:45 +0100
Subject: [R-pkg-devel] 
 update.packages Error in if (any(diff)) { : missing
 value where TRUE/FALSE needed
In-Reply-To: <20241117161731.7daf0722@Tarkus>
References: <90618185-a352-49c5-bf68-e4bc5d5b388a@univ-fcomte.fr>
 <20241117161731.7daf0722@Tarkus>
Message-ID: <155f88c8-ee72-4dac-b44a-d109c4b38301@univ-fcomte.fr>

Le 17/11/2024 ? 14:17, Ivan Krylov a ?crit?:
> ? Sun, 17 Nov 2024 14:04:56 +0100
> Patrick Giraudoux<patrick.giraudoux at univ-fcomte.fr> ?????:
>
>> trying URL
>> 'https://pbil.univ-lyon1.fr/CRAN/bin/windows/contrib/4.4/xfun_0.49.zip'
>> Content type 'application/zip' length 568935 bytes (555 KB)
>> downloaded 555 KB
>>
>> Error in if (any(diff)) { : missing value where TRUE/FALSE needed
> Looks like the code is failing in tools::checkMD5sums, but I'm not
> seeing anything wrong with the package file. Can you set options(error
> = recover) and take a look at the local variables at the site of the
> error? What are the values of 'x', 'xx', 'nmxx'? What is your
> sessionInfo()?
>
I have tried updating packages one by one (I had a ten to update), and 
it appears that the trouble comes only with Rcpp

 > update.packages(ask='graphics',checkBuilt=TRUE)
trying URL 
'https://pbil.univ-lyon1.fr/CRAN/bin/windows/contrib/4.4/Rcpp_1.0.13-1.zip'
Content type 'application/zip' length 2895664 bytes (2.8 MB)
downloaded 2.8 MB

Error in if (any(diff)) { : missing value where TRUE/FALSE needed

	[[alternative HTML version deleted]]


From p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r  Sun Nov 17 14:45:58 2024
From: p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r (Patrick Giraudoux)
Date: Sun, 17 Nov 2024 14:45:58 +0100
Subject: [R-pkg-devel] 
 update.packages Error in if (any(diff)) { : missing
 value where TRUE/FALSE needed
In-Reply-To: <155f88c8-ee72-4dac-b44a-d109c4b38301@univ-fcomte.fr>
References: <90618185-a352-49c5-bf68-e4bc5d5b388a@univ-fcomte.fr>
 <20241117161731.7daf0722@Tarkus>
 <155f88c8-ee72-4dac-b44a-d109c4b38301@univ-fcomte.fr>
Message-ID: <60e8efbd-8172-4431-9670-0e4a50adc396@univ-fcomte.fr>

Le 17/11/2024 ? 14:23, Patrick Giraudoux a ?crit?:
> Le 17/11/2024 ? 14:17, Ivan Krylov a ?crit?:
>> ? Sun, 17 Nov 2024 14:04:56 +0100
>> Patrick Giraudoux<patrick.giraudoux at univ-fcomte.fr> ?????:
>>
>>> trying URL
>>> 'https://pbil.univ-lyon1.fr/CRAN/bin/windows/contrib/4.4/xfun_0.49.zip'
>>> Content type 'application/zip' length 568935 bytes (555 KB)
>>> downloaded 555 KB
>>>
>>> Error in if (any(diff)) { : missing value where TRUE/FALSE needed
>> Looks like the code is failing in tools::checkMD5sums, but I'm not
>> seeing anything wrong with the package file. Can you set options(error
>> = recover) and take a look at the local variables at the site of the
>> error? What are the values of 'x', 'xx', 'nmxx'? What is your
>> sessionInfo()?

 > update.packages(ask='graphics',checkBuilt=TRUE)
trying URL 
'https://pbil.univ-lyon1.fr/CRAN/bin/windows/contrib/4.4/Rcpp_1.0.13-1.zip'
Content type 'application/zip' length 2895664 bytes (2.8 MB)
downloaded 2.8 MB

Error in if (any(diff)) { : missing value where TRUE/FALSE needed

Enter a frame number, or 0 to exit

1: update.packages(ask = "graphics", checkBuilt = TRUE)
2: install.packages(update[instlib == l, "Package"], l, repos = repos, 
method
3: .install.winbinary(pkgs = bins, lib = lib, contriburl = 
contrib.url(repos,
4: unpackPkgZip(foundpkgs[okp, 2], foundpkgs[okp, 1], lib, libs_only, lock)
5: tools::checkMD5sums(pkgname, file.path(tmpDir, pkgname))

Selection: 5

Then I get x = a character of 658 elements, same for xx, same for nmxx

samples of x:

Browse[1]> x
announce/ANNOUNCE-0.10.0.txt
"7a9967333ad85931cc6d2051f4dff76e"
announce/ANNOUNCE-0.11.0.txt
"734d037a2ac31af4659fb3b2e1a778ad"
announce/ANNOUNCE-0.6.0.txt
"7d85af8d096e473821a3f001d3128b01"
announce/ANNOUNCE-0.7.0.txt
"f61c7e9e1460eac25702b24c1af30442"
announce/ANNOUNCE-0.8.0.txt
"a198e05a9b004dfc1f8ea67629f2f6c7"
announce/ANNOUNCE-0.9.0.txt
"3e8a171f22548f5da208b58e66b48e6c"
bib/Rcpp.bib
"5bd3c7b28163de3425999995f29915b0"

Sample of xx

Browse[1]> head(xx)
 ????????????????????????? CITATION DESCRIPTION
"7599bada89d38a2474389682f552755e" "bbff006b3170cdad3e2a120981df8888"
 ???????????????????????????? INDEX Meta/Rd.rds
"52f315c96cb329173cc129688e517054" "dba746be5650c6b32d55f18e7d136548"
 ???????????????? Meta/features.rds Meta/hsearch.rds
"cafa9c5a405f88a5d247e638c4e76607" "79ca316b5519b0916dc99824e0f53db7"

Sample of nmxx

Browse[1]> nmxx
 ? [1] "CITATION"
 ? [2] "DESCRIPTION"
 ? [3] "INDEX"
 ? [4] "Meta/Rd.rds"
 ? [5] "Meta/features.rds"
 ? [6] "Meta/hsearch.rds"
 ? [7] "Meta/links.rds"
 ? [8] "Meta/nsInfo.rds"
 ? [9] "Meta/package.rds"
 ?[10] "Meta/vignette.rds"
 ?[11] "NAMESPACE"
 ?[12] "NEWS.Rd"
 ?[13] "R/Rcpp"
 ?[14] "R/Rcpp.rdb"
 ?[15] "R/Rcpp.rdx"
 ?[16] "announce/ANNOUNCE-0.10.0.txt"
 ?[17] "announce/ANNOUNCE-0.11.0.txt"
 ?[18] "announce/ANNOUNCE-0.6.0.txt"
 ?[19] "announce/ANNOUNCE-0.7.0.txt"
 ?[20] "announce/ANNOUNCE-0.8.0.txt"
 ?[21] "announce/ANNOUNCE-0.9.0.txt"

	[[alternative HTML version deleted]]


From edd @end|ng |rom deb|@n@org  Sun Nov 17 14:47:59 2024
From: edd @end|ng |rom deb|@n@org (Dirk Eddelbuettel)
Date: Sun, 17 Nov 2024 07:47:59 -0600
Subject: [R-pkg-devel] 
 update.packages Error in if (any(diff)) { : missing
 value where TRUE/FALSE needed
In-Reply-To: <155f88c8-ee72-4dac-b44a-d109c4b38301@univ-fcomte.fr>
References: <90618185-a352-49c5-bf68-e4bc5d5b388a@univ-fcomte.fr>
 <20241117161731.7daf0722@Tarkus>
 <155f88c8-ee72-4dac-b44a-d109c4b38301@univ-fcomte.fr>
Message-ID: <26425.62479.62561.901074@rob.eddelbuettel.com>


On 17 November 2024 at 14:23, Patrick Giraudoux wrote:
| Le 17/11/2024 ? 14:17, Ivan Krylov a ?crit?:
| > ? Sun, 17 Nov 2024 14:04:56 +0100
| > Patrick Giraudoux<patrick.giraudoux at univ-fcomte.fr> ?????:
| >
| >> trying URL
| >> 'https://pbil.univ-lyon1.fr/CRAN/bin/windows/contrib/4.4/xfun_0.49.zip'
| >> Content type 'application/zip' length 568935 bytes (555 KB)
| >> downloaded 555 KB
| >>
| >> Error in if (any(diff)) { : missing value where TRUE/FALSE needed
| > Looks like the code is failing in tools::checkMD5sums, but I'm not
| > seeing anything wrong with the package file. Can you set options(error
| > = recover) and take a look at the local variables at the site of the
| > error? What are the values of 'x', 'xx', 'nmxx'? What is your
| > sessionInfo()?
| >
| I have tried updating packages one by one (I had a ten to update), and 
| it appears that the trouble comes only with Rcpp
| 
|  > update.packages(ask='graphics',checkBuilt=TRUE)
| trying URL 
| 'https://pbil.univ-lyon1.fr/CRAN/bin/windows/contrib/4.4/Rcpp_1.0.13-1.zip'
| Content type 'application/zip' length 2895664 bytes (2.8 MB)
| downloaded 2.8 MB

If it is Rcpp (I cannot check, I don't have Windows) it is apparently not the
U Lyon mirror as I get identical bits from cloud.r-project.org so it may be
that the PACKAGES file is temporarily inconsistent.

   $ wget -q -O Rcpp_1.0.13-1.zip.lyon https://pbil.univ-lyon1.fr/CRAN/bin/windows/contrib/4.4/Rcpp_1.0.13-1.zip
   $ wget -q -O Rcpp_1.0.13-1.zip.cdn https://cloud.r-project.org/bin/windows/contrib/4.4/Rcpp_1.0.13-1.zip
   $ ls -l Rcpp_1.0.13-1.zip.*
   -rw-rw-r-- 1 edd edd 2895664 Nov 12 21:44 Rcpp_1.0.13-1.zip.cdn
   -rw-rw-r-- 1 edd edd 2895664 Nov 12 21:44 Rcpp_1.0.13-1.zip.lyon
   $ md5sum Rcpp_1.0.13-1.zip.*
   1910629d7f209ffad2943c6e50cd4867  Rcpp_1.0.13-1.zip.cdn
   1910629d7f209ffad2943c6e50cd4867  Rcpp_1.0.13-1.zip.lyon
   $ 

In the meantime you can take advantage of alternate installation approaches

   - install from source, avoiding the .zip file

       install.packages("Rcpp", type="source")
      
   - install from r-universe accessing a different PACKAGES file:

       install.packages("Rcpp", repos = c("https://rcppcore.r-universe.dev",
                                          "https://cloud.r-project.org"))

Dirk

-- 
dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org


From |kry|ov @end|ng |rom d|@root@org  Sun Nov 17 14:54:51 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Sun, 17 Nov 2024 16:54:51 +0300
Subject: [R-pkg-devel] 
 update.packages Error in if (any(diff)) { : missing
 value where TRUE/FALSE needed
In-Reply-To: <60e8efbd-8172-4431-9670-0e4a50adc396@univ-fcomte.fr>
References: <90618185-a352-49c5-bf68-e4bc5d5b388a@univ-fcomte.fr>
 <20241117161731.7daf0722@Tarkus>
 <155f88c8-ee72-4dac-b44a-d109c4b38301@univ-fcomte.fr>
 <60e8efbd-8172-4431-9670-0e4a50adc396@univ-fcomte.fr>
Message-ID: <20241117165451.1c8cfa89@Tarkus>

? Sun, 17 Nov 2024 14:45:58 +0100
Patrick Giraudoux <patrick.giraudoux at univ-fcomte.fr> ?????:

> Then I get x = a character of 658 elements, same for xx, same for nmxx

Thank you for providing the information!

The problem is that the following code:

diff <- xx[nmxx] != x[nmxx]

...somehow gives missing values. What's in 'diff'? What is
nmxx[is.na(diff)]? What about x[nmxx[is.na(diff)]] and
xx[nmxx[is.na(diff)]]?

It looks like tools::md5sum() fails to open some of the files (and thus
returns NA). The cause of that may depend on which version of Windows
you're running and your locale settings, hence the need for the
sessionInfo() output.

-- 
Best regards,
Ivan


From p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r  Sun Nov 17 15:12:58 2024
From: p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r (Patrick Giraudoux)
Date: Sun, 17 Nov 2024 15:12:58 +0100
Subject: [R-pkg-devel] 
 update.packages Error in if (any(diff)) { : missing
 value where TRUE/FALSE needed
In-Reply-To: <20241117165451.1c8cfa89@Tarkus>
References: <90618185-a352-49c5-bf68-e4bc5d5b388a@univ-fcomte.fr>
 <20241117161731.7daf0722@Tarkus>
 <155f88c8-ee72-4dac-b44a-d109c4b38301@univ-fcomte.fr>
 <60e8efbd-8172-4431-9670-0e4a50adc396@univ-fcomte.fr>
 <20241117165451.1c8cfa89@Tarkus>
Message-ID: <9a549ada-93aa-4f27-806f-40a41a9c6378@univ-fcomte.fr>

Le 17/11/2024 ? 14:54, Ivan Krylov a ?crit?:
> ? Sun, 17 Nov 2024 14:45:58 +0100
> Patrick Giraudoux<patrick.giraudoux at univ-fcomte.fr> ?????:
>
>> Then I get x = a character of 658 elements, same for xx, same for nmxx
> Thank you for providing the information!
>
> The problem is that the following code:
>
> diff <- xx[nmxx] != x[nmxx]
>
> ...somehow gives missing values. What's in 'diff'? What is
> nmxx[is.na(diff)]? What about x[nmxx[is.na(diff)]] and
> xx[nmxx[is.na(diff)]]?
>
> It looks like tools::md5sum() fails to open some of the files (and thus
> returns NA). The cause of that may depend on which version of Windows
> you're running and your locale settings, hence the need for the
> sessionInfo() output.
>
Ups sorry, here you are:

 > sessionInfo()
R version 4.4.2 (2024-10-31 ucrt)
Platform: x86_64-w64-mingw32/x64
Running under: Windows 10 x64 (build 19045)

Matrix products: default


locale:
[1] LC_COLLATE=French_France.utf8? LC_CTYPE=French_France.utf8
[3] LC_MONETARY=French_France.utf8 LC_NUMERIC=C
[5] LC_TIME=French_France.utf8

time zone: Europe/Paris
tzcode source: internal

attached base packages:
[1] stats???? graphics? grDevices utils???? datasets? methods base

loaded via a namespace (and not attached):
[1] compiler_4.4.2

	[[alternative HTML version deleted]]


From p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r  Sun Nov 17 15:16:31 2024
From: p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r (Patrick Giraudoux)
Date: Sun, 17 Nov 2024 15:16:31 +0100
Subject: [R-pkg-devel] 
 update.packages Error in if (any(diff)) { : missing
 value where TRUE/FALSE needed
In-Reply-To: <26425.62479.62561.901074@rob.eddelbuettel.com>
References: <90618185-a352-49c5-bf68-e4bc5d5b388a@univ-fcomte.fr>
 <20241117161731.7daf0722@Tarkus>
 <155f88c8-ee72-4dac-b44a-d109c4b38301@univ-fcomte.fr>
 <26425.62479.62561.901074@rob.eddelbuettel.com>
Message-ID: <0bb65b8a-6557-4301-9fb7-4e8fa02bb478@univ-fcomte.fr>

Le 17/11/2024 ? 14:47, Dirk Eddelbuettel a ?crit?:
>
> In the meantime you can take advantage of alternate installation approaches
>
>     - install from source, avoiding the .zip file
>
>         install.packages("Rcpp", type="source")

it gives

  install.packages("Rcpp", type="source")
Installing package into ?C:/Users/pgiraudo2/AppData/Local/R/win-library/4.4?
(as ?lib? is unspecified)
trying URL 'https://pbil.univ-lyon1.fr/CRAN/src/contrib/Rcpp_1.0.13-1.tar.gz'
Content type 'application/x-gzip' length 3435726 bytes (3.3 MB)
downloaded 3.3 MB

* installing *source* package 'Rcpp' ...
Error in if (any(diff)) { : missing value where TRUE/FALSE needed
* removing 'C:/Users/pgiraudo2/AppData/Local/R/win-library/4.4/Rcpp'

The downloaded source packages are in
         ?C:\Users\pgiraudo2\AppData\Local\Temp\Rtmpe2xTmv\downloaded_packages?
Warning message:
In install.packages("Rcpp", type = "source") :
   installation of package ?Rcpp? had non-zero exit status

>        
>     - install from r-universe accessing a different PACKAGES file:
>
>         install.packages("Rcpp", repos = c("https://rcppcore.r-universe.dev",
>                                            "https://cloud.r-project.org"))
>
> Dirk
>
 > install.packages("Rcpp", repos = c("https://rcppcore.r-universe.dev",
+ "https://cloud.r-project.org"))
Installing package into ?C:/Users/pgiraudo2/AppData/Local/R/win-library/4.4?
(as ?lib? is unspecified)
trying URL 
'https://rcppcore.r-universe.dev/bin/windows/contrib/4.4/Rcpp_1.0.13.5.zip'
Content type 'application/zip' length 2913678 bytes (2.8 MB)
downloaded 2.8 MB

package ?Rcpp? successfully unpacked and MD5 sums checked

The downloaded binary packages are in
C:\Users\pgiraudo2\AppData\Local\Temp\Rtmpe2xTmv\downloaded_packages

Thus, this latter works fine. Does this help to identify the trouble ?

	[[alternative HTML version deleted]]


From |kry|ov @end|ng |rom d|@root@org  Sun Nov 17 15:24:46 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Sun, 17 Nov 2024 17:24:46 +0300
Subject: [R-pkg-devel] 
 update.packages Error in if (any(diff)) { : missing
 value where TRUE/FALSE needed
In-Reply-To: <9a549ada-93aa-4f27-806f-40a41a9c6378@univ-fcomte.fr>
References: <90618185-a352-49c5-bf68-e4bc5d5b388a@univ-fcomte.fr>
 <20241117161731.7daf0722@Tarkus>
 <155f88c8-ee72-4dac-b44a-d109c4b38301@univ-fcomte.fr>
 <60e8efbd-8172-4431-9670-0e4a50adc396@univ-fcomte.fr>
 <20241117165451.1c8cfa89@Tarkus>
 <9a549ada-93aa-4f27-806f-40a41a9c6378@univ-fcomte.fr>
Message-ID: <20241117172446.1fc43e7f@Tarkus>

? Sun, 17 Nov 2024 15:12:58 +0100
Patrick Giraudoux <patrick.giraudoux at univ-fcomte.fr> ?????:

> Running under: Windows 10 x64 (build 19045)

> locale:
> [1] LC_COLLATE=French_France.utf8? LC_CTYPE=French_France.utf8
> [3] LC_MONETARY=French_France.utf8 LC_NUMERIC=C
> [5] LC_TIME=French_France.utf8

Your system is new enough to use the UTF-8 locale and very long file
paths, so the problem must be elsewhere.

What are the files for which tools::md5sum() returns NA, causing
tools::checkMD5sums() to fail? Can you open them from outside R? If you
re-run tools::md5sum() from the debugger, does it return NA again?

-- 
Best regards,
Ivan


From edd @end|ng |rom deb|@n@org  Sun Nov 17 16:06:54 2024
From: edd @end|ng |rom deb|@n@org (Dirk Eddelbuettel)
Date: Sun, 17 Nov 2024 09:06:54 -0600
Subject: [R-pkg-devel] 
 update.packages Error in if (any(diff)) { : missing
 value where TRUE/FALSE needed
In-Reply-To: <0bb65b8a-6557-4301-9fb7-4e8fa02bb478@univ-fcomte.fr>
References: <90618185-a352-49c5-bf68-e4bc5d5b388a@univ-fcomte.fr>
 <20241117161731.7daf0722@Tarkus>
 <155f88c8-ee72-4dac-b44a-d109c4b38301@univ-fcomte.fr>
 <26425.62479.62561.901074@rob.eddelbuettel.com>
 <0bb65b8a-6557-4301-9fb7-4e8fa02bb478@univ-fcomte.fr>
Message-ID: <26426.1678.232171.399185@rob.eddelbuettel.com>


On 17 November 2024 at 15:16, Patrick Giraudoux wrote:
| Thus, this latter works fine. Does this help to identify the trouble ?

I think this resonates with the fine work Ivan had already done. I suspect
you have a bad local with the repo information (possible PACKAGE.rds) and it
does not get overwritten correctly making you "stuck" at that error. This
might explain why you fail for both binary and source mode for that (default)
repo.

Switching to a different repo, in this case a r-universe one, leads to a
different repo into file being used and avoids the error.

So as Ivan mentioned, you need to trace which file gets read where and see
why it fails. The trying to remove that file. 

Dirk

-- 
dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org


From p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r  Sun Nov 17 16:11:52 2024
From: p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r (Patrick Giraudoux)
Date: Sun, 17 Nov 2024 16:11:52 +0100
Subject: [R-pkg-devel] 
 update.packages Error in if (any(diff)) { : missing
 value where TRUE/FALSE needed
In-Reply-To: <20241117172446.1fc43e7f@Tarkus>
References: <90618185-a352-49c5-bf68-e4bc5d5b388a@univ-fcomte.fr>
 <20241117161731.7daf0722@Tarkus>
 <155f88c8-ee72-4dac-b44a-d109c4b38301@univ-fcomte.fr>
 <60e8efbd-8172-4431-9670-0e4a50adc396@univ-fcomte.fr>
 <20241117165451.1c8cfa89@Tarkus>
 <9a549ada-93aa-4f27-806f-40a41a9c6378@univ-fcomte.fr>
 <20241117172446.1fc43e7f@Tarkus>
Message-ID: <9bbb632a-e2a8-4033-ab96-9c90d5504703@univ-fcomte.fr>

Le 17/11/2024 ? 15:24, Ivan Krylov a ?crit?:
> ? Sun, 17 Nov 2024 15:12:58 +0100
> Patrick Giraudoux<patrick.giraudoux at univ-fcomte.fr> ?????:
>
>> Running under: Windows 10 x64 (build 19045)
>> locale:
>> [1] LC_COLLATE=French_France.utf8? LC_CTYPE=French_France.utf8
>> [3] LC_MONETARY=French_France.utf8 LC_NUMERIC=C
>> [5] LC_TIME=French_France.utf8
> Your system is new enough to use the UTF-8 locale and very long file
> paths, so the problem must be elsewhere.
>
> What are the files for which tools::md5sum() returns NA, causing
> tools::checkMD5sums() to fail? Can you open them from outside R? If you
> re-run tools::md5sum() from the debugger, does it return NA again?
>
Difficult for me to identify/locate the file that makes problem, since 
trials that Dirk Eddelbuettel have advised solved the problem (see 
previous mail). Then, I no longer have a way to reproduce the error. 
Will come back to the list with a careful approach based on your advise 
if the trouble occurs again at the next update.

Anyway, thanks for the care taken and your guidance,

Best,

Patrick

	[[alternative HTML version deleted]]


From p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r  Sun Nov 17 16:19:39 2024
From: p@tr|ck@g|r@udoux @end|ng |rom un|v-|comte@|r (Patrick Giraudoux)
Date: Sun, 17 Nov 2024 16:19:39 +0100
Subject: [R-pkg-devel] 
 update.packages Error in if (any(diff)) { : missing
 value where TRUE/FALSE needed
In-Reply-To: <26426.1678.232171.399185@rob.eddelbuettel.com>
References: <90618185-a352-49c5-bf68-e4bc5d5b388a@univ-fcomte.fr>
 <20241117161731.7daf0722@Tarkus>
 <155f88c8-ee72-4dac-b44a-d109c4b38301@univ-fcomte.fr>
 <26425.62479.62561.901074@rob.eddelbuettel.com>
 <0bb65b8a-6557-4301-9fb7-4e8fa02bb478@univ-fcomte.fr>
 <26426.1678.232171.399185@rob.eddelbuettel.com>
Message-ID: <35b81823-1e35-43c8-b6b0-822bbd528a75@univ-fcomte.fr>

Le 17/11/2024 ? 16:06, Dirk Eddelbuettel a ?crit?:
> On 17 November 2024 at 15:16, Patrick Giraudoux wrote:
> | Thus, this latter works fine. Does this help to identify the trouble ?
>
> I think this resonates with the fine work Ivan had already done. I suspect
> you have a bad local with the repo information (possible PACKAGE.rds) and it
> does not get overwritten correctly making you "stuck" at that error. This
> might explain why you fail for both binary and source mode for that (default)
> repo.
>
> Switching to a different repo, in this case a r-universe one, leads to a
> different repo into file being used and avoids the error.
>
> So as Ivan mentioned, you need to trace which file gets read where and see
> why it fails. The trying to remove that file.
>
> Dirk
>
Thanks Dirk. I am not enough used to the deep of R packages to be sure 
to fully understand where exactly I must find the file, but will do my 
best at the next occasion.

Best,

Patrick


	[[alternative HTML version deleted]]


From m@@epu|ved@ @end|ng |rom m@||@utoronto@c@  Sun Nov 17 23:38:23 2024
From: m@@epu|ved@ @end|ng |rom m@||@utoronto@c@ (Mauricio Vargas Sepulveda)
Date: Sun, 17 Nov 2024 22:38:23 +0000
Subject: [R-pkg-devel] 
 Possible false negative for compiled C++ code in CRAN checks
In-Reply-To: <YT2PPFFFCD70057924C4ACF03BE9598A68EDD242@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
References: <YT2PPFFFCD7005701B25728913116FEEC8BDD5E2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241111124840.55248fa6@Tarkus>
 <YT2PPFFFCD70057CF5F7C2CA2439229E0B6DD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <YT2PPFFFCD700570537573F529D215EC62ADD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241112135634.44ceb4a9@arachnoid>
 <YT2PPFFFCD700574402F067CF21834F38FCDD592@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <QB1PPF4A6194682D335931D60BE683F6DB3DD592@QB1PPF4A6194682.CANPRD01.PROD.OUTLOOK.COM>
 <20241112233710.3b18c120@Tarkus>
 <YT2PPFFFCD700572D7D25315A5FFFD31378DD5B2@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
 <20241115005043.1947995d@Tarkus>
 <YT2PPFFFCD70057924C4ACF03BE9598A68EDD242@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>
Message-ID: <YT2PPFFFCD70057AE65324805D4EB4DE9FCDD262@YT2PPFFFCD70057.CANPRD01.PROD.OUTLOOK.COM>

The issue was finally resolved and the package is back on CRAN!

Extensive try-and-fail is not the best with my advanced arthritis, but progress is progress

I added a small section with a minimal example here: https://cpp4r.org/08-debugging.html#testing-with-docker

This is a "nautical diary " I keep with a long collection of errors I found. My research is International Relations and Public Policy, so it is good to have a resource with all my Stackoverflow searches and questions in 1 place.

Best,


????

Mauricio "Pach??" Vargas Sep??lveda

PhD Student, Political Science
University of Toronto



________________________________
From: Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca>
Sent: November 15, 2024 7:16 AM
To: Ivan Krylov <ikrylov at disroot.org>
Cc: r-package-devel at r-project.org <r-package-devel at r-project.org>
Subject: Re: [R-pkg-devel] Possible false negative for compiled C++ code in CRAN checks

Dear R Developers,

I implemented Dr. Krylov's fix, and now redatam is back to CRAN (Point 1).

Dr. Eddelbuettel's suggestion about not fully mimicking CRAN gcc-san setup was also correct (Point 2).

Point 1:
- When the big endian issue was described here, I tried the s390x image from R-Hub, which does not work on my laptop. Then I went to a big endian server that we have at UofT and that reproduced the error!

Point 2:
- I was testing with docker.io/rocker/r-devel-san:latest, and I could not replicate the error.
- I ended up using the R-Hub image with https://github.com/r-hub/containers/pull/81#issuecomment-2478009166, and that replicated the error line by line.

Besides it, I implemented the same fix for the command line tool and the Python package. I also changed the example data by aggregating Uruguay's census to show some numbers. Just cutting the levels and show region/city is not informative. Being Redatam a closed format with no standard or specification, I ended up reading the census with my pkg, aggregating with dplyr, saving to CSV, and then converting back to Redatam with a point-and-click tool following an unofficial tutorial from You Tube. There is no easy way  to aggregate and save in the same format as we do with SPSS.

I added Dr. Krylov to ctb for this very useful fix! Thanks a lot to Dr. Krylov and Dr. Eddelbuettel for the suggestions, I was going in circles being unable to replicate the issue and I now asked Dr. Ligges for the possibility to know more about the CRAN specific configuration to add it to R-Hub.

Best,

????
Mauricio "Pach??" Vargas Sep??lveda
PhD Student, Political Science
University of Toronto


________________________________________
From: Ivan Krylov <ikrylov at disroot.org>
Sent: November 14, 2024 4:50 PM
To: Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca>
Cc: r-package-devel at r-project.org <r-package-devel at r-project.org>
Subject: Re: [R-pkg-devel] Possible false negative for compiled C++ code in CRAN checks

?? Thu, 14 Nov 2024 16:24:16 +0000
Mauricio Vargas Sepulveda <m.sepulveda at mail.utoronto.ca> ??????:

> After enabling the SAN flags, I cannot reproduce the gcc-san error
> [2].

Can you use the rocker/r-devel-san container? It reproduces the problem
for me.

When reading galapagos/cg15.dic, FuzzyEntityParser::ParseEntities()
keeps advancing over the file and failing to parse a single entity
until it eventually calls stop() because it didn't find any entities.

In a non-sanitized build, it first succeeds at 0-based offset 1095. In
a sanitized build, it fails for all offsets. I think this is due to the
ordering of the byte reads:
https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2Fpachadotdev%2Fopen-redatam%2Fblob%2Fbbb65242f1af5f601def1c0b971ed601d459b4f3%2Fsrc%2Freaders%2FByteArrayReader.cpp%23L176-L192&data=05%7C02%7Cm.sepulveda%40mail.utoronto.ca%7C762907f4ee8f46c7f59b08dd04f667a8%7C78aac2262f034b4d9037b46d56c55210%7C0%7C0%7C638672178560868627%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=O8Cjgp1m%2FqQc7CAKWOl%2F6IMcAi0cIhCFnFUY7x%2FYdhU%3D&reserved=0<https://github.com/pachadotdev/open-redatam/blob/bbb65242f1af5f601def1c0b971ed601d459b4f3/src/readers/ByteArrayReader.cpp#L176-L192>

In C++, an operation like the following:

static_cast<uint16_t>(ReadByte()) << 8 |
static_cast<uint16_t>(ReadByte());

...depends on the order in which the compiler will choose to evaluate
the calls to static_cast<uint16_t>(ReadByte()), and this order is not
guaranteed to be left-to-right:
https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fen.cppreference.com%2Fw%2Fcpp%2Flanguage%2Feval_order&data=05%7C02%7Cm.sepulveda%40mail.utoronto.ca%7C762907f4ee8f46c7f59b08dd04f667a8%7C78aac2262f034b4d9037b46d56c55210%7C0%7C0%7C638672178560885711%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=8k0RVuOCfXwzh72IjVkzKy0yq1uM1bHZc7OBgAhKe9w%3D&reserved=0<https://en.cppreference.com/w/cpp/language/eval_order>

I edited all four byte-reading functions and replaced the one-statement
operations with separate statements for each of the byte reads:

--- redatam.orig/src/redatamlib/readers/ByteArrayReader.cpp     2024-11-09 02:12:17.000000000 +0000
+++ redatam.new/src/redatamlib/readers/ByteArrayReader.cpp      2024-11-14 21:25:54.000000000 +0000
@@ -175,23 +175,27 @@
 }

 uint16_t ByteArrayReader::ReadInt16LE() {
-  return static_cast<uint16_t>(ReadByte()) |
-         (static_cast<uint16_t>(ReadByte()) << 8);
+  uint16_t a = static_cast<uint16_t>(ReadByte());
+  uint16_t b = static_cast<uint16_t>(ReadByte()) << 8;
+  return a | b;
 }

 uint32_t ByteArrayReader::ReadInt32LE() {
-  return static_cast<uint32_t>(ReadInt16LE()) |
-         static_cast<uint32_t>(ReadInt16LE()) << 16;
+  uint32_t a = static_cast<uint32_t>(ReadInt16LE());
+  uint32_t b = static_cast<uint32_t>(ReadInt16LE()) << 16;
+  return a | b;
 }

 uint16_t ByteArrayReader::ReadInt16BE() {
-  return (static_cast<uint16_t>(ReadByte()) << 8) |
-         static_cast<uint16_t>(ReadByte());
+ uint16_t a= (static_cast<uint16_t>(ReadByte()) << 8);
+ uint16_t b= static_cast<uint16_t>(ReadByte());
+ return a| b;
 }

 uint32_t ByteArrayReader::ReadInt32BE() {
-  return (static_cast<uint32_t>(ReadInt16BE()) << 16) |
-         static_cast<uint32_t>(ReadInt16BE());
+  uint32_t b = static_cast<uint32_t>(ReadInt16LE()) << 16;
+  uint32_t a = static_cast<uint32_t>(ReadInt16LE());
+  return b | a;
 }

 }  // namespace RedatamLib

...and this seems to make the error vanish. I think I see the
misordering too. In the output of objdump -d
redatam.Rcheck/redatam/libs/redatam.so, I see:

0000000000267010 <_ZN10RedatamLib15ByteArrayReader11ReadInt16LEEv>:

  267028:       e8 93 6f f5 ff          call   1bdfc0 <_ZN10RedatamLib15ByteArrayReader8ReadByteEv at plt>
                                               first_byte <- ReadByte()
  26702d:       41 89 c4                mov    %eax,%r12d
                                               save first byte in r12
  26703d:       41 c1 e4 08             shl    $0x8,%r12d
                                               left-shift the first byte!
  267041:       e8 7a 6f f5 ff          call   1bdfc0 <_ZN10RedatamLib15ByteArrayReader8ReadByteEv at plt>
                                               second byte in eax
  26704a:       44 09 e0                or     %r12d,%eax
                                               OR them together

...which is how you read big-endian numbers, not little-endian ones.

--
Best regards,
Ivan

	[[alternative HTML version deleted]]


From rodr|go @end|ng |rom borge@@net@br  Mon Nov 18 20:31:21 2024
From: rodr|go @end|ng |rom borge@@net@br (Rodrigo Borges)
Date: Mon, 18 Nov 2024 16:31:21 -0300
Subject: [R-pkg-devel] Fwd: [CRAN-pretest-archived] CRAN Submission sidra
 0.1.3
In-Reply-To: <01db34ea$Blat.v3.2.24$ec2b08aa$76ec4db3@mail.statistik.tu-dortmund.de>
References: <01db34ea$Blat.v3.2.24$ec2b08aa$76ec4db3@mail.statistik.tu-dortmund.de>
Message-ID: <81060989-720D-4FE0-8DEC-5B18FDBEB771@borges.net.br>

Dear all,

I would like to erase one last doubt about the unique note that has been generated after fixing / improving the package documentation.

The only note that is left is:

   * checking CRAN incoming feasibility ... NOTE
   Maintainer: 'Rodrigo Emmanuel Santana Borges<rodrigo at borges.net.br>'

   New submission

I did online research, and it seems this could be ignored. Is it so? This would be last thing to confirm before re-submitting to CRAN.

Thanks in advance for the initiative, your time and kindess.

Best Regards,

Rodrigo Borges

-------- Forwarded Message --------
Subject: 	[CRAN-pretest-archived] CRAN Submission sidra 0.1.3
Date: 	Tue, 12 Nov 2024 11:09:12 +0100
From: 	ligges at statistik.tu-dortmund.de
Reply-To: 	CRAN-submissions at R-project.org
To: 	rodrigo at borges.net.br
CC: 	CRAN-submissions at R-project.org



Dear maintainer,
package sidra_0.1.3.tar.gz does not pass the incoming checks automatically, please see the following pre-tests (additional issue checks):
Windows: <https://win-builder.r-project.org/incoming_pretest/sidra_0.1.3_20241112_031351/Windows/00check.log>
Status: 2 NOTEs
Debian: <https://win-builder.r-project.org/incoming_pretest/sidra_0.1.3_20241112_031351/Debian/00check.log>
Status: 2 NOTEs

Please fix all problems and resubmit a fixed version via the webform.
If you are not sure how to fix the problems shown, please ask for help on the R-package-devel mailing list:
<https://stat.ethz.ch/mailman/listinfo/r-package-devel>
If you are fairly certain the rejection is a false positive, please reply-all to this message and explain.
More details are given in the directory:
<https://win-builder.r-project.org/incoming_pretest/sidra_0.1.3_20241112_031351/>
The files will be removed after roughly 7 days.
No strong reverse dependencies to be checked.
Best regards,
CRAN teams' auto-check service

-- 
Rodrigo Emmanuel Santana Borges
Doutor em Economia pela Universidad Complutense de Madrid
P?s-doutor em Pol?tica Social - PPGPS/UFES
Consultor no Minist?rio da Sa?de
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: Attached Message Part
URL: <https://stat.ethz.ch/pipermail/r-package-devel/attachments/20241118/1988a737/attachment.ksh>

From |kry|ov @end|ng |rom d|@root@org  Tue Nov 19 08:25:39 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Tue, 19 Nov 2024 10:25:39 +0300
Subject: [R-pkg-devel] 
 Fwd: [CRAN-pretest-archived] CRAN Submission sidra 0.1.3
In-Reply-To: <81060989-720D-4FE0-8DEC-5B18FDBEB771@borges.net.br>
References: <01db34ea$Blat.v3.2.24$ec2b08aa$76ec4db3@mail.statistik.tu-dortmund.de>
 <81060989-720D-4FE0-8DEC-5B18FDBEB771@borges.net.br>
Message-ID: <20241119102539.077d1973@Tarkus>

? Mon, 18 Nov 2024 16:31:21 -0300
Rodrigo Borges <rodrigo at borges.net.br> ?????:

> The only note that is left is:
> 
>    * checking CRAN incoming feasibility ... NOTE
>    Maintainer: 'Rodrigo Emmanuel Santana
> Borges<rodrigo at borges.net.br>'
> 
>    New submission
> 
> I did online research, and it seems this could be ignored. Is it so?

Yes. It's for the CRAN maintainers to perform a manual review of the
new package. Good luck!

-- 
Best regards,
Ivan


From pro|jcn@@h @end|ng |rom gm@||@com  Tue Nov 19 14:41:40 2024
From: pro|jcn@@h @end|ng |rom gm@||@com (J C Nash)
Date: Tue, 19 Nov 2024 08:41:40 -0500
Subject: [R-pkg-devel] Closing a display window from a program
Message-ID: <85fc6478-bc49-402d-8205-1e9aa5467f72@gmail.com>

In answer to my own posting about this, I found the following partially
answers what I need.

The task is to display a file (in my case a pdf, for which 'xdisp' contains
the string for the command to do this. See below for the reason this is a
variable. The displayed file has information I will need to possibly enter
into other program structures and which may be in the form of pixels rather
than text or numbers. Later, I wish to close the display when the need is past.
Clearly, that step could be left to the user, but I believe in decluttering
the screen as much as I can.


   cmd<-cmd <- paste0(xdisp," ",xdocfn," &") # add & to keep running and return??
   system(cmd)
   pidcmd<-paste0("pgrep -f '",cmd,"'")
   spid<-system(pidcmd, intern=TRUE) # gets spid, but stays running
   # For some reason increased by 1
   spid<-as.integer(spid)-1

Later on I can close the display with

# Kill the display of the statement now.
   tmp<-readline("Kill the bill display process now")
   kcmd<-paste0("kill -9 ",spid)

Clearly I'm on a Linux system (Mint 22 Wilma) I've not considered how I'd do this
in Windows, but would welcome suggestions as I believe cross-platform solutions
widen the utility of any software. I also looked at the CRAN package ps, and found
there are ways to use some of its tools. They may, in fact, be more system-neutral,
so are still on my radar for consideration.

My posting asked also if the display could be controlled as to position and size.
I have not yet found how to do that, but have found choice of the pdf display
program a partial help. I am currently setting xdisp to xpdf in an "ini" file,
for which the CRAN package ini is most helpful.

For information, I put below a solution to an Rstudio matter that arose.

Comments and discussion welcome.

Best,

John Nash

PS. In building this code in Rstudio and using browseURL(file) to open the display,
I got a warning error about "signal 10". This can be overcome by using
browseURL(file, browser="xdg-open"). However, "file" must be either a simple
filename of a file in the current directory, or a fully qualified path. Use
of the shortcut "~/" for the home directory fails. This issue does not arise
for R in a terminal.


From murdoch@dunc@n @end|ng |rom gm@||@com  Tue Nov 19 15:01:09 2024
From: murdoch@dunc@n @end|ng |rom gm@||@com (Duncan Murdoch)
Date: Tue, 19 Nov 2024 09:01:09 -0500
Subject: [R-pkg-devel] Simple way to run code during package install
Message-ID: <c466e189-cc41-4cfd-883c-64a15108c333@gmail.com>

I have some code in rgl and rgl2gltf that should be run during the 
package install process, and not later.  (It's a call to 
rgl::makeDependency, which does some stuff with Javascript files and 
writes into the package installation directory, saving the paths of the 
files it wrote.)

Currently rgl handles this by simply placing calls to makeDependency in 
one of the .R files, relying on the fact that they are run at install 
time and not later. It creates rgl:::rglDependency and another similar 
object.  That works fine.

Tomas just pointed out to me that rgl2gltf is trying to modify its 
installation location after installation.  This is happening because it 
calls makeDependency in a function the user can call, and that's bad, so 
I'm fixing it.

The problem is that rgl2gltf uses Roxygen for documentation, and Roxygen 
executes all the code in the package when it is producing Rd files. 
(Normally this just creates the functions in the package, it doesn't 
actually call them, so it's harmless.  But calling makeDependency from 
Roxygen fails because I wasn't expecting that.)

So I'd like to ask for suggestions for the simplest way to deal with 
this in rgl2gltf.

1. One choice is to fix rgl::makeDependency so it can tell that it is 
being run after installation, and stop trying to write any files.  It 
should just return the object.  I can probably do this, but I've just 
had two rgl releases in the last few weeks, so I'd prefer to limit the 
changes to rgl2gltf.

2. I can use pkgload::is_loading() to detect the load_all() call from 
Roxygen and not run makeDependency in that situation.  But that forces a 
dependence on pkgload, and that's not very appealing.

3. Maybe I can mark the file that contains the makeDependency call so 
that Roxygen ignores it.  Is that possible?

4. I can write a Makevars file that runs makeDependency.  That seems
like a pretty heavyweight solution, especially since I need to save the 
result of the call so it is available later.

Does anyone else have this problem, and a nice solution for it?

Duncan Murdoch


From murdoch@dunc@n @end|ng |rom gm@||@com  Tue Nov 19 15:20:33 2024
From: murdoch@dunc@n @end|ng |rom gm@||@com (Duncan Murdoch)
Date: Tue, 19 Nov 2024 09:20:33 -0500
Subject: [R-pkg-devel] Simple way to run code during package install
In-Reply-To: <c466e189-cc41-4cfd-883c-64a15108c333@gmail.com>
References: <c466e189-cc41-4cfd-883c-64a15108c333@gmail.com>
Message-ID: <492d36a9-2a23-46c3-96c1-a5b972c882d9@gmail.com>

I think I have a solution.  Roxygen2 allows this option to be specified 
in the DESCRIPTION file:

   Roxygen: list(markdown = TRUE, load = "installed")

With the `load = "installed"` setting, it doesn't try to run the .R files.

Duncan Murdoch

On 2024-11-19 9:01 a.m., Duncan Murdoch wrote:
> I have some code in rgl and rgl2gltf that should be run during the
> package install process, and not later.  (It's a call to
> rgl::makeDependency, which does some stuff with Javascript files and
> writes into the package installation directory, saving the paths of the
> files it wrote.)
> 
> Currently rgl handles this by simply placing calls to makeDependency in
> one of the .R files, relying on the fact that they are run at install
> time and not later. It creates rgl:::rglDependency and another similar
> object.  That works fine.
> 
> Tomas just pointed out to me that rgl2gltf is trying to modify its
> installation location after installation.  This is happening because it
> calls makeDependency in a function the user can call, and that's bad, so
> I'm fixing it.
> 
> The problem is that rgl2gltf uses Roxygen for documentation, and Roxygen
> executes all the code in the package when it is producing Rd files.
> (Normally this just creates the functions in the package, it doesn't
> actually call them, so it's harmless.  But calling makeDependency from
> Roxygen fails because I wasn't expecting that.)
> 
> So I'd like to ask for suggestions for the simplest way to deal with
> this in rgl2gltf.
> 
> 1. One choice is to fix rgl::makeDependency so it can tell that it is
> being run after installation, and stop trying to write any files.  It
> should just return the object.  I can probably do this, but I've just
> had two rgl releases in the last few weeks, so I'd prefer to limit the
> changes to rgl2gltf.
> 
> 2. I can use pkgload::is_loading() to detect the load_all() call from
> Roxygen and not run makeDependency in that situation.  But that forces a
> dependence on pkgload, and that's not very appealing.
> 
> 3. Maybe I can mark the file that contains the makeDependency call so
> that Roxygen ignores it.  Is that possible?
> 
> 4. I can write a Makevars file that runs makeDependency.  That seems
> like a pretty heavyweight solution, especially since I need to save the
> result of the call so it is available later.
> 
> Does anyone else have this problem, and a nice solution for it?
> 
> Duncan Murdoch
>


From @ergue|@@oko| @end|ng |rom gm@||@com  Tue Nov 19 16:13:40 2024
From: @ergue|@@oko| @end|ng |rom gm@||@com (Serguei Sokol)
Date: Tue, 19 Nov 2024 16:13:40 +0100
Subject: [R-pkg-devel] Closing a display window from a program
In-Reply-To: <85fc6478-bc49-402d-8205-1e9aa5467f72@gmail.com>
References: <85fc6478-bc49-402d-8205-1e9aa5467f72@gmail.com>
Message-ID: <425001c6-662a-4a92-a071-1b0875d3d28f@gmail.com>

Le 19/11/2024 ? 14:41, J C Nash a ?crit?:
> In answer to my own posting about this, I found the following partially
> answers what I need.
> 
> The task is to display a file (in my case a pdf, for which 'xdisp' contains
> the string for the command to do this. See below for the reason this is a
> variable. The displayed file has information I will need to possibly enter
> into other program structures and which may be in the form of pixels rather
> than text or numbers. Later, I wish to close the display when the need 
> is past.
> Clearly, that step could be left to the user, but I believe in decluttering
> the screen as much as I can.
> 
> 
>  ? cmd<-cmd <- paste0(xdisp," ",xdocfn," &") # add & to keep running and 
> return??
>  ? system(cmd)
>  ? pidcmd<-paste0("pgrep -f '",cmd,"'")
>  ? spid<-system(pidcmd, intern=TRUE) # gets spid, but stays running
>  ? # For some reason increased by 1
>  ? spid<-as.integer(spid)-1
> 
> Later on I can close the display with
> 
> # Kill the display of the statement now.
>  ? tmp<-readline("Kill the bill display process now")
>  ? kcmd<-paste0("kill -9 ",spid)
> 
> Clearly I'm on a Linux system (Mint 22 Wilma) I've not considered how 
> I'd do this
> in Windows, but would welcome suggestions as I believe cross-platform 
> solutions
> widen the utility of any software. I also looked at the CRAN package ps, 
> and found
> there are ways to use some of its tools. They may, in fact, be more 
> system-neutral,
> so are still on my radar for consideration.
> 
> My posting asked also if the display could be controlled as to position 
> and size.
> I have not yet found how to do that, but have found choice of the pdf 
> display
> program a partial help. I am currently setting xdisp to xpdf in an "ini" 
> file,
> for which the CRAN package ini is most helpful.
> 
> For information, I put below a solution to an Rstudio matter that arose.
> 
> Comments and discussion welcome.
> 
> Best,
> 
> John Nash
> 
> PS. In building this code in Rstudio and using browseURL(file) to open 
> the display,
> I got a warning error about "signal 10". This can be overcome by using
> browseURL(file, browser="xdg-open"). However, "file" must be either a 
> simple
> filename of a file in the current directory, or a fully qualified path. Use
> of the shortcut "~/" for the home directory fails.
may be path.exapnd()?
 > path.expand("~/tmp/my.pdf")
[1] "/home/sokol/tmp/my.pdf"


> This issue does not 
> arise
> for R in a terminal.
> 
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From t@ph@m @end|ng |rom @m@terd@mumc@n|  Tue Nov 26 11:18:42 2024
From: t@ph@m @end|ng |rom @m@terd@mumc@n| (Pham, T.V.)
Date: Tue, 26 Nov 2024 10:18:42 +0000
Subject: [R-pkg-devel] libarrow
Message-ID: <AM9P193MB09814E2B93D7EA7CACEA6457972F2@AM9P193MB0981.EURP193.PROD.OUTLOOK.COM>

Dear all,

I am planning to use libarrow for reading parquet files, chunk by chunk. It seems that by installing "arrow", one gets the libarrow library too (at least on Windows).

I wonder if the C++ header files are already in some package like Rcpp. Also, how should the link to the libarrow look like?

Thank you & best regards,
Thang

______________________________________________________
AmsterdamUMC disclaimer : www.amsterdamumc.org/nl/disclaimers.htm


From tom@@@k@||ber@ @end|ng |rom gm@||@com  Tue Nov 26 12:10:47 2024
From: tom@@@k@||ber@ @end|ng |rom gm@||@com (Tomas Kalibera)
Date: Tue, 26 Nov 2024 12:10:47 +0100
Subject: [R-pkg-devel] libarrow
In-Reply-To: <AM9P193MB09814E2B93D7EA7CACEA6457972F2@AM9P193MB0981.EURP193.PROD.OUTLOOK.COM>
References: <AM9P193MB09814E2B93D7EA7CACEA6457972F2@AM9P193MB0981.EURP193.PROD.OUTLOOK.COM>
Message-ID: <1989b439-df81-4f7e-aee8-718124441db6@gmail.com>

On 11/26/24 11:18, Pham, T.V. via R-package-devel wrote:
> Dear all,
>
> I am planning to use libarrow for reading parquet files, chunk by chunk. It seems that by installing "arrow", one gets the libarrow library too (at least on Windows).

On Windows, to properly use Apache Arrow with R, it would have to be 
added to Rtools (and hence ideally first upstream to MXE). I've been in 
touch with two arrow developers who started working on adding libarrow 
to MXE, but then ran out of time. If there were any volunteers to finish 
this, perhaps its best to check first with the arrow team where they 
got, rather than starting from scratch.

Best
Tomas

>
> I wonder if the C++ header files are already in some package like Rcpp. Also, how should the link to the libarrow look like?
>
> Thank you & best regards,
> Thang
>
> ______________________________________________________
> AmsterdamUMC disclaimer : www.amsterdamumc.org/nl/disclaimers.htm
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From brycemecum @end|ng |rom gm@||@com  Tue Nov 26 20:45:38 2024
From: brycemecum @end|ng |rom gm@||@com (Bryce Mecum)
Date: Tue, 26 Nov 2024 11:45:38 -0800
Subject: [R-pkg-devel] libarrow
In-Reply-To: <1989b439-df81-4f7e-aee8-718124441db6@gmail.com>
References: <AM9P193MB09814E2B93D7EA7CACEA6457972F2@AM9P193MB0981.EURP193.PROD.OUTLOOK.COM>
 <1989b439-df81-4f7e-aee8-718124441db6@gmail.com>
Message-ID: <CAKvA_=ptW=zkBv=1pHWc0cg8iF32aEQvAHR8y9xWwfDXSVkAkw@mail.gmail.com>

The work in progress to add libarrow to MXE is located at [1]. I don't
think it's complete but I'm sharing it here in case it's a useful
starting point for someone. Continuing this work would be welcome.

Thang: Feel free to file an issue on the Arrow issue tracker [2] or
email the user@ mailing list [3] if you get stuck.

[1] https://github.com/assignUser/cran-mxe
[2] https://github.com/apache/arrow/issues
[3] https://arrow.apache.org/community/

On Tue, Nov 26, 2024 at 3:11?AM Tomas Kalibera <tomas.kalibera at gmail.com> wrote:
>
> On 11/26/24 11:18, Pham, T.V. via R-package-devel wrote:
> > Dear all,
> >
> > I am planning to use libarrow for reading parquet files, chunk by chunk. It seems that by installing "arrow", one gets the libarrow library too (at least on Windows).
>
> On Windows, to properly use Apache Arrow with R, it would have to be
> added to Rtools (and hence ideally first upstream to MXE). I've been in
> touch with two arrow developers who started working on adding libarrow
> to MXE, but then ran out of time. If there were any volunteers to finish
> this, perhaps its best to check first with the arrow team where they
> got, rather than starting from scratch.
>
> Best
> Tomas
>
> >
> > I wonder if the C++ header files are already in some package like Rcpp. Also, how should the link to the libarrow look like?
> >
> > Thank you & best regards,
> > Thang
> >
> > ______________________________________________________
> > AmsterdamUMC disclaimer : www.amsterdamumc.org/nl/disclaimers.htm
> >
> > ______________________________________________
> > R-package-devel at r-project.org mailing list
> > https://stat.ethz.ch/mailman/listinfo/r-package-devel
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From t@ph@m @end|ng |rom @m@terd@mumc@n|  Wed Nov 27 16:01:30 2024
From: t@ph@m @end|ng |rom @m@terd@mumc@n| (Pham, T.V.)
Date: Wed, 27 Nov 2024 15:01:30 +0000
Subject: [R-pkg-devel] libarrow
Message-ID: <AM9P193MB09810DE9E64C36E516DCD00A97282@AM9P193MB0981.EURP193.PROD.OUTLOOK.COM>

It is clear. Thank you very much.

Thang

-----Original Message-----
From: R-package-devel <r-package-devel-bounces at r-project.org> On Behalf Of r-package-devel-request at r-project.org
Sent: Wednesday, November 27, 2024 12:00 PM
To: r-package-devel at r-project.org
Subject: R-package-devel Digest, Vol 115, Issue 19

Send R-package-devel mailing list submissions to
        r-package-devel at r-project.org

To subscribe or unsubscribe via the World Wide Web, visit
        https://stat.ethz.ch/mailman/listinfo/r-package-devel
or, via email, send a message with subject or body 'help' to
        r-package-devel-request at r-project.org

You can reach the person managing the list at
        r-package-devel-owner at r-project.org

When replying, please edit your Subject line so it is more specific than "Re: Contents of R-package-devel digest..."


Today's Topics:

   1. Re: libarrow (Tomas Kalibera)

----------------------------------------------------------------------

Message: 1
Date: Tue, 26 Nov 2024 12:10:47 +0100
From: Tomas Kalibera <tomas.kalibera at gmail.com>
To: r-package-devel at r-project.org
Subject: Re: [R-pkg-devel] libarrow
Message-ID: <1989b439-df81-4f7e-aee8-718124441db6 at gmail.com>
Content-Type: text/plain; charset="utf-8"; Format="flowed"

On 11/26/24 11:18, Pham, T.V. via R-package-devel wrote:
> Dear all,
>
> I am planning to use libarrow for reading parquet files, chunk by chunk. It seems that by installing "arrow", one gets the libarrow library too (at least on Windows).

On Windows, to properly use Apache Arrow with R, it would have to be added to Rtools (and hence ideally first upstream to MXE). I've been in touch with two arrow developers who started working on adding libarrow to MXE, but then ran out of time. If there were any volunteers to finish this, perhaps its best to check first with the arrow team where they got, rather than starting from scratch.

Best
Tomas

>
> I wonder if the C++ header files are already in some package like Rcpp. Also, how should the link to the libarrow look like?
>
> Thank you & best regards,
> Thang
>
> ______________________________________________________
> AmsterdamUMC disclaimer : http://www.amsterdamumc.org/nl/disclaimers.htm
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel




------------------------------

Subject: Digest Footer

_______________________________________________
R-package-devel mailing list
R-package-devel at r-project.org
https://stat.ethz.ch/mailman/listinfo/r-package-devel


------------------------------

End of R-package-devel Digest, Vol 115, Issue 19


From dewey @end|ng |rom dunn|ngton@c@  Thu Nov 28 04:34:21 2024
From: dewey @end|ng |rom dunn|ngton@c@ (Dewey Dunnington)
Date: Wed, 27 Nov 2024 23:34:21 -0400
Subject: [R-pkg-devel] libarrow
In-Reply-To: <CAKvA_=ptW=zkBv=1pHWc0cg8iF32aEQvAHR8y9xWwfDXSVkAkw@mail.gmail.com>
References: <AM9P193MB09814E2B93D7EA7CACEA6457972F2@AM9P193MB0981.EURP193.PROD.OUTLOOK.COM>
 <1989b439-df81-4f7e-aee8-718124441db6@gmail.com>
 <CAKvA_=ptW=zkBv=1pHWc0cg8iF32aEQvAHR8y9xWwfDXSVkAkw@mail.gmail.com>
Message-ID: <b6030a6bf1c84b273843809e8eb1e12d@dunnington.ca>

I'll also add that you can write R level code that processes files 
lazily chunk-by-chunk
using arrow::open_dataset() |> arrow::map_batches(), and that you can 
write
C level code that processes batches chunk-by-chunk using 
arrow::open_dataset() |>
nanoarrow::as_nanoarrow_array_stream(), which will give you a pointer to
an ABI stable ArrowArrayStream that you can pass between packages 
(helpers
exist in the Arrow rust implementation and the nanoarrow C/C++ library 
to help
consume that, and I'm happy to work up an example if you are 
interested).

Cheers,

-dewey

On 2024-11-26 15:45, Bryce Mecum wrote:
> The work in progress to add libarrow to MXE is located at [1]. I don't
> think it's complete but I'm sharing it here in case it's a useful
> starting point for someone. Continuing this work would be welcome.
> 
> Thang: Feel free to file an issue on the Arrow issue tracker [2] or
> email the user@ mailing list [3] if you get stuck.
> 
> [1] https://github.com/assignUser/cran-mxe
> [2] https://github.com/apache/arrow/issues
> [3] https://arrow.apache.org/community/
> 
> On Tue, Nov 26, 2024 at 3:11?AM Tomas Kalibera 
> <tomas.kalibera at gmail.com> wrote:
>> 
>> On 11/26/24 11:18, Pham, T.V. via R-package-devel wrote:
>> > Dear all,
>> >
>> > I am planning to use libarrow for reading parquet files, chunk by chunk. It seems that by installing "arrow", one gets the libarrow library too (at least on Windows).
>> 
>> On Windows, to properly use Apache Arrow with R, it would have to be
>> added to Rtools (and hence ideally first upstream to MXE). I've been 
>> in
>> touch with two arrow developers who started working on adding libarrow
>> to MXE, but then ran out of time. If there were any volunteers to 
>> finish
>> this, perhaps its best to check first with the arrow team where they
>> got, rather than starting from scratch.
>> 
>> Best
>> Tomas
>> 
>> >
>> > I wonder if the C++ header files are already in some package like Rcpp. Also, how should the link to the libarrow look like?
>> >
>> > Thank you & best regards,
>> > Thang
>> >
>> > ______________________________________________________
>> > AmsterdamUMC disclaimer : www.amsterdamumc.org/nl/disclaimers.htm
>> >
>> > ______________________________________________
>> > R-package-devel at r-project.org mailing list
>> > https://stat.ethz.ch/mailman/listinfo/r-package-devel
>> 
>> ______________________________________________
>> R-package-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-package-devel
> 
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From @pencer@gr@ve@ @end|ng |rom e||ect|vede|en@e@org  Sun Dec  1 23:53:04 2024
From: @pencer@gr@ve@ @end|ng |rom e||ect|vede|en@e@org (Spencer Graves)
Date: Sun, 1 Dec 2024 16:53:04 -0600
Subject: [R-pkg-devel] roxygen2 and .Rbuildignore problems
Message-ID: <1f7aea95-c8ee-46b5-957a-5268ebc3695e@effectivedefense.org>

Hello, All:


	  I'm having two problems with a tiny package on GitHub:


* Non-standard file/directory found at top level: ?README.Rmd?


 >>> BUT "README.Rmd" is IN .Rbuildignore


* Error in grepInTable(c("Afghanistan", "Netherlands Antilles")) : could 
not find function "grepInTable"


 >>> BUT 'grepInTable.R' includes "#' @importFrom rworldmap 
countrySynonyms".


SEE:


https://github.com/sbgraves237/acledr


	  What am I doing wrong?


	  Thanks,
	  Spencer Graves


From bbo|ker @end|ng |rom gm@||@com  Sun Dec  1 23:57:04 2024
From: bbo|ker @end|ng |rom gm@||@com (Ben Bolker)
Date: Sun, 1 Dec 2024 17:57:04 -0500
Subject: [R-pkg-devel] roxygen2 and .Rbuildignore problems
In-Reply-To: <1f7aea95-c8ee-46b5-957a-5268ebc3695e@effectivedefense.org>
References: <1f7aea95-c8ee-46b5-957a-5268ebc3695e@effectivedefense.org>
Message-ID: <af81bd7e-7806-4773-acf7-b48364685915@gmail.com>

* Your NAMESPACE file is empty -- did you forget to devtools::document() 
[or otherwise mess up this file]?

* for the README issue, all I can think of is that you might have run R 
CMD check on a directory rather than a built tarball?

On 12/1/24 17:53, Spencer Graves wrote:
> Hello, All:
> 
> 
>  ????? I'm having two problems with a tiny package on GitHub:
> 
> 
> * Non-standard file/directory found at top level: ?README.Rmd?
> 
> 
>  >>> BUT "README.Rmd" is IN .Rbuildignore
> 
> 
> * Error in grepInTable(c("Afghanistan", "Netherlands Antilles")) : could 
> not find function "grepInTable"
> 
> 
>  >>> BUT 'grepInTable.R' includes "#' @importFrom rworldmap 
> countrySynonyms".
> 
> 
> SEE:
> 
> 
> https://github.com/sbgraves237/acledr
> 
> 
>  ????? What am I doing wrong?
> 
> 
>  ????? Thanks,
>  ????? Spencer Graves
> 
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel

-- 
Dr. Benjamin Bolker
Professor, Mathematics & Statistics and Biology, McMaster University
Director, School of Computational Science and Engineering
* E-mail is sent at my convenience; I don't expect replies outside of 
working hours.


From cohen@@ @end|ng |rom |u@edu  Mon Dec  2 17:38:54 2024
From: cohen@@ @end|ng |rom |u@edu (Cohen, Aaron)
Date: Mon, 2 Dec 2024 16:38:54 +0000
Subject: [R-pkg-devel] Confusing error
Message-ID: <PH7PR08MB8379541D325C8B32BD0DE5C8D3352@PH7PR08MB8379.namprd08.prod.outlook.com>

Hello,

I am trying to submit an R package to CRAN. There are no notes, comments or errors when checking on my local machine, but I keep getting an error message when submitting. I am attaching the log file, but basically the error occurs when running the examples. In particular, it says

Error in loadNamespace(x) : there is no package called 'survey'

However, my package does not use the ?survey? package, and when I include this package to the Imports field in the DESCRIPTION file, it gives the following NOTE:

checking dependencies in R code ... NOTE
  Namespace in Imports field not imported from: ?survey?
    All declared Imports should be used.


How do I resolve this issue?

Best,
Aaron

-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: _00details.log_.log
URL: <https://stat.ethz.ch/pipermail/r-package-devel/attachments/20241202/6bb856bb/attachment.log>

From murdoch@dunc@n @end|ng |rom gm@||@com  Mon Dec  2 21:09:03 2024
From: murdoch@dunc@n @end|ng |rom gm@||@com (Duncan Murdoch)
Date: Mon, 2 Dec 2024 15:09:03 -0500
Subject: [R-pkg-devel] Confusing error
In-Reply-To: <PH7PR08MB8379541D325C8B32BD0DE5C8D3352@PH7PR08MB8379.namprd08.prod.outlook.com>
References: <PH7PR08MB8379541D325C8B32BD0DE5C8D3352@PH7PR08MB8379.namprd08.prod.outlook.com>
Message-ID: <8ca3efa8-b68d-4c87-a756-b5816e06174c@gmail.com>

On 2024-12-02 11:38 a.m., Cohen, Aaron wrote:
> Hello,
> 
> I am trying to submit an R package to CRAN. There are no notes, comments or errors when checking on my local machine, but I keep getting an error message when submitting. I am attaching the log file, but basically the error occurs when running the examples. In particular, it says
> 
> Error in loadNamespace(x) : there is no package called 'survey'
> 
> However, my package does not use the ?survey? package, and when I include this package to the Imports field in the DESCRIPTION file, it gives the following NOTE:
> 
> checking dependencies in R code ... NOTE
>    Namespace in Imports field not imported from: ?survey?
>      All declared Imports should be used.
> 
> 
> How do I resolve this issue?
> 

I'd remove the survey package on your system, and try running the 
example that fails.  If you get the same error, you can track it down.

Duncan Murdoch


From cohen@@ @end|ng |rom |u@edu  Mon Dec  2 21:38:19 2024
From: cohen@@ @end|ng |rom |u@edu (Cohen, Aaron)
Date: Mon, 2 Dec 2024 20:38:19 +0000
Subject: [R-pkg-devel] [External] Re:  Confusing error
In-Reply-To: <8ca3efa8-b68d-4c87-a756-b5816e06174c@gmail.com>
References: <PH7PR08MB8379541D325C8B32BD0DE5C8D3352@PH7PR08MB8379.namprd08.prod.outlook.com>
 <8ca3efa8-b68d-4c87-a756-b5816e06174c@gmail.com>
Message-ID: <PH7PR08MB83799DCF1CA241796BBD3C8BD3352@PH7PR08MB8379.namprd08.prod.outlook.com>

Hello, thank you for getting back to me. I have a github with the code:

https://github.com/237triangle/surveynnet

The main code is in R/surveynnet.R.

Re: your suggestion, do you mean I should de-install the survey package? I will try that, but would appreciate any additional help in the meantime so I?m linking my github above.

Best,
Aaron

From: Duncan Murdoch <murdoch.duncan at gmail.com>
Date: Monday, December 2, 2024 at 3:09?PM
To: Cohen, Aaron <cohenaa at iu.edu>, r-package-devel at r-project.org <r-package-devel at r-project.org>
Subject: [External] Re: [R-pkg-devel] Confusing error
[You don't often get email from murdoch.duncan at gmail.com. Learn why this is important at https://aka.ms/LearnAboutSenderIdentification ]

This message was sent from a non-IU address. Please exercise caution when clicking links or opening attachments from external sources.


On 2024-12-02 11:38 a.m., Cohen, Aaron wrote:
> Hello,
>
> I am trying to submit an R package to CRAN. There are no notes, comments or errors when checking on my local machine, but I keep getting an error message when submitting. I am attaching the log file, but basically the error occurs when running the examples. In particular, it says
>
> Error in loadNamespace(x) : there is no package called 'survey'
>
> However, my package does not use the ?survey? package, and when I include this package to the Imports field in the DESCRIPTION file, it gives the following NOTE:
>
> checking dependencies in R code ... NOTE
>    Namespace in Imports field not imported from: ?survey?
>      All declared Imports should be used.
>
>
> How do I resolve this issue?
>

I'd remove the survey package on your system, and try running the
example that fails.  If you get the same error, you can track it down.

Duncan Murdoch

	[[alternative HTML version deleted]]


From jo@|@h@p@rry @end|ng |rom gm@||@com  Mon Dec  2 21:45:48 2024
From: jo@|@h@p@rry @end|ng |rom gm@||@com (Josiah Parry)
Date: Mon, 2 Dec 2024 12:45:48 -0800
Subject: [R-pkg-devel] Confusing error
In-Reply-To: <8ca3efa8-b68d-4c87-a756-b5816e06174c@gmail.com>
References: <PH7PR08MB8379541D325C8B32BD0DE5C8D3352@PH7PR08MB8379.namprd08.prod.outlook.com>
 <8ca3efa8-b68d-4c87-a756-b5816e06174c@gmail.com>
Message-ID: <CAL3ufUJBpBqZS4paDwYBYw6-3a3R054Pkt=_A8bqNgMB7d=k_Q@mail.gmail.com>

My guess is that one of your packages uses survey as a Suggested package.
And your calling a function from that package that uses survey via
Suggests.

Is your package on GitHub? Or could you share your Imports?

On Mon, Dec 2, 2024 at 12:09 Duncan Murdoch <murdoch.duncan at gmail.com>
wrote:

> On 2024-12-02 11:38 a.m., Cohen, Aaron wrote:
> > Hello,
> >
> > I am trying to submit an R package to CRAN. There are no notes, comments
> or errors when checking on my local machine, but I keep getting an error
> message when submitting. I am attaching the log file, but basically the
> error occurs when running the examples. In particular, it says
> >
> > Error in loadNamespace(x) : there is no package called 'survey'
> >
> > However, my package does not use the ?survey? package, and when I
> include this package to the Imports field in the DESCRIPTION file, it gives
> the following NOTE:
> >
> > checking dependencies in R code ... NOTE
> >    Namespace in Imports field not imported from: ?survey?
> >      All declared Imports should be used.
> >
> >
> > How do I resolve this issue?
> >
>
> I'd remove the survey package on your system, and try running the
> example that fails.  If you get the same error, you can track it down.
>
> Duncan Murdoch
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>

	[[alternative HTML version deleted]]


From murdoch@dunc@n @end|ng |rom gm@||@com  Mon Dec  2 21:48:02 2024
From: murdoch@dunc@n @end|ng |rom gm@||@com (Duncan Murdoch)
Date: Mon, 2 Dec 2024 15:48:02 -0500
Subject: [R-pkg-devel] [External] Re:  Confusing error
In-Reply-To: <PH7PR08MB83799DCF1CA241796BBD3C8BD3352@PH7PR08MB8379.namprd08.prod.outlook.com>
References: <PH7PR08MB8379541D325C8B32BD0DE5C8D3352@PH7PR08MB8379.namprd08.prod.outlook.com>
 <8ca3efa8-b68d-4c87-a756-b5816e06174c@gmail.com>
 <PH7PR08MB83799DCF1CA241796BBD3C8BD3352@PH7PR08MB8379.namprd08.prod.outlook.com>
Message-ID: <c5a80312-8941-4825-a044-883a47e8e3ab@gmail.com>

The PracTools::deffCR function calls survey::svydesign.  It only 
suggests the survey package, so it is not necessarily available.

What you could do is also suggest survey, then add a test for its 
presence before calling PracTools::deffCR.  Or if that call is 
essential, then you should import survey, and add some innocuous direct 
reference to it to quiet the NOTE.

Duncan Murdoch

On 2024-12-02 3:38 p.m., Cohen, Aaron wrote:
> Hello, thank you for getting back to me. I have a github with the code:
> 
> https://github.com/237triangle/surveynnet 
> <https://github.com/237triangle/surveynnet>
> 
> The main code is in R/surveynnet.R.
> 
> Re: your suggestion, do you mean I should de-install the survey package? 
> I will try that, but would appreciate any additional help in the 
> meantime so I?m linking my github above.
> 
> Best,
> 
> Aaron
> 
> *From: *Duncan Murdoch <murdoch.duncan at gmail.com>
> *Date: *Monday, December 2, 2024 at 3:09?PM
> *To: *Cohen, Aaron <cohenaa at iu.edu>, r-package-devel at r-project.org 
> <r-package-devel at r-project.org>
> *Subject: *[External] Re: [R-pkg-devel] Confusing error
> 
> [You don't often get email from murdoch.duncan at gmail.com. Learn why this 
> is important at https://aka.ms/LearnAboutSenderIdentification 
> <https://aka.ms/LearnAboutSenderIdentification> ]
> 
> This message was sent from a non-IU address. Please exercise caution 
> when clicking links or opening attachments from external sources.
> 
> 
> On 2024-12-02 11:38 a.m., Cohen, Aaron wrote:
>> Hello,
>>
>> I am trying to submit an R package to CRAN. There are no notes, comments or errors when checking on my local machine, but I keep getting an error message when submitting. I am attaching the log file, but basically the error occurs when running the examples.  In particular, it says
>>
>> Error in loadNamespace(x) : there is no package called 'survey'
>>
>> However, my package does not use the ?survey? package, and when I include this package to the Imports field in the DESCRIPTION file, it gives the following NOTE:
>>
>> checking dependencies in R code ... NOTE
>>??? Namespace in Imports field not imported from: ?survey?
>>????? All declared Imports should be used.
>>
>>
>> How do I resolve this issue?
>>
> 
> I'd remove the survey package on your system, and try running the
> example that fails.? If you get the same error, you can track it down.
> 
> Duncan Murdoch
>


From cohen@@ @end|ng |rom |u@edu  Mon Dec  2 21:55:02 2024
From: cohen@@ @end|ng |rom |u@edu (Cohen, Aaron)
Date: Mon, 2 Dec 2024 20:55:02 +0000
Subject: [R-pkg-devel] [External] Re:  Confusing error
In-Reply-To: <c5a80312-8941-4825-a044-883a47e8e3ab@gmail.com>
References: <PH7PR08MB8379541D325C8B32BD0DE5C8D3352@PH7PR08MB8379.namprd08.prod.outlook.com>
 <8ca3efa8-b68d-4c87-a756-b5816e06174c@gmail.com>
 <PH7PR08MB83799DCF1CA241796BBD3C8BD3352@PH7PR08MB8379.namprd08.prod.outlook.com>
 <c5a80312-8941-4825-a044-883a47e8e3ab@gmail.com>
Message-ID: <PH7PR08MB8379FB4B9FB766D6EA0ACAF2D3352@PH7PR08MB8379.namprd08.prod.outlook.com>

Thank you [and Josiah Parry] for your help; I had already seen that PracTools uses `survey` but only suggests it, and I was unsure what to do on my end since I was getting in trouble whether I imported it or not. I will try doing what you suggest.

Since the call to PracTools::deffCR is essential to this package, I will do the second suggestion.

Best,
Aaron

From: Duncan Murdoch <murdoch.duncan at gmail.com>
Date: Monday, December 2, 2024 at 3:48?PM
To: Cohen, Aaron <cohenaa at iu.edu>, r-package-devel at r-project.org <r-package-devel at r-project.org>
Subject: Re: [External] Re: [R-pkg-devel] Confusing error
The PracTools::deffCR function calls survey::svydesign.  It only
suggests the survey package, so it is not necessarily available.

What you could do is also suggest survey, then add a test for its
presence before calling PracTools::deffCR.  Or if that call is
essential, then you should import survey, and add some innocuous direct
reference to it to quiet the NOTE.

Duncan Murdoch

On 2024-12-02 3:38 p.m., Cohen, Aaron wrote:
> Hello, thank you for getting back to me. I have a github with the code:
>
> https://nam12.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2F237triangle%2Fsurveynnet&data=05%7C02%7Ccohenaa%40iu.edu%7C060efca807ac4e2520f108dd13129edc%7C1113be34aed14d00ab4bcdd02510be91%7C0%7C0%7C638687692959141667%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=OH%2BsGWU%2FCuhyY111erhWCWNZE6rOsSnm2otRtrbN%2FaI%3D&reserved=0<https://github.com/237triangle/surveynnet>
> <https://nam12.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2F237triangle%2Fsurveynnet&data=05%7C02%7Ccohenaa%40iu.edu%7C060efca807ac4e2520f108dd13129edc%7C1113be34aed14d00ab4bcdd02510be91%7C0%7C0%7C638687692959178428%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=%2F4%2FhIYppugbVVzwyEsA1kAV5iK4XIUulxBOWmE1BZaI%3D&reserved=0<https://github.com/237triangle/surveynnet>>
>
> The main code is in R/surveynnet.R.
>
> Re: your suggestion, do you mean I should de-install the survey package?
> I will try that, but would appreciate any additional help in the
> meantime so I?m linking my github above.
>
> Best,
>
> Aaron
>
> *From: *Duncan Murdoch <murdoch.duncan at gmail.com>
> *Date: *Monday, December 2, 2024 at 3:09?PM
> *To: *Cohen, Aaron <cohenaa at iu.edu>, r-package-devel at r-project.org
> <r-package-devel at r-project.org>
> *Subject: *[External] Re: [R-pkg-devel] Confusing error
>
> [You don't often get email from murdoch.duncan at gmail.com. Learn why this
> is important at https://aka.ms/LearnAboutSenderIdentification
> <https://aka.ms/LearnAboutSenderIdentification> ]
>
> This message was sent from a non-IU address. Please exercise caution
> when clicking links or opening attachments from external sources.
>
>
> On 2024-12-02 11:38 a.m., Cohen, Aaron wrote:
>> Hello,
>>
>> I am trying to submit an R package to CRAN. There are no notes, comments or errors when checking on my local machine, but I keep getting an error message when submitting. I am attaching the log file, but basically the error occurs when running the examples.  In particular, it says
>>
>> Error in loadNamespace(x) : there is no package called 'survey'
>>
>> However, my package does not use the ?survey? package, and when I include this package to the Imports field in the DESCRIPTION file, it gives the following NOTE:
>>
>> checking dependencies in R code ... NOTE
>>    Namespace in Imports field not imported from: ?survey?
>>      All declared Imports should be used.
>>
>>
>> How do I resolve this issue?
>>
>
> I'd remove the survey package on your system, and try running the
> example that fails.  If you get the same error, you can track it down.
>
> Duncan Murdoch
>

	[[alternative HTML version deleted]]


From jo@|@h@p@rry @end|ng |rom gm@||@com  Mon Dec  2 22:33:47 2024
From: jo@|@h@p@rry @end|ng |rom gm@||@com (Josiah Parry)
Date: Mon, 2 Dec 2024 13:33:47 -0800
Subject: [R-pkg-devel] [External] Re: Confusing error
In-Reply-To: <PH7PR08MB8379FB4B9FB766D6EA0ACAF2D3352@PH7PR08MB8379.namprd08.prod.outlook.com>
References: <PH7PR08MB8379541D325C8B32BD0DE5C8D3352@PH7PR08MB8379.namprd08.prod.outlook.com>
 <8ca3efa8-b68d-4c87-a756-b5816e06174c@gmail.com>
 <PH7PR08MB83799DCF1CA241796BBD3C8BD3352@PH7PR08MB8379.namprd08.prod.outlook.com>
 <c5a80312-8941-4825-a044-883a47e8e3ab@gmail.com>
 <PH7PR08MB8379FB4B9FB766D6EA0ACAF2D3352@PH7PR08MB8379.namprd08.prod.outlook.com>
Message-ID: <CAL3ufULEYkUbr0yXQkzY-qO_E74+Mcane-Zsmc_D5nvDhUQ73A@mail.gmail.com>

Since you have dplyr as a dependency (though I?d reconsider that one since
it can be quite hefty / change it?s API) I would suggest using
rlang::check_installer(?survey?) in the function that indirectly calls
survey.

This will throw an informative error when survey is not found.

In your examples you can wrap your example like:

if (rlang::is_installed(?survey?)) {
   Example code here
}

On Mon, Dec 2, 2024 at 13:17 Cohen, Aaron <cohenaa at iu.edu> wrote:

> Thank you [and Josiah Parry] for your help; I had already seen that
> PracTools uses `survey` but only suggests it, and I was unsure what to do
> on my end since I was getting in trouble whether I imported it or not. I
> will try doing what you suggest.
>
> Since the call to PracTools::deffCR is essential to this package, I will
> do the second suggestion.
>
> Best,
> Aaron
>
> From: Duncan Murdoch <murdoch.duncan at gmail.com>
> Date: Monday, December 2, 2024 at 3:48?PM
> To: Cohen, Aaron <cohenaa at iu.edu>, r-package-devel at r-project.org <
> r-package-devel at r-project.org>
> Subject: Re: [External] Re: [R-pkg-devel] Confusing error
> The PracTools::deffCR function calls survey::svydesign.  It only
> suggests the survey package, so it is not necessarily available.
>
> What you could do is also suggest survey, then add a test for its
> presence before calling PracTools::deffCR.  Or if that call is
> essential, then you should import survey, and add some innocuous direct
> reference to it to quiet the NOTE.
>
> Duncan Murdoch
>
> On 2024-12-02 3:38 p.m., Cohen, Aaron wrote:
> > Hello, thank you for getting back to me. I have a github with the code:
> >
> >
> https://nam12.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2F237triangle%2Fsurveynnet&data=05%7C02%7Ccohenaa%40iu.edu%7C060efca807ac4e2520f108dd13129edc%7C1113be34aed14d00ab4bcdd02510be91%7C0%7C0%7C638687692959141667%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=OH%2BsGWU%2FCuhyY111erhWCWNZE6rOsSnm2otRtrbN%2FaI%3D&reserved=0
> <https://github.com/237triangle/surveynnet>
> > <
> https://nam12.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2F237triangle%2Fsurveynnet&data=05%7C02%7Ccohenaa%40iu.edu%7C060efca807ac4e2520f108dd13129edc%7C1113be34aed14d00ab4bcdd02510be91%7C0%7C0%7C638687692959178428%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=%2F4%2FhIYppugbVVzwyEsA1kAV5iK4XIUulxBOWmE1BZaI%3D&reserved=0
> <https://github.com/237triangle/surveynnet>>
> >
> > The main code is in R/surveynnet.R.
> >
> > Re: your suggestion, do you mean I should de-install the survey package?
> > I will try that, but would appreciate any additional help in the
> > meantime so I?m linking my github above.
> >
> > Best,
> >
> > Aaron
> >
> > *From: *Duncan Murdoch <murdoch.duncan at gmail.com>
> > *Date: *Monday, December 2, 2024 at 3:09?PM
> > *To: *Cohen, Aaron <cohenaa at iu.edu>, r-package-devel at r-project.org
> > <r-package-devel at r-project.org>
> > *Subject: *[External] Re: [R-pkg-devel] Confusing error
> >
> > [You don't often get email from murdoch.duncan at gmail.com. Learn why this
> > is important at https://aka.ms/LearnAboutSenderIdentification
> > <https://aka.ms/LearnAboutSenderIdentification> ]
> >
> > This message was sent from a non-IU address. Please exercise caution
> > when clicking links or opening attachments from external sources.
> >
> >
> > On 2024-12-02 11:38 a.m., Cohen, Aaron wrote:
> >> Hello,
> >>
> >> I am trying to submit an R package to CRAN. There are no notes,
> comments or errors when checking on my local machine, but I keep getting an
> error message when submitting. I am attaching the log file, but basically
> the error occurs when running the examples.  In particular, it says
> >>
> >> Error in loadNamespace(x) : there is no package called 'survey'
> >>
> >> However, my package does not use the ?survey? package, and when I
> include this package to the Imports field in the DESCRIPTION file, it gives
> the following NOTE:
> >>
> >> checking dependencies in R code ... NOTE
> >>    Namespace in Imports field not imported from: ?survey?
> >>      All declared Imports should be used.
> >>
> >>
> >> How do I resolve this issue?
> >>
> >
> > I'd remove the survey package on your system, and try running the
> > example that fails.  If you get the same error, you can track it down.
> >
> > Duncan Murdoch
> >
>
>         [[alternative HTML version deleted]]
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>

	[[alternative HTML version deleted]]


From @zz@||n| @end|ng |rom @t@t@un|pd@|t  Wed Dec  4 19:25:54 2024
From: @zz@||n| @end|ng |rom @t@t@un|pd@|t (Adelchi Azzalini)
Date: Wed, 4 Dec 2024 19:25:54 +0100
Subject: [R-pkg-devel] conditional import of a package?
Message-ID: <562E9DD8-97A4-4B30-A568-C814CADF7F11@stat.unipd.it>

Hi. I am working on the development of an existing package (smof, on CRAN). My current aim is widen the list of possible optimizers from which the user can select one method for optimizing a certain task. Well-known possibilities within the base package are optim (with various options) and nlminb. Besides these, I am thinking of including also those of package nloptr, but without forcing users to install this package which perhaps they don't need for other purposes. Hence, I would like to import nloptr only if it is available on the user system; it not, I can just confine the list of optimizers to optim and nlminb.  

This idea implies a sort of ?conditional import? of nloptr. Is this possible? Section 1.1.3.1 "Suggested packages" of
https://translation.r-project.org/man/R-exts/R-exts-ko.html#Suggested-packages
seems to hint at such a possibility.  See the use of requireNamespace in the second paragraph.

After elaborating along this line, I packaged my code, with nloptr listed on the line Suggests of DESCRIPTION.  However this attempt failed a the ?R CMD check ? stage with message

Namespace dependency missing from DESCRIPTION Imports/Depends entries: ?nloptr?

In addition, I have no idea of how to declare a "conditional import? in NAMESPACE. 

Is this idea of ?conditional import? totally unfeasible, then?

---
Adelchi Azzalini
http://azzalini.stat.unipd.it


From br|@n @end|ng |rom br@verock@com  Wed Dec  4 19:56:20 2024
From: br|@n @end|ng |rom br@verock@com (Brian G. Peterson)
Date: Wed, 04 Dec 2024 12:56:20 -0600
Subject: [R-pkg-devel] conditional import of a package?
In-Reply-To: <562E9DD8-97A4-4B30-A568-C814CADF7F11@stat.unipd.it>
References: <562E9DD8-97A4-4B30-A568-C814CADF7F11@stat.unipd.it>
Message-ID: <26d1a055dde950cdeb0948286bb8479d4e3e992e.camel@braverock.com>

Adelchi,

The package 'PortfolioAnalytics', which we maintain, uses this pattern
extensively to support different optimization solvers. ?The packages
are all in 'Suggests' rather than 'Imports', because we don't want them
all required all the time.

So the code pattern is something like this:

if(optimize_method=="pso"){
? ?stopifnot("package:pso" %in% search() ||
requireNamespace("pso",quietly = TRUE) )
? # ...
}

where all the code that requires the 'pso' engine in this example is
contained inside the if block and the stopifnot check.

Regards,

Brian

-- 
Brian G. Peterson
ph: +1.773.459.4973
im: bgpbraverock

On Wed, 2024-12-04 at 19:25 +0100, Adelchi Azzalini wrote:
> Hi. I am working on the development of an existing package (smof, on
> CRAN). My current aim is widen the list of possible optimizers from
> which the user can select one method for optimizing a certain task.
> Well-known possibilities within the base package are optim (with
> various options) and nlminb. Besides these, I am thinking of
> including also those of package nloptr, but without forcing users to
> install this package which perhaps they don't need for other
> purposes. Hence, I would like to import nloptr only if it is
> available on the user system; it not, I can just confine the list of
> optimizers to optim and nlminb.? 
> 
> This idea implies a sort of ?conditional import? of nloptr. Is this
> possible? Section 1.1.3.1 "Suggested packages" of
> https://translation.r-project.org/man/R-exts/R-exts-ko.html#Suggested-packages
> seems to hint at such a possibility.? See the use of requireNamespace
> in the second paragraph.
> 
> After elaborating along this line, I packaged my code, with nloptr
> listed on the line Suggests of DESCRIPTION.? However this attempt
> failed a the ?R CMD check ? stage with message
> 
> Namespace dependency missing from DESCRIPTION Imports/Depends
> entries: ?nloptr?
> 
> In addition, I have no idea of how to declare a "conditional import?
> in NAMESPACE. 
> 
> Is this idea of ?conditional import? totally unfeasible, then?
> 
> ---
> Adelchi Azzalini
> http://azzalini.stat.unipd.it
> 
> ______________________________________________
> R-package-devel at r-project.org?mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
> 

	[[alternative HTML version deleted]]


From murdoch@dunc@n @end|ng |rom gm@||@com  Wed Dec  4 20:56:52 2024
From: murdoch@dunc@n @end|ng |rom gm@||@com (Duncan Murdoch)
Date: Wed, 4 Dec 2024 14:56:52 -0500
Subject: [R-pkg-devel] conditional import of a package?
In-Reply-To: <562E9DD8-97A4-4B30-A568-C814CADF7F11@stat.unipd.it>
References: <562E9DD8-97A4-4B30-A568-C814CADF7F11@stat.unipd.it>
Message-ID: <2f5a7a59-0b68-4e99-ab3f-3064d45dcd36@gmail.com>

On 2024-12-04 1:25 p.m., Adelchi Azzalini wrote:
> Hi. I am working on the development of an existing package (smof, on CRAN). My current aim is widen the list of possible optimizers from which the user can select one method for optimizing a certain task. Well-known possibilities within the base package are optim (with various options) and nlminb. Besides these, I am thinking of including also those of package nloptr, but without forcing users to install this package which perhaps they don't need for other purposes. Hence, I would like to import nloptr only if it is available on the user system; it not, I can just confine the list of optimizers to optim and nlminb.
> 
> This idea implies a sort of ?conditional import? of nloptr. Is this possible? Section 1.1.3.1 "Suggested packages" of
> https://translation.r-project.org/man/R-exts/R-exts-ko.html#Suggested-packages
> seems to hint at such a possibility.  See the use of requireNamespace in the second paragraph.
> 
> After elaborating along this line, I packaged my code, with nloptr listed on the line Suggests of DESCRIPTION.  However this attempt failed a the ?R CMD check ? stage with message
> 
> Namespace dependency missing from DESCRIPTION Imports/Depends entries: ?nloptr?
> 
> In addition, I have no idea of how to declare a "conditional import? in NAMESPACE.
> 
> Is this idea of ?conditional import? totally unfeasible, then?

The usual way to do this is to list the package in Suggests, and then 
wrap any use of it in `if (requireNamespace("pkg")) { ... }` blocks. 
This doesn't quite import the functions, you would need to use the 
`pkg::fn` syntax to access the functions.

If you really want to simulate importing so that you don't need the 
`pkg::` prefix, you could do it this way:  In the `.onLoad` function of 
your package, you would have code like

   if (requireNamespace("pkg")) {
     foo <- pkg::foo
     bar <- pkg::bar
   } else {
     foo <- stub
     bar <- stub
   }

where `stub` is a function that says "you need `pkg` to use this function".

Duncan Murdoch


From @zz@||n| @end|ng |rom @t@t@un|pd@|t  Thu Dec  5 09:06:10 2024
From: @zz@||n| @end|ng |rom @t@t@un|pd@|t (Adelchi Azzalini)
Date: Thu, 5 Dec 2024 09:06:10 +0100
Subject: [R-pkg-devel] conditional import of a package?
In-Reply-To: <2f5a7a59-0b68-4e99-ab3f-3064d45dcd36@gmail.com>
References: <562E9DD8-97A4-4B30-A568-C814CADF7F11@stat.unipd.it>
 <2f5a7a59-0b68-4e99-ab3f-3064d45dcd36@gmail.com>
Message-ID: <8B8E7114-B848-4D9F-81A6-A22B43CCEC46@stat.unipd.it>

Thanks, Duncan, for the kind advice. 

In my understanding, this is what I have done (or I tried to do).  My code is as follows:

  opt.methods <- c("Nelder-Mead", "BFGS", "nlminb")
  if(requireNamespace("nloptr", quietly = TRUE)) {
    nloptr.methods <- c("newuoa", "bobyqa", "cobyla")
    if(opt.method %in%  nloptr.methods) require(nloptr, quietly=TRUE)
    opt.methods <- c(opt.methods, nloptr.methods)
   }

<skip>

   if(opt.method %in% nloptr.methods) {    
      pos <- match("package:nloptr", search())
      nloptr.method <-  get(paste("nloptr", opt.method, sep="::"), pos=pos)
      opt <- nloptr.method(<args>)
      }
       
In the DESCRIPTION file there is
   Suggests: ggplot2, survival, nloptr

However, when I run ?R CMD check <etc>?, I get the following message 
* checking package dependencies ... ERROR
Namespace dependency missing from DESCRIPTION Imports/Depends entries: ?nloptr?

See section ?The DESCRIPTION file? in the ?Writing R Extensions?
manual.
* DONE

And - admittedly - I have no idea about how to insert appropriate import statements in NAMESPACE.


Best regards,

Adelchi


> On 4 Dec 2024, at 20:56, Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
> 
> On 2024-12-04 1:25 p.m., Adelchi Azzalini wrote:
>> Hi. I am working on the development of an existing package (smof, on CRAN). My current aim is widen the list of possible optimizers from which the user can select one method for optimizing a certain task. Well-known possibilities within the base package are optim (with various options) and nlminb. Besides these, I am thinking of including also those of package nloptr, but without forcing users to install this package which perhaps they don't need for other purposes. Hence, I would like to import nloptr only if it is available on the user system; it not, I can just confine the list of optimizers to optim and nlminb.
>> This idea implies a sort of ?conditional import? of nloptr. Is this possible? Section 1.1.3.1 "Suggested packages" of
>> https://translation.r-project.org/man/R-exts/R-exts-ko.html#Suggested-packages
>> seems to hint at such a possibility.  See the use of requireNamespace in the second paragraph.
>> After elaborating along this line, I packaged my code, with nloptr listed on the line Suggests of DESCRIPTION.  However this attempt failed a the ?R CMD check ? stage with message
>> Namespace dependency missing from DESCRIPTION Imports/Depends entries: ?nloptr?
>> In addition, I have no idea of how to declare a "conditional import? in NAMESPACE.
>> Is this idea of ?conditional import? totally unfeasible, then?
> 
> The usual way to do this is to list the package in Suggests, and then wrap any use of it in `if (requireNamespace("pkg")) { ... }` blocks. This doesn't quite import the functions, you would need to use the `pkg::fn` syntax to access the functions.
> 
> If you really want to simulate importing so that you don't need the `pkg::` prefix, you could do it this way:  In the `.onLoad` function of your package, you would have code like
> 
>  if (requireNamespace("pkg")) {
>    foo <- pkg::foo
>    bar <- pkg::bar
>  } else {
>    foo <- stub
>    bar <- stub
>  }
> 
> where `stub` is a function that says "you need `pkg` to use this function".
> 
> Duncan Murdoch
> 


From @ergue|@@oko| @end|ng |rom gm@||@com  Thu Dec  5 09:36:54 2024
From: @ergue|@@oko| @end|ng |rom gm@||@com (Sokol Serguei)
Date: Thu, 5 Dec 2024 09:36:54 +0100
Subject: [R-pkg-devel] conditional import of a package?
In-Reply-To: <8B8E7114-B848-4D9F-81A6-A22B43CCEC46@stat.unipd.it>
References: <562E9DD8-97A4-4B30-A568-C814CADF7F11@stat.unipd.it>
 <2f5a7a59-0b68-4e99-ab3f-3064d45dcd36@gmail.com>
 <8B8E7114-B848-4D9F-81A6-A22B43CCEC46@stat.unipd.it>
Message-ID: <caecb7f9-214a-4cdd-964a-590422a92b64@gmail.com>

Le 05/12/2024 ? 09:06, Adelchi Azzalini a ?crit?:
> Thanks, Duncan, for the kind advice.
>
> In my understanding, this is what I have done (or I tried to do).  My code is as follows:
>
>    opt.methods <- c("Nelder-Mead", "BFGS", "nlminb")
>    if(requireNamespace("nloptr", quietly = TRUE)) {
>      nloptr.methods <- c("newuoa", "bobyqa", "cobyla")
>      if(opt.method %in%  nloptr.methods) require(nloptr, quietly=TRUE)
>      opt.methods <- c(opt.methods, nloptr.methods)
>     }
>
> <skip>
>
>     if(opt.method %in% nloptr.methods) {
>        pos <- match("package:nloptr", search())
>        nloptr.method <-  get(paste("nloptr", opt.method, sep="::"), pos=pos)
>        opt <- nloptr.method(<args>)
>        }
>         
> In the DESCRIPTION file there is
>     Suggests: ggplot2, survival, nloptr
>
> However, when I run ?R CMD check <etc>?, I get the following message
> * checking package dependencies ... ERROR
> Namespace dependency missing from DESCRIPTION Imports/Depends entries: ?nloptr?

It probably means that despite your intention, there is somewhere in
your code a place where you call nloptr::some_fun() out of the
'if(requireNamespace("nloptr", quietly = TRUE)) {...}' scope.

You can try to locally uninstall nloptr, then run 'R CMD check ...' to see where it happens and why.

Best,
Serguei.

>
> See section ?The DESCRIPTION file? in the ?Writing R Extensions?
> manual.
> * DONE
>
> And - admittedly - I have no idea about how to insert appropriate import statements in NAMESPACE.
>
>
> Best regards,
>
> Adelchi
>
>
>> On 4 Dec 2024, at 20:56, Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
>>
>> On 2024-12-04 1:25 p.m., Adelchi Azzalini wrote:
>>> Hi. I am working on the development of an existing package (smof, on CRAN). My current aim is widen the list of possible optimizers from which the user can select one method for optimizing a certain task. Well-known possibilities within the base package are optim (with various options) and nlminb. Besides these, I am thinking of including also those of package nloptr, but without forcing users to install this package which perhaps they don't need for other purposes. Hence, I would like to import nloptr only if it is available on the user system; it not, I can just confine the list of optimizers to optim and nlminb.
>>> This idea implies a sort of ?conditional import? of nloptr. Is this possible? Section 1.1.3.1 "Suggested packages" of
>>> https://translation.r-project.org/man/R-exts/R-exts-ko.html#Suggested-packages
>>> seems to hint at such a possibility.  See the use of requireNamespace in the second paragraph.
>>> After elaborating along this line, I packaged my code, with nloptr listed on the line Suggests of DESCRIPTION.  However this attempt failed a the ?R CMD check ? stage with message
>>> Namespace dependency missing from DESCRIPTION Imports/Depends entries: ?nloptr?
>>> In addition, I have no idea of how to declare a "conditional import? in NAMESPACE.
>>> Is this idea of ?conditional import? totally unfeasible, then?
>> The usual way to do this is to list the package in Suggests, and then wrap any use of it in `if (requireNamespace("pkg")) { ... }` blocks. This doesn't quite import the functions, you would need to use the `pkg::fn` syntax to access the functions.
>>
>> If you really want to simulate importing so that you don't need the `pkg::` prefix, you could do it this way:  In the `.onLoad` function of your package, you would have code like
>>
>>   if (requireNamespace("pkg")) {
>>     foo <- pkg::foo
>>     bar <- pkg::bar
>>   } else {
>>     foo <- stub
>>     bar <- stub
>>   }
>>
>> where `stub` is a function that says "you need `pkg` to use this function".
>>
>> Duncan Murdoch
>>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From murdoch@dunc@n @end|ng |rom gm@||@com  Thu Dec  5 11:41:24 2024
From: murdoch@dunc@n @end|ng |rom gm@||@com (Duncan Murdoch)
Date: Thu, 5 Dec 2024 05:41:24 -0500
Subject: [R-pkg-devel] conditional import of a package?
In-Reply-To: <8B8E7114-B848-4D9F-81A6-A22B43CCEC46@stat.unipd.it>
References: <562E9DD8-97A4-4B30-A568-C814CADF7F11@stat.unipd.it>
 <2f5a7a59-0b68-4e99-ab3f-3064d45dcd36@gmail.com>
 <8B8E7114-B848-4D9F-81A6-A22B43CCEC46@stat.unipd.it>
Message-ID: <4d818ee1-e4c7-4366-b5a7-76e81cc22a3e@gmail.com>

On 2024-12-05 3:06 a.m., Adelchi Azzalini wrote:
> Thanks, Duncan, for the kind advice.
> 
> In my understanding, this is what I have done (or I tried to do).  My code is as follows:
> 
>    opt.methods <- c("Nelder-Mead", "BFGS", "nlminb")
>    if(requireNamespace("nloptr", quietly = TRUE)) {
>      nloptr.methods <- c("newuoa", "bobyqa", "cobyla")
>      if(opt.method %in%  nloptr.methods) require(nloptr, quietly=TRUE)

You shouldn't use `require(nloptr, quietly=TRUE)`.  That puts it on the 
search list, and packages should generally not modify the search list.

Just before this in your code, you know that nloptr is loaded.  You 
don't know if it's on the search list or not, and that shouldn't matter.

>      opt.methods <- c(opt.methods, nloptr.methods)
>     }
> 
> <skip>
> 
>     if(opt.method %in% nloptr.methods) {
>        pos <- match("package:nloptr", search())
>        nloptr.method <-  get(paste("nloptr", opt.method, sep="::"), pos=pos)
>        opt <- nloptr.method(<args>)
>        }

The code above relies on having nloptr on the search list, and you don't 
know that, so you'll need a different way to set nloptr.method.  Another 
problem is that at this point you don't know if nloptr is loaded or not, 
because the requireNamespace() call above might have returned FALSE.

What I would do is to set nloptr.method in the code block above, i.e. 
change the first block to

     opt.methods <- c("Nelder-Mead", "BFGS", "nlminb")
     if(requireNamespace("nloptr", quietly = TRUE)) {
       nloptr.methods <- c("newuoa", "bobyqa", "cobyla")
       if(opt.method %in%  nloptr.methods)
         nloptr.method <- get(opt.method,
                              envir = loadNamespace("nloptr"))
     } else
       nloptr.method <- function(...) stop("this optimization needs the 
nloptr package.")


The second block could then be simplified to

      if(opt.method %in% nloptr.methods)
         opt <- nloptr.method(<args>)


>         
> In the DESCRIPTION file there is
>     Suggests: ggplot2, survival, nloptr

That should be fine.

> 
> However, when I run ?R CMD check <etc>?, I get the following message
> * checking package dependencies ... ERROR
> Namespace dependency missing from DESCRIPTION Imports/Depends entries: ?nloptr?
> 
> See section ?The DESCRIPTION file? in the ?Writing R Extensions?
> manual.
> * DONE
> 
> And - admittedly - I have no idea about how to insert appropriate import statements in NAMESPACE.

You shouldn't need to do that.

Duncan Murdoch

> 
> 
> Best regards,
> 
> Adelchi
> 
> 
>> On 4 Dec 2024, at 20:56, Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
>>
>> On 2024-12-04 1:25 p.m., Adelchi Azzalini wrote:
>>> Hi. I am working on the development of an existing package (smof, on CRAN). My current aim is widen the list of possible optimizers from which the user can select one method for optimizing a certain task. Well-known possibilities within the base package are optim (with various options) and nlminb. Besides these, I am thinking of including also those of package nloptr, but without forcing users to install this package which perhaps they don't need for other purposes. Hence, I would like to import nloptr only if it is available on the user system; it not, I can just confine the list of optimizers to optim and nlminb.
>>> This idea implies a sort of ?conditional import? of nloptr. Is this possible? Section 1.1.3.1 "Suggested packages" of
>>> https://translation.r-project.org/man/R-exts/R-exts-ko.html#Suggested-packages
>>> seems to hint at such a possibility.  See the use of requireNamespace in the second paragraph.
>>> After elaborating along this line, I packaged my code, with nloptr listed on the line Suggests of DESCRIPTION.  However this attempt failed a the ?R CMD check ? stage with message
>>> Namespace dependency missing from DESCRIPTION Imports/Depends entries: ?nloptr?
>>> In addition, I have no idea of how to declare a "conditional import? in NAMESPACE.
>>> Is this idea of ?conditional import? totally unfeasible, then?
>>
>> The usual way to do this is to list the package in Suggests, and then wrap any use of it in `if (requireNamespace("pkg")) { ... }` blocks. This doesn't quite import the functions, you would need to use the `pkg::fn` syntax to access the functions.
>>
>> If you really want to simulate importing so that you don't need the `pkg::` prefix, you could do it this way:  In the `.onLoad` function of your package, you would have code like
>>
>>   if (requireNamespace("pkg")) {
>>     foo <- pkg::foo
>>     bar <- pkg::bar
>>   } else {
>>     foo <- stub
>>     bar <- stub
>>   }
>>
>> where `stub` is a function that says "you need `pkg` to use this function".
>>
>> Duncan Murdoch
>>
>


From Luc@DeW||de @end|ng |rom UGent@be  Thu Dec  5 14:21:30 2024
From: Luc@DeW||de @end|ng |rom UGent@be (Luc De Wilde)
Date: Thu, 5 Dec 2024 13:21:30 +0000
Subject: [R-pkg-devel] Cannot create C code with acceptable performance with
 respect to internal R command.
Message-ID: <AM0PR09MB3843E3FD6F0F9F3847ECEC5898302@AM0PR09MB3843.eurprd09.prod.outlook.com>

Dear package developers,

in creating a package lavaanC for use in lavaan, I need to perform some matrix computations involving matrix products and crossproducts. As far as I see I cannot directly call the C code in the R core. So I copied the code in the R core, but the same C/C++ code in a package is 2.5 ? 3 times slower than executed directly in R :?

C code in package :?
? SEXP prod0(SEXP mat1, SEXP mat2) {
? ? SEXP u1 = Rf_getAttrib(mat1, R_DimSymbol);
? ? int m1 = INTEGER(u1)[0];
? ? int n1 = INTEGER(u1)[1];
? ? SEXP u2 = Rf_getAttrib(mat2, R_DimSymbol);
? ? int m2 = INTEGER(u2)[0];
? ? int n2 = INTEGER(u2)[1];
? ? if (n1 != m2) Rf_error("matrices not conforming");
? ? SEXP retval = PROTECT(Rf_allocMatrix(REALSXP, m1, n2));
? ? double* left = REAL(mat1);
? ? double* right = REAL(mat2);
? ? double* ret = REAL(retval);
? ? double werk = 0.0;
? ? for (int j = 0; j < n2; j++) {
? ? ? for (int i = 0; i < m1; i++) {
? ? ? ? ? werk = 0.0;
? ? ? ? for (int k = 0; k < n1; k++) werk += (left[i + m1 * k] * right[k + m2 * j]);
? ? ? ? ret[j * m1 + i] = ?werk;
? ? ? }
? ? }
? ? UNPROTECT(1);
? ? return retval;
? }

Test script :
m1 <- matrix(rnorm(300000), nrow = 60)
m2 <- matrix(rnorm(300000), ncol = 60)
print(microbenchmark::microbenchmark(
  m1 %*% m2, .Call("prod0", m1, m2), times = 100
))

Result on my pc:
Unit: milliseconds
                   expr     min      lq     mean  median       uq     max neval
              m1 %*% m2 10.5650 10.8967 11.13434 10.9449 11.02965 15.8397   100
 .Call("prod0", m1, m2) 29.3336 30.7868 32.05114 31.0408 33.85935 45.5321   100


Can anyone explain why the compiled code in the package is so much slower than in R core?

and

Is there a way to improve the performance in R package?


Best regards,

Luc De Wilde




From tom@@@k@||ber@ @end|ng |rom gm@||@com  Thu Dec  5 14:39:43 2024
From: tom@@@k@||ber@ @end|ng |rom gm@||@com (Tomas Kalibera)
Date: Thu, 5 Dec 2024 14:39:43 +0100
Subject: [R-pkg-devel] 
 Cannot create C code with acceptable performance with
 respect to internal R command.
In-Reply-To: <AM0PR09MB3843E3FD6F0F9F3847ECEC5898302@AM0PR09MB3843.eurprd09.prod.outlook.com>
References: <AM0PR09MB3843E3FD6F0F9F3847ECEC5898302@AM0PR09MB3843.eurprd09.prod.outlook.com>
Message-ID: <fdda61b7-2258-4273-aab9-19d7e01286f4@gmail.com>


On 12/5/24 14:21, Luc De Wilde wrote:
> Dear package developers,
>
> in creating a package lavaanC for use in lavaan, I need to perform some matrix computations involving matrix products and crossproducts. As far as I see I cannot directly call the C code in the R core. So I copied the code in the R core, but the same C/C++ code in a package is 2.5 ? 3 times slower than executed directly in R :
>
> C code in package :
>  ? SEXP prod0(SEXP mat1, SEXP mat2) {
>  ? ? SEXP u1 = Rf_getAttrib(mat1, R_DimSymbol);
>  ? ? int m1 = INTEGER(u1)[0];
>  ? ? int n1 = INTEGER(u1)[1];
>  ? ? SEXP u2 = Rf_getAttrib(mat2, R_DimSymbol);
>  ? ? int m2 = INTEGER(u2)[0];
>  ? ? int n2 = INTEGER(u2)[1];
>  ? ? if (n1 != m2) Rf_error("matrices not conforming");
>  ? ? SEXP retval = PROTECT(Rf_allocMatrix(REALSXP, m1, n2));
>  ? ? double* left = REAL(mat1);
>  ? ? double* right = REAL(mat2);
>  ? ? double* ret = REAL(retval);
>  ? ? double werk = 0.0;
>  ? ? for (int j = 0; j < n2; j++) {
>  ? ? ? for (int i = 0; i < m1; i++) {
>  ? ? ? ? ? werk = 0.0;
>  ? ? ? ? for (int k = 0; k < n1; k++) werk += (left[i + m1 * k] * right[k + m2 * j]);
>  ? ? ? ? ret[j * m1 + i] = ?werk;
>  ? ? ? }
>  ? ? }
>  ? ? UNPROTECT(1);
>  ? ? return retval;
>  ? }
>
> Test script :
> m1 <- matrix(rnorm(300000), nrow = 60)
> m2 <- matrix(rnorm(300000), ncol = 60)
> print(microbenchmark::microbenchmark(
>    m1 %*% m2, .Call("prod0", m1, m2), times = 100
> ))
>
> Result on my pc:
> Unit: milliseconds
>                     expr     min      lq     mean  median       uq     max neval
>                m1 %*% m2 10.5650 10.8967 11.13434 10.9449 11.02965 15.8397   100
>   .Call("prod0", m1, m2) 29.3336 30.7868 32.05114 31.0408 33.85935 45.5321   100
>
>
> Can anyone explain why the compiled code in the package is so much slower than in R core?

By default, R would use BLAS, not the simple algorithm above. See 
?options, look for "matprod" for more information on how to select an 
algorithm. The code is then in array.c, function matprod().

> and
>
> Is there a way to improve the performance in R package?

One option is to use BLAS.

Best
Tomas

>
>
> Best regards,
>
> Luc De Wilde
>
>
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From Luc@DeW||de @end|ng |rom UGent@be  Thu Dec  5 14:50:22 2024
From: Luc@DeW||de @end|ng |rom UGent@be (Luc De Wilde)
Date: Thu, 5 Dec 2024 13:50:22 +0000
Subject: [R-pkg-devel] 
 Cannot create C code with acceptable performance with
 respect to internal R command.
In-Reply-To: <fdda61b7-2258-4273-aab9-19d7e01286f4@gmail.com>
References: <AM0PR09MB3843E3FD6F0F9F3847ECEC5898302@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <fdda61b7-2258-4273-aab9-19d7e01286f4@gmail.com>
Message-ID: <AM0PR09MB3843075CEA5CD544CA37CFE298302@AM0PR09MB3843.eurprd09.prod.outlook.com>

Thank you very much, Tomas, now it's clear and I'll see what to do with that knowledge!

Luc

________________________________________
Van: Tomas Kalibera <tomas.kalibera at gmail.com>
Verzonden: donderdag 5 december 2024 14:39
Aan: Luc De Wilde <Luc.DeWilde at UGent.be>; r-package-devel at r-project.org <r-package-devel at r-project.org>
CC: Yves Rosseel <Yves.Rosseel at UGent.be>
Onderwerp: Re: [R-pkg-devel] Cannot create C code with acceptable performance with respect to internal R command.


On 12/5/24 14:21, Luc De Wilde wrote:
> Dear package developers,
>
> in creating a package lavaanC for use in lavaan, I need to perform some matrix computations involving matrix products and crossproducts. As far as I see I cannot directly call the C code in the R core. So I copied the code in the R core, but the same C/C++ code in a package is 2.5 ? 3 times slower than executed directly in R :
>
> C code in package :
>    SEXP prod0(SEXP mat1, SEXP mat2) {
>      SEXP u1 = Rf_getAttrib(mat1, R_DimSymbol);
>      int m1 = INTEGER(u1)[0];
>      int n1 = INTEGER(u1)[1];
>      SEXP u2 = Rf_getAttrib(mat2, R_DimSymbol);
>      int m2 = INTEGER(u2)[0];
>      int n2 = INTEGER(u2)[1];
>      if (n1 != m2) Rf_error("matrices not conforming");
>      SEXP retval = PROTECT(Rf_allocMatrix(REALSXP, m1, n2));
>      double* left = REAL(mat1);
>      double* right = REAL(mat2);
>      double* ret = REAL(retval);
>      double werk = 0.0;
>      for (int j = 0; j < n2; j++) {
>        for (int i = 0; i < m1; i++) {
>            werk = 0.0;
>          for (int k = 0; k < n1; k++) werk += (left[i + m1 * k] * right[k + m2 * j]);
>          ret[j * m1 + i] =  werk;
>        }
>      }
>      UNPROTECT(1);
>      return retval;
>    }
>
> Test script :
> m1 <- matrix(rnorm(300000), nrow = 60)
> m2 <- matrix(rnorm(300000), ncol = 60)
> print(microbenchmark::microbenchmark(
>    m1 %*% m2, .Call("prod0", m1, m2), times = 100
> ))
>
> Result on my pc:
> Unit: milliseconds
>                     expr     min      lq     mean  median       uq     max neval
>                m1 %*% m2 10.5650 10.8967 11.13434 10.9449 11.02965 15.8397   100
>   .Call("prod0", m1, m2) 29.3336 30.7868 32.05114 31.0408 33.85935 45.5321   100
>
>
> Can anyone explain why the compiled code in the package is so much slower than in R core?

By default, R would use BLAS, not the simple algorithm above. See
?options, look for "matprod" for more information on how to select an
algorithm. The code is then in array.c, function matprod().

> and
>
> Is there a way to improve the performance in R package?

One option is to use BLAS.

Best
Tomas

>
>
> Best regards,
>
> Luc De Wilde
>
>
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From @ergue|@@oko| @end|ng |rom gm@||@com  Thu Dec  5 14:55:51 2024
From: @ergue|@@oko| @end|ng |rom gm@||@com (Sokol Serguei)
Date: Thu, 5 Dec 2024 14:55:51 +0100
Subject: [R-pkg-devel] 
 Cannot create C code with acceptable performance with
 respect to internal R command.
In-Reply-To: <AM0PR09MB3843E3FD6F0F9F3847ECEC5898302@AM0PR09MB3843.eurprd09.prod.outlook.com>
References: <AM0PR09MB3843E3FD6F0F9F3847ECEC5898302@AM0PR09MB3843.eurprd09.prod.outlook.com>
Message-ID: <140e06f2-202c-4f98-8d65-189fcf061450@gmail.com>

Luc,

There can be many reasons explaining the difference in compiled code 
performances. Tuning such code to achieve a pick performance is 
generally a fine art.
Optimizations techniques can include but are not limited to:
 ?- SIMD instructions (and memory alignment for their optimal use);
 ?- instruction level parallelism;
 ?- unrolling loops;
 ?- cache level (mis-)hits;
 ?- multi-thread parallelism;
 ?- ...
Approaches in optimization are not the same depending on kind of 
application: CPU-bound, memory-bound or IO-bound.
Many of this techniques can be directly used (or not) by compiler 
depending on chosen options. Are you sure to use the same options and 
compiler that were used during R compilation?
And finally, the compared code could be plainly not the same. R can use 
BLAS call, e.g. OpenBLAS to multiply two matrices. This latter is 
heavily optimized for such operations and can achieve x10 acceleration 
compared to plain "naive" BLAS.
The R code you cite can be just the code for a fallback in case no BLAS 
was found during R compilation.
Look at what your sessionInfo() says about used BLAS.

Best,
Serguei.

Le 05/12/2024 ? 14:21, Luc De Wilde a ?crit?:
> Dear package developers,
>
> in creating a package lavaanC for use in lavaan, I need to perform some matrix computations involving matrix products and crossproducts. As far as I see I cannot directly call the C code in the R core. So I copied the code in the R core, but the same C/C++ code in a package is 2.5 ? 3 times slower than executed directly in R :
>
> C code in package :
>  ? SEXP prod0(SEXP mat1, SEXP mat2) {
>  ? ? SEXP u1 = Rf_getAttrib(mat1, R_DimSymbol);
>  ? ? int m1 = INTEGER(u1)[0];
>  ? ? int n1 = INTEGER(u1)[1];
>  ? ? SEXP u2 = Rf_getAttrib(mat2, R_DimSymbol);
>  ? ? int m2 = INTEGER(u2)[0];
>  ? ? int n2 = INTEGER(u2)[1];
>  ? ? if (n1 != m2) Rf_error("matrices not conforming");
>  ? ? SEXP retval = PROTECT(Rf_allocMatrix(REALSXP, m1, n2));
>  ? ? double* left = REAL(mat1);
>  ? ? double* right = REAL(mat2);
>  ? ? double* ret = REAL(retval);
>  ? ? double werk = 0.0;
>  ? ? for (int j = 0; j < n2; j++) {
>  ? ? ? for (int i = 0; i < m1; i++) {
>  ? ? ? ? ? werk = 0.0;
>  ? ? ? ? for (int k = 0; k < n1; k++) werk += (left[i + m1 * k] * right[k + m2 * j]);
>  ? ? ? ? ret[j * m1 + i] = ?werk;
>  ? ? ? }
>  ? ? }
>  ? ? UNPROTECT(1);
>  ? ? return retval;
>  ? }
>
> Test script :
> m1 <- matrix(rnorm(300000), nrow = 60)
> m2 <- matrix(rnorm(300000), ncol = 60)
> print(microbenchmark::microbenchmark(
>    m1 %*% m2, .Call("prod0", m1, m2), times = 100
> ))
>
> Result on my pc:
> Unit: milliseconds
>                     expr     min      lq     mean  median       uq     max neval
>                m1 %*% m2 10.5650 10.8967 11.13434 10.9449 11.02965 15.8397   100
>   .Call("prod0", m1, m2) 29.3336 30.7868 32.05114 31.0408 33.85935 45.5321   100
>
>
> Can anyone explain why the compiled code in the package is so much slower than in R core?
>
> and
>
> Is there a way to improve the performance in R package?
>
>
> Best regards,
>
> Luc De Wilde
>
>
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From edd @end|ng |rom deb|@n@org  Thu Dec  5 15:09:44 2024
From: edd @end|ng |rom deb|@n@org (Dirk Eddelbuettel)
Date: Thu, 5 Dec 2024 08:09:44 -0600
Subject: [R-pkg-devel] 
 Cannot create C code with acceptable performance with
 respect to internal R command.
In-Reply-To: <AM0PR09MB3843075CEA5CD544CA37CFE298302@AM0PR09MB3843.eurprd09.prod.outlook.com>
References: <AM0PR09MB3843E3FD6F0F9F3847ECEC5898302@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <fdda61b7-2258-4273-aab9-19d7e01286f4@gmail.com>
 <AM0PR09MB3843075CEA5CD544CA37CFE298302@AM0PR09MB3843.eurprd09.prod.outlook.com>
Message-ID: <26449.46120.144741.619166@rob.eddelbuettel.com>


Luc,

As Tomas mentioned, matrix-multiplication can take advantage of multiple
threads, and the 'text book' nexted loops do not do that.  Now, one
alternative that appeals a lot to me is to farm out to Armadillo which also
calls LAPACK for you (as R does). And via RcppArmadillo, the setup becomes a
one-liner with the expression 'mat1 * mat2' where '*' is overloaded
appropriately (as is matrix multiplication '%*%' in R).  I include your
example as self-contained and reproducible script below, on my not-so-recent
machine with twelve cores I get

$ Rscript luc.r 
Unit: microseconds
 expr       min        lq     mean    median       uq      max neval cld
    C 29010.538 39242.004 47948.98 50930.500 52715.30 81668.53   100  a 
    R   685.658   800.653  1984.17  1129.754  2719.88  8420.66   100   b
  Cpp   401.182   444.164  1775.03   651.023  1656.24 30369.15   100   b
$ 

but what really shines (in my eyes) is that a function

    arma::mat cppprod(const arma::mat& m1, const arma::mat& m2) {
        return m1 * m2;
    }

gets set-up for you with no worries whatsoever and outscores the R
version. (And if you look into the Rcpp docs you can learn to make this a
little faster still but skipping a (generally recommended !!) handshake with
RNG status etc).

But different strokes for different folks, not everybody likes C++ (which is
both perfectly find and also includes Tomas who saw fit to rail against it
yesterday regarding its compile times which can both tweaked and are also
worse still in some other popular languages) but I digress ...

Hope this helps, Dirk


ccode <- r"(
SEXP u1 = Rf_getAttrib(mat1, R_DimSymbol);
int m1 = INTEGER(u1)[0];
int n1 = INTEGER(u1)[1];
SEXP u2 = Rf_getAttrib(mat2, R_DimSymbol);
int m2 = INTEGER(u2)[0];
int n2 = INTEGER(u2)[1];
if (n1 != m2) Rf_error("matrices not conforming");
SEXP retval = PROTECT(Rf_allocMatrix(REALSXP, m1, n2));
double* left = REAL(mat1);
double* right = REAL(mat2);
double* ret = REAL(retval);
double werk = 0.0;
for (int j = 0; j < n2; j++) {
  for (int i = 0; i < m1; i++) {
     werk = 0.0;
     for (int k = 0; k < n1; k++)
       werk += (left[i + m1 * k] * right[k + m2 * j]);
     ret[j * m1 + i] = werk;
  }
}
UNPROTECT(1);
return retval;
)"
cprod <- inline::cfunction(sig=signature(mat1="numeric", mat2="numeric"), body=ccode, language="C")

Rcpp::cppFunction("arma::mat cppprod(const arma::mat& m1, const arma::mat& m2) { return m1 * m2; }", depends="RcppArmadillo")

set.seed(123)
m1 <- matrix(rnorm(300000), nrow = 60)
m2 <- matrix(rnorm(300000), ncol = 60)
print(microbenchmark::microbenchmark(C = cprod(m1, m2),
                                     R = m1 %*% m2,
                                     Cpp = cppprod(m1, m2),
                                     times = 100))

-- 
dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org


From @zz@||n| @end|ng |rom @t@t@un|pd@|t  Thu Dec  5 16:36:45 2024
From: @zz@||n| @end|ng |rom @t@t@un|pd@|t (Adelchi Azzalini)
Date: Thu, 5 Dec 2024 16:36:45 +0100
Subject: [R-pkg-devel] conditional import of a package?
In-Reply-To: <4d818ee1-e4c7-4366-b5a7-76e81cc22a3e@gmail.com>
References: <562E9DD8-97A4-4B30-A568-C814CADF7F11@stat.unipd.it>
 <2f5a7a59-0b68-4e99-ab3f-3064d45dcd36@gmail.com>
 <8B8E7114-B848-4D9F-81A6-A22B43CCEC46@stat.unipd.it>
 <4d818ee1-e4c7-4366-b5a7-76e81cc22a3e@gmail.com>
Message-ID: <D12E7668-3B78-4390-ADD7-35C1C94D149D@stat.unipd.it>

Hi. Thanks for the additional advice. It now works!

I only had to move the assignment of  nloptr.methods outside the if(.) block in the first chunk of code, otherwise the variable was undefined for the second block. This issue only showed up when I tried the newly created package on a machine without nloptr installed.

Best regards, and thanks again for your kind help.

Adelchi


> On 5 Dec 2024, at 11:41, Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
> 
> On 2024-12-05 3:06 a.m., Adelchi Azzalini wrote:
>> Thanks, Duncan, for the kind advice.
>> In my understanding, this is what I have done (or I tried to do).  My code is as follows:
>>   opt.methods <- c("Nelder-Mead", "BFGS", "nlminb")
>>   if(requireNamespace("nloptr", quietly = TRUE)) {
>>     nloptr.methods <- c("newuoa", "bobyqa", "cobyla")
>>     if(opt.method %in%  nloptr.methods) require(nloptr, quietly=TRUE)
> 
> You shouldn't use `require(nloptr, quietly=TRUE)`.  That puts it on the search list, and packages should generally not modify the search list.
> 
> Just before this in your code, you know that nloptr is loaded.  You don't know if it's on the search list or not, and that shouldn't matter.
> 
>>     opt.methods <- c(opt.methods, nloptr.methods)
>>    }
>> <skip>
>>    if(opt.method %in% nloptr.methods) {
>>       pos <- match("package:nloptr", search())
>>       nloptr.method <-  get(paste("nloptr", opt.method, sep="::"), pos=pos)
>>       opt <- nloptr.method(<args>)
>>       }
> 
> The code above relies on having nloptr on the search list, and you don't know that, so you'll need a different way to set nloptr.method.  Another problem is that at this point you don't know if nloptr is loaded or not, because the requireNamespace() call above might have returned FALSE.
> 
> What I would do is to set nloptr.method in the code block above, i.e. change the first block to
> 
>    opt.methods <- c("Nelder-Mead", "BFGS", "nlminb")
>    if(requireNamespace("nloptr", quietly = TRUE)) {
>      nloptr.methods <- c("newuoa", "bobyqa", "cobyla")
>      if(opt.method %in%  nloptr.methods)
>        nloptr.method <- get(opt.method,
>                             envir = loadNamespace("nloptr"))
>    } else
>      nloptr.method <- function(...) stop("this optimization needs the nloptr package.")
> 
> 
> The second block could then be simplified to
> 
>     if(opt.method %in% nloptr.methods)
>        opt <- nloptr.method(<args>)
> 
> 
>>        In the DESCRIPTION file there is
>>    Suggests: ggplot2, survival, nloptr
> 
> That should be fine.
> 
>> However, when I run ?R CMD check <etc>?, I get the following message
>> * checking package dependencies ... ERROR
>> Namespace dependency missing from DESCRIPTION Imports/Depends entries: ?nloptr?
>> See section ?The DESCRIPTION file? in the ?Writing R Extensions?
>> manual.
>> * DONE
>> And - admittedly - I have no idea about how to insert appropriate import statements in NAMESPACE.
> 
> You shouldn't need to do that.
> 
> Duncan Murdoch
> 
>> Best regards,
>> Adelchi
>>> On 4 Dec 2024, at 20:56, Duncan Murdoch <murdoch.duncan at gmail.com> wrote:
>>> 
>>> On 2024-12-04 1:25 p.m., Adelchi Azzalini wrote:
>>>> Hi. I am working on the development of an existing package (smof, on CRAN). My current aim is widen the list of possible optimizers from which the user can select one method for optimizing a certain task. Well-known possibilities within the base package are optim (with various options) and nlminb. Besides these, I am thinking of including also those of package nloptr, but without forcing users to install this package which perhaps they don't need for other purposes. Hence, I would like to import nloptr only if it is available on the user system; it not, I can just confine the list of optimizers to optim and nlminb.
>>>> This idea implies a sort of ?conditional import? of nloptr. Is this possible? Section 1.1.3.1 "Suggested packages" of
>>>> https://translation.r-project.org/man/R-exts/R-exts-ko.html#Suggested-packages
>>>> seems to hint at such a possibility.  See the use of requireNamespace in the second paragraph.
>>>> After elaborating along this line, I packaged my code, with nloptr listed on the line Suggests of DESCRIPTION.  However this attempt failed a the ?R CMD check ? stage with message
>>>> Namespace dependency missing from DESCRIPTION Imports/Depends entries: ?nloptr?
>>>> In addition, I have no idea of how to declare a "conditional import? in NAMESPACE.
>>>> Is this idea of ?conditional import? totally unfeasible, then?
>>> 
>>> The usual way to do this is to list the package in Suggests, and then wrap any use of it in `if (requireNamespace("pkg")) { ... }` blocks. This doesn't quite import the functions, you would need to use the `pkg::fn` syntax to access the functions.
>>> 
>>> If you really want to simulate importing so that you don't need the `pkg::` prefix, you could do it this way:  In the `.onLoad` function of your package, you would have code like
>>> 
>>>  if (requireNamespace("pkg")) {
>>>    foo <- pkg::foo
>>>    bar <- pkg::bar
>>>  } else {
>>>    foo <- stub
>>>    bar <- stub
>>>  }
>>> 
>>> where `stub` is a function that says "you need `pkg` to use this function".
>>> 
>>> Duncan Murdoch
>>> 
> 


From Luc@DeW||de @end|ng |rom UGent@be  Thu Dec  5 23:14:03 2024
From: Luc@DeW||de @end|ng |rom UGent@be (Luc De Wilde)
Date: Thu, 5 Dec 2024 22:14:03 +0000
Subject: [R-pkg-devel] 
 Cannot create C code with acceptable performance with
 respect to internal R command.
In-Reply-To: <26449.46120.144741.619166@rob.eddelbuettel.com>
References: <AM0PR09MB3843E3FD6F0F9F3847ECEC5898302@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <fdda61b7-2258-4273-aab9-19d7e01286f4@gmail.com>
 <AM0PR09MB3843075CEA5CD544CA37CFE298302@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <26449.46120.144741.619166@rob.eddelbuettel.com>
Message-ID: <AM0PR09MB3843BE9F3B6B1BC43774583A98302@AM0PR09MB3843.eurprd09.prod.outlook.com>

Dirk,

that's indeed an easy way to go, but I'm searching for methods that doesn't need to add other dependencies in my package, so the answer of Avraham is the most relevant for me.

But off course, thank you for your help!

Luc

________________________________
Van: Dirk Eddelbuettel <edd at debian.org>
Verzonden: donderdag 5 december 2024 15:09
Aan: Luc De Wilde <Luc.DeWilde at UGent.be>
CC: Tomas Kalibera <tomas.kalibera at gmail.com>; r-package-devel at r-project.org <r-package-devel at r-project.org>; Yves Rosseel <Yves.Rosseel at UGent.be>
Onderwerp: Re: [R-pkg-devel] Cannot create C code with acceptable performance with respect to internal R command.


Luc,

As Tomas mentioned, matrix-multiplication can take advantage of multiple
threads, and the 'text book' nexted loops do not do that.  Now, one
alternative that appeals a lot to me is to farm out to Armadillo which also
calls LAPACK for you (as R does). And via RcppArmadillo, the setup becomes a
one-liner with the expression 'mat1 * mat2' where '*' is overloaded
appropriately (as is matrix multiplication '%*%' in R).  I include your
example as self-contained and reproducible script below, on my not-so-recent
machine with twelve cores I get

$ Rscript luc.r
Unit: microseconds
 expr       min        lq     mean    median       uq      max neval cld
    C 29010.538 39242.004 47948.98 50930.500 52715.30 81668.53   100  a
    R   685.658   800.653  1984.17  1129.754  2719.88  8420.66   100   b
  Cpp   401.182   444.164  1775.03   651.023  1656.24 30369.15   100   b
$

but what really shines (in my eyes) is that a function

    arma::mat cppprod(const arma::mat& m1, const arma::mat& m2) {
        return m1 * m2;
    }

gets set-up for you with no worries whatsoever and outscores the R
version. (And if you look into the Rcpp docs you can learn to make this a
little faster still but skipping a (generally recommended !!) handshake with
RNG status etc).

But different strokes for different folks, not everybody likes C++ (which is
both perfectly find and also includes Tomas who saw fit to rail against it
yesterday regarding its compile times which can both tweaked and are also
worse still in some other popular languages) but I digress ...

Hope this helps, Dirk


ccode <- r"(
SEXP u1 = Rf_getAttrib(mat1, R_DimSymbol);
int m1 = INTEGER(u1)[0];
int n1 = INTEGER(u1)[1];
SEXP u2 = Rf_getAttrib(mat2, R_DimSymbol);
int m2 = INTEGER(u2)[0];
int n2 = INTEGER(u2)[1];
if (n1 != m2) Rf_error("matrices not conforming");
SEXP retval = PROTECT(Rf_allocMatrix(REALSXP, m1, n2));
double* left = REAL(mat1);
double* right = REAL(mat2);
double* ret = REAL(retval);
double werk = 0.0;
for (int j = 0; j < n2; j++) {
  for (int i = 0; i < m1; i++) {
     werk = 0.0;
     for (int k = 0; k < n1; k++)
       werk += (left[i + m1 * k] * right[k + m2 * j]);
     ret[j * m1 + i] = werk;
  }
}
UNPROTECT(1);
return retval;
)"
cprod <- inline::cfunction(sig=signature(mat1="numeric", mat2="numeric"), body=ccode, language="C")

Rcpp::cppFunction("arma::mat cppprod(const arma::mat& m1, const arma::mat& m2) { return m1 * m2; }", depends="RcppArmadillo")

set.seed(123)
m1 <- matrix(rnorm(300000), nrow = 60)
m2 <- matrix(rnorm(300000), ncol = 60)
print(microbenchmark::microbenchmark(C = cprod(m1, m2),
                                     R = m1 %*% m2,
                                     Cpp = cppprod(m1, m2),
                                     times = 100))

--
dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org

	[[alternative HTML version deleted]]


From @vr@h@m@@d|er @end|ng |rom gm@||@com  Fri Dec  6 08:58:10 2024
From: @vr@h@m@@d|er @end|ng |rom gm@||@com (Avraham Adler)
Date: Fri, 6 Dec 2024 09:58:10 +0200
Subject: [R-pkg-devel] 
 Cannot create C code with acceptable performance with
 respect to internal R command.
In-Reply-To: <140e06f2-202c-4f98-8d65-189fcf061450@gmail.com>
References: <140e06f2-202c-4f98-8d65-189fcf061450@gmail.com>
Message-ID: <D73C8AC0-ED5B-40F0-8B4A-0627E753F49A@gmail.com>


Sent from my iPhone

> On Dec 5, 2024, at 4:11?PM, Sokol Serguei <serguei.sokol at gmail.com> wrote:
> 
> ?Luc,
> 
> There can be many reasons explaining the difference in compiled code performances. Tuning such code to achieve a pick performance is generally a fine art.
> Optimizations techniques can include but are not limited to:
>  - SIMD instructions (and memory alignment for their optimal use);
>  - instruction level parallelism;
>  - unrolling loops;
>  - cache level (mis-)hits;
>  - multi-thread parallelism;
>  - ...
> Approaches in optimization are not the same depending on kind of application: CPU-bound, memory-bound or IO-bound.
> Many of this techniques can be directly used (or not) by compiler depending on chosen options. Are you sure to use the same options and compiler that were used during R compilation?
> And finally, the compared code could be plainly not the same. R can use BLAS call, e.g. OpenBLAS to multiply two matrices. This latter is heavily optimized for such operations and can achieve x10 acceleration compared to plain "naive" BLAS.
> The R code you cite can be just the code for a fallback in case no BLAS was found during R compilation.
> Look at what your sessionInfo() says about used BLAS.

That doesn?t always work. I build R on Windows (10) linking to a pre-compiled static OpenBLAS (3.28) and my sessionInfo has an empty string for BLAS. I reckon that is because I?m using Rblas.dll, it?s just that my Rblas isn?t vanilla. 

Avi

> 
> Best,
> Serguei.
> 
>> Le 05/12/2024 ? 14:21, Luc De Wilde a ?crit :
>> Dear package developers,
>> 
>> in creating a package lavaanC for use in lavaan, I need to perform some matrix computations involving matrix products and crossproducts. As far as I see I cannot directly call the C code in the R core. So I copied the code in the R core, but the same C/C++ code in a package is 2.5 ? 3 times slower than executed directly in R :
>> 
>> C code in package :
>>   SEXP prod0(SEXP mat1, SEXP mat2) {
>>     SEXP u1 = Rf_getAttrib(mat1, R_DimSymbol);
>>     int m1 = INTEGER(u1)[0];
>>     int n1 = INTEGER(u1)[1];
>>     SEXP u2 = Rf_getAttrib(mat2, R_DimSymbol);
>>     int m2 = INTEGER(u2)[0];
>>     int n2 = INTEGER(u2)[1];
>>     if (n1 != m2) Rf_error("matrices not conforming");
>>     SEXP retval = PROTECT(Rf_allocMatrix(REALSXP, m1, n2));
>>     double* left = REAL(mat1);
>>     double* right = REAL(mat2);
>>     double* ret = REAL(retval);
>>     double werk = 0.0;
>>     for (int j = 0; j < n2; j++) {
>>       for (int i = 0; i < m1; i++) {
>>           werk = 0.0;
>>         for (int k = 0; k < n1; k++) werk += (left[i + m1 * k] * right[k + m2 * j]);
>>         ret[j * m1 + i] =  werk;
>>       }
>>     }
>>     UNPROTECT(1);
>>     return retval;
>>   }
>> 
>> Test script :
>> m1 <- matrix(rnorm(300000), nrow = 60)
>> m2 <- matrix(rnorm(300000), ncol = 60)
>> print(microbenchmark::microbenchmark(
>>   m1 %*% m2, .Call("prod0", m1, m2), times = 100
>> ))
>> 
>> Result on my pc:
>> Unit: milliseconds
>>                    expr     min      lq     mean  median       uq     max neval
>>               m1 %*% m2 10.5650 10.8967 11.13434 10.9449 11.02965 15.8397   100
>>  .Call("prod0", m1, m2) 29.3336 30.7868 32.05114 31.0408 33.85935 45.5321   100
>> 
>> 
>> Can anyone explain why the compiled code in the package is so much slower than in R core?
>> 
>> and
>> 
>> Is there a way to improve the performance in R package?
>> 
>> 
>> Best regards,
>> 
>> Luc De Wilde
>> 
>> 
>> 
>> ______________________________________________
>> R-package-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-package-devel
> 
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From Luc@DeW||de @end|ng |rom UGent@be  Fri Dec  6 09:39:08 2024
From: Luc@DeW||de @end|ng |rom UGent@be (Luc De Wilde)
Date: Fri, 6 Dec 2024 08:39:08 +0000
Subject: [R-pkg-devel] 
 Cannot create C code with acceptable performance with
 respect to internal R command.
In-Reply-To: <60433DA0-BD30-48E8-B189-C4651A5372DB@gmail.com>
References: <AM0PR09MB3843BE9F3B6B1BC43774583A98302@AM0PR09MB3843.eurprd09.prod.outlook.com>
 <60433DA0-BD30-48E8-B189-C4651A5372DB@gmail.com>
Message-ID: <AM0PR09MB3843CA93CE9D6D99925D188B98312@AM0PR09MB3843.eurprd09.prod.outlook.com>

Thanks to all help, I finally got two (!) solutions for my problem :?


Unit: milliseconds
                                        expr     min       lq     mean   median       uq     max neval
                                   m1 %*% m2 11.2685 11.48595 11.83029 11.60745 11.83170 17.2381   200
 .Call("prod0", m1, m2, PACKAGE = "ldwTest") 10.8301 11.03360 11.43360 11.18950 11.36395 24.4530   200
 .Call("prod2", m1, m2, PACKAGE = "ldwTest") 10.7453 10.96310 11.29727 11.09395 11.31465 17.3467   200

m& %*% m2 : R matrix product

prod0 : the BLAS fortran GEMM routine rewritten in C++ (there was an important rearrangement of the for loops to improve cache use)

prod1 : call, in C++, of the BLAS fortran GEMM routine



Luc

________________________________________
Van:?Avraham Adler <avraham.adler at gmail.com>
Verzonden:?vrijdag 6 december 2024 8:46
Aan:?Luc De Wilde <Luc.DeWilde at UGent.be>
CC:?Dirk Eddelbuettel <edd at debian.org>; Yves Rosseel <Yves.Rosseel at UGent.be>; r-package-devel at r-project.org <r-package-devel at r-project.org>
Onderwerp:?Re: [R-pkg-devel] Cannot create C code with acceptable performance with respect to internal R command.
?
For future reference and completeness, since I responded off list, I simply pointed out to Luke an example of using R?s BLAS interface with DGEMV. He needs DGEMM, but the idea is the same.?

<?https://github.com/aadler/minimaxApprox/blob/master/src/Chebyshev.c>

Avi

Sent from my iPhone

On Dec 6, 2024, at 12:14?AM, Luc De Wilde <Luc.DeWilde at ugent.be> wrote:

?Dirk,

that's indeed an easy way to go, but I'm searching for methods that doesn't need to add other dependencies in my package, so the answer of Avraham is the most relevant for me.

But off course, thank you for your help!

Luc

________________________________
Van: Dirk Eddelbuettel <edd at debian.org>
Verzonden: donderdag 5 december 2024 15:09
Aan: Luc De Wilde <Luc.DeWilde at UGent.be>
CC: Tomas Kalibera <tomas.kalibera at gmail.com>; r-package-devel at r-project.org <r-package-devel at r-project.org>; Yves Rosseel <Yves.Rosseel at UGent.be>
Onderwerp: Re: [R-pkg-devel] Cannot create C code with acceptable performance with respect to internal R command.


Luc,

As Tomas mentioned, matrix-multiplication can take advantage of multiple
threads, and the 'text book' nexted loops do not do that. ?Now, one
alternative that appeals a lot to me is to farm out to Armadillo which also
calls LAPACK for you (as R does). And via RcppArmadillo, the setup becomes a
one-liner with the expression 'mat1 * mat2' where '*' is overloaded
appropriately (as is matrix multiplication '%*%' in R). ?I include your
example as self-contained and reproducible script below, on my not-so-recent
machine with twelve cores I get

$ Rscript luc.r
Unit: microseconds
expr ??????min ???????lq ????mean ???median ??????uq ?????max neval cld
???C 29010.538 39242.004 47948.98 50930.500 52715.30 81668.53 ??100 ?a
???R ??685.658 ??800.653 ?1984.17 ?1129.754 ?2719.88 ?8420.66 ??100 ??b
?Cpp ??401.182 ??444.164 ?1775.03 ??651.023 ?1656.24 30369.15 ??100 ??b
$

but what really shines (in my eyes) is that a function

???arma::mat cppprod(const arma::mat& m1, const arma::mat& m2) {
???????return m1 * m2;
???}

gets set-up for you with no worries whatsoever and outscores the R
version. (And if you look into the Rcpp docs you can learn to make this a
little faster still but skipping a (generally recommended !!) handshake with
RNG status etc).

But different strokes for different folks, not everybody likes C++ (which is
both perfectly find and also includes Tomas who saw fit to rail against it
yesterday regarding its compile times which can both tweaked and are also
worse still in some other popular languages) but I digress ...

Hope this helps, Dirk


ccode <- r"(
SEXP u1 = Rf_getAttrib(mat1, R_DimSymbol);
int m1 = INTEGER(u1)[0];
int n1 = INTEGER(u1)[1];
SEXP u2 = Rf_getAttrib(mat2, R_DimSymbol);
int m2 = INTEGER(u2)[0];
int n2 = INTEGER(u2)[1];
if (n1 != m2) Rf_error("matrices not conforming");
SEXP retval = PROTECT(Rf_allocMatrix(REALSXP, m1, n2));
double* left = REAL(mat1);
double* right = REAL(mat2);
double* ret = REAL(retval);
double werk = 0.0;
for (int j = 0; j < n2; j++) {
?for (int i = 0; i < m1; i++) {
????werk = 0.0;
????for (int k = 0; k < n1; k++)
??????werk += (left[i + m1 * k] * right[k + m2 * j]);
????ret[j * m1 + i] = werk;
?}
}
UNPROTECT(1);
return retval;
)"
cprod <- inline::cfunction(sig=signature(mat1="numeric", mat2="numeric"), body=ccode, language="C")

Rcpp::cppFunction("arma::mat cppprod(const arma::mat& m1, const arma::mat& m2) { return m1 * m2; }", depends="RcppArmadillo")

set.seed(123)
m1 <- matrix(rnorm(300000), nrow = 60)
m2 <- matrix(rnorm(300000), ncol = 60)
print(microbenchmark::microbenchmark(C = cprod(m1, m2),
????????????????????????????????????R = m1 %*% m2,
????????????????????????????????????Cpp = cppprod(m1, m2),
????????????????????????????????????times = 100))

--
dirk.eddelbuettel.com | @eddelbuettel | edd at debian.org

? ?[[alternative HTML version deleted]]

______________________________________________
R-package-devel at r-project.org mailing list
https://stat.ethz.ch/mailman/listinfo/r-package-devel

From tom@@@k@||ber@ @end|ng |rom gm@||@com  Fri Dec  6 15:50:23 2024
From: tom@@@k@||ber@ @end|ng |rom gm@||@com (Tomas Kalibera)
Date: Fri, 6 Dec 2024 15:50:23 +0100
Subject: [R-pkg-devel] 
 Cannot create C code with acceptable performance with
 respect to internal R command.
In-Reply-To: <D73C8AC0-ED5B-40F0-8B4A-0627E753F49A@gmail.com>
References: <140e06f2-202c-4f98-8d65-189fcf061450@gmail.com>
 <D73C8AC0-ED5B-40F0-8B4A-0627E753F49A@gmail.com>
Message-ID: <4c5af64e-0907-4d24-8c95-8be00b7e16cd@gmail.com>


On 12/6/24 08:58, Avraham Adler wrote:
> Sent from my iPhone
>
>> On Dec 5, 2024, at 4:11?PM, Sokol Serguei <serguei.sokol at gmail.com> wrote:
>>
>> ?Luc,
>>
>> There can be many reasons explaining the difference in compiled code performances. Tuning such code to achieve a pick performance is generally a fine art.
>> Optimizations techniques can include but are not limited to:
>>   - SIMD instructions (and memory alignment for their optimal use);
>>   - instruction level parallelism;
>>   - unrolling loops;
>>   - cache level (mis-)hits;
>>   - multi-thread parallelism;
>>   - ...
>> Approaches in optimization are not the same depending on kind of application: CPU-bound, memory-bound or IO-bound.
>> Many of this techniques can be directly used (or not) by compiler depending on chosen options. Are you sure to use the same options and compiler that were used during R compilation?
>> And finally, the compared code could be plainly not the same. R can use BLAS call, e.g. OpenBLAS to multiply two matrices. This latter is heavily optimized for such operations and can achieve x10 acceleration compared to plain "naive" BLAS.
>> The R code you cite can be just the code for a fallback in case no BLAS was found during R compilation.
>> Look at what your sessionInfo() says about used BLAS.
> That doesn?t always work. I build R on Windows (10) linking to a pre-compiled static OpenBLAS (3.28) and my sessionInfo has an empty string for BLAS. I reckon that is because I?m using Rblas.dll, it?s just that my Rblas isn?t vanilla.
Right, the BLAS/LAPACK detection in sessionInfo() is only implemented 
for Unix, tested on Linux and macOS.

Tomas

>
> Avi
>
>> Best,
>> Serguei.
>>
>>> Le 05/12/2024 ? 14:21, Luc De Wilde a ?crit :
>>> Dear package developers,
>>>
>>> in creating a package lavaanC for use in lavaan, I need to perform some matrix computations involving matrix products and crossproducts. As far as I see I cannot directly call the C code in the R core. So I copied the code in the R core, but the same C/C++ code in a package is 2.5 ? 3 times slower than executed directly in R :
>>>
>>> C code in package :
>>>    SEXP prod0(SEXP mat1, SEXP mat2) {
>>>      SEXP u1 = Rf_getAttrib(mat1, R_DimSymbol);
>>>      int m1 = INTEGER(u1)[0];
>>>      int n1 = INTEGER(u1)[1];
>>>      SEXP u2 = Rf_getAttrib(mat2, R_DimSymbol);
>>>      int m2 = INTEGER(u2)[0];
>>>      int n2 = INTEGER(u2)[1];
>>>      if (n1 != m2) Rf_error("matrices not conforming");
>>>      SEXP retval = PROTECT(Rf_allocMatrix(REALSXP, m1, n2));
>>>      double* left = REAL(mat1);
>>>      double* right = REAL(mat2);
>>>      double* ret = REAL(retval);
>>>      double werk = 0.0;
>>>      for (int j = 0; j < n2; j++) {
>>>        for (int i = 0; i < m1; i++) {
>>>            werk = 0.0;
>>>          for (int k = 0; k < n1; k++) werk += (left[i + m1 * k] * right[k + m2 * j]);
>>>          ret[j * m1 + i] =  werk;
>>>        }
>>>      }
>>>      UNPROTECT(1);
>>>      return retval;
>>>    }
>>>
>>> Test script :
>>> m1 <- matrix(rnorm(300000), nrow = 60)
>>> m2 <- matrix(rnorm(300000), ncol = 60)
>>> print(microbenchmark::microbenchmark(
>>>    m1 %*% m2, .Call("prod0", m1, m2), times = 100
>>> ))
>>>
>>> Result on my pc:
>>> Unit: milliseconds
>>>                     expr     min      lq     mean  median       uq     max neval
>>>                m1 %*% m2 10.5650 10.8967 11.13434 10.9449 11.02965 15.8397   100
>>>   .Call("prod0", m1, m2) 29.3336 30.7868 32.05114 31.0408 33.85935 45.5321   100
>>>
>>>
>>> Can anyone explain why the compiled code in the package is so much slower than in R core?
>>>
>>> and
>>>
>>> Is there a way to improve the performance in R package?
>>>
>>>
>>> Best regards,
>>>
>>> Luc De Wilde
>>>
>>>
>>>
>>> ______________________________________________
>>> R-package-devel at r-project.org mailing list
>>> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>> ______________________________________________
>> R-package-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-package-devel
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From pro|jcn@@h @end|ng |rom gm@||@com  Tue Dec 10 15:02:05 2024
From: pro|jcn@@h @end|ng |rom gm@||@com (J C Nash)
Date: Tue, 10 Dec 2024 09:02:05 -0500
Subject: [R-pkg-devel] Query about broken reverse dependencies that already
 are broken
Message-ID: <93067192-36f0-4b9a-8365-0b08a48bb523@gmail.com>

This is a question about how things are done rather than a request for a fix.

Yesterday I re-submitted my optimx package with some small but important fixes
(e.g., one place where one solver would miss catching function evaluation limits).
I'd done a revdepcheck that came up with "Wow, no problems", but in fact one of
the revdeps had a test failure which was already flagged in its checks list on
CRAN. A package test example had a singularity on some systems. This can happen with
nonlinear function minimization due to very small changes in arithmetic and
approximations of different systems. Putting in checks and "graceful failure"
for such conditions is the ideal for optimization solvers, but it isn't easy.
Some of the changes in the optimx update submitted are of this flavour.

When the submission checks came back this morning there was a
"Changes to worse in reverse depends:", even though there really is no change.
However, I then got a msg "Thanks, on its way to CRAN."

Am I correct in assuming a manual review passed the package (which hopefully I
did get fully compliant)? Or will I get an eventual "please fix" for something
clearly outside my scope of action?

As indicated, at the moment this isn't a request for help, though that may come
later.

Cheers,

John Nash


From ||gge@ @end|ng |rom @t@t|@t|k@tu-dortmund@de  Tue Dec 10 15:42:48 2024
From: ||gge@ @end|ng |rom @t@t|@t|k@tu-dortmund@de (Uwe Ligges)
Date: Tue, 10 Dec 2024 15:42:48 +0100
Subject: [R-pkg-devel] 
 Query about broken reverse dependencies that already are broken
In-Reply-To: <93067192-36f0-4b9a-8365-0b08a48bb523@gmail.com>
References: <93067192-36f0-4b9a-8365-0b08a48bb523@gmail.com>
Message-ID: <96a6b850-4a09-4fa5-af8d-1b4c51fd0f99@statistik.tu-dortmund.de>



On 10.12.2024 15:02, J C Nash wrote:
> This is a question about how things are done rather than a request for a 
> fix.
> 
> Yesterday I re-submitted my optimx package with some small but important 
> fixes
> (e.g., one place where one solver would miss catching function 
> evaluation limits).
> I'd done a revdepcheck that came up with "Wow, no problems", but in fact 
> one of
> the revdeps had a test failure which was already flagged in its checks 
> list on
> CRAN. A package test example had a singularity on some systems. This can 
> happen with
> nonlinear function minimization due to very small changes in arithmetic and
> approximations of different systems. Putting in checks and "graceful 
> failure"
> for such conditions is the ideal for optimization solvers, but it isn't 
> easy.
> Some of the changes in the optimx update submitted are of this flavour.
> 
> When the submission checks came back this morning there was a
> "Changes to worse in reverse depends:", even though there really is no 
> change.
> However, I then got a msg "Thanks, on its way to CRAN."

Indeed, as I have seen the packages with "changes to worse" had similar 
issues on another platform even before your change, I had let yours pass.

Best,
Uwe Ligges

> 
> Am I correct in assuming a manual review passed the package (which 
> hopefully I
> did get fully compliant)? Or will I get an eventual "please fix" for 
> something
> clearly outside my scope of action?
> 
> As indicated, at the moment this isn't a request for help, though that 
> may come
> later.
> 
> Cheers,
> 
> John Nash
> 
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel

From @n248 @end|ng |rom corne||@edu  Wed Dec 11 05:23:41 2024
From: @n248 @end|ng |rom corne||@edu (Satyaprakash Nayak)
Date: Tue, 10 Dec 2024 23:23:41 -0500
Subject: [R-pkg-devel] Creating and hosting static libraries for package
 installation on Windows
Message-ID: <CAM3Cqv+WJjKSjLpv-_2rXDK2E8OF3MbF1zUTaxyhK6APwQiYbw@mail.gmail.com>

Hi r-package-devel

I am working on updating my package `sundialr` (
https://cran.r-project.org/web/packages/sundialr/index.html), wherein I was
earlier bundling the C source files with the package, but now I am using
`cmake` to create static libraries for the upstream C library SUNDIALS
which the package provides an interface for. In brief, the previous
approach can be found at:

https://github.com/sn248/sundialr/blob/master/src/Makevars

And the new approach can be seen below (heavily borrowed from nloptr
package installation approach):

https://github.com/sn248/sundialr/blob/cmake-install/tools/cmake_call.sh

The second approach works successfully on linux and macOS platforms
(checked by rhub).

I am struggling to get this working on a Windows platform, and have looked
at a few packages (e.g., nloptr, rcppredis, openssl) which have solved this
issue. As I understand the following steps are required to get the static
libraries in correct locations for package installation on the Windows

1) Host the .tar.gz files or .zip files on https://github.com/rwinlib/
(deprecated now) or https://github.com/r-windows/bundles/releases/download/
which should contain the static libraries (*.a files) in separate folders
for i386, x64-ucrt and x-64 platforms and required header files in the
`include` folder.

2) Use a winlibs.R file within the `tools` sub-directory in the package
file structure to download the .zip or .tar.gz file and extract them to a
`windows` directory.

3) Set PKG_CPPFLAGS and PKG_LIBS via Makewars.win file in src sub-directory
in the package files.

Currently, I am struggling with Step #1, i.e., how to create the required
.zip or .tar.gz files and host them on
https://github.com/r-windows/bundles/releases for download. I will be
thankful if any one can provide some guidance in this regard.

Sincerely
Satya

	[[alternative HTML version deleted]]


From ||gge@ @end|ng |rom @t@t|@t|k@tu-dortmund@de  Wed Dec 11 10:23:08 2024
From: ||gge@ @end|ng |rom @t@t|@t|k@tu-dortmund@de (Uwe Ligges)
Date: Wed, 11 Dec 2024 10:23:08 +0100
Subject: [R-pkg-devel] Creating and hosting static libraries for package
 installation on Windows
In-Reply-To: <CAM3Cqv+WJjKSjLpv-_2rXDK2E8OF3MbF1zUTaxyhK6APwQiYbw@mail.gmail.com>
References: <CAM3Cqv+WJjKSjLpv-_2rXDK2E8OF3MbF1zUTaxyhK6APwQiYbw@mail.gmail.com>
Message-ID: <753efe58-1b6a-4f67-af29-66ea29665649@statistik.tu-dortmund.de>

We really want to get rid of having compiled code imported during the 
installation process. Ideally talk to Tomas Kalibera to get the 
libraries you need included in to the next Rtools update.

Best,
Uwe Ligges


On 11.12.2024 05:23, Satyaprakash Nayak wrote:
> Hi r-package-devel
> 
> I am working on updating my package `sundialr` (
> https://cran.r-project.org/web/packages/sundialr/index.html), wherein I was
> earlier bundling the C source files with the package, but now I am using
> `cmake` to create static libraries for the upstream C library SUNDIALS
> which the package provides an interface for. In brief, the previous
> approach can be found at:
> 
> https://github.com/sn248/sundialr/blob/master/src/Makevars
> 
> And the new approach can be seen below (heavily borrowed from nloptr
> package installation approach):
> 
> https://github.com/sn248/sundialr/blob/cmake-install/tools/cmake_call.sh
> 
> The second approach works successfully on linux and macOS platforms
> (checked by rhub).
> 
> I am struggling to get this working on a Windows platform, and have looked
> at a few packages (e.g., nloptr, rcppredis, openssl) which have solved this
> issue. As I understand the following steps are required to get the static
> libraries in correct locations for package installation on the Windows
> 
> 1) Host the .tar.gz files or .zip files on https://github.com/rwinlib/
> (deprecated now) or https://github.com/r-windows/bundles/releases/download/
> which should contain the static libraries (*.a files) in separate folders
> for i386, x64-ucrt and x-64 platforms and required header files in the
> `include` folder.
> 
> 2) Use a winlibs.R file within the `tools` sub-directory in the package
> file structure to download the .zip or .tar.gz file and extract them to a
> `windows` directory.
> 
> 3) Set PKG_CPPFLAGS and PKG_LIBS via Makewars.win file in src sub-directory
> in the package files.
> 
> Currently, I am struggling with Step #1, i.e., how to create the required
> .zip or .tar.gz files and host them on
> https://github.com/r-windows/bundles/releases for download. I will be
> thankful if any one can provide some guidance in this regard.
> 
> Sincerely
> Satya
> 
> 	[[alternative HTML version deleted]]
> 
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel

From br@d|eyjeck @end|ng |rom gm@||@com  Wed Dec 11 13:12:11 2024
From: br@d|eyjeck @end|ng |rom gm@||@com (Brad Eck)
Date: Wed, 11 Dec 2024 12:12:11 +0000
Subject: [R-pkg-devel] truncating strings on purpose
Message-ID: <CALECgPaop1dk_Zfxrb-68sJkFfUPtBJ6FHkqMAuNTKbA+t=zPg@mail.gmail.com>

Dear List

The latest update to my epanet2toolkit package bounced from CRAN due to
some warnings about string truncation in C code from gcc.

Found the following significant warnings:
    input2.c:863:5: warning: ?__builtin_strncpy? output may be truncated
copying 225 bytes from a string of length 255 [-Wstringop-truncation]
    input2.c:302:15: warning: ?__builtin_strncpy? output may be truncated
copying 78 bytes from a string of length 1024 [-Wstringop-truncation]
    report.c:795:9: warning: ?__builtin_strncpy? output may be truncated
copying 967 bytes from a string of length 1024 [-Wstringop-truncation]

The package wraps a simulation engine that parses inputs from and
writes results to text files. Where the truncation warnings appear, I
am truncating on purpose using `strncpy` to avoid overflows later.  I
believe this works fine from an application point of view but the
warnings remain.

Any suggestions on how to carry out a truncation so that gcc won't
complain?

Thanks in advance,

Brad

PS - CRAN check info is here
https://win-builder.r-project.org/incoming_pretest/epanet2toolkit_1.0.6_20241209_221743/specialChecks/

PPS the latest CRAN submission is from this branch
https://github.com/bradleyjeck/epanet2toolkit/tree/lto-crash

	[[alternative HTML version deleted]]


From |kry|ov @end|ng |rom d|@root@org  Wed Dec 11 14:29:30 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Wed, 11 Dec 2024 16:29:30 +0300
Subject: [R-pkg-devel] truncating strings on purpose
In-Reply-To: <CALECgPaop1dk_Zfxrb-68sJkFfUPtBJ6FHkqMAuNTKbA+t=zPg@mail.gmail.com>
References: <CALECgPaop1dk_Zfxrb-68sJkFfUPtBJ6FHkqMAuNTKbA+t=zPg@mail.gmail.com>
Message-ID: <20241211162930.38eb4ba3@arachnoid>

? Wed, 11 Dec 2024 12:12:11 +0000
Brad Eck <bradleyjeck at gmail.com> ?????:

> Found the following significant warnings:
>     input2.c:863:5: warning: ?__builtin_strncpy? output may be
> truncated copying 225 bytes from a string of length 255
> [-Wstringop-truncation]

> Where the truncation warnings appear, I am truncating on purpose
> using `strncpy` to avoid overflows later.  I believe this works fine
> from an application point of view but the warnings remain.

GCC documentation suggests setting the length argument to _one less_
than sizeof destination buffer in addition to terminating the string:
https://gcc.gnu.org/onlinedocs/gcc-14.2.0/gcc/Warning-Options.html#index-Wstringop-truncation

        strncpy(trunc_s1, s1, sizeof trunc_s1 - 1);
        trunc_s1[sizeof trunc_s1 - 1] = '\0';

-- 
Best regards,
Ivan


From |kw@|mmo @end|ng |rom gm@||@com  Wed Dec 11 14:29:56 2024
From: |kw@|mmo @end|ng |rom gm@||@com (Iris Simmons)
Date: Wed, 11 Dec 2024 08:29:56 -0500
Subject: [R-pkg-devel] truncating strings on purpose
In-Reply-To: <CALECgPaop1dk_Zfxrb-68sJkFfUPtBJ6FHkqMAuNTKbA+t=zPg@mail.gmail.com>
References: <CALECgPaop1dk_Zfxrb-68sJkFfUPtBJ6FHkqMAuNTKbA+t=zPg@mail.gmail.com>
Message-ID: <CADNULg_UOuKmEUK79T0Wb8nBV4fPoddAw627jnuA3UHbKP7qOw@mail.gmail.com>

You could use memcpy instead. That gets rids of the type checking though.

You could also define something like char * my_strncpy ( char *
destination, const char * source, size_t num ) { return (char *)
memcpy(destination, source, num) } to keep the type checking.

On Wed, Dec 11, 2024, 07:12 Brad Eck <bradleyjeck at gmail.com> wrote:

> Dear List
>
> The latest update to my epanet2toolkit package bounced from CRAN due to
> some warnings about string truncation in C code from gcc.
>
> Found the following significant warnings:
>     input2.c:863:5: warning: ?__builtin_strncpy? output may be truncated
> copying 225 bytes from a string of length 255 [-Wstringop-truncation]
>     input2.c:302:15: warning: ?__builtin_strncpy? output may be truncated
> copying 78 bytes from a string of length 1024 [-Wstringop-truncation]
>     report.c:795:9: warning: ?__builtin_strncpy? output may be truncated
> copying 967 bytes from a string of length 1024 [-Wstringop-truncation]
>
> The package wraps a simulation engine that parses inputs from and
> writes results to text files. Where the truncation warnings appear, I
> am truncating on purpose using `strncpy` to avoid overflows later.  I
> believe this works fine from an application point of view but the
> warnings remain.
>
> Any suggestions on how to carry out a truncation so that gcc won't
> complain?
>
> Thanks in advance,
>
> Brad
>
> PS - CRAN check info is here
>
> https://win-builder.r-project.org/incoming_pretest/epanet2toolkit_1.0.6_20241209_221743/specialChecks/
>
> PPS the latest CRAN submission is from this branch
> https://github.com/bradleyjeck/epanet2toolkit/tree/lto-crash
>
>         [[alternative HTML version deleted]]
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel
>

	[[alternative HTML version deleted]]


From br@d|eyjeck @end|ng |rom gm@||@com  Thu Dec 12 15:46:08 2024
From: br@d|eyjeck @end|ng |rom gm@||@com (Brad Eck)
Date: Thu, 12 Dec 2024 14:46:08 +0000
Subject: [R-pkg-devel] duplicating gcc-UBSAN warning
Message-ID: <CALECgPZGfHrSSYKZeP_-sX5cBhzBn7FwM0RWmZ5Giq-=MpMsnA@mail.gmail.com>

Dear List

I'm trying to duplicate a warning CRAN is seeing on the additional checks
for gcc-UBSAN.  That is using:

CRAN's gcc-UBSAN:
* using R Under development (unstable) (2024-12-04 r87420)
* using platform: x86_64-pc-linux-gnu
* R was compiled by
    gcc-14 (GCC) 14.2.0
    GNU Fortran (GCC) 14.2.0
* running under: Fedora Linux 36 (Workstation Edition)

And gave warnings like.
    input2.c:863:5: warning: ?__builtin_strncpy? output may be truncated
copying 225 bytes from a string of length 255 [-Wstringop-truncation]

To try and duplicate, I added a src/Makevars with
PKG_CFLAGS = -Wstringop-truncation

And ran in two different docker images:
Docker #1 (fedora:40)
* using R version 4.4.2 (2024-10-31)

* using platform: aarch64-redhat-linux-gnu

* R was compiled by

    gcc (GCC) 14.2.1 20240912 (Red Hat 14.2.1-3)

    GNU Fortran (GCC) 14.2.1 20240912 (Red Hat 14.2.1-3)

* running under: Fedora Linux 40 (Container Image)

Docker #2 (thanks to Tomas Kalibera)

* using R Under development (unstable) (2024-12-02 r87417)

* using platform: aarch64-unknown-linux-gnu

* R was compiled by

    gcc (Debian 14.2.0-8) 14.2.0

    GNU Fortran (Debian 14.2.0-8) 14.2.0

* running under: Debian GNU/Linux trixie/sid

The flag appears in 00install.out, but the warning doesn't get raised.

Any ideas on how to duplicate?

Thanks,

Brad

PS checks for my package are here:
https://www.stats.ox.ac.uk/pub/bdr/memtests/gcc-UBSAN/epanet2toolkit/00check.log

	[[alternative HTML version deleted]]


From |kry|ov @end|ng |rom d|@root@org  Thu Dec 12 16:38:45 2024
From: |kry|ov @end|ng |rom d|@root@org (Ivan Krylov)
Date: Thu, 12 Dec 2024 18:38:45 +0300
Subject: [R-pkg-devel] duplicating gcc-UBSAN warning
In-Reply-To: <CALECgPZGfHrSSYKZeP_-sX5cBhzBn7FwM0RWmZ5Giq-=MpMsnA@mail.gmail.com>
References: <CALECgPZGfHrSSYKZeP_-sX5cBhzBn7FwM0RWmZ5Giq-=MpMsnA@mail.gmail.com>
Message-ID: <20241212183845.407f9667@arachnoid>

? Thu, 12 Dec 2024 14:46:08 +0000
Brad Eck <bradleyjeck at gmail.com> ?????:

> The flag appears in 00install.out, but the warning doesn't get raised.
> 
> Any ideas on how to duplicate?

In my experiments with gcc 14.2.0-8 on Debian for amd64 (the
debian:testing container), the warning only appears when all of the
following flags are present:

-fsanitize=address -O2 -Wstringop-truncation

-Wall can be used instead of -Wstringop-truncation because the former
includes the latter. -fsanitize=address,undefined also works, but not
just -fsanitize=undefined.

Remove the optimisation or the AddressSanitizer, and GCC stops being
able to prove that truncation occurs. It looks like you will either
need to find a container with R pre-built with sanitizers enabled (are
there Rocker containers for aarch64?) or build R yourself [*].

-- 
Best regards,
Ivan

[*]
https://cran.r-project.org/doc/manuals/R-exts.html#Using-Address-Sanitizer


From tom@@@k@||ber@ @end|ng |rom gm@||@com  Fri Dec 13 07:52:29 2024
From: tom@@@k@||ber@ @end|ng |rom gm@||@com (Tomas Kalibera)
Date: Fri, 13 Dec 2024 07:52:29 +0100
Subject: [R-pkg-devel] Creating and hosting static libraries for package
 installation on Windows
In-Reply-To: <CAM3Cqv+WJjKSjLpv-_2rXDK2E8OF3MbF1zUTaxyhK6APwQiYbw@mail.gmail.com>
References: <CAM3Cqv+WJjKSjLpv-_2rXDK2E8OF3MbF1zUTaxyhK6APwQiYbw@mail.gmail.com>
Message-ID: <eeeedde4-9407-4e38-9263-0c28a2683c9c@gmail.com>

On 12/11/24 05:23, Satyaprakash Nayak wrote:
> Hi r-package-devel
>
> I am working on updating my package `sundialr` (
> https://cran.r-project.org/web/packages/sundialr/index.html), wherein I was
> earlier bundling the C source files with the package, but now I am using
> `cmake` to create static libraries for the upstream C library SUNDIALS
> which the package provides an interface for. In brief, the previous
> approach can be found at:
>
> https://github.com/sn248/sundialr/blob/master/src/Makevars
>
> And the new approach can be seen below (heavily borrowed from nloptr
> package installation approach):
>
> https://github.com/sn248/sundialr/blob/cmake-install/tools/cmake_call.sh
>
> The second approach works successfully on linux and macOS platforms
> (checked by rhub).
>
> I am struggling to get this working on a Windows platform, and have looked
> at a few packages (e.g., nloptr, rcppredis, openssl) which have solved this
> issue. As I understand the following steps are required to get the static
> libraries in correct locations for package installation on the Windows

Technically, it is possible to build sundials from the downloaded source 
code using cmake on Windows pretty much like on Unix. Rtools includes 
cmake as well as the toolchains and libraries to build sundials. The 
older version of sundialr was building sundials on Windows using make, 
there is no technical reason why it couldn't do that using cmake (and 
downloaded _sources_) as well.

I was able to build the new sundialr on my Windows with these changes, 
and the package passed its checks (with some warnings):

1. delete Makevars.win and Makevars.ucrt
2. create configure.win file with this content in the package root directory

---

#! /bin/sh

./configure $*

---

Whenever in doubt, I would recommend starting with the same code for 
Unix and Windows. Only customize for Windows (or macOS or another 
system) if needed.

Best Tomas

> 1) Host the .tar.gz files or .zip files on https://github.com/rwinlib/
> (deprecated now) or https://github.com/r-windows/bundles/releases/download/
> which should contain the static libraries (*.a files) in separate folders
> for i386, x64-ucrt and x-64 platforms and required header files in the
> `include` folder.
>
> 2) Use a winlibs.R file within the `tools` sub-directory in the package
> file structure to download the .zip or .tar.gz file and extract them to a
> `windows` directory.
>
> 3) Set PKG_CPPFLAGS and PKG_LIBS via Makewars.win file in src sub-directory
> in the package files.
>
> Currently, I am struggling with Step #1, i.e., how to create the required
> .zip or .tar.gz files and host them on
> https://github.com/r-windows/bundles/releases for download. I will be
> thankful if any one can provide some guidance in this regard.
>
> Sincerely
> Satya
>
> 	[[alternative HTML version deleted]]
>
> ______________________________________________
> R-package-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-package-devel


From @n248 @end|ng |rom corne||@edu  Fri Dec 13 15:02:50 2024
From: @n248 @end|ng |rom corne||@edu (Satyaprakash Nayak)
Date: Fri, 13 Dec 2024 09:02:50 -0500
Subject: [R-pkg-devel] Creating and hosting static libraries for package
 installation on Windows
In-Reply-To: <CAM3Cqv+WJjKSjLpv-_2rXDK2E8OF3MbF1zUTaxyhK6APwQiYbw@mail.gmail.com>
References: <CAM3Cqv+WJjKSjLpv-_2rXDK2E8OF3MbF1zUTaxyhK6APwQiYbw@mail.gmail.com>
Message-ID: <CAM3Cqv+Np7ZYeX2HyapEruYLFoM6CeSCZYacT=yjvYaAOC129w@mail.gmail.com>

For some reason, I am not getting emails from the list, but would like to
thank Uwe and Tomas for their help. The code Tomas has provided in his
response has resolved the issue.

Satya


On Tue, Dec 10, 2024 at 11:23?PM Satyaprakash Nayak <sn248 at cornell.edu>
wrote:

> Hi r-package-devel
>
> I am working on updating my package `sundialr` (
> https://cran.r-project.org/web/packages/sundialr/index.html), wherein I
> was
> earlier bundling the C source files with the package, but now I am using
> `cmake` to create static libraries for the upstream C library SUNDIALS
> which the package provides an interface for. In brief, the previous
> approach can be found at:
>
> https://github.com/sn248/sundialr/blob/master/src/Makevars
>
> And the new approach can be seen below (heavily borrowed from nloptr
> package installation approach):
>
> https://github.com/sn248/sundialr/blob/cmake-install/tools/cmake_call.sh
>
> The second approach works successfully on linux and macOS platforms
> (checked by rhub).
>
> I am struggling to get this working on a Windows platform, and have looked
> at a few packages (e.g., nloptr, rcppredis, openssl) which have solved this
> issue. As I understand the following steps are required to get the static
> libraries in correct locations for package installation on the Windows
>
> 1) Host the .tar.gz files or .zip files on https://github.com/rwinlib/
> (deprecated now) or
> https://github.com/r-windows/bundles/releases/download/
> which should contain the static libraries (*.a files) in separate folders
> for i386, x64-ucrt and x-64 platforms and required header files in the
> `include` folder.
>
> 2) Use a winlibs.R file within the `tools` sub-directory in the package
> file structure to download the .zip or .tar.gz file and extract them to a
> `windows` directory.
>
> 3) Set PKG_CPPFLAGS and PKG_LIBS via Makewars.win file in src sub-directory
> in the package files.
>
> Currently, I am struggling with Step #1, i.e., how to create the required
> .zip or .tar.gz files and host them on
> https://github.com/r-windows/bundles/releases for download. I will be
> thankful if any one can provide some guidance in this regard.
>
> Sincerely
> Satya
>
>

	[[alternative HTML version deleted]]


From br@d|eyjeck @end|ng |rom gm@||@com  Fri Dec 13 19:08:27 2024
From: br@d|eyjeck @end|ng |rom gm@||@com (Brad Eck)
Date: Fri, 13 Dec 2024 18:08:27 +0000
Subject: [R-pkg-devel] truncating strings on purpose
In-Reply-To: <20241211162930.38eb4ba3@arachnoid>
References: <CALECgPaop1dk_Zfxrb-68sJkFfUPtBJ6FHkqMAuNTKbA+t=zPg@mail.gmail.com>
 <20241211162930.38eb4ba3@arachnoid>
Message-ID: <CALECgPbe1fNZ=XYA8A6Pypg1R8Uc7aVFcbA8uhqHLBRV09E8bA@mail.gmail.com>

Hi Ivan, List,

Thanks for the suggestion, and for the pointer on duplicating the error.
The good news is that I am able to trigger the warning locally now. The bad
news is that following the gcc docs on avoid the warning did not seem to
work:


gcc -std=gnu99 -fsanitize=undefined -fno-omit-frame-pointer -std=gnu11
-I"/usr/local/lib/R/include" -DNDEBUG   -I/usr/local/include
-fsanitize=address
-O2 -Wstringop-truncation -fPIC  -g -O2  -c input2.c -o input2.o

input2.c: In function ?inperrmsg?:

input2.c:863:5: warning: ?strncpy? output may be truncated copying 225
bytes from a string of length 255 [-Wstringop-truncation]

  863 |     strncpy(trunc_tok, tok, sizeof trunc_tok - 1);

      |     ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~




I could also try memcpy, but i don't so much like the idea of going away
from string functions for string handling.


Other suggestions are also welcome.


Brad



On Wed, Dec 11, 2024 at 1:29?PM Ivan Krylov <ikrylov at disroot.org> wrote:

> ? Wed, 11 Dec 2024 12:12:11 +0000
> Brad Eck <bradleyjeck at gmail.com> ?????:
>
> > Found the following significant warnings:
> >     input2.c:863:5: warning: ?__builtin_strncpy? output may be
> > truncated copying 225 bytes from a string of length 255
> > [-Wstringop-truncation]
>
> > Where the truncation warnings appear, I am truncating on purpose
> > using `strncpy` to avoid overflows later.  I believe this works fine
> > from an application point of view but the warnings remain.
>
> GCC documentation suggests setting the length argument to _one less_
> than sizeof destination buffer in addition to terminating the string:
>
> https://gcc.gnu.org/onlinedocs/gcc-14.2.0/gcc/Warning-Options.html#index-Wstringop-truncation
>
>         strncpy(trunc_s1, s1, sizeof trunc_s1 - 1);
>         trunc_s1[sizeof trunc_s1 - 1] = '\0';
>
> --
> Best regards,
> Ivan
>

	[[alternative HTML version deleted]]


